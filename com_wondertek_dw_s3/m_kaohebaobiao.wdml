<?xml version="1.0" encoding="utf-8"?>
<!--
 == ============================================================================
 == | WonderTek [ 网络无处不在，沟通及时到达 ]
 == ============================================================================
 == | Copyright (c) 2012, WonderTek, Inc. All Rights Reserved.
 == ============================================================================
 == | Author: hewu<hewu2008@gmail.com>
 == ============================================================================
 == | Desc: 页面描述
 == ============================================================================
-->
<root>
    <header/>
    <body resolution="480,800" BuildChildrenFinished="bodyBuildChildrenFinished"
        OnSpriteEvent="bodyOnSpriteEvent" OnPluginEvent="bodyOnPluginEvent">
        <!-- 主节点  -->
        <node name="mainNode" rect="0,0,480,800" enable="true" 
            active="true" OnKeyUp="mainNodeOnKeyUp" layouttype="1" extendstyle="1111">
	        <!-- 设置背景 -->
	        <image rect="0,0,0,0" src="file://image/backgroundImg.png" style="autosize"
	           extendstyle="1177" />
            
            <!-- 设置头部 -->
            <node name="baseSprite" rect="0,0,480,66" extendstyle="1111">
				 <image name="title" rect="0,0,480,66" border="false" src="file://image/title_bg_new.png" 
				    style="autosize" extendstyle="1111">
					 <label rect="0,0,480,66" text="考核报表" color="#ffffff" v-align="center"  
					   h-align="center" font-family="微软雅黑" font-size="30" extendstyle="1111" />
				 </image>
				 <!-- 返回按钮  -->
				 <button name="backBtn" rect="10,10,40,40"  style="autosize"  normal="" sel="" 
				    OnSelect="doBack" extendstyle="1111">
					<image name="normal" rect="0,0,40,40" src="file://image/ico_back.png"
								style="autosize"  extendstyle="1111" />
					<image name="sel" rect="0,0,40,40" src="file://image/ico_back.png" 
					            style="autosize"  extendstyle="1111" />
                </button>
            </node>
            
            <!-- 主体可滑动部分  -->
            <panorama name="panorama" rect="0,66,480,654" foreground="" alpha="255">
                <panoramaitem name="item1" rect="0,0,480,654" OnSelect="PanoramaItemOnSelect" data="01">
			        <!-- 报表标题  -->
		            <node rect="0,0,480,56" extendstyle="1111">
		                <image name="search_bg" rect="0,0,480,56" src="file://image/search_bg_new.png"
		                    style="autosize" extendstyle="1111" />
		                <label rect="0,0,120,56" text="地市" color="#0" v-align="center"  
		                    h-align="center" font-family="微软雅黑" font-size="22" extendstyle="1111" />
		                <label rect="120,0,120,56" text="总分" color="#0" v-align="center"  
		                    h-align="center" font-family="微软雅黑" font-size="22" extendstyle="1111" />
		                <label rect="240,0,120,56" text="基站" color="#0" v-align="center"  
		                    h-align="center" font-family="微软雅黑" font-size="22" extendstyle="1111" />
		                <label rect="360,0,120,56" text="铁塔" color="#0" v-align="center"  
		                    h-align="center" font-family="微软雅黑" font-size="22" extendstyle="1111" />
		            </node>
		            <!--列表信息-->
		            <node name="listNode1" rect="0,56,480,598" extendstyle="1111">
		                <listview name="sampleList1" rect="0,0,480,598" extendstyle="1111" />
		            </node>
			    </panoramaitem>
			    
			    <panoramaitem name="item2" rect="0,0,480,654" OnSelect="PanoramaItemOnSelect" data="02">
                    <!-- 报表标题  -->
                    <node rect="0,0,480,56" extendstyle="1111">
                        <image name="search_bg" rect="0,0,480,56" src="file://image/search_bg_new.png"
                            style="autosize" extendstyle="1111" />
                        <label rect="0,0,120,56" text="地市" color="#0" v-align="center"  
                            h-align="center" font-family="微软雅黑" font-size="22" extendstyle="1111" />
                        <label rect="120,0,120,56" text="综合覆盖" color="#0" v-align="center"  
                            h-align="center" font-family="微软雅黑" font-size="22" extendstyle="1111" />
                        <label rect="240,0,120,56" text="传输" color="#0" v-align="center"  
                            h-align="center" font-family="微软雅黑" font-size="22" extendstyle="1111" />
                        <label rect="360,0,120,56" text="集客家客" color="#0" v-align="center"  
                            h-align="center" font-family="微软雅黑" font-size="22" extendstyle="1111" />
                    </node>
                    <!--列表信息-->
                    <node name="listNode2" rect="0,56,480,598" extendstyle="1111">
                        <listview name="sampleList2" rect="0,0,480,598" extendstyle="1111" />
                    </node>
                </panoramaitem>
            </panorama>
            
            <!-- 更多按钮  -->
             <node rect="0,720,480,80" extendstyle="1111">
                <button name="more" rect="40,15,400,50" style="autosize"  
                    normal="" sel="" OnSelect="" extendstyle="1111">
                    <image name="normal" rect="0,0,400,50" src="file://image/button_more.png"
                        style="autosize"  extendstyle="1111" />
                    <image name="sel" rect="0,0,400,50" src="file://image/button_more.png" 
                        style="autosize"  extendstyle="1111" />
                    <label rect="0,0,400,50" text="点击查看更多..." color="#0" v-align="center"  
                        h-align="center" font-family="微软雅黑" font-size="24" extendstyle="1111" />
                </button>
            </node>
            
            <!-- 列表项模板1: 总分，基站，铁塔  -->
            <node name="listitem1" visible="false" enable="false" active="false"
                extendstyle="1011" rect="0,350,480,50">
                <image name="listitembg" rect="0,0,480,50" src="" style="autosize"  extendstyle="1111" />
                <!-- 地市名称 -->
                <node rect="0,0,120,50" extendstyle="1111">
                    <label name="city" rect="0,0,120,50" text="" font-family='微软雅黑' color="#0" 
                        font-size="20"  h-align="center" v-align="center" extendstyle="1111" border="false" />
                    <!--  <shadow rect="118,0,2,50" color="#c3c3c3" alpha="255" extendstyle="1111"></shadow> -->
                </node>
                <!-- 总分  -->
                <node rect="120,0,120,50" extendstyle="1111">
                    <label name="total" rect="0,0,60,50" text="" font-family='微软雅黑' color="#0" 
                        font-size="20"  h-align="right" v-align="center" extendstyle="1111" border="false" />
                    <image name="totalFlag" rect="70,12,25,25" src="" style="autosize"  extendstyle="1111" />
                    <!--  <shadow rect="118,0,2,50" color="#c3c3c3" alpha="255" extendstyle="1111"></shadow>  -->
                </node>
                <!-- 基站考核得分  -->
                <node rect="240,0,120,50" extendstyle="1111">
                    <label name="station" rect="0,0,60,50" text="" font-family='微软雅黑' color="#0" 
                        font-size="20"  h-align="right" v-align="center" extendstyle="1111" border="false" />
                    <image name="stationFlag" rect="70,12,25,25" src="" style="autosize"  extendstyle="1111" />
                    <!--  <shadow rect="118,0,2,50" color="#c3c3c3" alpha="255" extendstyle="1111"></shadow>  -->
                </node>
                <!-- 铁塔考核得分  -->
                <node rect="360,0,120,50" extendstyle="1111">
                    <label name="tower" rect="0,0,60,50" text="" font-family='微软雅黑' color="#0" 
                        font-size="20"  h-align="right" v-align="center" extendstyle="1111" border="false" />
                    <image name="towerFlag" rect="70,12,25,25" src="" style="autosize"  extendstyle="1111" />
                    <!--  <shadow rect="118,0,2,50" color="#c3c3c3" alpha="255" extendstyle="1111"></shadow>  -->
                </node>
            </node>
            
            <!-- 列表项模板2: 综合覆盖，传输，集客家客  -->
            <node name="listitem2" visible="false" enable="false" active="false"
                extendstyle="1011" rect="0,350,480,50">
                <image name="listitembg" rect="0,0,480,50" src="" style="autosize"  extendstyle="1111" />
                <!-- 地市名称 -->
                <node rect="0,0,120,50" extendstyle="1111">
                    <label name="city" rect="0,0,120,50" text="" font-family='微软雅黑' color="#0" 
                        font-size="20"  h-align="center" v-align="center" extendstyle="1111" border="false" />
                    <!--  <shadow rect="118,0,2,50" color="#c3c3c3" alpha="255" extendstyle="1111"></shadow> -->
                </node>
                <!-- 综合覆盖考核得分  -->
                <node rect="120,0,120,50" extendstyle="1111">
                    <label name="coverage" rect="0,0,60,50" text="" font-family='微软雅黑' color="#0" 
                        font-size="20"  h-align="right" v-align="center" extendstyle="1111" border="false" />
                    <image name="coverageFlag" rect="70,12,25,25" src="" style="autosize"  extendstyle="1111" />
                    <!-- <shadow rect="118,0,2,50" color="#c3c3c3" alpha="255" extendstyle="1111"></shadow>  -->
                </node>
                <!-- 传输考核得分  -->
                <node rect="240,0,120,50" extendstyle="1111">
                    <label name="line" rect="0,0,60,50" text="" font-family='微软雅黑' color="#0" 
                        font-size="20"  h-align="right" v-align="center" extendstyle="1111" border="false" />
                    <image name="lineFlag" rect="70,12,25,25" src="" style="autosize"  extendstyle="1111" />
                    <!--  <shadow rect="118,0,2,50" color="#c3c3c3" alpha="255" extendstyle="1111"></shadow>  -->
                </node>
                <!-- 集客家客考核得分  -->
                <node rect="360,0,120,50" extendstyle="1111">
                    <label name="client" rect="0,0,60,50" text="" font-family='微软雅黑' color="#0" 
                        font-size="20"  h-align="right" v-align="center" extendstyle="1111" border="false" />
                    <image name="clientFlag" rect="70,12,25,25" src="" style="autosize"  extendstyle="1111" />
                    <!--  <shadow rect="118,0,2,50" color="#c3c3c3" alpha="255" extendstyle="1111"></shadow>  -->
                </node>
            </node>
        </node>
    </body>
    <![CDATA[

require 'com_wondertek_dw_s3.common.framework'
require 'framework.webbrowser'

local rootSprite

local sepData = {
                    {name="合肥", total="90.47", line="88.96", station="94.78", tower="98", coverage="83.69", client="86.66"},
                    {name="芜湖", total="92.40", line="91.57", station="93.04", tower="0", coverage="87", client="96.64"},
                    {name="蚌埠", total="92.02", line="90.62", station="93.82", tower="0", coverage="90.7", client="80.54"},
                    {name="淮南", total="92.09", line="90.47", station="93.48", tower="98", coverage="86", client="92.55"},
                    {name="淮北", total="93.09", line="92.23", station="93.5", tower="96", coverage="0", client="93.5"},
                    {name="铜陵", total="92.62", line="92.00", station="93.8", tower="99", coverage="86.14", client="94.825"},
                    {name="安庆", total="91.81", line="88.89", station="95.25", tower="0", coverage="0", client="90.5"},
                    {name="黄山", total="92.67", line="90.29", station="95.09", tower="95", coverage="91", client="92.58"},
                    {name="滁州", total="93.37", line="92.42", station="94.79", tower="97", coverage="86", client="92.43"},
                    {name="阜阳", total="93.20", line="92.06", station="94.61", tower="96", coverage="91.7", client="94"},
                    {name="宿州", total="90.35", line="86.32", station="94.05", tower="95", coverage="91.1", client="91.03"},
                    {name="六安", total="92.64", line="90.32", station="93.28", tower="98", coverage="88.7", client="95.99"},
                    {name="亳州", total="92.98", line="92.35", station="94.6", tower="96", coverage="89", client="92"},
                    {name="池州", total="92.76", line="90.08", station="94.57", tower="96", coverage="90.7", client="96.41"},
                    {name="宣城", total="91.56", line="90", station="92.5", tower="0", coverage="90.5", client="92.5"},
                }

local g_data = nil

---------------------------------------回调函数--------------------------------
-- root子节点创建完事件
function bodyBuildChildrenFinished(sprite)
    rootSprite = sprite
     -- 准备数据
    g_data = sepData 
    sortData(g_data)
    local len = #g_data
    
    -- 加载列表项1
    local sampleList1 = Sprite:findChild(rootSprite, 'sampleList1')
    local listitem1 = Sprite:findChild(rootSprite, 'listitem1')
    ListView:removeAllItems(sampleList1)
    ListView:loadItem(sampleList1, listitem1, len, 'loadListItem1')
    ListView:adjust(sampleList1)
    
    local sampleList2 = Sprite:findChild(rootSprite, 'sampleList2')
    local listitem2 = Sprite:findChild(rootSprite, 'listitem2')
    ListView:removeAllItems(sampleList2)
    ListView:loadItem(sampleList2, listitem2, len, 'loadListItem2')
    ListView:adjust(sampleList2)
end

-- root节点消息方法
function bodyOnSpriteEvent(msg, param)
    if msg == MSG_ACTIVATE then -- 页面激活
	    if umsagentHasAppkey == 1 then
	        pluginInvoke(umsagentPlugin, "OnActivate", string.match(Alias.chart, 'MODULE:\\(.*)'))
	    end
    elseif msg == MSG_DEACTIVATE then
        if umsagentHasAppkey == 1 then
            pluginInvoke(umsagentPlugin, "OnDeactivate")
        end
    end
end

-- 插件消息方法
function bodyOnPluginEvent(msg, param)
    if msg == 101 then
    elseif msg == 101 + MSG_CACHEDATA_RELOAD then -- 101请求的数据有更新
    elseif msg == 101 + MSG_NETWORK_ERROR then -- 101请求的数据超时
    elseif msg == MSG_NETWORK_ERROR then -- 拨号失败
        Log:write('拨号失败')
    elseif msg > MSG_NETWORK_ERROR then -- 请求超时
        Log:write('请求超时')
    end
end

-- 按键响应处理
function mainNodeOnKeyUp(sprite, kc)
    if kc == Key.F2 then -- 按下返回键
        Scene:back()
        return 1
    end
end

-- 返回上一个页面
function doBack()
    Scene:back()
end

-- 对考核数据进行排序
function sortData(data)
    sortFunc = function(a, b)  return a.total > b.total end
    table.sort(data, sortFunc)
end

-----------------------------------------------------------------
function  PanoramaItemOnSelect( sprite )
end

------------------------------ 加载列表项1，基站，铁塔，综合覆盖---------------------------
function loadListItem1(list, item, index)
	Sprite:setRect(item, 0, 0, 480, 50)
	local listitembg = Sprite:findChild(item, 'listitembg')
	if index % 2 > 0 then
	   Sprite:setProperty(listitembg, 'src', 'file://image/item_bg_m.png')
	else
	   Sprite:setVisible(listitembg, 0)
	end
    -- 获取地市名称，基站，铁塔，综合覆盖的Sprite 
	Sprite:setProperty(item, 'extendstyle', '1111')
	local city = Sprite:findChild(item, 'city')
    local total = Sprite:findChild(item, 'total')
    local tower = Sprite:findChild(item, 'tower')
    local station = Sprite:findChild(item, 'station')
    
    -- 显示到界面
    Sprite:setProperty(city, 'text', g_data[index+1].name)
    Sprite:setProperty(station, 'text', g_data[index+1].station)
    Sprite:setProperty(tower, 'text',  g_data[index+1].tower)
    Sprite:setProperty(total, 'text', g_data[index+1].total)
    
    -- 前三名显示笑脸，后三名显示哭脸
    showRank1(item, index)
end

-- 对前三名显示笑脸，后三名显示哭脸
function showRank1(item, index)
    -- 获取当前的总分，基站，铁塔，综合覆盖的值
    local total = g_data[index+1].total
    local station = g_data[index+1].station
    local tower = g_data[index+1].tower
    
    -- 统计总分，基站，铁塔，综合覆盖的排名
    local stationCount = 0
    local towerCount = 0
    local totalCount = 0
    for i=1,#g_data do
        if tonumber(station) < tonumber(g_data[i].station) then 
            stationCount =  stationCount + 1
        end 
        if tonumber(tower) < tonumber(g_data[i].tower) then 
            towerCount =  towerCount + 1
        end 
        if tonumber(total) < tonumber(g_data[i].total) then 
            totalCount =  totalCount + 1
        end 
    end
    
    -- 获取笑脸和哭脸的Sprite
    local stationFlag = Sprite:findChild(item, 'stationFlag')
    local towerFlag = Sprite:findChild(item, 'towerFlag')
    local totalFlag = Sprite:findChild(item, 'totalFlag')
    
    if stationCount <= 2 then
        Sprite:setProperty(stationFlag, 'src', 'file://image/smileface.png')
    elseif #g_data - stationCount <= 3 or tonumber(station) == 0 then
        Sprite:setProperty(stationFlag, 'src', 'file://image/cryface.png')
    end
    
    if towerCount <= 2 then
        Sprite:setProperty(towerFlag, 'src', 'file://image/smileface.png')
    elseif #g_data - towerCount <= 3   or tonumber(tower)  == 0 then
        Sprite:setProperty(towerFlag, 'src', 'file://image/cryface.png')
    end
    
    if totalCount <= 2 then
        Sprite:setProperty(totalFlag, 'src', 'file://image/smileface.png')
    elseif #g_data - totalCount <= 3  or tonumber(total)  == 0 then
        Sprite:setProperty(totalFlag, 'src', 'file://image/cryface.png')
    end
end

------------------------------ 加载列表项项2，线路，集客家客 ---------------------------
function loadListItem2(list, item, index)
    Sprite:setRect(item, 0, 0, 480, 50)
    local listitembg = Sprite:findChild(item, 'listitembg')
    if index % 2 > 0 then
       Sprite:setProperty(listitembg, 'src', 'file://image/item_bg_m.png')
    else
       Sprite:setVisible(listitembg, 0)
    end
    -- 获取地市名称，基站，铁塔，综合覆盖的Sprite 
    Sprite:setProperty(item, 'extendstyle', '1111')
    local city = Sprite:findChild(item, 'city')
    local coverage = Sprite:findChild(item, 'coverage')
    local line = Sprite:findChild(item, 'line')
    local client = Sprite:findChild(item, 'client')
    
    -- 显示到界面
    Sprite:setProperty(city, 'text', g_data[index+1].name)
    Sprite:setProperty(coverage, 'text', g_data[index+1].coverage)
    Sprite:setProperty(line, 'text', g_data[index+1].line)
    Sprite:setProperty(client, 'text',  g_data[index+1].client)
    
    -- 前三名显示笑脸，后三名显示哭脸
    showRank2(item, index)
end

-- 对前三名显示笑脸，后三名显示哭脸
function showRank2(item, index)
    -- 获取当前的综合覆盖，线路，集客家客的值
    local coverage = g_data[index+1].coverage
    local line = g_data[index+1].line
    local client = g_data[index+1].client
    
    -- 统计综合覆盖, 线路，集客家客的排名
    local coverageCount = 0
    local lineCount = 0
    local clientCount = 0
    for i=1,#g_data do
        if tonumber(coverage) < tonumber(g_data[i].coverage) then 
            coverageCount = coverageCount + 1
        end
        if tonumber(line) < tonumber(g_data[i].line) then 
            lineCount =  lineCount + 1
        end 
        if tonumber(client) < tonumber(g_data[i].client) then 
            clientCount =  clientCount + 1
        end 
    end
    
    -- 获取笑脸和哭脸的Sprite
    local coverageFlag = Sprite:findChild(item, 'coverageFlag')
    local lineFlag = Sprite:findChild(item, 'lineFlag')
    local clientFlag = Sprite:findChild(item, 'clientFlag')
    
    if coverageCount <= 2 then
        Sprite:setProperty(coverageFlag, 'src', 'file://image/smileface.png')
    elseif #g_data - coverageCount <= 3 then
        Sprite:setProperty(coverageFlag, 'src', 'file://image/cryface.png')
    end
    
    if lineCount <= 2 then
        Sprite:setProperty(lineFlag, 'src', 'file://image/smileface.png')
    elseif #g_data - lineCount <= 3 then
        Sprite:setProperty(lineFlag, 'src', 'file://image/cryface.png')
    end
    
    if clientCount <= 2 then
        Sprite:setProperty(clientFlag, 'src', 'file://image/smileface.png')
    elseif #g_data - clientCount <= 3 then
        Sprite:setProperty(clientFlag, 'src', 'file://image/cryface.png')
    end
end
    ]]>
</root>
