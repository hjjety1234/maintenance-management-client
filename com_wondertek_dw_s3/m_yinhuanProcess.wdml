<?xml version="1.0" encoding="utf-8"?>
<!--
==
============================================================================
== | WonderTek [ 网络无处不在，沟通及时到达 ] ==
============================================================================
== | Copyright (c) 2012, WonderTek, Inc. All Rights Reserved. ==
============================================================================
== | Author: hewu <hewu2008@gmail.com> ==
============================================================================
== | Desc: 页面描述 ==
============================================================================
-->
<root>
    <header />
    <body resolution="480,800" BuildChildrenFinished="bodyBuildChildrenFinished"
        OnSpriteEvent="bodyOnSpriteEvent" OnPluginEvent="bodyOnPluginEvent">

        <!-- 主体节点 -->
        <node name="mainNode" rect="0,0,480,800" enable="true" active="true"
            OnKeyUp="mainNodeOnKeyUp" layouttype="1" extendstyle="1111">

            <!-- 设置背景 -->
            <image rect="0,0,0,0" src="file://image/backgroundImg.png" style="autosize" extendstyle="1177">
            <image name="line" rect="80,0,3,800" border="false"
                    src="file://image/process_line.png" style="autosize" extendstyle="1111" />
            </image>
           
            <!-- 设置头部 -->
            <node name="baseSprite" rect="0,0,480,66" extendstyle="1111">
                <image name="title" rect="0,0,480,66" border="false"
                    src="file://image/title_bg_new.png" style="autosize" extendstyle="1111" />
                <label rect="0,0,480,66" text="隐患流程查询" color="#ffffff" v-align="center"
                    h-align="center" font-size="30" extendstyle="1111" />
                <button name="backBtn" rect="17,13,40,40" normal="normal" sel="sel"
                    OnSelect="doBack" extendstyle="1111">
						<image name="normal" rect="0,0,40,40" src="file://image/ic_home_new.png" style="autosize" extendstyle="1111"/>
						<image name="sel" rect="0,0,40,40"  src="file://image/ic_home_new.png" style="autosize" extendstyle="1111"/>               
                </button>                    
            </node>

            <!-- 工单标题 -->
            <node name="selectBar" rect="0,66,480,56" extendstyle="1111"
                visible="true">
		    <image name="select_bg_new" rect="0,0,480,52" src="file://image/search_bg.png"
                    style="autosize" extendstyle="1111" />
		    <label rect="0,0,480,52" text="隐患工单流程详情" color="#3C57C4" v-align="center"
                    h-align="center" font-size="24" extendstyle="1111" />    
            </node>

            <!-- 列表 -->
            <node name="listNode" rect="0,122,480,678" extendstyle="1111">
                <listview name="sampleList" rect="60,0,480,678" extendstyle="1111">        
					<list-item rect="0,0,420,126" extendstyle="1111">
							  <image rect="7,0,2,126"  style="autosize" src="file://image/sep.png" extendstyle="1111"/>
							 <node name="baseSprite" rect="0,0,420,116" extendstyle="1111">
										 <image rect="0,50,16,16" border="false" src="file://image/finished_circle.png" 
											 style="autosize" extendstyle="1111" />
											 
										<node name="baseSprite" rect="20,4,420,100" extendstyle="1111"> 
												 <image rect="0,0,342,110" border="false" src="file://image/finished_bg.png" 
													 style="autosize" extendstyle="1111" />    
												 <label rect="25,5,150,30" text="工单派发：" color="#ffffff"
													font-size="20" h-align="left" v-align="center" extendstyle="1111"
													border="false" />
												<label name="textTitle" rect="120,5,300,30" text="周礼" color="#ffffff"
													font-size="20" h-align="left" v-align="center" extendstyle="1111"
													border="false" />
												<label rect="25,30,150,30" text="派单时间：" color="#ffffff" font-size="20"
													h-align="left" v-align="center" extendstyle="1111" border="false" />
												<label name="textNum" rect="120,30,300,30" text="2012-06-14 08:35:03" color="#ffffff"
													font-size="20" h-align="left" v-align="center" extendstyle="1111"
													border="false" />
												<label rect="25,55,150,30" text="处理意见：" color="#ffffff" font-size="20"
													h-align="left" v-align="center" extendstyle="1111" border="false" />
												<label name="textTime" rect="120,55,300,30" text="" color="#0"
													font-size="20" h-align="left" v-align="center" extendstyle="1111"
													border="false" />
												<label name="timeLabel" rect="25,80,150,30" text="步骤状态：" color="#ffffff" font-size="20"
													h-align="left" v-align="center" extendstyle="1111" border="false" />
												<label name="finishTime" rect="120,80,300,30" text="已完成" color="#ffffff"
													font-size="20" h-align="left" v-align="center" extendstyle="1111"
													border="false" />              
									   </node>  
							 </node>                   
				   </list-item>
				   <list-item rect="0,126,420,126" extendstyle="1111">
							  <image rect="7,0,2,126"  style="autosize" src="file://image/sep.png" extendstyle="1111"/>
							 <node name="baseSprite" rect="0,0,420,116" extendstyle="1111">
										 <image rect="0,50,16,16" border="false" src="file://image/unfinished_circle.png" 
											 style="autosize" extendstyle="1111" />
											 
										<node name="baseSprite" rect="20,4,420,100" extendstyle="1111"> 
												 <image rect="0,0,342,110" border="false" src="file://image/unfinished_bg.png" 
													 style="autosize" extendstyle="1111" />    
												 <label rect="25,5,150,30" text="工单派发：" color="#ffffff"
													font-size="20" h-align="left" v-align="center" extendstyle="1111"
													border="false" />
												<label name="textTitle" rect="120,5,300,30" text="周礼" color="#ffffff"
													font-size="20" h-align="left" v-align="center" extendstyle="1111"
													border="false" />
												<label rect="25,30,150,30" text="派单时间：" color="#ffffff" font-size="20"
													h-align="left" v-align="center" extendstyle="1111" border="false" />
												<label name="textNum" rect="120,30,300,30" text="2012-06-14 08:35:03" color="#ffffff"
													font-size="20" h-align="left" v-align="center" extendstyle="1111"
													border="false" />
												<label rect="25,55,150,30" text="处理意见：" color="#ffffff" font-size="20"
													h-align="left" v-align="center" extendstyle="1111" border="false" />
												<label name="textTime" rect="120,55,300,30" text="" color="#0"
													font-size="20" h-align="left" v-align="center" extendstyle="1111"
													border="false" />
												<label name="timeLabel" rect="25,80,150,30" text="步骤状态：" color="#ffffff" font-size="20"
													h-align="left" v-align="center" extendstyle="1111" border="false" />
												<label name="finishTime" rect="120,80,300,30" text="已完成" color="#ffffff"
													font-size="20" h-align="left" v-align="center" extendstyle="1111"
													border="false" />              
									   </node>  
							 </node>                   
				   </list-item>
			    </listview>  
            </node>
			
            <!-- 列表项模板  -->
            <node name="listitem" visible="false" enable="false" active="false"
                extendstyle="1011" rect="0,0,420,126">
				 <image  rect="7,0,2,126"  style="autosize" src="file://image/sep.png" extendstyle="1111"/>			
				 <button name="btnname" rect="0,0,420,116" OnSelect="itemOnSelect" extendstyle="1111">
						<image name="imageCircle" rect="0,50,16,16" border="false" src="file://image/finished_circle.png" 
									style="autosize" extendstyle="1111" />	
						<node name="baseSprite" rect="20,4,420,100" extendstyle="1111"> 
									<image name = "imageBg" rect="0,0,342,110" border="false" src="file://image/finished_bg.png" 
													style="autosize" extendstyle="1111" /> 											
									<label rect="25,5,150,30" text="工单派发：" color="#ffffff"
													font-size="20" h-align="left" v-align="center" border="false" extendstyle="1111" />
									<label name="textTitle" rect="120,5,300,30" text="周礼" color="#ffffff"
													font-size="20" h-align="left" v-align="center" border="false" extendstyle="1111"/>
									<label rect="25,30,150,30" text="派单时间：" color="#ffffff" font-size="20"
													h-align="left" v-align="center" extendstyle="1111" border="false" />
									<label name="textTime" rect="120,30,300,30" text="2012-06-14 08:35:03" color="#ffffff"
													font-size="20" h-align="left" v-align="center" border="false" extendstyle="1111" />
									<label rect="25,55,150,30" text="处理意见：" color="#ffffff" font-size="20"
													h-align="left" v-align="center" extendstyle="1111" border="false" />
									<label name="textOpinion" rect="120,55,300,30" text="" color="#0"
													font-size="20" h-align="left" v-align="center" border="false" extendstyle="1111" />
									<label  rect="25,80,150,30" text="步骤状态：" color="#ffffff" font-size="20"
													h-align="left" v-align="center" extendstyle="1111" border="false" />
									<label name="stepStatus" rect="120,80,300,30" text="已完成" color="#ffffff"
													font-size="20" h-align="left" v-align="center"  border="false" extendstyle="1111"/>   
							</node>
					</button>
		  </node>
        </node>
    </body>
    <![CDATA[

require 'com_wondertek_dw_s3.common.framework'
local rootSprite
---------------------------------------回调函数--------------------------------
-- root子节点创建完事件
function bodyBuildChildrenFinished(sprite)
    rootSprite = sprite
end

-- root节点消息方法
function bodyOnSpriteEvent(msg, param)
    if msg == MSG_ACTIVATE then -- 页面激活
		--local list = Sprite:findChild(rootSprite, 'sampleList')
		--ListView:removeAllItems(list) --初始化时去除已经显示的list
	    local param = 'cmd=wlbdangerlist&page=1'  
		local url = getWholeUrl('nbspweb/webservice/accident!doWebservice.action', param)
        --Http:request('danger_process_data', url, 101, {useCache = false})		
		--Loading:show(rootSprite)
    elseif msg == MSG_DEACTIVATE then
    end
end

-- 插件消息方法
function bodyOnPluginEvent(msg)
    if Loading:isShow() then Loading:close() end
    if msg == 101 then
        local resp = Http:jsonDecode('danger_process_data')
        Log:write(resp.value)
        if (resp.code == nil or resp.code ~= '0') then
            Dialog:show('', getErrorCode(resp.code), 'ok')
			return
        elseif (getJsonArrayCount(resp.value) == 0 or resp.value=='') then
            Dialog:show('', '返回数据为空!', 'ok')
			return
        end
        -- 删除原来的列表
        local listView = Sprite:findChild(rootSprite, 'sampleList')
        ListView:removeAllItems(listView)
        local total = resp.total
        local respValue = resp.value
        Log:write('remote server responsed with value:',respValue)
        local len = getJsonArrayCount(respValue)
        -- 加载列表项
        ListView:loadItem(listView, Sprite:findChild(rootSprite, 'listitem'), len, 'loadListItem')
        ListView:adjust(listView)
        Loading:close()
    end
end

-- 按键响应处理
function mainNodeOnKeyUp(sprite, kc)
    if kc == Key.F2 then -- 按下返回键
        if Loading:isShow() == true then Loading:close() end
        Scene:back()
        return 1
    end
end

---------------------------------------util functions---------------------------
--加载车辆列表项 
function loadListItem(list, item, index)
    Sprite:setRect(item, 0,0,420,126)
    Sprite:setProperty(item, 'extendstyle', '1111')
	local imageCircle = Sprite:findChild(item, 'imageCircle')
	local imageBg = Sprite:findChild(item, 'imageBg')
    local textTitle = Sprite:findChild(item, 'textTitle')
	local textTime = Sprite:findChild(item, 'textTime')
	local textOpinion = Sprite:findChild(item, 'textOpinion')
	local stepStatus = Sprite:findChild(item, 'stepStatus')
   -- if index % 2 > 0 then
      --  Sprite:setProperty(listItemBg, 'color', '#e8e8e8')
    --else
       -- Sprite:setProperty(listItemBg, 'color', '#f2f2f2')
    --end
    -- 读取返回的数据(根据接口返回值)
    --local value = respValue[index]
    -- local titleValue = value.
    --local timeValue = value.
    --local opinionValue = value.
    --local statusValue = value.
	-- 根据状态返回值，设置圆圈与背景图片
	if statusValue == "未完成" then
	Sprite:setProperty(imageCircle,'src','file://image/unfinished_circle.png')
	Sprite:setProperty(imageBg,'src','file://image/unfinished_bg.png')
	end
    -- 显示到界面
    Sprite:setProperty(textTitle, 'text', titleValue)
    Sprite:setProperty(textTime, 'text', timeValue)
    Sprite:setProperty(textOpinion, 'text', opinionValue)
    Sprite:setProperty(stepStatus, 'text', statusValue)
end

--返回按钮消息处理函数
function doBack(sprite)
    if Loading:isShow() == true then Loading:close() end
    Scene:back()
end

    ]]>
</root>
