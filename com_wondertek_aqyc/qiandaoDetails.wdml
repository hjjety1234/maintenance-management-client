<?xml version="1.0" encoding="utf-8"?>
<!--
 == ============================================================================
 == | WonderTek [ 网络无处不在，沟通及时到达 ]
 == ============================================================================
 == | Copyright (c) 2012, WonderTek, Inc. All Rights Reserved.
 == ============================================================================
 == | Author: xxxx <xxxx@xxxx.com>
 == ============================================================================
 == | Desc: 页面描述
 == ============================================================================
-->
<root>
    <header/>
    <body resolution="480,800" BuildChildrenFinished="bodyBuildChildrenFinished" OnSpriteEvent="bodyOnSpriteEvent" OnPluginEvent="bodyOnPluginEvent">
        <node name="mainNode" rect="0,0,480,800" enable="true" active="true" OnKeyUp="mainNodeOnKeyUp" layouttype="1" extendstyle="1111">
            <shadow rect="0,0,480,800" color="#ffffff" alpha="255"
                extendstyle="1111" />
            <!-- 设置背景 -->
            <image rect="0,80,480,720" src="" style="autosize" extendstyle="1111" />
            <!-- 设置头部 -->
            <node name="baseSprite" rect="0,0,480,87" extendstyle="1111">
                <image name="title" rect="0,0,480,87" border="false" src="file://image/top-a.png" 
                    style="autosize" extendstyle="1111">
                    <label name="titleLabel" rect="0,0,480,80" text="签到详情" color="#ffffff" v-align="center"  
                       h-align="center" font-family="微软雅黑" font-size="30" extendstyle="1111" />
                </image>
                <!-- 返回 -->
                <button rect="20,18,84,51" OnSelect="doBack" normal="src:file://image/button-a.png;"
                    sel="src:file://image/button-b.png;" style="autosize" extendstyle="1111">
                </button>
            </node> 
            <node name="xuanze" rect="0,83,480,717" extendstyle="1111">
            ---------------------------------------选择区域----------------------------------------------------
            <node rect="0,0,480,80" extendstyle="1111" >
                <label name="quyu" rect="10,13,100,50" text="区      域"  v-align="center"  
                       h-align="center" font-family="微软雅黑" font-size="24" extendstyle="1111"  />
               <label name="quyuname" rect="100,13,300,50" text="安庆市" color="#6c6c6c"   v-align="center"  
                       h-align="center" font-family="微软雅黑" font-size="24" extendstyle="1111" />
                <!--间隔线-->
                <image name="jiange" rect="0,75,480,1" src="file://image/line.png"
                            style='autosize' extendstyle="1111"/>
            </node>
            <node rect="0,80,480,80"  extendstyle="1111" >
                <label name="wangdian" rect="10,13,110,50" text="月      份"  v-align="center"  
                       h-align="center" font-family="微软雅黑" font-size="24" extendstyle="1111" />
               
                <label name="wangdian1" rect="100,14,300,50" text="2013-5" color="#6c6c6c"  v-align="center"  
                       h-align="center" font-family="微软雅黑" font-size="24" extendstyle="1111" />
                <!--间隔线-->
                <image name="jiange" rect="0,75,480,1" src="file://image/line.png"
                            style='autosize' extendstyle="1111"/>
                </node>
            </node>
            <node rect="0,0,480,100"  extendstyle="1111">
            <image name="bg" rect="0,231,480,79" src="file://image/jicharenyuanqiandaotongjibiaoge1.png"
                            style='autosize' extendstyle="1111"/>
                <textarea rect="0,250,70,60" font-size="20" font-family="微软雅黑"
                    text="网店名称" extendstyle="1111" v-align="center"  h-align="center"/>
                <textarea  rect="70,250,80,60" font-size="20"  font-family="微软雅黑"
                    text="签到人" extendstyle="1111" v-align="center"  h-align="center" />
                <textarea  rect="150,250,110,60" font-size="20"  font-family="微软雅黑"
                    text="签到时间" extendstyle="1111" v-align="center"  h-align="center" />
                <textarea  rect="260,250,110,60" font-size="20"  font-family="微软雅黑"
                    text="签到位置" extendstyle="1111" v-align="center" h-align="center" />
                <textarea  rect="370,250,110,60" font-size="20"  font-family="微软雅黑"
                    text="二维码扫描结果" extendstyle="1111"  v-align="center" h-align="center" />
            </node>
            <node rect="0,80,480,750" extendstyle="1111">
               <listview name="sampleList" rect="0,0,480,750" border="false" limit="false"></listview>
            </node>
            <node rect="0,80,480,100"  name="listitem" visible="false" enable="false" extendstyle="1111">
                <image name="bg1" rect="0,230,480,79" src="file://image/jicharenyuanqiandaotongjibiaoge2.png" extendstyle="1111"/>
                <textarea name="shop" rect="0,250,70,50" font-size="20" font-family="微软雅黑"
                    text="网店名称" extendstyle="1111" v-align="center"  h-align="center"/>
                <textarea name="time" rect="150,250,110,50" font-size="20"  font-family="微软雅黑"
                    text="签到时间" extendstyle="1111" v-align="center"  h-align="center" />
                <textarea name="pepole" rect="70,250,80,50" font-size="20"  font-family="微软雅黑"
                    text="签到人" extendstyle="1111" v-align="center"  h-align="center" />
                <textarea name="location" rect="260,250,110,50" font-size="20"  font-family="微软雅黑"
                    text="签到位置" extendstyle="1111" v-align="center" h-align="center" />
                <textarea name="erweima" rect="370,250,110,50" font-size="20"  font-family="微软雅黑"
                    text="二维码扫描结果" extendstyle="1111"  v-align="center" h-align="center" />
            </node>
        </node>70,250,80,50
    </body>
    <![CDATA[

require 'com_wondertek_aqyc.common.framework'



local rootSprite
local server = Config:get('serverUrl')..':'..Config:get('port')
local wangdianidList 
local qiandaoData
local listview
local listItem
local time
local areaname
local tetype
---------------------------------------callbacks--------------------------------
-- @brief root子节点创建完事件
function bodyBuildChildrenFinished(sprite)
    rootSprite = sprite
    listview = Sprite:findChild(rootSprite, 'sampleList')
end

-- @brief root节点消息方法
function bodyOnSpriteEvent(msg, param)
    if msg == MSG_ACTIVATE then -- 页面激活
        local regHandle = Reg:create('chuanzhi')
        time = Reg:getString(regHandle,"date")
        tetype = Reg:getString(regHandle,"type") 
        areaname = Reg:getString(regHandle,'area')
        Reg:clear(Reg:create('chuanzhi'))
        local quyuname = Sprite:findChild(rootSprite,'quyuname')
        Sprite:setProperty(quyuname,'text',areaname)
        local wangdian1 = Sprite:findChild(rootSprite,'wangdian1')
        Sprite:setProperty(wangdian1,'text',time) 
        request()      
    elseif msg == MSG_DEACTIVATE then
    end
end

-- @brief 插件消息方法
function bodyOnPluginEvent(msg, param)
    if msg == 101  then 
        qiandaoData = Http:jsonDecode('qiandaoData')
        if qiandaoData then
            intListData()
        end
    elseif msg == 101 + MSG_CACHEDATA_RELOAD then -- 101请求的数据有更新
    elseif msg == MSG_NETWORK_ERROR then -- 拨号失败
        Log:write('拨号失败')
    elseif msg > MSG_NETWORK_ERROR then -- 请求超时
        Log:write('请求超时')
    end
end

-- @brief 按键响应处理
function mainNodeOnKeyUp(sprite, kc)
    if kc == Key.F2 then -- 按下返回键
        doBack()
    end
end

---------------------------------------util functions---------------------------
function doBack()
   if tetype == "kehujingli" then
      Scene:go(Alias.kehujingliqiandaotongji,true)
      return
   end
   if tetype == "jicha" then
      Scene:go(Alias.jiheqiandaotongji,true)
      return
   end
end
--进入区域列表
--请求地址
function request()
     local param = '&startDate='..time..'&area='..areaname..'&employeeId='..Config:get("employeeId")
     local Url = string.format(server..'/mobileSale/report/detail.htm?page=1&rows=10000')
     Http:request('qiandaoData', Url, 101, {useCache=false,method='post',postData=param})
end

function intListData()
    local s = tonumber(qiandaoData["Total"])
    Log:write("11111",s)
    ListView:loadItem(listview,Sprite:findChild(rootSprite, 'listitem'),s, 'loadListItem')
    ListView:adjust(listview)
end
 function loadListItem(list, item, index)
        Sprite:setRect(item, 0, 0, 480, 76)
        Sprite:setProperty(item, 'extendstyle', '1170')
        local shop = Sprite:findChild(item, 'shop')
        local time = Sprite:findChild(item, 'time')
        local pepole = Sprite:findChild(item, 'pepole')
        local location = Sprite:findChild(item, 'location')
        local erweima = Sprite:findChild(item, 'erweima')
        local value = qiandaoData['Rows'][index]
        if value["wangdian"] then
            Sprite:setProperty(shop, 'text', value["wangdian"])
        end
        if value["attence_day"] then
            Sprite:setProperty(time, 'text', value["attence_day"])
        end
        if value["employee_name"] then
            Sprite:setProperty(pepole, 'text', value["employee_name"])
        end
        if value["locat_detail"] then
            Sprite:setProperty(location, 'text', value["locat_detail"])
        end
        if value["barcode"] then
            Sprite:setProperty(erweima, 'text', value["barcode"])
        end
    end
    ]]>
</root>
