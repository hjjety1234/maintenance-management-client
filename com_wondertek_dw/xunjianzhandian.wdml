<?xml version="1.0" encoding="utf-8"?>
	<!--
		==
		============================================================================
		== | WonderTek [ 网络无处不在，沟通及时到达 ] ==
		============================================================================
		== | Copyright (c) 2012, WonderTek, Inc. All Rights Reserved. ==
		============================================================================
		== | Author: xxxx <xxxx@xxxx.com> ==
		============================================================================
		== | Desc: 页面描述 ==
		============================================================================
	-->
<root>
	<header />
	<body resolution="480,800" BuildChildrenFinished="bodyBuildChildrenFinished"
		OnSpriteEvent="bodyOnSpriteEvent" OnPluginEvent="bodyOnPluginEvent">
		<node name="mainNode" rect="0,0,480,800" enable="true" active="true"
			OnKeyUp="mainNodeOnKeyUp" layouttype="1" extendstyle="1111">

			<!-- 页面背景  -->
			<shadow rect="0,0,480,800" color="#e8e8e8" alpha="255"
				extendstyle="1111" />

			<!-- 巡检站点头部  -->
			<node name="headSprite" rect="0,0,480,66" extendstyle="1111">
				<image name="titleBg" rect="0,0,480,66" src="file://image/title_bg.png"
					extendstyle="1111" style="autosize" />
				<!-- 返回按钮 -->
				<button name="backBtn" rect="0,10,75,45" normal="normal" sel="sel"
					OnSelect="doBack" extendstyle="1111">
					<image name="normal" rect="0,0,75,45" src="file://image/title_back_n.png"
						style="autosize" extendstyle="1111">
					</image>
					<image name="sel" rect="0,0,75,45" src="file://image/title_back_s.png"
						style="autosize" extendstyle="1111">
					</image>
					<label rect="15,0,60,45" text="返回" color="#ffffff"
						extendstyle="1111" style="autosize" h-align="center" v-align="center"
						font-size="24"></label>
				</button>
				<!-- 页面标题  -->
				<scrolltext name="title" rect="0,0,480,66" text="巡检站点"
					extendstyle="1111" font-size="30" h-align="center" v-align="center"
					color="#ffffff" scroll="true" step="2"></scrolltext>
			</node>

			<!-- 站点列表  -->
			<node name="listviewNode" rect="0,66,480,654" extendstyle="1111">
				<listview name="listview1" rect="0,0,480,654" extendstyle="1111" />
			</node>

			<!-- 站点列表项 -->
			<node name="listitem" visible="false" enable="false" active="false"
				extendstyle="1011" rect="0,66,480,70">
				<shadow name="listItemBg" rect="0,0,480,70" color="#e8e8e8"
					alpha="255" extendstyle="1111" />
				<button name="btnname" rect="0,0,480,70" OnSelect="itemOnSelect"
					extendstyle="1111" data="">
					<image name="stationStatusImage" rect="10,20,30,30" src=""
						style="autosize" extendstyle="1100">
					</image>
					<label name="stationId" rect="40,20,10,30" text="" color="#0"
						font-size="16" h-align="left" v-align="center" extendstyle="1111"
						border="false" visible="false" />
					<label name="stationName" rect="50,10,300,50" text="" color="#0"
						font-size="30" h-align="left" v-align="center" extendstyle="1111"
						border="false" font-family="微软雅黑" />
					<label name="stationDistance" rect="390,10,80,50" text="923米"
						color="#0" font-size="30" h-align="left" v-align="center"
						extendstyle="1111" border="false" font-family="微软雅黑" />
				</button>
			</node>

			<!-- 页面底部，站点选择方式  -->
			<node name="footerNode" rect="0,720,480,80" extendstyle="1111">
				<image rect="0,0,480,80" src="file://image/bottom_bg.png"
					style="autosize" extendstyle="1111">
				</image>
				<button name="button1" rect="20,1,96,75" border="false" text=""
					color="#ffffff" OnSelect="bottomMenuSelect" extendstyle="1111"
					data="1">
					<image rect="0,0,96,75" src="file://image/ic_back_home.png"
						style="autosize" extendstyle="1111">
					</image>
				</button>
				<button name="button1" rect="136,1,96,75" border="false"
					text="" color="#ffffff" OnSelect="bottomMenuSelect" extendstyle="1111"
					data="2">
					<image rect="0,0,96,75" src="file://image/ic_location.png"
						style="autosize" extendstyle="1111">
					</image>
				</button>
				<button name="button1" rect="252,1,96,75" border="false"
					text="" color="#ffffff" OnSelect="bottomMenuSelect" extendstyle="1111"
					data="3">
					<image rect="0,0,96,75" src="file://image/ic_take_pic.png"
						style="autosize" extendstyle="1111">
					</image>
				</button>
				<button name="button1" rect="368,1,96,75" border="false"
					text="" color="#ffffff" OnSelect="bottomMenuSelect" extendstyle="1111"
					data="4">
					<image rect="0,0,96,75" src="file://image/search.png" style="autosize"
						extendstyle="1111">
					</image>
				</button>
			</node>

			<!-- GPS方式站点搜索对话框 -->
			<node name="gpsSearchDialog" rect="0,0,480,800" visible="false"
				enable="false" extendstyle="1111">
				<button rect="0,0,480,800" extendstyle="1111" OnSelect="hideGpsSearchDialog" />
				<!-- 对话框内容  -->
				<node rect="20,200,440,300" extendstyle="1111">
					<shadow rect="0,0,440,300" color="#f2f2f2" alpha="255"
						extendstyle="1111">
					</shadow>
					<node name="dlgTitle" rect="0,0,440,50" extendstyle="1111">
						<image rect="0,0,440,50" src="file://image/tab_s.png" style="autosize"
							extendstyle="1111">
							<label rect="10,0,440,50" text="站点范围搜索" font-family="微软雅黑"
								font-size="24" v-align="center"></label>
						</image>
					</node>
					<label rect="10,80,100,50" text="站点范围：" font-family="微软雅黑"
						font-size="24" v-align="center"></label>
					<edit name="radiusEdit" rect="110,80,230,50" text="1000"
						enable="true" border="true" font-family="微软雅黑" font-size="24"
						v-center="true" h-align="center" extendstyle="1111">
					</edit>
					<label rect="350,80,40,50" text="米" font-family="微软雅黑"
						font-size="24" v-align="center"></label>
					<button name="" rect="160,170,120,45" OnSelect="getNearbyStationByRadius"
						normal="normal" extendstyle="1111">
						<image name="normal" rect="0,0,120,45" src="file://image/button1_normal.png"
							style="autosize" extendstyle="1111">
						</image>
						<label rect="0,0,127,45" text="确定" font-family="微软雅黑"
							font-size="24" h-align="center" v-align="center"></label>
					</button>
				</node>
			</node>

			<!-- 模糊搜索对话框 -->
			<node name="fuzzyNameSearchDialog" rect="0,0,480,800" visible="false"
				enable="false" extendstyle="1111">
				<button rect="0,0,480,800" extendstyle="1111"
					OnSelect="hideFuzzyNameSearchDialog" />
				<!-- 对话框内容  -->
				<node rect="20,200,440,300" extendstyle="1111">
					<shadow rect="0,0,440,300" color="#f2f2f2" alpha="255"
						extendstyle="1111">
					</shadow>
					<node name="fuzzySearchdlgTitle" rect="0,0,440,50"
						extendstyle="1111">
						<image rect="0,0,440,50" src="file://image/tab_s.png" style="autosize"
							extendstyle="1111">
							<label rect="10,0,440,50" text="站点名称搜索" font-family="微软雅黑"
								font-size="24" v-align="center"></label>
						</image>
					</node>
					<label rect="10,80,100,50" text="站点名称：" font-family="微软雅黑"
						font-size="24" v-align="center"></label>
					<edit name="stationNameEdit" rect="110,80,230,50" text=""
						enable="true" border="true" font-family="微软雅黑" font-size="24"
						v-center="true" h-align="center" extendstyle="1111">
					</edit>
					<button name="" rect="160,170,120,45" OnSelect="doFuzzyNameSearch"
						normal="normal" extendstyle="1111">
						<image name="normal" rect="0,0,120,45" src="file://image/button1_normal.png"
							style="autosize" extendstyle="1111">
						</image>
						<label rect="0,0,127,45" text="确定" font-family="微软雅黑"
							font-size="24" h-align="center" v-align="center"></label>
					</button>
				</node>
			</node>
		</node>
	</body>
    <![CDATA[

    require 'com_wondertek_dw.common.framework'
    require 'framework.map'
    require 'framework.barcode'
    local rootSprite = nil
    local respValue = nil -- 站点列表值
    local planId = nil
    local templateId = nil
    local total = 0
    local page = 1
    local isSimulate = true
    ---------------------------------------回调函数列表--------------------------------
    -- root子节点创建完事件
    function bodyBuildChildrenFinished(sprite)
        rootSprite = sprite
        -- 获取巡检计划页面传来的计划ID和模板ID
        local regHandle = Reg:create('xunjianrenwu')
        planId = Reg:getString(regHandle, 'planId')
        templateId = Reg:getString(regHandle, 'templateId')
    end
    -- root节点消息方法
    function bodyOnSpriteEvent(msg, param)
        if msg == MSG_ACTIVATE then -- 页面激活
            getNearbyStationByDefaultRadius()
            elseif msg == MSG_DEACTIVATE then
        end
    end
    -- 插件消息方法
    function bodyOnPluginEvent(msg, param)
        if msg == 1001 then
            -- 请求默认范围内的基站列表
            -- 获取当前位置的经纬度
            local postData = Param:getString(param, 0)
            local latitude = postData.latitude
            local longitude = postData.longitude
            local posValue = string.format('%s,%s', longitude, latitude)
            Dialog:show('当前经纬度:', posValue, 'ok')
            Log:write('get current position by gps has successed, msg no. is 1001.')
            -- 请求附近的基站列表
            local defaultRadius = 100000
            local requestParam = string.format('cmd=wlbxunjianResSearch&planId=%s&condition=1&value=%s&radius=%s&page=%s',
            planId, posValue, defaultRadius, page)
            local requestURL = getWholeUrl('nbspweb/webservice/resource!doWebservice.action', requestParam)
            Http:request('stationList', requestURL, 1004)
       elseif msg == 1002 then
            -- 请求指定范围内的基站列表
            -- 获取当前位置的经纬度
            local postData = Param:getString(param, 0)
            local latitude = postData.latitude
            local longitude = postData.longitude
            local posValue = string.format('%s,%s', longitude, latitude)
            Dialog:show('当前经纬度:', posValue, 'ok')
            Log:write('get current position by gps has successed, msg no. is 1002.')
            -- 请求附近的基站列表
            local radius = Sprite:getText(Sprite:findChild(rootSprite, 'radiusEdit'))
            local requestParam = string.format('cmd=wlbxunjianResSearch&planId=%s&condition=1&value=%s&radius=%s&page=%s',
            planId, posValue, radius, page)
            local requestURL = getWholeUrl('nbspweb/webservice/resource!doWebservice.action', requestParam)
            Http:request('stationList', requestURL, 1004)
       elseif msg == 1003 then
            -- 二维码搜索
            local path = Param:getString(param, 0) -- 条码图片路径
            local code = Param:getString(param, 1) -- 解码后的文本
            Log:write('二维码解码后的文本为:'..code)
            local requestParam = string.format('cmd=wlbxunjianResSearch&planId=%s&condition=3&value=%s',
            planId, code)
            local requestURL = getWholeUrl('nbspweb/webservice/resource!doWebservice.action', requestParam)
            Http:request('stationList', requestURL, 1004)
       elseif msg == 1004 then
            -- 服务端返回结果解析
            -- 解析返回的列表
            local resp = Http:jsonDecode('stationList')
            Log:write(resp.value)
            if (resp.code == nil or resp.code ~= '0') then
                Dialog:show('', '服务端返回错误:'..getErrorCode(resp.code), 'ok')
                Loading:close()
                return
                elseif (getJsonArrayCount(resp.value) == 0 or resp.value=='') then
                Dialog:show('', '返回数据为空!', 'ok')
                Loading:close()
                return
            end
             -- 删除原来的列表
            local listView = Sprite:findChild(rootSprite, 'listview1')
            ListView:removeAllItems(listView)
            total = resp['total']
            respValue = resp.value
            Log:write('remote server responsed with value:',respValue)
            local len = getJsonArrayCount(respValue)
            -- 加载列表项
            ListView:loadItem(listView, Sprite:findChild(rootSprite, 'listitem'), len, 'loadListItem')
            ListView:adjust(listView)
            Loading:close()
            -- 隐藏所有的对话框
            hideGpsSearchDialog()
            hideFuzzyNameSearchDialog()
        end
    end
    -- 按键响应处理
    function mainNodeOnKeyUp(sprite, kc)
        if kc == Key.F2 then -- 按下返回键
            doBack()
            return 1
        end
    end
    -- 点击站点列表项处理函数
    function itemOnSelect(sprite)
        -- 获取当前选中站点的ID号
        local stationId = Sprite:findChild(rootSprite, "stationId")
        -- 设置要传递给巡检子项的参数
        local regHandle = Reg:create('xunjianzhixiang')
        Reg:clear(regHandle)
        Reg:setString(regHandle, 'planId', planId)
        Reg:setString(regHandle, 'templateId', templateId)
        Reg:setString(regHandle, 'stationId', Sprite:getText(stationId))
        -- 跳转到巡检子项
        Scene:setReturn(Alias.xunjianzhandian, Alias.xunjianEditEx)
        Scene:go(Alias.xunjianEditEx)
    end
    -- 底部菜单按钮响应分发
    function bottomMenuSelect(sprite)
        local dataInfo = Sprite:getData(sprite)
        if dataInfo == '1' then
            goHome()
            elseif dataInfo == '2' then
            showGpsSearchDialog()
            elseif dataInfo == '3' then
            startBarCodeScanner()
            elseif dataInfo == '4' then
            showFuzzyNameSearchDialog()
        end
    end
    ---------------------------------------界面操作函数列表---------------------------
    -- 跳转到上一个页面
    function doBack()
        if (Loading:isShow() == true) then
            Loading:close()
        end
        Scene:back()
    end
    -- 跳转到首页
    function goHome()
        if (Loading:isShow() == true) then
            Loading:close()
        end
        Scene:go(Alias.home)
    end
    -- 显示gps定位搜索对话框
    function showGpsSearchDialog()
        local searchDialog = Sprite:findChild(rootSprite, "gpsSearchDialog")
        Sprite:setVisible(searchDialog, 1)
        Sprite:setEnable(searchDialog, 1)
    end
    -- 隐藏gps定位搜索对话框
    function hideGpsSearchDialog()
        local searchDialog = Sprite:findChild(rootSprite, "gpsSearchDialog")
        Sprite:setVisible(searchDialog, 0)
        Sprite:setEnable(searchDialog, 0)
    end
    -- 显示模糊搜索对话框
    function showFuzzyNameSearchDialog()
        local searchDialog = Sprite:findChild(rootSprite, "fuzzyNameSearchDialog")
        Sprite:setVisible(searchDialog, 1)
        Sprite:setEnable(searchDialog, 1)
    end
    -- 隐藏模糊搜索对话框
    function hideFuzzyNameSearchDialog()
        local searchDialog = Sprite:findChild(rootSprite, "fuzzyNameSearchDialog")
        Sprite:setVisible(searchDialog, 0)
        Sprite:setEnable(searchDialog, 0)
    end
    -- 加载列表项
    function loadListItem(list, item, index)
        -- 设置列表项的大小的背景色
        Sprite:setRect(item, 0, 0, 480, 70)
        Sprite:setProperty(item, 'extendstyle', '1111')
        local listItemBg = Sprite:findChild(item, 'listItemBg')
        Sprite:setRect(listItemBg, 0, 0, 480, 70)
        if index % 2 > 0 then
            Sprite:setProperty(listItemBg, 'color', '#e8e8e8')
            else
            Sprite:setProperty(listItemBg, 'color', '#f2f2f2')
        end
        -- 取得对应列表项的数据
        local itemValue = respValue[index]
        if itemValue == nil then
            Log:write('列表项数据为空',index)
            return
        end
        local stationId = itemValue.stationId
        local stationNameText = itemValue.stationName
        local isPatroled = itemValue.isPatroled
        Log:write(string.format('station_id:%s, station_name=%s, is_patroled:%s', stationId, stationNameText, isPatroled))
        -- 设置列表项的值
        local stationStatusImage = Sprite:findChild(rootSprite, 'stationStatusImage')
        local stationIdSprite = Sprite:findChild(rootSprite, 'stationId')
        local stationName = Sprite:findChild(rootSprite, 'stationName')
        if isPatroled == 'Y' then
            Sprite:setProperty(stationStatusImage, "src", "file://image/s1.png")
            else
            Sprite:setProperty(stationStatusImage, "src", "")
        end
        Sprite:setProperty(stationIdSprite, "text", stationId)
        Sprite:setProperty(stationName, "text", '站点名称：'..stationNameText)
    end
    ---------------------------------------与服务端交互函数列表---------------------------
    -- 取得默认范围内的基站
    function getNearbyStationByDefaultRadius()
        if isSimulate == false then
            -- 真机环境下，调用GPS获取当前位置
            local observer = Plugin:getObserver()
            Map:getCurPosition(observer, 1001)
            else
            -- 模拟环境下，设置默认经纬度
            local posValue = '117.251339,31.849438'
            -- 请求默认附近10km的基站列表
            local defaultRadius = 100000
            local requestParam = string.format('cmd=wlbxunjianResSearch&planId=%s&condition=1&value=%s&radius=%s&page=%s',
            planId, posValue, defaultRadius, page)
            local requestURL = getWholeUrl('nbspweb/webservice/resource!doWebservice.action', requestParam)
            Http:request('stationList', requestURL, 1004)
        end
        Loading:show()
    end
    -- 请求指定范围内的基站
    function getNearbyStationByRadius(sprite)
        if isSimulate == false then
            local observer = Plugin:getObserver()
            Map:getCurPosition(observer, 1002)
            else
            -- 模拟环境下，设置默认经纬度
            local posValue = '117.251339,31.849438'
            -- 请求附近的基站列表
            local radius = Sprite:getText(Sprite:findChild(rootSprite, 'radiusEdit'))
            local requestParam = string.format('cmd=wlbxunjianResSearch&planId=%s&condition=1&value=%s&radius=%s&page=%s',
            planId, posValue, radius, page)
            local requestURL = getWholeUrl('nbspweb/webservice/resource!doWebservice.action', requestParam)
            Http:request('stationList', requestURL, 1004)
        end
        Loading:show()
    end
    -- 开始二维码扫描
    function startBarCodeScanner()
        if isSimulate == false then
            local observer = Plugin:getObserver()
            local ret1 = BarCode:setPreferences('front_light',
                 'true') -- 开启闪光灯
            local ret2 = BarCode:setPreferences('play_beep', 'true') -- 开启提示音
            local ret3 = BarCode:setPreferences('vibrate', 'true') -- 开启震动
            local ret = BarCode:startScanner(observer, 1003)
            else
            local code = '000001'
            local requestParam = string.format('cmd=wlbxunjianResSearch&planId=%s&condition=3&value=%s',
            planId, code)
            local requestURL = getWholeUrl('nbspweb/webservice/resource!doWebservice.action', requestParam)
            Http:request('stationList', requestURL, 1004)
        end
    end
    -- 根据站点名称进行搜索
    function doFuzzyNameSearch(sprite)
        local stationName = Sprite:getText(Sprite:findChild(rootSprite, 'stationNameEdit'))
        local requestParam = string.format('cmd=wlbxunjianResSearch&planId=%s&condition=2&value=%s&page=%s',
        planId, stationName, page)
        local requestURL = getWholeUrl('nbspweb/webservice/resource!doWebservice.action', requestParam)
        Http:request('stationList', requestURL, 1004)
    end
]]>
</root>
