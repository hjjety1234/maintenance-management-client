<?xml version="1.0" encoding="utf-8"?>
<!--
 == ============================================================================
 == | WonderTek [ 网络无处不在，沟通及时到达 ]
 == ============================================================================
 == | Copyright (c) 2012, WonderTek, Inc. All Rights Reserved.
 == ============================================================================
 == | Author: xxxx <xxxx@xxxx.com>
 == ============================================================================
 == | Desc: 页面描述
 == ============================================================================
-->
<root>
    <header/>
    <body resolution="480,800" BuildChildrenFinished="bodyBuildChildrenFinished" OnSpriteEvent="bodyOnSpriteEvent" OnPluginEvent="bodyOnPluginEvent">
        <node name="mainNode" rect="0,0,480,800" enable="true" active="true" OnKeyUp="mainNodeOnKeyUp" layouttype="1" extendstyle="1111">
            <!-- 设置背景 -->
            <image rect="0,0,0,0" src="file://image/backgroundImg.png" style="autosize" extendstyle="1177" />
            <!-- 设置头部 -->
            <node name="baseSprite" rect="0,0,480,66" extendstyle="1111">
                <image name="title" rect="0,0,480,66" border="false"
                    src="file://image/title_new.png" style="autosize" extendstyle="1111" />
                <label rect="0,0,480,66" text="故障工单" color="#ffffff" v-align="center"
                    h-align="center" font-family="微软雅黑" font-size="30" extendstyle="1111" />    
                <button name="backBtn" rect="0,0,66,66"  OnSelect="doBack" extendstyle="1111">
                    <image name="normal" rect="15,8,75,75" src="file://image/skin/ic_home_new.png" extendstyle="1111" />
                </button>
                <!-- 提交 -->
                <button name="submitBtn" rect="400,0,75,75" text="" color="#ffffff"
                    extendstyle="1111" OnSelect="submitOnSelect"
                    font-size="24" visible="false" enable="false">
                    <image name="titleBg1" rect="21,8,75,75" src="file://image/skin/ico_submit.png"
                    extendstyle="1111"  />
                </button>
            </node>
            <!-- 详情内容 -->
            <listview name="listview" rect="0,80,480,734" col="1" extendstyle="1111" limit="true" border="false">
                <list-item name="chuligz" rect="0,0,480,500" extendstyle="1111" limit="true"  visible="false">
                    <node name="dealstepNode" rect="0,10,480,150" extendstyle="1111" >
                        <label name="label1" rect="0,10,150,30" border="false" text="处理措施："
                            font-family='微软雅黑' h-align="center" v-align="center" color="#0062ab"
                            font-size="24" extendstyle="1111" />
                        <shadow rect="130,10,322,550" color="#ffffff" alpha="255"
                            border='true' extendstyle="1111" />
                        <edit name="dealstepContent" rect="135,15,312,540" font-size="24"
                            font-family='微软雅黑' text="" color="#303030" extendstyle="1111"
                            line-height='28' multiline="true" style="autosize" h-align="left"
                            v-align="top" />
                    </node>
                </list-item>  
            </listview>   
            <!-- 故障工单查询详情 -->
            <node  name='gzchuli' rect="0,70,292,52" border="false" text="" color="#ffffff"
                    extendstyle="1111" visible="false">
                <!-- 标题 -->
                <label rect="20,0,140,52" border="false" text="工单标题："
                    h-align="left" v-align="center" color="#0062ab" font-family="微软雅黑" font-size="22"
                     extendstyle="1111" />
                <textarea name="querytitle" rect="130,5,330,100" text="" 
                    font-family="微软雅黑" color="#303030" font-size="22" h-align="left" v-align="top" 
                    style="autosize" extendstyle="1111"   multiline="true"，line-height = '22'>
                </textarea>
                <!-- 告警级别 -->   
                <image rect="0,100,480,50" src="file://image/ziyuan_bg.png" style="autosize" extendstyle="1111" /> 
                <label rect="20,100,140,50" border="false" text="告警级别："
                    h-align="left" v-align="center" color="#0062ab" font-family="微软雅黑" font-size="22"
                    extendstyle="1111" />
                <scrolltext name="querylevel" rect="130,100,300,52" text="" 
                        font-family="微软雅黑" color="#303030" font-size="22" h-align="left" v-align="center" 
                        scroll="true" style="autosize" extendstyle="1111" >
                </scrolltext>
                <!-- 故障发生时间 --> 
                <label rect="20,150,140,50" border="false" text="故障时间："
                    h-align="left" v-align="center" color="#0062ab" font-family="微软雅黑" font-size="22"
                    extendstyle="1111" />
                <scrolltext name="querytime" rect="130,150,300,50" text="" 
                    font-family="微软雅黑" color="#303030" font-size="22" h-align="left" v-align="center" 
                    scroll="true" style="autosize" extendstyle="1111" >
                </scrolltext>  
                <!-- 处理时限 -->  
                <image rect="0,200,480,50" src="file://image/ziyuan_bg.png" style="autosize" extendstyle="1111" />      
                <label name="label1" rect="20,200,140,50" border="false" text="处理时限："
                    h-align="left" v-align="center" color="#0062ab" font-family="微软雅黑" font-size="22"
                    extendstyle="1111" />
                <scrolltext name="querylimit" rect="130,200,300,50" text="" 
                    font-family="微软雅黑" color="#303030" font-size="22" h-align="left" v-align="center" 
                    scroll="true" style="autosize" extendstyle="1111" >
                </scrolltext> 
                <!-- t2处理时限 -->        
                <label name="label1" rect="20,250,140,50" border="false" text="T2时限："
                    h-align="left" v-align="center" color="#0062ab" font-family="微软雅黑" font-size="22"
                    extendstyle="1111" />
                <scrolltext name="queryt2limit" rect="130,250,300,50" text="" 
                    font-family="微软雅黑" color="#303030" font-size="22" h-align="left" v-align="center" 
                    scroll="true" style="autosize" extendstyle="1111" >
                </scrolltext> 
            </node> 
            <!-- 工单状态按钮 --> 
            <button name="statusBtn" rect="160,650,160,50" text="" color="#ffffff"
                    extendstyle="1111" OnSelect="doStatus"
                    normal="src:file://image/btn_bg_n.png;style:sudoku-auto;sudoku:15,15,15,15;color:#ffffff"
                    sel="src:file://image/btn_bg_s.png;style:sudoku-auto;sudoku:15,15,15,15;color:#000000"
                    font-size="24"  visible="false" enable="false"/>
        </node>
    </body>
    <![CDATA[

require 'com_wondertek_dw.common.framework'
require 'framework.umsagent'
local rootSprite
local dangerListData = {}
local dangerSubmitData = {}
local curErrorBtn
local gzdata
local gzdata2
---------------------------------------callbacks--------------------------------
-- @brief root子节点创建完事件
function bodyBuildChildrenFinished(sprite)
    rootSprite = sprite
    Log:write("故障工单ID = ",dangerOrderId,taskcode,taskid)
    fillContent()
end

-- @brief root节点消息方法
function bodyOnSpriteEvent(msg, param)
    if msg == MSG_ACTIVATE then -- 页面激活
        UmsAgent:OnActivate(string.match(Alias.m_yinhuangongdanlist, 'MODULE:\\(.*)'), '故障工单列表首页')
        UmsAgent:OnDeactivate()
    elseif msg == MSG_DEACTIVATE then
    end
end

-- @brief 插件消息方法
function bodyOnPluginEvent(msg)
    if Loading:isShow() then Loading:close() end
    if msg == 101 then
        Loading:close()
        local data = Http:jsonDecode('dangerlist_data')
        Log:write('故障工单状态：',data)
        if data.code == '0' then 
            Scene:back()
        else 
            Dialog:show('','提交失败，服务端数据错误','ok')
        end
    elseif msg == 102 then
        gzdata = Http:jsonDecode('dangerlist_data1')
        Log:write("故障数据",gzdata)
        if  gzdata.code == '0' then 
            fillgzData()
        else 
            Dialog:show('','服务端数据错误','ok')
        end
    elseif msg == 103 then 
        gzdata2 = Http:jsonDecode('dangerlist_data2')
        Log:write("故障数据提交",gzdata2.value)
        if  gzdata2.code == '0' then 
            Scene:back()
        else 
            Dialog:show('','提交失败，服务端数据错误','ok')
        end
    elseif msg == 101 + MSG_CACHEDATA_RELOAD then -- 101请求的数据有更新
    elseif msg == MSG_NETWORK_ERROR then -- 拨号失败
        Log:write('拨号失败')
    elseif msg > MSG_NETWORK_ERROR then -- 请求超时
        Log:write('请求超时')
    end
end

-- @brief 按键响应处理
function mainNodeOnKeyUp(sprite, kc)
    if kc == Key.F2 then -- 按下返回键
        Scene:back()
        return 1
    end
end

---------------------------------------util functions---------------------------
-- 返回按钮
function doBack()
    Scene:setReturn(Alias.m_yinhuangongdanlist, Alias.m_daibangongdan)
    Scene:go(Alias.m_daibangongdan,true)
end

-- 提交隐患处理信息  
function submitOnSelect(sprites)  
    local dealResultText = Sprite:getProperty(Sprite:findChild(Sprite:findChild(rootSprite, 'dealResult'), 'dealResultContent'), 'text')
    local dealOpinionText = Sprite:getProperty(Sprite:findChild(Sprite:findChild(rootSprite, 'dealOpinionNode'), 'dealOpinionContent'), 'text')   
    local dealmanContent = Sprite:getProperty(Sprite:findChild(Sprite:findChild(rootSprite, 'dealmanNode'), 'dealmanContent'), 'text')
    local dealstepContent = Sprite:getProperty(Sprite:findChild(Sprite:findChild(rootSprite, 'dealstepNode'), 'dealstepContent'), 'text')
    local dealResultCodeText = Sprite:getProperty(Sprite:findChild(Sprite:findChild(rootSprite, 'dealResult'), 'dealResultCode'), 'text')
    
    if dealstepContent and dealstepContent == '' then
        Dialog:show('提示', '对不起，处理措施为空！', 'ok')
        return
    else
        Dialog:show('提示','是否确定提交此故障工单？','ok_cancel','doUpload')
    end
end
function doUpload()
    Loading:show()
    local dealstepContent = Sprite:getProperty(Sprite:findChild(Sprite:findChild(rootSprite, 'dealstepNode'), 'dealstepContent'), 'text')
    Log:write('+++++',dealstepContent)
    local param = 'cmd=wlbfaultreply&page=1&id='..taskcode..'&processmeasure='..dealstepContent..'&taskid='..taskid
    local url= getWholeUrl('nbspweb/webservice/wlbfault!doWebservice.action',param)
    Log:write('提交故障工单接口URL为：', url)
    Http:request('dangerlist_data', url, 101, {useCache = false, method = 'post', postData=''})
end
function fillContent()
    local param = 'cmd=wlbfaultinquiry&id='..taskcode..'&page=1'
    local url= getWholeUrl('nbspweb/webservice/wlbfault!doWebservice.action',param)
    Log:write('===新故障工单列表======', url)
    Http:request('dangerlist_data1', url, 102, {useCache = false, method = 'post', postData=''})
end
function  fillgzData()
    local querytitle = Sprite:findChild(rootSprite,"querytitle")
    local querylevel = Sprite:findChild(rootSprite,"querylevel")
    local querytime = Sprite:findChild(rootSprite,"querytime")
    local querylimit = Sprite:findChild(rootSprite,"querylimit")
    local queryt2limit = Sprite:findChild(rootSprite,"queryt2limit")
    local statusBtn=Sprite:findChild(rootSprite,"statusBtn")
    local submitBtn =Sprite:findChild(rootSprite,"submitBtn")
    local chuligz=Sprite:findChild(rootSprite,"chuligz")
    local gzchuli=Sprite:findChild(rootSprite,"gzchuli")
    local pic =Sprite:findChild(rootSprite,"pic")
    if gzdata.value[0].title ~='' then
        Sprite:setProperty(querytitle,"text",gzdata.value[0].title)
    end
    if gzdata.value[0].level~='' then
        Sprite:setProperty(querylevel,"text",gzdata.value[0].level)
    end
    if gzdata.value[0].time ~='' then
        Sprite:setProperty(querytime,"text",gzdata.value[0].time)
    end
    if gzdata.value[0].limit ~='' then
        Sprite:setProperty(querylimit,"text",gzdata.value[0].limit)
    end
    if gzdata.value[0].t2limit ~='' then
        Sprite:setProperty(queryt2limit,"text",gzdata.value[0].t2limit)
    end
    if gzdata.value[0].status =='01' then
      Sprite:setProperty(statusBtn,"text","到达现场")
      Sprite:setVisible(submitBtn, 0)
      Sprite:setEnable(submitBtn, 0)
      Sprite:setVisible(statusBtn, 1)
      Sprite:setEnable(statusBtn, 1)  
      Sprite:setVisible(gzchuli, 1) 
      Sprite:setVisible(chuligz, 0) 
      Sprite:setVisible(pic, 1)
   elseif gzdata.value[0].status =='' then
      Sprite:setProperty(statusBtn,"text","签收")
      Sprite:setVisible(submitBtn, 0)
      Sprite:setEnable(submitBtn, 0)
       Sprite:setVisible(statusBtn, 1)
      Sprite:setEnable(statusBtn, 1)  
      Sprite:setVisible(gzchuli, 1) 
      Sprite:setVisible(chuligz, 0) 
      Sprite:setVisible(pic, 1)
   elseif  gzdata.value[0].status =='00' then
      Sprite:setProperty(statusBtn,"text","正在途中")
      Sprite:setVisible(submitBtn, 0)
      Sprite:setEnable(submitBtn, 0)
       Sprite:setVisible(statusBtn, 1)
      Sprite:setEnable(statusBtn, 1)  
      Sprite:setVisible(gzchuli, 1) 
      Sprite:setVisible(chuligz, 0) 
      Sprite:setVisible(pic, 1)
   elseif gzdata.value[0].status =='02' then
      Sprite:setProperty(statusBtn,"text","处理结束")
      Sprite:setVisible(submitBtn, 0)
      Sprite:setEnable(submitBtn, 0)
       Sprite:setVisible(statusBtn, 1)
      Sprite:setEnable(statusBtn, 1)  
      Sprite:setVisible(gzchuli, 1) 
      Sprite:setVisible(chuligz, 0) 
      Sprite:setVisible(pic, 1)
   elseif gzdata.value[0].status =='05' then
     --Sprite:setProperty(gzjibie,"text","故障消除")
      Sprite:setVisible(submitBtn, 1)
      Sprite:setEnable(submitBtn, 1)
      Sprite:setVisible(statusBtn, 0)
      Sprite:setEnable(statusBtn, 0)  
      Sprite:setVisible(gzchuli, 0) 
      Sprite:setVisible(chuligz, 1) 
      Sprite:setVisible(pic, 0)
   end
end
function doStatus()
    local gg
    if gzdata.value[0].status==''then
       gg= '00'
    elseif gzdata.value[0].status=='00'then
       gg= '01'
    elseif gzdata.value[0].status=='01' then
          gg= '02'
    elseif gzdata.value[0].status=='02' then
        gg= '05'
    end
    local param = 'cmd=wlbtroubleprocessevent&userid='..Config:get("username")..'&orderid='..taskcode..'&eventtime='..'&eventid='..gg..'&lon=11&lat=11&ordertypeid=002'
    local url= getWholeUrl('nbspweb/webservice/trouble!doWebservice.action',param)
    Log:write('===新故障工单列表提交按钮响应======', url)
    Http:request('dangerlist_data2', url, 103, {useCache = false, method = 'post', postData=''})
end
    ]]>
</root>
