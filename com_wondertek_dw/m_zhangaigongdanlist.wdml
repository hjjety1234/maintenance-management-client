<?xml version="1.0" encoding="utf-8"?>
<!--
 == ============================================================================
 == | WonderTek [ 网络无处不在，沟通及时到达 ]
 == ============================================================================
 == | Copyright (c) 2012, WonderTek, Inc. All Rights Reserved.
 == ============================================================================
 == | Author: xxxx <xxxx@xxxx.com>
 == ============================================================================
 == | Desc: 页面描述
 == ============================================================================
-->
<root>
    <header/>
    <body resolution="480,800" BuildChildrenFinished="bodyBuildChildrenFinished" OnSpriteEvent="bodyOnSpriteEvent" OnPluginEvent="bodyOnPluginEvent">
        <node name="mainNode" rect="0,0,480,800" enable="true" active="true" OnKeyUp="mainNodeOnKeyUp" layouttype="1" extendstyle="1111">
            <!-- 设置背景 -->
            <image rect="0,0,0,0" src="file://image/backgroundImg.png" style="autosize" extendstyle="1177" />
            <!-- 设置头部 -->
            <node name="baseSprite" rect="0,0,480,66" extendstyle="1111">
                <image name="title" rect="0,0,480,66" border="false"
                    src="file://image/title_new.png" style="autosize" extendstyle="1111" />
                <label rect="0,0,480,66" text="故障工单" color="#ffffff" v-align="center"
                    h-align="center" font-family="微软雅黑" font-size="30" extendstyle="1111" />    
                <button name="backBtn" rect="0,0,66,66"  OnSelect="doBack" extendstyle="1111">
                    <image name="normal" rect="15,8,75,75" src="file://image/skin/title_back_new.png" extendstyle="1111" />
                </button>
                <!-- 提交 -->
                <button name="submitBtn" rect="400,0,75,75" text="" color="#ffffff"
                    extendstyle="1111" OnSelect="submitOnSelect"
                    font-size="24" visible="false" enable="false">
                    <image name="titleBg1" rect="21,8,75,75" src="file://image/skin/ico_submit.png"
                    extendstyle="1111"  />
                </button>
            </node>
            <!-- 详情内容 -->
            <listview name="listview" rect="0,80,480,734" col="1" extendstyle="1111" limit="true" border="false">
                <list-item name="chuligz" rect="0,0,480,500" extendstyle="1111" limit="true"  visible="false">
                     <node name="baseSprite" rect="0,0,480,60" extendstyle="1111">
                        <label name="label1" rect="0,5,140,50" border="false" text="处理结果："
                            h-align="right" v-align="center" color="#303030" font-size="24"
                            extendstyle="1111" />
                        <button name="typeBtn" rect="140,5,290,50" border="false" text="" color="#ffffff" 
                            OnSelect="typeOnSelect" extendstyle="1111">
                            <image rect="0,5,290,40" src="file://image/select_bg.png"  style="sudoku-auto" 
                                    sudoku="15,15,15,15" extendstyle="1111">                  
                            </image>
                            <scrolltext name="name" rect="5,5,280,35" text="" color="#303030" extendstyle="1111"
                                style="autosize" scroll="true" h-align="left" v-align="center" font-size="24" >
                            </scrolltext>
                        </button>
                    </node>
                    
                    <node name="baseSprite" rect="0,60,480,60" extendstyle="1111">
                        <label name="label1" rect="0,5,140,50" border="false" text="故障原因："
                            h-align="right" v-align="center" color="#303030" font-size="24"
                            extendstyle="1111" />
                        <button name="levelBtn" rect="140,5,290,50" border="false"
                            text="" color="#ffffff" OnSelect="levelOnSelect" extendstyle="1111">
                            <image rect="0,5,290,40" src="file://image/select_bg.png"  style="sudoku-auto" 
                                    sudoku="15,15,15,15" extendstyle="1111">                  
                            </image>
                            <scrolltext name="name" rect="5,5,280,35" text="" color="#303030" extendstyle="1111"
                                style="autosize" scroll="true" h-align="left" v-align="center" font-size="24">
                            </scrolltext>
                        </button>
                    </node> 

                    <node name="baseSprite" rect="0,120,480,60" extendstyle="1111">
                        <label name="label1" rect="0,5,140,50" border="false" text="原因细分："
                            h-align="right" v-align="center" color="#303030" font-size="24"
                            extendstyle="1111" />
                        <button name="reasonBtn" rect="140,5,290,50" border="false"
                            text="" color="#ffffff" OnSelect="reasonOnSelect" extendstyle="1111">
                            <image rect="0,5,290,40" src="file://image/select_bg.png"  style="sudoku-auto" 
                                    sudoku="15,15,15,15" extendstyle="1111">                  
                            </image>
                            <scrolltext name="name" rect="5,5,280,35" text="" color="#303030" extendstyle="1111"
                                style="autosize" scroll="true" h-align="left" v-align="center" font-size="24">
                            </scrolltext>
                        </button>
                    </node>  

                    <node name="baseSprite" rect="0,180,480,60" extendstyle="1111">
                        <label name="label1" rect="0,5,140,50" border="false" text="消除时间："
                            h-align="right" v-align="center" color="#303030" font-size="24"
                            extendstyle="1111" />
                        <button  rect="140,5,290,50" border="false" OnSelect=""  extendstyle="1111">
                            <image rect="0,5,290,40" src="file://image/input_text.png"  style="sudoku-auto" 
                                    sudoku="15,15,15,15" extendstyle="1111">                  
                            </image>
                            <edit name="timeEdit" rect="5,5,350,35" text="" color="#303030" extendstyle="1111"
                                style="autosize" scroll="true" h-align="left" v-align="center" font-size="24">
                            </edit>
                        </button>
                    </node> 
                    <node name="dealstepNode" rect="0,240,480,150" extendstyle="1111" >
                        <label name="label1" rect="0,5,140,50" border="false" text="处理措施："
                            h-align="right" v-align="center" color="#303030" font-size="24"
                            extendstyle="1111" />
                        <button name="label1" rect="440,5,40,40" border="false" text=""
                            h-align="right" v-align="center"  color="#303030" OnSelect="voiceOnSelect" font-size="24"
                            extendstyle="1111" >
                            <image rect="5,8,25,45" src="file://image/voice.png"  tyle="sudoku-auto" 
                                    sudoku="15,15,15,15" extendstyle="1111">                  
                            </image>
                        </button>
                        <image rect="140,10,290,550" color="#ffffff" src="file://image/input_text.png"  style="sudoku-auto" 
                                    sudoku="15,15,15,15" border='true' extendstyle="1111" />
                        <edit name="dealstepContent" rect="145,15,280,500" font-size="24"
                            font-family='微软雅黑' text="" color="#303030" extendstyle="1111"
                            line-height='28' multiline="true" style="autosize" h-align="left"
                            v-align="top" />
                    </node>
                    <!-- 下拉框  -->
                    <node name="xunjianSelectNode" rect="0,0,480,800" mushroom="false" visible="false" enable="false">
                        <button name="button" rect="0,0,480,800" OnSelect="hideXunjianSelected">
                        </button>
                        <node rect="66,200,368,68" extendstyle="1111"  border="false">
                            <image rect="0,0,368,68" src="file://image/top.png"  style="autosize" extendstyle="0010" />
                            <image rect="20,30,22,22" src="file://image/icon_arrow.png" style="autosize" extendstyle="0010" />
                            <label rect="42,7,120,68" border="false" color="#FFFFFF" style="autosize"
                             text="选择类型" h-align="center" v-align="center" font-family="微软雅黑" font-size="24"></label>
                        </node>
                        <image rect="66,264,368,216" src="file://image/center.png"  style="autosize" extendstyle="1111" />
                        <listview name="listSelect" rect="66,268,368,216" auto-scroll="true" style="autosize"
                            auto-adjust="true" extendstyle="1111" />
                        <image rect="66,478,368,21" src="file://image/bottom.png"  style="autosize" extendstyle="1111"/>
                    </node>
                    <node name="selectItem" rect="0,0,368,72" visible="false" enable="false" active="false">                   
                          <button rect="12,0,342,61" text="" color="#303030" h-align="left" v-align="center" font-family="微软雅黑" font-size="24" style="autosize" 
                                extendstyle="0010" OnSelect="xunjianGroupOnSelect"
                                normal=""
                                sel=""
                                data="C30"  >
                                <image rect="285,15,32,32" src="file://image/list_arrow.png"  style="autosize" extendstyle="1111" />           
                                <image rect="12,70,320,2" src="file://image/line.png"  style="autosize" extendstyle="0010" />
                          </button>
                    </node>
                </list-item>  
            </listview>   
            <!-- 故障工单查询详情 -->
            <node  name='gzchuli' rect="0,70,292,52" extendstyle="1111" border="false" text="" color="#ffffff"
                visible="false">
                <listview rect="0,0,480,730" extendstyle="1111" limit="true" border="false">
                    <list-item rect="0,0,480,105" extendstyle="1111">
                        <!-- 标题 -->
                        <label rect="20,0,140,52" border="false" text="工单标题："
                            h-align="left" v-align="center" color="#0062ab" font-family="微软雅黑" font-size="22"
                            extendstyle="1111" />
                        <textarea name="querytitle" rect="130,5,330,100" text="" 
                            font-family="微软雅黑" color="#303030" font-size="22" h-align="left" v-align="top" 
                            style="autosize" extendstyle="1111"   multiline="true"，line-height = '22'>
                        </textarea>
                    </list-item>
                    <list-item rect="0,0,480,55" extendstyle="1111">
                        <!-- 告警级别 -->   
                        <image rect="0,0,480,50" src="file://image/ziyuan_bg.png" style="autosize" extendstyle="1111" /> 
                        <label rect="20,0,140,50" border="false" text="告警级别："
                            h-align="left" v-align="center" color="#0062ab" font-family="微软雅黑" font-size="22"
                            extendstyle="1111" />
                            <scrolltext name="querylevel" rect="130,0,300,52" text="" 
                                font-family="微软雅黑" color="#303030" font-size="22" h-align="left" v-align="center" 
                                scroll="true" style="autosize" extendstyle="1111" >
                             </scrolltext>
                    </list-item>
                    <list-item rect="0,0,480,55" extendstyle="1111">
                        <!-- 告警描述 --> 
                        <label rect="20,0,140,50" border="false" text="告警描述："
                            h-align="left" v-align="center" color="#0062ab" font-family="微软雅黑" font-size="22"
                            extendstyle="1111" />
                            <scrolltext name="description" rect="130,0,300,52" text="" 
                                font-family="微软雅黑" color="#303030" font-size="22" h-align="left" v-align="center" 
                                scroll="true" style="autosize" extendstyle="1111" >
                             </scrolltext>
                    </list-item>
                    <list-item rect="0,0,480,50" extendstyle="1111">
                        <!-- 故障发生时间 --> 
                        <image rect="0,0,480,50" src="file://image/ziyuan_bg.png" style="autosize" extendstyle="1111" />
                        <label rect="20,0,140,50" border="false" text="故障时间："
                            h-align="left" v-align="center" color="#0062ab" font-family="微软雅黑" font-size="22"
                            extendstyle="1111" />
                        <scrolltext name="querytime" rect="130,0,300,50" text="" 
                            font-family="微软雅黑" color="#303030" font-size="22" h-align="left" v-align="center" 
                            scroll="true" style="autosize" extendstyle="1111" >
                        </scrolltext>  
                    </list-item>
                    <list-item rect="0,0,480,50" extendstyle="1111">
                        <!-- 处理时限 -->    
                        <label name="label1" rect="20,0,140,50" border="false" text="处理时限："
                            h-align="left" v-align="center" color="#0062ab" font-family="微软雅黑" font-size="22"
                            extendstyle="1111" />
                        <scrolltext name="querylimit" rect="130,0,300,50" text="" 
                            font-family="微软雅黑" color="#303030" font-size="22" h-align="left" v-align="center" 
                            scroll="true" style="autosize" extendstyle="1111" >
                        </scrolltext>  
                    </list-item>
                    <list-item rect="0,0,480,50" extendstyle="1111">
                        <!-- t2处理时限 -->
                        <image rect="0,0,480,50" src="file://image/ziyuan_bg.png" style="autosize" extendstyle="1111" />    
                        <label name="label1" rect="20,0,140,50" border="false" text="T2时限："
                            h-align="left" v-align="center" color="#0062ab" font-family="微软雅黑" font-size="22"
                            extendstyle="1111" />
                        <scrolltext name="queryt2limit" rect="130,0,300,50" text="" 
                            font-family="微软雅黑" color="#303030" font-size="22" h-align="left" v-align="center" 
                            scroll="true" style="autosize" extendstyle="1111" >
                        </scrolltext> 
                    </list-item>
                    <list-item rect="0,0,480,50" extendstyle="1111">
                        <!-- EMOS 编号 -->
                        <label name="label1" rect="20,0,140,50" border="false" text="EMOS："
                            h-align="left" v-align="center" color="#0062ab" font-family="微软雅黑" font-size="22"
                            extendstyle="1111" />
                        <scrolltext name="eomsid" rect="130,0,300,50" text="" 
                            font-family="微软雅黑" color="#303030" font-size="22" h-align="left" v-align="center" 
                            scroll="true" style="autosize" extendstyle="1111" >
                        </scrolltext> 
                    </list-item>
                    <list-item rect="0,0,480,50" extendstyle="1111">
                        <!-- 网元名称 -->
                        <image rect="0,0,480,50" src="file://image/ziyuan_bg.png" style="autosize" extendstyle="1111" />    
                        <label name="label1" rect="20,0,140,50" border="false" text="网元名称："
                            h-align="left" v-align="center" color="#0062ab" font-family="微软雅黑" font-size="22"
                            extendstyle="1111" />
                        <scrolltext name="networkname" rect="130,0,340,50" text="" 
                            font-family="微软雅黑" color="#303030" font-size="22" h-align="left" v-align="center" 
                            scroll="true" style="autosize" extendstyle="1111" >
                        </scrolltext> 
                    </list-item>
                    <list-item rect="0,0,480,50" extendstyle="1111">
                        <!-- 设备厂商 -->
                        <label name="label1" rect="20,0,140,50" border="false" text="设备厂商："
                            h-align="left" v-align="center" color="#0062ab" font-family="微软雅黑" font-size="22"
                            extendstyle="1111" />
                        <scrolltext name="equipment" rect="130,0,300,50" text="" 
                            font-family="微软雅黑" color="#303030" font-size="22" h-align="left" v-align="center" 
                            scroll="true" style="autosize" extendstyle="1111" >
                        </scrolltext> 
                    </list-item>
                </listview>         
            </node> 
            <!-- 工单状态按钮 --> 
            <button name="statusBtn" rect="160,650,160,50" text="" color="#ffffff"
                    extendstyle="1111" OnSelect="doStatus"
                    normal="src:file://image/btn_bg_n.png;style:sudoku-auto;sudoku:15,15,15,15;color:#ffffff"
                    sel="src:file://image/btn_bg_s.png;style:sudoku-auto;sudoku:15,15,15,15;color:#000000"
                    font-size="24"  visible="false" enable="false"/>
            <!-- 跳过现场处理 -->
            <button name="nextBtn" rect="160,720,160,50" text="跳过现场处理" color="#ffffff"
                    extendstyle="1111" OnSelect="doNext"
                    normal="src:file://image/btn_bg_n.png;style:sudoku-auto;sudoku:15,15,15,15;color:#ffffff"
                    sel="src:file://image/btn_bg_s.png;style:sudoku-auto;sudoku:15,15,15,15;color:#000000"
                    font-size="24"  visible="false" enable="false"/>
        </node>
    </body>
    <![CDATA[

require 'com_wondertek_dw.common.framework'
require 'framework.umsagent'
require('framework.voiceinput')

local rootSprite
local dangerListData = {}
local dangerSubmitData = {}
local curErrorBtn
local gzdata
local gzdata2
local currentMonthString   --故障消除时间
local dangerOrderId
local taskcode
local taskid
---------------------------------------callbacks--------------------------------
-- @brief root子节点创建完事件
function bodyBuildChildrenFinished(sprite)
    rootSprite = sprite
    dangerOrderId = Config:get('zhangai_dangerOrderId')
    taskcode = Config:get('zhangai_taskcode')
    taskid = Config:get('zhangai_taskid')
    Log:write("故障工单ID = ",dangerOrderId,taskcode,taskid)
end

-- @brief root节点消息方法
function bodyOnSpriteEvent(msg, param)
    if msg == MSG_ACTIVATE then -- 页面激活
        fillContent()
        -- local regHandle = Reg:create("dateTime")
        -- local retuenTime = Reg:getString(regHandle, "time")
        -- if retuenTime ~= '' and retuenTime ~= nil then 
        --     local timeNode = Sprite:findChild(rootSprite,'timeEdit')
        --     Sprite:setProperty(timeNode,'text',retuenTime)
        -- end 
    elseif msg == MSG_DEACTIVATE then
    end
end
function backPre()
    Scene:back()
end
-- @brief 插件消息方法
function bodyOnPluginEvent(msg, param)
    if Loading:isShow() then Loading:close() end
    if msg == 101 then
        Loading:close()
        local data = Http:jsonDecode('dangerlist_data')
        Log:write('故障工单状态：',data)
        if data.code == '0' then 
            Dialog:show('','已提交成功','ok','backPre')
        else 
            Dialog:show('','提交失败，服务端数据错误','ok')
        end
    elseif msg == 102 then
        gzdata = Http:jsonDecode('dangerlist_data1')
        Log:write("故障数据",gzdata)
        --如果没有故障消除时间，则获取系统时间
        if gzdata.value[0].faultdealtime == '' or gzdata.value[0].faultdealtime==nil then 
           filltime()
        else
           filltime()
           -- local timeNode = Sprite:findChild(rootSprite,'timeEdit')
           -- Sprite:setProperty(timeNode,'text',gzdata.value[0].faultdealtime)
        end 
        if  gzdata.code == '0' then 
            fillgzData()
        else 
            Dialog:show('','服务端数据错误','ok')
        end
    elseif msg == 103 then 
        gzdata2 = Http:jsonDecode('dangerlist_data2')
        Log:write("故障数据提交",gzdata2.value)
        if  gzdata2.code == '0' then 
            Scene:back()
        else 
            Dialog:show('','提交失败，服务端数据错误','ok')
        end
    elseif msg == 104 then
        if Loading:isShow() then Loading:close() end
        local list = Sprite:findChild(rootSprite, 'listSelect')
        local item = Sprite:findChild(rootSprite, 'selectItem')
        ListView:removeAllItems(list, 1, 1)
        selectData = Http:jsonDecode('select')
        Log:write("data:", selectData)
        Log:write("selectData.code = "..selectData.code)
        if selectData.code == "0" then
            fillSelect()
        end
    elseif msg == MSG_VOICEINPUT then --语音返回消息 
        local toText = VoiceInput:getInputText()
        local voiceData = Json:loadString2Table(toText)
        Log:write('voiceData is ',voiceData)
        --语音赋值
        local dealstep = Sprite:findChild(rootSprite, 'dealstepContent')
        Sprite:setProperty(dealstep,'text',voiceData.RecognizedText)

    elseif msg == 101 + MSG_CACHEDATA_RELOAD then -- 101请求的数据有更新
    elseif msg == MSG_NETWORK_ERROR then -- 拨号失败
        Log:write('拨号失败')
    elseif msg > MSG_NETWORK_ERROR then -- 请求超时
        Log:write('请求超时')
    end
end

-- @brief 按键响应处理
function mainNodeOnKeyUp(sprite, kc)
    if kc == Key.F2 then -- 按下返回键
        Scene:back()
        return 1
    end
end

---------------------------------------util functions---------------------------
-- 返回按钮
function doBack()
    Scene:back()
end

-- 提交隐患处理信息  
function submitOnSelect(sprites)  
    local dealResultText = Sprite:getProperty(Sprite:findChild(Sprite:findChild(rootSprite, 'dealResult'), 'dealResultContent'), 'text')
    local dealOpinionText = Sprite:getProperty(Sprite:findChild(Sprite:findChild(rootSprite, 'dealOpinionNode'), 'dealOpinionContent'), 'text')   
    local dealmanContent = Sprite:getProperty(Sprite:findChild(Sprite:findChild(rootSprite, 'dealmanNode'), 'dealmanContent'), 'text')
    local dealstepContent = Sprite:getProperty(Sprite:findChild(Sprite:findChild(rootSprite, 'dealstepNode'), 'dealstepContent'), 'text')
    local dealResultCodeText = Sprite:getProperty(Sprite:findChild(Sprite:findChild(rootSprite, 'dealResult'), 'dealResultCode'), 'text')

    local typeBtn = Sprite:findChild(rootSprite,'typeBtn')
    local levelBtn = Sprite:findChild(rootSprite,'levelBtn')
    local reasonBtn = Sprite:findChild(rootSprite,'reasonBtn')
    local typename = Sprite:getText(Sprite:findChildByClass(typeBtn,'scrolltext'))
    local levelname = Sprite:getText(Sprite:findChildByClass(levelBtn,'scrolltext'))
    local resonname = Sprite:getText(Sprite:findChildByClass(reasonBtn,'scrolltext'))
    Log:write('##typename',typename)

    if typename and typename == '' then
        Dialog:show('提示','对不起，请先选择处理结果！','ok')
        return
    end
    if levelname and levelname == '' then
        Dialog:show('提示','对不起，请先选择故障原因！','ok')
        return
    end
    if resonname and resonname == '' then
        Dialog:show('提示','对不起，请先选择原因细分！','ok')
        return
    end
     if dealstepContent and dealstepContent == '' then
        Dialog:show('提示', '对不起，处理措施为空！', 'ok')
        return
    end
    Dialog:show('提示','是否确定提交此故障工单？','ok_cancel','doUpload')
end
function doUpload()
    Loading:show()
    local dealstepContent = Sprite:getProperty(Sprite:findChild(Sprite:findChild(rootSprite, 'dealstepNode'), 'dealstepContent'), 'text')
    local timeNode = Sprite:findChild(rootSprite,'timeEdit')
    local faultdealtime = Sprite:getText(timeNode)
    Log:write('+++++',dealstepContent)
    local param = 'cmd=wlbfaultreply&page=1&id='..dangerOrderId..'&processmeasure='..dealstepContent..'&taskid='..taskid .. '&result='..typeValue
        ..'&troubletype='..levelValue..'&troubledetail='..zhuanyeValue..'&faultdealtime='..faultdealtime..'&usercode='..Config:get('username')
    local url= getUrl()..'nbspweb/webservice/wlbfault!doWebservice.action'
    Log:write('提交故障工单接口URL为：', url..'?'..param)
    Http:request('dangerlist_data', url, 101, {useCache = false, method = 'post', postData=''..param})
end
function fillContent()
    local param = 'cmd=wlbfaultdetail&id='..dangerOrderId..'&page=1'
    local url= getWholeUrl('nbspweb/webservice/wlbfault!doWebservice.action',param)
    Log:write('===新故障工单列表======', url)
    Http:request('dangerlist_data1', url, 102, {useCache = false, method = 'post', postData=''})
end
function  fillgzData()
    local querytitle = Sprite:findChild(rootSprite,"querytitle")
    local querylevel = Sprite:findChild(rootSprite,"querylevel")
    local description = Sprite:findChild(rootSprite,"description")
    local querytime = Sprite:findChild(rootSprite,"querytime")
    local querylimit = Sprite:findChild(rootSprite,"querylimit")
    local queryt2limit = Sprite:findChild(rootSprite,"queryt2limit")
    local equipment = Sprite:findChild(rootSprite,"equipment")
    local eomsid = Sprite:findChild(rootSprite,"eomsid")
    local networkname = Sprite:findChild(rootSprite,"networkname")

    local statusBtn=Sprite:findChild(rootSprite,"statusBtn")
    local submitBtn =Sprite:findChild(rootSprite,"submitBtn")
    local chuligz=Sprite:findChild(rootSprite,"chuligz")
    local gzchuli=Sprite:findChild(rootSprite,"gzchuli")
    local pic =Sprite:findChild(rootSprite,"pic")

    --跳过处理
    local nextBtn =Sprite:findChild(rootSprite,"nextBtn")
    if gzdata.value[0].title ~='' then
        Sprite:setProperty(querytitle,"text",gzdata.value[0].title)
    end
    if gzdata.value[0].level~='' then
        Sprite:setProperty(querylevel,"text",gzdata.value[0].level)
    end
    if gzdata.value[0].description~='' then
        Sprite:setProperty(description,"text",gzdata.value[0].description)
    end
    if gzdata.value[0].time ~='' then
        Sprite:setProperty(querytime,"text",gzdata.value[0].time)
    end
    if gzdata.value[0].limit ~='' then
        Sprite:setProperty(querylimit,"text",gzdata.value[0].limit)
    end
    if gzdata.value[0].t2limit ~='' then
        Sprite:setProperty(queryt2limit,"text",gzdata.value[0].t2limit)
    end
    if gzdata.value[0].equipment ~='' then
        Sprite:setProperty(equipment,"text",gzdata.value[0].equipment)
    end
    if gzdata.value[0].eomsid ~='' then
        Sprite:setProperty(eomsid,"text",gzdata.value[0].eomsid)
    end
    if gzdata.value[0].networkname ~='' then
        Sprite:setProperty(networkname,"text",gzdata.value[0].networkname)
    end

    if gzdata.value[0].status =='01' then
      Sprite:setProperty(statusBtn,"text","到达现场")
      Sprite:setVisible(submitBtn, 0)
      Sprite:setEnable(submitBtn, 0)
      Sprite:setVisible(statusBtn, 1)
      Sprite:setEnable(statusBtn, 1)  
      Sprite:setVisible(gzchuli, 1) 
      Sprite:setVisible(chuligz, 0) 
      Sprite:setVisible(pic, 1)
      setAllShoworHide(nextBtn,0)
   elseif gzdata.value[0].status =='' then
      Sprite:setProperty(statusBtn,"text","签收")
      Sprite:setVisible(submitBtn, 0)
      Sprite:setEnable(submitBtn, 0)
       Sprite:setVisible(statusBtn, 1)
      Sprite:setEnable(statusBtn, 1)  
      Sprite:setVisible(gzchuli, 1) 
      Sprite:setVisible(chuligz, 0) 
      Sprite:setVisible(pic, 1)
      setAllShoworHide(nextBtn,1)
   elseif  gzdata.value[0].status =='00' then
      Sprite:setProperty(statusBtn,"text","正在途中")
      Sprite:setVisible(submitBtn, 0)
      Sprite:setEnable(submitBtn, 0)
       Sprite:setVisible(statusBtn, 1)
      Sprite:setEnable(statusBtn, 1)  
      Sprite:setVisible(gzchuli, 1) 
      Sprite:setVisible(chuligz, 0) 
      Sprite:setVisible(pic, 1)
      setAllShoworHide(nextBtn,0)
   elseif gzdata.value[0].status =='02' then
      Sprite:setProperty(statusBtn,"text","处理结束")
      Sprite:setVisible(submitBtn, 0)
      Sprite:setEnable(submitBtn, 0)
       Sprite:setVisible(statusBtn, 1)
      Sprite:setEnable(statusBtn, 1)  
      Sprite:setVisible(gzchuli, 1) 
      Sprite:setVisible(chuligz, 0) 
      Sprite:setVisible(pic, 1)
      setAllShoworHide(nextBtn,0)
   elseif gzdata.value[0].status =='05' then
     --Sprite:setProperty(gzjibie,"text","故障消除")
      Sprite:setVisible(submitBtn, 1)
      Sprite:setEnable(submitBtn, 1)
      Sprite:setVisible(statusBtn, 0)
      Sprite:setEnable(statusBtn, 0)  
      setAllShoworHide(gzchuli,0)
      Sprite:setVisible(chuligz, 1) 
      Sprite:setVisible(pic, 0)
      setAllShoworHide(nextBtn,0)
   end
end
function doStatus()
    local gg
    if gzdata.value[0].status==''then
       gg= '00'
    elseif gzdata.value[0].status=='00'then
       gg= '01'
    elseif gzdata.value[0].status=='01' then
          gg= '02'
    elseif gzdata.value[0].status=='02' then
        gg= '05'
    end
    local param = 'cmd=wlbtroubleprocessevent&userid='..Config:get("username")..'&orderid='..taskcode..'&eventtime='..'&eventid='..gg..'&lon=11&lat=11&ordertypeid=002'
    local url= getWholeUrl('nbspweb/webservice/trouble!doWebservice.action',param)
    Log:write('===新故障工单列表提交按钮响应======', url)
    Http:request('dangerlist_data2', url, 103, {useCache = false, method = 'post', postData=''})
end
--跳过处理
function doNext()
    local gg = '05'
    local param = 'cmd=wlbtroubleprocessevent&userid='..Config:get("username")..'&orderid='..taskcode..'&eventtime='..'&eventid='..gg..'&lon=11&lat=11&ordertypeid=002'
    local url= getWholeUrl('nbspweb/webservice/trouble!doWebservice.action',param)
    Log:write('===新故障工单列表提交按钮响应======', url)
    Http:request('dangerlist_data2', url, 103, {useCache = false, method = 'post', postData=''})
end 

-- 处理结果选择
function typeOnSelect(sprite)
    Log:write('进入处理结果')
    local xunjianData = Sprite:getData(sprite)
    curXunjianBtn = sprite
    --@Log:write('tempid===', tempid)
    selectIndex = 3
    local list = Sprite:findChild(rootSprite, 'listSelect')
    local item = Sprite:findChild(rootSprite, 'selectItem')
    ListView:removeAllItems(list, 1, 1)
    selectData = {
    ["value"]={
        [0]={name='已解决', id='0'},
        [1]={name='延期解决', id='1'},
        [2]={name='无需解决', id='2'},
    }
}
    fillSelect()
end

-- 故障原因选择
function levelOnSelect(sprite)
    Sprite:setProperty(Sprite:findChild(Sprite:findChild(rootSprite, 'reasonBtn'), 'name'), 'text', '')
    Sprite:setProperty(Sprite:findChild(Sprite:findChild(rootSprite, 'levelBtn'), 'name'), 'text', '')
    local xunjianData = Sprite:getData(sprite)
    curXunjianBtn = sprite   
    selectIndex = 2
    local param = 'cmd=wlbfaulttroubletype&usercode=' .. Config:get('username')..'&page=1&pagesize=20'
    local url = getWholeUrl('nbspweb/webservice/wlbfault!doWebservice.action', param)
    Http:request('select', url, 104, {useCache = true, method = 'post'})
    Loading:show(rootSprite)
    setAllShoworHide(Sprite:findChild(rootSprite, 'xunjianSelectNode'), 1)
end
-- 原因细分选择
function reasonOnSelect(sprite)
    local levelBtnText = Sprite:getProperty(Sprite:findChild(Sprite:findChild(rootSprite, 'levelBtn'), 'name'), 'text')
    if levelBtnText and levelBtnText == '' then
        Dialog:show('提示', '对不起，请先选择故障原因！', 'ok')
        return
    end
    local xunjianData = Sprite:getData(sprite)
    curXunjianBtn = sprite   
    local levelBtn = Sprite:findChild(rootSprite, 'levelBtn')
    local troubletypeid = Sprite:getData(levelBtn)
    Log:write("troubletypeid==",troubletypeid)
    selectIndex = 1
    
    local param = 'cmd=wlbfaulttroubledetail&usercode=' .. Config:get('username')..'&page=1&pagesize=20'..'&troubletypeid='..troubletypeid
    local url = getUrl()..'nbspweb/webservice/wlbfault!doWebservice.action?'..param
    Http:request('select', url, 104, {useCache = false})
    Loading:show(rootSprite)
    setAllShoworHide(Sprite:findChild(rootSprite, 'xunjianSelectNode'), 1)
end
--加载弹出框数据
function fillSelect()
    setAllShoworHide(Sprite:findChild(rootSprite, 'xunjianSelectNode'), 1)
    local count = #selectData.value + 1
    local list = Sprite:findChild(rootSprite, 'listSelect')
    local item = Sprite:findChild(rootSprite, 'selectItem')
    ListView:removeAllItems(list, 1, 1)
    ListView:loadItem(list, item, count, 'loadSelectItem')
    ListView:adjust(list)
end

function loadSelectItem(list, item, index)
    Sprite:setRect(item, 0, 0, 480, 76)
    Sprite:setProperty(item, 'extendstyle', '0010')

    local button = Sprite:findChildByClass(item, 'button')
    if selectIndex == 1 then
        Sprite:setProperty(button, 'text', "      "..selectData.value[index].typename)
        Sprite:setProperty(button, 'data', selectData.value[index].id)
    elseif selectIndex == 2 then
        Sprite:setProperty(button, 'text', "      "..selectData.value[index].typename)
        Sprite:setProperty(button, 'data', selectData.value[index].id)
    elseif selectIndex == 3 then
        Sprite:setProperty(button, 'text', "      "..selectData.value[index].name)
        Sprite:setProperty(button, 'data', selectData.value[index].id)
        codevalue = selectData.value[index].id
    elseif selectIndex == 4 then
        Sprite:setProperty(button, 'text', "      "..selectData.value[index].itemname)
        Sprite:setProperty(button, 'data', selectData.value[index].xtbh)
    end

end

--隐藏弹出框
function hideXunjianSelected(sprite)
    setAllShoworHide(Sprite:findChild(rootSprite, 'xunjianSelectNode'), 0)
end

--加载项点击事件
function xunjianGroupOnSelect(sprite)
    local xunjianData = Sprite:getData(sprite)
    Log:write("xunjianData == "..xunjianData)
    local xunjianText = Sprite:findChild(curXunjianBtn, 'name')

    local index = ListView:getItemIndex(Sprite:getParent(sprite))

    local title
    local zhuanyeBtn = Sprite:findChild(rootSprite, 'zhuanyeBtn')
    local typeBtn = Sprite:findChild(rootSprite, 'typeBtn')
    local levelBtn = Sprite:findChild(rootSprite, 'levelBtn')
    local zhandianBtn = Sprite:findChild(rootSprite, 'zhandianBtn')
    local zhandianlabel=Sprite:findChild(rootSprite,'zhandianlabel')
    local typeBtn =Sprite:findChild(rootSprite,'typeBtn')
    local typeLab =Sprite:findChild(typeBtn,'name')
    if selectIndex == 1 then  --原因细分
        title = selectData.value[index].typename
        zhuanyeValue = xunjianData
        Log:write('##xunjianData',xunjianData)
     
    elseif selectIndex == 2 then -- 故障原因
        title = selectData.value[index].typename
        levelValue = xunjianData
        Log:write('##levelValue',levelValue)
    elseif selectIndex == 3 then --处理结果
        title = selectData.value[index].name
        typeValue = xunjianData
        Log:write('##typeValue',typeValue)
    end
    Log:write('data:',Sprite:getData(sprite),text)
    Sprite:setProperty(curXunjianBtn, 'data', Sprite:getData(sprite))
    Sprite:setProperty(xunjianText, 'text', title)
    setAllShoworHide(Sprite:findChild(rootSprite, 'xunjianSelectNode'), 0)
end
--获取系统时间替代故障消除时间,小于10前面加0
function filltime()
    local timeNode = Sprite:findChild(rootSprite,'timeEdit')
    local now = os.date("*t",os.time())
    local nowMin = tonumber(now["min"])
    if nowMin<10 then 
        nowMin = '0'..tostring(nowMin)
    end 
    local nowSec = tonumber(now["sec"])
    if nowSec<10 then 
        nowSec = '0'..tostring(nowSec)
    end 
    local nowHour = tonumber(now["hour"])
    if nowHour<10 then 
        nowHour = '0'..tostring(nowHour)
    end 
    local nowDay = tonumber(now["day"])
    if nowDay<10 then 
        nowDay = '0'..tostring(nowDay)
    end 
    local nowMonth = tonumber(now["month"])
    if nowMonth<10 then 
        nowMonth = '0'..tostring(nowMonth)
    end 
    currentMonthString = string.format('%s-%s-%s %s:%s:%s', now['year'], nowMonth, nowDay,nowHour,nowMin,nowSec)
    Log:write('当前时间', now,currentMonthString)
    Sprite:setProperty(timeNode,'text',currentMonthString)
end

--暂时不用
function timeOnSelect(sprite)
    local now = os.date("*t",os.time())
    currentMonthString = string.format('%s-%s-%s %s:%s:%s', now['year'], now['month'], now["day"],now["hour"],now["min"],now["sec"])
    Log:write("currentMonthString",currentMonthString)
    local stringDate = Split(currentMonthString, '-')
    Log:write("str========",stringDate)
    local regHandle = Reg:create("startEnd")
    Reg:setString(regHandle, 'type', 'start')
    Reg:setString(regHandle, 'year', stringDate[1])
    Reg:setString(regHandle, 'month', stringDate[2])
    Reg:setString(regHandle, 'day', stringDate[3])
    Scene:setReturn(Alias.m_zhangaigongdanlist, Alias.m_dateDialogTime)
    Scene:go(Alias.m_dateDialogTime,true)
end

function voiceOnSelect(sprite)
    Sprite:releaseCapture(sprite)
    Sprite:killFocus(sprite)
    local success = VoiceInput:startVoiceInput('0000', '')
    if success == 0 then
        Dialog:show(rootSprite, '打开录音失败!', 'ok')
    end
end
    ]]>
</root>
