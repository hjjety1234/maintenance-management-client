<?xml version="1.0" encoding="utf-8"?>
<!--
 == ============================================================================
 == | WonderTek [ 网络无处不在，沟通及时到达 ]
 == ============================================================================
 == | Copyright (c) 2012, WonderTek, Inc. All Rights Reserved.
 == ============================================================================
 == | Author: xxxx <xxxx@xxxx.com>
 == ============================================================================
 == | Desc: 页面描述
 == ============================================================================
-->
<root>
    <header/>
    <body resolution="480,800" BuildChildrenFinished="bodyBuildChildrenFinished" OnSpriteEvent="bodyOnSpriteEvent" OnPluginEvent="bodyOnPluginEvent">
        <node name="mainNode" rect="0,0,480,800" enable="true" active="true" OnKeyUp="mainNodeOnKeyUp" layouttype="1" extendstyle="1111">
            <!-- 设置背景 -->
            <image rect="0,0,0,0" src="file://image/backgroundImg.png" style="autosize" extendstyle="1177" />
            <!-- 设置头部 -->
            <node name="baseSprite" rect="0,0,480,66" extendstyle="1111">
                <image name="title" rect="0,0,480,66" border="false"
                    src="file://image/title_new.png" style="autosize" extendstyle="1111" />
                <label rect="0,0,480,66" text="故障工单" color="#ffffff" v-align="center"
                    h-align="center" font-family="微软雅黑" font-size="30" extendstyle="1111" />    
                <button name="backBtn" rect="0,0,66,66"  OnSelect="doBack" extendstyle="1111">
                    <image name="normal" rect="15,8,75,75" src="file://image/skin/ic_home_new.png" extendstyle="1111" />
                </button>
                <!-- 提交 -->
                <button name="submitBtn" rect="400,0,75,75" text="" color="#ffffff"
                    extendstyle="1111" OnSelect="submitOnSelect"
                    font-size="24" visible="false" enable="false">
                    <image name="titleBg1" rect="21,8,75,75" src="file://image/skin/ico_submit.png"
                    extendstyle="1111"  />
                </button>
            </node>
            <!-- 详情内容 -->
            <listview name="listview" rect="0,80,480,734" col="1" extendstyle="1111" limit="true" border="false">
                <list-item rect="0,0,480,52" extendstyle="1111" border="false">
                    <label name="label1" rect="20,0,118,52" border="false" text="工单编号："
                        h-align="left" v-align="center" color="#0062ab" font-family="微软雅黑" font-size="24"
                        extendstyle="1111" />
                    <node rect="120,0,292,52" border="false" text="" color="#ffffff"
                        extendstyle="1111">
                        <scrolltext name="orderNum" rect="15,0,400,52" text="" font-family="微软雅黑"
                            color="#303030" font-size="22" h-align="left" v-align="center"
                            scroll="true" style="autosize" extendstyle="1111" >
                        </scrolltext>    
                    </node>
                </list-item>
                <list-item rect="0,0,480,52" extendstyle="1111" border="false">
                    <image name="pic" rect="0,0,480,60" src="file://image/ziyuan_bg.png" style="autosize" extendstyle="1111" />
                    <label name="label1" rect="20,0,118,52" border="false" text="工单标题："
                        h-align="left" v-align="center" color="#0062ab" font-family="微软雅黑" font-size="24"
                        extendstyle="1111" />
                    <node rect="120,0,292,52" border="false" text="" color="#ffffff"
                        extendstyle="1111">
                        <scrolltext name="orderTitle" rect="15,0,252,52" text="" 
                            font-family="微软雅黑" color="#303030" font-size="22" h-align="left" v-align="center" 
                            scroll="true" style="autosize" extendstyle="1111" >
                        </scrolltext>    
                    </node>
                </list-item>
                
                <list-item name="textNode" rect="0,0,480,50" extendstyle="1111"
                    border="false" visible="false">
                    <node name="baseSprite" rect="0,0,480,50"  extendstyle="1111">
                        <image rect="0,0,480,50" src="file://image/search_bg_new.png"
                            style="autosize" extendstyle="1111" />
                        <label name="label1" rect="0,0,150,50"  text="工单处理        "
                            font-family="微软雅黑" font-size="24" color="#303030"  h-align="center"
                            v-align="center" extendstyle="1111" />
                    </node>
                </list-item>

                <list-item name="chuligz" rect="0,0,480,500" extendstyle="1111" limit="true"  visible="false">
                     <node name="dealmanNode" rect="0,0,480,150" extendstyle="1111" >
                        <label name="label1" rect="0,10,150,30" border="false" text="故障原因："
                            font-family='微软雅黑' h-align="center" v-align="center" color="#0062ab"
                            font-size="24" extendstyle="1111" />
                        <shadow rect="130,10,322,140" color="#ffffff" alpha="255"
                            border='true' extendstyle="1111" />
                        <edit name="dealmanContent" rect="135,15,312,130" font-size="24"
                            font-family='微软雅黑' text="" color="#303030" extendstyle="1111"
                            line-height='28' multiline="true" style="autosize" h-align="left"
                            v-align="top" />
                    </node>
                    <node name="dealstepNode" rect="0,160,480,150" extendstyle="1111" >
                        <label name="label1" rect="0,10,150,30" border="false" text="处理措施："
                            font-family='微软雅黑' h-align="center" v-align="center" color="#0062ab"
                            font-size="24" extendstyle="1111" />
                        <shadow rect="130,10,322,150" color="#ffffff" alpha="255"
                            border='true' extendstyle="1111" />
                        <edit name="dealstepContent" rect="135,15,312,140" font-size="24"
                            font-family='微软雅黑' text="" color="#303030" extendstyle="1111"
                            line-height='28' multiline="true" style="autosize" h-align="left"
                            v-align="top" />
                    </node>
                    <node name="dealOpinionNode" rect="0,330,480,150" extendstyle="1111" >
                        <label name="label1" rect="0,10,150,30" border="false" text="遗留问题："
                            font-family='微软雅黑' h-align="center" v-align="center" color="#0062ab"
                            font-size="24" extendstyle="1111" />
                        <shadow rect="130,10,322,150" color="#ffffff" alpha="255"
                            border='true' extendstyle="1111" />
                        <edit name="dealOpinionContent" rect="135,15,312,140" font-size="24"
                            font-family='微软雅黑' text="" color="#303030" extendstyle="1111"
                            line-height='28' multiline="true" style="autosize" h-align="left"
                            v-align="top" />
                    </node>
                </list-item>  
            </listview>   
            <!-- 故障单流转处理 -->
                 <node name="gzchuli" rect="0,180,292,52" border="false" text="" color="#ffffff"
                        extendstyle="1111" visible="false">
                 
                     <label name="label1" rect="20,0,120,52" border="false" text="故障处理人："
                        h-align="left" v-align="center" color="#0062ab" font-family="微软雅黑" font-size="22"
                         extendstyle="1111" />
                     <scrolltext name="gzchuliren" rect="150,0,252,50" text="" 
                            font-family="微软雅黑" color="#303030" font-size="22" h-align="left" v-align="center" 
                            scroll="true" style="autosize" extendstyle="1111" >
                        </scrolltext>   
                     <image rect="0,50,480,60" src="file://image/ziyuan_bg.png" style="autosize" extendstyle="1111" /> 
                     <label name="label1" rect="20,50,120,50" border="false" text="处理人电话："
                        h-align="left" v-align="center" color="#0062ab" font-family="微软雅黑" font-size="22"
                        extendstyle="1111" />
               
                        <scrolltext name="gzphone" rect="150,50,300,52" text="" 
                            font-family="微软雅黑" color="#303030" font-size="22" h-align="left" v-align="center" 
                            scroll="true" style="autosize" extendstyle="1111" >
                        </scrolltext>    
                 
                     <label name="label1" rect="20,100,120,50" border="false" text="站点名称："
                        h-align="left" v-align="center" color="#0062ab" font-family="微软雅黑" font-size="22"
                        extendstyle="1111" />
                  
                        <scrolltext name="gzzhandian" rect="150,100,300,50" text="" 
                            font-family="微软雅黑" color="#303030" font-size="22" h-align="left" v-align="center" 
                            scroll="true" style="autosize" extendstyle="1111" >
                        </scrolltext>  
                           <image rect="0,150,480,60" src="file://image/ziyuan_bg.png" style="autosize" extendstyle="1111" />  
                      <label name="label1" rect="20,150,120,50" border="false" text="故障级别："
                        h-align="left" v-align="center" color="#0062ab" font-family="微软雅黑" font-size="22"
                        extendstyle="1111" />
                        <scrolltext name="gzjibie" rect="150,150,300,50" text="" 
                            font-family="微软雅黑" color="#303030" font-size="22" h-align="left" v-align="center" 
                            scroll="true" style="autosize" extendstyle="1111" >
                        </scrolltext>    
                   
                    </node> 
            <!-- 列表模版 -->
            <node name="listitem" visible="false" enable="false" active="false"
                extendstyle="1011" rect="0,0,480,66">
                <button name="btnname" rect="0,0,480,66" OnSelect="itemOnSelect" normal="normal"
                    focus="focus" style="autosize" border="false" extendstyle="1111" data="">
                    <label rect="0,0,118,35" border="false" text="隐患名称：" h-align="right" v-align="center"
                         color="#0062ab" font-family="微软雅黑" font-size="24" extendstyle="1111" />     
                    <node rect="120,0,292,35" border="false" text="" color="#ffffff"
                        extendstyle="1111">
                        <scrolltext name="dangerTitle" rect="8,0,252,35" text="测试1" font-family="微软雅黑"
                            color="#303030" font-size="24" h-align="left" v-align="center"
                            scroll="true" style="autosize" extendstyle="1111" >
                        </scrolltext> 
                    </node>
                    <label rect="0,35,118,30" border="false" text="上报时间：" h-align="right" v-align="center"
                         color="#303030" font-family="微软雅黑" font-size="22" extendstyle="1111" />     
                    <node rect="120,35,292,30" border="false" text="" color="#ffffff"
                        extendstyle="1111">
                        <scrolltext name="createtimedis" rect="8,0,252,30" text="2013-01-23 12:10:10" font-family="微软雅黑"
                            color="#303030" font-size="22" h-align="left" v-align="center"
                            scroll="true" style="autosize" extendstyle="1111" >
                        </scrolltext> 
                    </node>
                </button>
            </node>
            <button name="statusBtn" rect="160,450,160,50" text="" color="#ffffff"
                    extendstyle="1111" OnSelect="doStatus"
                    normal="src:file://image/btn_bg_n.png;style:sudoku-auto;sudoku:15,15,15,15;color:#ffffff"
                    sel="src:file://image/btn_bg_s.png;style:sudoku-auto;sudoku:15,15,15,15;color:#000000"
                    font-size="24"  visible="false" enable="false"/>
        </node>
    </body>
    <![CDATA[

require 'com_wondertek_dw.common.framework'
require 'framework.umsagent'
local rootSprite
local dangerListData = {}
local dangerSubmitData = {}
local curErrorBtn
local gzdata
local gzdata2
---------------------------------------callbacks--------------------------------
-- @brief root子节点创建完事件
function bodyBuildChildrenFinished(sprite)
    rootSprite = sprite
    Log:write("故障工单ID = ",dangerOrderId,taskname,taskcode,taskid)
    fillContent()
end

-- @brief root节点消息方法
function bodyOnSpriteEvent(msg, param)
    if msg == MSG_ACTIVATE then -- 页面激活
        local orderNum =Sprite:findChild(rootSprite,'orderNum')
        local orderTitle =Sprite:findChild(rootSprite,'orderTitle')
        Sprite:setProperty(orderNum,'text',taskcode)
        Sprite:setProperty(orderTitle,'text',taskname)
        UmsAgent:OnActivate(string.match(Alias.m_yinhuangongdanlist, 'MODULE:\\(.*)'), '故障工单列表首页')
        UmsAgent:OnDeactivate()
    elseif msg == MSG_DEACTIVATE then
    end
end

-- @brief 插件消息方法
function bodyOnPluginEvent(msg)
    if Loading:isShow() then Loading:close() end
    if msg == 101 then
        Loading:close()
        local data = Http:jsonDecode('dangerlist_data')
        if data.code == '0' then 
            Scene:back()
        else 
            Dialog:show('','提交失败，服务端数据错误','ok')
        end
    elseif msg == 102 then
        gzdata = Http:jsonDecode('dangerlist_data1')
        Log:write("故障数据",gzdata.value)
        if  gzdata.code == '0' then 
            fillgzData()
        else 
            Dialog:show('','服务端数据错误','ok')
        end
    elseif msg == 103 then 
        gzdata2 = Http:jsonDecode('dangerlist_data2')
        Log:write("故障数据提交",gzdata2.value)
        if  gzdata2.code == '0' then 
            Scene:back()
        else 
            Dialog:show('','提交失败，服务端数据错误','ok')
        end
    elseif msg == 101 + MSG_CACHEDATA_RELOAD then -- 101请求的数据有更新
    elseif msg == MSG_NETWORK_ERROR then -- 拨号失败
        Log:write('拨号失败')
    elseif msg > MSG_NETWORK_ERROR then -- 请求超时
        Log:write('请求超时')
    end
end

-- @brief 按键响应处理
function mainNodeOnKeyUp(sprite, kc)
    if kc == Key.F2 then -- 按下返回键
        Scene:back()
        return 1
    end
end

---------------------------------------util functions---------------------------
-- 返回按钮
function doBack()
    Scene:setReturn(Alias.m_yinhuangongdanlist, Alias.m_daibangongdan)
    Scene:go(Alias.m_daibangongdan,true)
end

-- 提交隐患处理信息  
function submitOnSelect(sprites)  
    local dealResultText = Sprite:getProperty(Sprite:findChild(Sprite:findChild(rootSprite, 'dealResult'), 'dealResultContent'), 'text')
    local dealOpinionText = Sprite:getProperty(Sprite:findChild(Sprite:findChild(rootSprite, 'dealOpinionNode'), 'dealOpinionContent'), 'text')   
  
     local dealmanContent = Sprite:getProperty(Sprite:findChild(Sprite:findChild(rootSprite, 'dealmanNode'), 'dealmanContent'), 'text')
    
    local dealstepContent = Sprite:getProperty(Sprite:findChild(Sprite:findChild(rootSprite, 'dealstepNode'), 'dealstepContent'), 'text')
    local dealResultCodeText = Sprite:getProperty(Sprite:findChild(Sprite:findChild(rootSprite, 'dealResult'), 'dealResultCode'), 'text')
    

    if dealmanContent and dealmanContent == '' then
        Dialog:show('提示', '对不起，故障原因为空！', 'ok')
        return
     elseif dealstepContent and dealstepContent == '' then
        Dialog:show('提示', '对不起，处理措施为空！', 'ok')
        return
    elseif dealOpinionText and dealOpinionText == '' then
        Dialog:show('提示', '对不起，遗留问题为空！', 'ok')
        return
    else
        Dialog:show('提示','是否确定提交此故障工单？','ok_cancel','doUpload')
    end
end
function doUpload()
    Loading:show()
    local dealmanContent = Sprite:getProperty(Sprite:findChild(Sprite:findChild(rootSprite, 'dealmanNode'), 'dealmanContent'), 'text')
    local dealstepContent = Sprite:getProperty(Sprite:findChild(Sprite:findChild(rootSprite, 'dealstepNode'), 'dealstepContent'), 'text')
    local dealOpinionText = Sprite:getProperty(Sprite:findChild(Sprite:findChild(rootSprite, 'dealOpinionNode'), 'dealOpinionContent'), 'text')
    Log:write('+++++',dealmanContent,dealstepContent,dealOpinionText)
    local param = 'cmd=wlbfaultreply&page=1&id='..dangerOrderId..'&reason='..dealmanContent..'&processmeasure='..dealstepContent..'&leaveproblem='..dealOpinionText..'&taskid='..taskid
    local url= getWholeUrl('nbspweb/webservice/wlbfault!doWebservice.action',param)
    Log:write('故障工单列表接口URL为：', url)
    Http:request('dangerlist_data', url, 101, {useCache = false, method = 'post', postData=''})
end
function fillContent()
    local param = 'cmd=wlbfaultinquiry&id='..dangerOrderId..'&page=1'
    local url= getWholeUrl('nbspweb/webservice/wlbfault!doWebservice.action',param)
    Log:write('===新故障工单列表======', url)
    Http:request('dangerlist_data1', url, 102, {useCache = false, method = 'post', postData=''})
end
function  fillgzData()
   local gzchuliren=Sprite:findChild(rootSprite,"gzchuliren")
   local gzzhandian=Sprite:findChild(rootSprite,"gzzhandian")
   local gzphone=Sprite:findChild(rootSprite,"gzphone")
   local gzjibie=Sprite:findChild(rootSprite,"gzjibie")
   local statusBtn=Sprite:findChild(rootSprite,"statusBtn")
   local submitBtn =Sprite:findChild(rootSprite,"submitBtn")
   local chuligz=Sprite:findChild(rootSprite,"chuligz")
   local gzchuli=Sprite:findChild(rootSprite,"gzchuli")
   local pic =Sprite:findChild(rootSprite,"pic")
   if gzdata.value[0].name then
   Sprite:setProperty(gzchuliren,"text",gzdata.value[0].name)
   end
   if gzdata.value[0].station then
   Sprite:setProperty(gzzhandian,"text",gzdata.value[0].station)
   end
   if gzdata.value[0].phone then
   Sprite:setProperty(gzphone,"text",gzdata.value[0].phone)
   end
   if gzdata.value[0].level then
   Sprite:setProperty(gzjibie,"text",gzdata.value[0].level)
   end
   if gzdata.value[0].status =='01' then
      Sprite:setProperty(statusBtn,"text","到达现场")
      Sprite:setVisible(submitBtn, 0)
      Sprite:setEnable(submitBtn, 0)
      Sprite:setVisible(statusBtn, 1)
      Sprite:setEnable(statusBtn, 1)  
      Sprite:setVisible(gzchuli, 1) 
      Sprite:setVisible(chuligz, 0) 
      Sprite:setVisible(pic, 1)
   elseif gzdata.value[0].status =='' then
      Sprite:setProperty(statusBtn,"text","签收")
      Sprite:setVisible(submitBtn, 0)
      Sprite:setEnable(submitBtn, 0)
       Sprite:setVisible(statusBtn, 1)
      Sprite:setEnable(statusBtn, 1)  
      Sprite:setVisible(gzchuli, 1) 
      Sprite:setVisible(chuligz, 0) 
      Sprite:setVisible(pic, 1)
   elseif  gzdata.value[0].status =='00' then
      Sprite:setProperty(statusBtn,"text","正在途中")
      Sprite:setVisible(submitBtn, 0)
      Sprite:setEnable(submitBtn, 0)
       Sprite:setVisible(statusBtn, 1)
      Sprite:setEnable(statusBtn, 1)  
      Sprite:setVisible(gzchuli, 1) 
      Sprite:setVisible(chuligz, 0) 
      Sprite:setVisible(pic, 1)
   elseif gzdata.value[0].status =='02' then
      Sprite:setProperty(statusBtn,"text","处理结束")
      Sprite:setVisible(submitBtn, 0)
      Sprite:setEnable(submitBtn, 0)
       Sprite:setVisible(statusBtn, 1)
      Sprite:setEnable(statusBtn, 1)  
      Sprite:setVisible(gzchuli, 1) 
      Sprite:setVisible(chuligz, 0) 
      Sprite:setVisible(pic, 1)
   elseif gzdata.value[0].status =='05' then
     --Sprite:setProperty(gzjibie,"text","故障消除")
      Sprite:setVisible(submitBtn, 1)
      Sprite:setEnable(submitBtn, 1)
      Sprite:setVisible(statusBtn, 0)
      Sprite:setEnable(statusBtn, 0)  
      Sprite:setVisible(gzchuli, 0) 
      Sprite:setVisible(chuligz, 1) 
      Sprite:setVisible(pic, 0)
   end
end
function doStatus()
    local gg
    if gzdata.value[0].status==''then
       gg= '00'
    elseif gzdata.value[0].status=='00'then
       gg= '01'
    elseif gzdata.value[0].status=='01' then
          gg= '02'
    elseif gzdata.value[0].status=='02' then
        gg= '05'
    end
    local param = 'cmd=wlbtroubleprocessevent&userid='..Config:get("username")..'&orderid='..dangerOrderId..'&eventtime='..'&eventid='..gg..'&lon=&lat=&ordertypeid=002'
    local url= getWholeUrl('nbspweb/webservice/trouble!doWebservice.action',param)
    Log:write('===新故障工单列表提交按钮响应======', url)
    Http:request('dangerlist_data2', url, 103, {useCache = false, method = 'post', postData=''})
end
    ]]>
</root>
