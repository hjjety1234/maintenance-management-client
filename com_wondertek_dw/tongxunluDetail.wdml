<?xml version="1.0" encoding="utf-8"?>
    <!--
        ==
        ============================================================================
        == | WonderTek [ 网络无处不在，沟通及时到达 ] ==
        ============================================================================
        == | Copyright (c) 2012, WonderTek, Inc. All Rights Reserved. ==
        ============================================================================
        == | Author: xxxx <xxxx@xxxx.com> ==
        ============================================================================
        == | Desc: 页面描述 ==
        ============================================================================
    -->
<root>
    <header />
    <body resolution="480,800" BuildChildrenFinished="bodyBuildChildrenFinished"
        OnSpriteEvent="bodyOnSpriteEvent" OnPluginEvent="bodyOnPluginEvent">
        <shadow rect="0,0,480,800" color="#e8e9ed" alpha="255"
            extendstyle="1111" />
        <node name="mainNode" rect="0,0,480,800" enable="true" active="true"
            OnKeyUp="mainNodeOnKeyUp" layouttype="1" extendstyle="1111">

            <node rect="0,0,480,66" name="NodeTitle" extendstyle="1111">
                <image name="titleBg" rect="0,0,480,66" src="file://image/title_bg.png"
                    extendstyle="1111" style="autosize" />
                <button name="backBtn" rect="0,10,75,45" normal="normal" sel="sel"
                    OnSelect="doBack" extendstyle="1111">
                    <image name="normal" rect="0,0,75,45" src="file://image/title_back_n.png"
                        style="autosize" extendstyle="1111">
                    </image>
                    <image name="sel" rect="0,0,75,45" src="file://image/title_back_s.png"
                        style="autosize" extendstyle="1111">
                    </image>
                    <label rect="15,0,60,45" text="返回" color="#ffffff"
                        extendstyle="1111" style="autosize" h-align="center" v-align="center"
                        font-size="24"></label>
                </button>

                <scrolltext name="title" rect="105,0,280,66" text="通讯录详情"
                    extendstyle="1111" font-size="30" h-align="center" v-align="center"
                    color="#ffffff" scroll="true"  step="2"></scrolltext>
               
            </node>
            <node name="Codenode" rect="0,70,480,50" extendstyle="1111">
                <label name="label1" rect="0,0,150,50" border="false" text="用户编号："
                    h-align="center" v-align="center" color="#000000"  font-size="20"
                    extendstyle="1111"></label>
                <label name="lblcode" v-align="center" font-size="20" h-align="left" rect="150,0,292,50" text="" color="#000000" extendstyle="1111">
                    
                </label>
            </node>
            <node name="titlenode" rect="0,120,480,50" extendstyle="1111">
                <label name="label1" rect="0,0,150,50" border="false" text="用户姓名："
                    h-align="center" v-align="center" color="#000000"  font-size="20"
                    extendstyle="1111"></label>
                <label name="lblcode" v-align="center" h-align="left"  font-size="20" rect="150,0,292,60" text="" color="#000000" extendstyle="1111">
                    
                </label>
            </node>
            <node name="typenode" rect="0,170,480,50" extendstyle="1111">
                <label name="label1" rect="0,0,150,50" border="false" text="手 机 号："
                    h-align="center" v-align="center" color="#000000"  font-size="20"
                    extendstyle="1111"></label>
                <label name="lblcode" v-align="center" h-align="left"  font-size="20" rect="150,0,292,50" text="" color="#000000" extendstyle="1111">
                    
                </label>
            </node>
            <node name="timenode" rect="0,220,480,50" extendstyle="1111">
                <label name="label1" rect="0,0,150,50" border="false" text="用户部门："
                    h-align="center" v-align="center" color="#000000"  font-size="20"
                    extendstyle="1111"></label>
                <label name="lblcode" v-align="center" h-align="left" font-size="20" rect="150,0,292,50" text="" color="#000000" extendstyle="1111">
                    
                </label>
            </node>
            <node name="contentnode" rect="0,270,480,50" extendstyle="1111">
                <label name="label1" rect="0,0,150,60" border="false" text="用户邮箱："
                    h-align="center" v-align="center" color="#000000"  font-size="20"
                    extendstyle="1111"></label>

            </node>
            <node name="content" rect="0,270,460,170" extendstyle="1111">
                <image rect="150,0,310,170" src="file://image/input.png" style="sudoku-auto"
                    extendstyle="1111" sudoku="15,15,15,15">
                </image>
                
                    <label name="hideLabel" rect="160,15,300,170"  font-size="20" text="" color="#000000"
                        extendstyle="1111" style="autosize" h-align="left" v-align="top"
                        ></label>
                
            </node>
            
            <node name="baseSprite" rect="0,470,480,50" extendstyle="1111" border="false">
                            <image rect="0,0,480,50" src="file://image/title_bar.png"
                                style="autosize" extendstyle="1111" />
                            <label name="label1" rect="20,0,460,50" border="false" text="其他操作:"
                                h-align="left" v-align="center" color="#ffffff" font-size="22"
                                extendstyle="1111"></label>
            </node>
            <node name="qianshouNode" rect="0,540,480,240" extendstyle="1111">
            
           <node name="contentnode" rect="0,0,480,170" extendstyle="1111">
                <label name="label1" rect="0,0,150,60" border="false" text="短信内容："
                    h-align="center" v-align="center" color="#000000"  font-size="20"
                    extendstyle="1111"></label>
                     <image rect="150,0,310,170" src="file://image/input.png" style="sudoku-auto"
                    extendstyle="1111" sudoku="15,15,15,15">
                </image>
                
                    <edit name="hideLabel" rect="160,15,300,170"  font-size="20" text="" color="#000000"
                        extendstyle="1111" style="autosize" h-align="left" v-align="top"
                        ></edit>

            </node>
           
           <node name="baseSprite" rect="0,170,480,60" extendstyle="1111" border="false">
           <button name="takePicBtn" rect="60,5,130,50" border="false"
                        text="button1" color="#ffffff" OnSelect="makeCallOnSelect"
                        extendstyle="1111">
                            <image rect="0,0,130,50" src="file://image/phone.png"
                                style="autosize" extendstyle="1111" />
                                </button>
                                <button name="takePicBtn" rect="260,5,130,50" border="false"
                        text="button1" color="#ffffff" OnSelect="sendSMSOnSelect"
                        extendstyle="1111">
                            <image rect="0,0,130,50" src="file://image/sms.png"
                                style="autosize" extendstyle="1111" />
                                </button>
                           
            </node>
            </node>
            
           
            
        </node>
    </body>
    <![CDATA[

    require 'com_wondertek_dw.common.framework'
    local rootSprite
    local errorListTotalHeight = 0
    local curErrorBtn
    local curXunjianBtn
    local curresult
    local curzhuanshen
    local curhuifu
    regHandle=Reg:create('daiban')
    local id
    local taskcode
    local pid
    local step
    local stepdata 
    local flag 
    local data = {}

    ---------------------------------------callbacks--------------------------------
    -- @brief root子节点创建完事件
    function bodyBuildChildrenFinished(sprite)
        rootSprite = sprite
       --@ local xunjianNode = Sprite:findChild(rootSprite, 'xunjianNode')
        --@setAllShoworHide(xunjianNode, 1)
        
        
    end
    -- @brief root节点消息方法
    function bodyOnSpriteEvent(msg, param)
        if msg == MSG_ACTIVATE then -- 页面激活
             --id= Reg:getString(regHandle,'id') 
           name= Reg:getString(regHandle,'name') 
           phone= Reg:getString(regHandle,'phone') 
           dept= Reg:getString(regHandle,'dept') 
           --stepdata = Reg:getString(regHandle,'stepdata')
          -- flag = Reg:getString(regHandle,'flag')
           --loadRequest()
 fillContent()
            elseif msg == MSG_DEACTIVATE then
        end
    end
    -- @brief 插件消息方法
    function bodyOnPluginEvent(msg)
        if Loading:isShow() then Loading:close() end
        if msg == 101 then
            data = Http:jsonDecode('daibandetail_data')
            Log:write("data101 = ", data)
            if not data or type(data) ~= 'table' then
                Dialog:show(rootSprite, '返回数据格式错误', 'ok')
                return
            end
            
            if data ~= nil then
                if data.code == '0' then
                   
                    fillContent()
                    else
                    Dialog:show(rootSprite, '未知错误！', 'ok')
                end
                else
                Dialog:show(rootSprite, '未知错误！', 'ok')
            end
            elseif msg==102 then

            data = Http:jsonDecode('daibanqianshou')
            Log:write("data101 = ", data)
            if not data or type(data) ~= 'table' then
                Dialog:show(rootSprite, '返回数据格式错误', 'ok')
                return
            end
            
            if data ~= nil then
                if data.code == '0' then
                    Scene:setReturn(Alias.home, Alias.daibangongdan)
                    Scene:go(Alias.daibangongdan)
                    else
                    Dialog:show(rootSprite, '提交失败，请稍后再试！', 'ok')
                end
                else
                Dialog:show(rootSprite, '未知错误！', 'ok')
            end
            elseif msg==103 then
            data = Http:jsonDecode('daibanhuidan')
            Log:write("data101 = ", data)
            if not data or type(data) ~= 'table' then
                Dialog:show(rootSprite, '返回数据格式错误', 'ok')
                return
            end
            
            if data ~= nil then
                if data.code == '0' then
                    Scene:setReturn(Alias.home, Alias.daibangongdan)
                    Scene:go(Alias.daibangongdan)
                    else
                    Dialog:show(rootSprite, '提交失败，请稍后再试！', 'ok')
                end
                else
                Dialog:show(rootSprite, '未知错误！', 'ok')
            end
            

            elseif msg == 101 + MSG_CACHEDATA_RELOAD then -- 101请求的数据有更新
            elseif msg == MSG_NETWORK_ERROR then -- 拨号失败
            Log:write('拨号失败')
            elseif msg > MSG_NETWORK_ERROR then -- 请求超时
            Log:write('请求超时')
        end
    end
    -- @brief 按键响应处理
    function mainNodeOnKeyUp(sprite, kc)
        if kc == Key.F2 then -- 按下返回键
            Scene:back()
            return 1
        end
    end
    ---------------------------------------util functions---------------------------
     function loadRequest()
        local url = 'http://61.191.25.238:7011/nbspweb/webservice/workorder!doWebservice.action'
        local param = '&usercode='..'zyhefei'..'&id='..id..'&taskcode='..taskcode..'&pid='..pid..'&step='..step
        Log:write("param = ", param)
        Http:request('daibandetail_data', url, 101, {useCache = false, method = 'post', postData='cmd=wlbtaskdetail'..param})
        Loading:show(rootSprite)
    end
    function fillContent()
        
        local taskidnode= Sprite:findChild(rootSprite, 'Codenode')
        local titlenode= Sprite:findChild(rootSprite, 'titlenode')
        local timenode= Sprite:findChild(rootSprite, 'timenode')
        local contentnode= Sprite:findChild(rootSprite, 'content')
        local typenode= Sprite:findChild(rootSprite, 'typenode')
        
        Sprite:setProperty(Sprite:findChild(typenode, "lblcode"), 'text', phone)
        Sprite:setProperty(Sprite:findChild(taskidnode, "lblcode"), 'text', '00123256')
        Sprite:setProperty(Sprite:findChild(titlenode, 'lblcode'), 'text', name)
        Sprite:setProperty(Sprite:findChild(timenode, 'lblcode'), 'text', dept)
        Sprite:setProperty(Sprite:findChild(contentnode, 'hideLabel'), 'text', '')
        local sampleList = Sprite:findChild(rootSprite, "sampleList")
        local editList = Sprite:findChild(sampleList, "editList")
       
        local x,y,w,h = Sprite:getRect(editList)
        Sprite:setRect(editList, x,y,w, errorListTotalHeight)
        Sprite:setRect(Sprite:getParent(editList), x,y,w, errorListTotalHeight)
        ListView:adjust(editList)
        ListView:adjust(sampleList)
        Log:write('11111', Sprite:getRect(sampleList))
    end
    
   
    function submitOnSelect(sprite)   
     Dialog:show('工单处理提示：','是否确定提交此工单？','ok_cancel','okCallback','cancelCallback')
     end
     function okCallback()
        local url='http://61.191.25.238:7011/nbspweb/webservice/workorder!doWebservice.action'
        local param
        --签收处理
        if stepdata=='1' then
        local qianshouNode= Sprite:findChild(rootSprite, 'qianshouNode')
        local contentnode= Sprite:findChild(qianshouNode, 'chulicontent')
        local itemNode= Sprite:findChild(qianshouNode, 'itemNode')
        local xunjianNode= Sprite:findChild(qianshouNode, 'xunjianNode')
        local content=Sprite:getText(Sprite:findChild(contentnode, 'edit'))
        local signflag=Sprite:getData(Sprite:findChild(itemNode,'errorBtn'))
        local patrolgroupcode =Sprite:getData(Sprite:findChild(xunjianNode,'xunjianBtn'))
        if signflag=='01' then
            signflag='pass'
            elseif signflag=='02' then
                signflag='untread'
                end

        param = '&usercode='..'zyhefei'..'&id='..id..'&taskcode='..taskcode..'&pid='..pid..'&step='..step..'&signflag='..signflag..'&signdetail='..content..'&patrolgroupcode=zy'
        Log:write("param = ", param)
        Http:request('daibanqianshou', url, 102, {useCache = false, method = 'post', postData='cmd=wlbtaskdealsign'..param})
        Loading:show(rootSprite)
        elseif stepdata=='2' then

            elseif stepdata=='3' then
                Log:write('```````````````````````````````````````````')
                    local huidanNode= Sprite:findChild(rootSprite, 'huidan')
                    local contentnode= Sprite:findChild(huidanNode, 'chulicontent')
                    local resultNode= Sprite:findChild(huidanNode, 'resultNode')
                    
                    local content=Sprite:getText(Sprite:findChild(contentnode, 'edit'))
                    local issubmit=Sprite:getData(Sprite:findChild(resultNode,'resultBtn'))

                    if issubmit=='01' then
                        issubmit='0'
                        elseif issubmit=='02' then
                            issubmit='1'
                        end
                    param = '&usercode='..'zyhefei'..'&id='..id..'&taskcode='..taskcode..'&pid='..pid..'&step='..step..'&issubmit='..issubmit..'&remark='..content
                    Log:write("param = ", param)
                    Http:request('daibanhuidan', url, 103, {useCache = false, method = 'post', postData='cmd=wlbtaskdealrequest'..param})
                    Loading:show(rootSprite)
                    
        end
           --Scene:setReturn(Alias.home, Alias.daibangongdan)
           --Scene:go(Alias.daibangongdan)
     end
     function cancelCallback()
           if Dialog:isShow() then
           Dialog:close() 
           end
     end
     
    function sendSMSOnSelect(sprite)
        Sprite:releaseCapture(sprite)
        Sprite:killFocus(sprite)
        local qianshouNode= Sprite:findChild(rootSprite, 'qianshouNode')
        local contentnode= Sprite:findChild(rootSprite, 'contentnode')
        
        local smscontent=Sprite:getText(Sprite:findChild(contentnode, "hideLabel")) 
        local typenode= Sprite:findChild(rootSprite, 'typenode')
        --Sprite:setProperty(Sprite:findChild(typenode, "lblcode"), 'text', phone)
        local phone = Sprite:getText(Sprite:findChild(typenode, "lblcode")) 
        if smscontent==nil or smscontent=='' then
        Dialog:show(rootSprite, '短信内容为空！', 'ok')
        elseif phone ~= nil and phone ~= '' then
            Util:sendSMS(phone, smscontent)
            else
            Dialog:show(rootSprite, '电话号码为空！', 'ok')
        end
    end
   function makeCallOnSelect(sprite)
        Sprite:releaseCapture(sprite)
        Sprite:killFocus(sprite)
        local typenode= Sprite:findChild(rootSprite, 'typenode')
        --Sprite:setProperty(Sprite:findChild(typenode, "lblcode"), 'text', phone)
        local phone = Sprite:getText(Sprite:findChild(typenode, "lblcode")) 
        if phone ~= nil and phone ~= '' then
            Util:openCallDialog('callFinished',phone, 0)
            else
            Dialog:show(rootSprite, '电话号码为空！', 'ok')
        end
    end
    
    function cancelZancun()
      Scene:back()
    end
    
    function doBack()
       Scene:back()
    end
]]>
</root>
