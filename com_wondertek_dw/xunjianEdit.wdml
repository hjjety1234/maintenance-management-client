<?xml version="1.0" encoding="utf-8"?>
	<!--
		==
		============================================================================
		== | WonderTek [ 网络无处不在，沟通及时到达 ] ==
		============================================================================
		== | Copyright (c) 2012, WonderTek, Inc. All Rights Reserved. ==
		============================================================================
		== | Author: xxxx <xxxx@xxxx.com> ==
		============================================================================
		== | Desc: 页面描述 ==
		============================================================================
	-->
<root>
	<header />
	<body resolution="480,800" BuildChildrenFinished="bodyBuildChildrenFinished"
		OnSpriteEvent="bodyOnSpriteEvent" OnPluginEvent="bodyOnPluginEvent">
		<shadow rect="0,0,480,800" color="#e8e8e8" alpha="255"
			extendstyle="1111" />
		<node name="mainNode" rect="0,0,480,800" enable="true" active="true"
			OnKeyUp="mainNodeOnKeyUp" layouttype="1" extendstyle="1111">
			<node name="NodeTitle" rect="0,0,480,66" extendstyle="1111">
				<image name="titleBg" rect="0,0,480,66" src="file://image/title_bg.png"
					extendstyle="1111" style="autosize" />
				<button name="backBtn" rect="0,10,75,45" normal="normal" sel="sel"
					OnSelect="isSave" extendstyle="1111">
					<image name="normal" rect="0,0,75,45" src="file://image/title_back_n.png"
						style="autosize" extendstyle="1111">
					</image>
					<image name="sel" rect="0,0,75,45" src="file://image/title_back_s.png"
						style="autosize" extendstyle="1111">
					</image>
					<label rect="15,0,60,45" text="返回" color="#ffffff"
						extendstyle="1111" style="autosize" h-align="center" v-align="center"
						font-size="24"></label>
				</button>

				<scrolltext name="title" rect="105,0,280,66" text="巡检情况"
					extendstyle="1111" font-size="30" h-align="center" v-align="center"
					color="#ffffff" scroll="true" step="2"></scrolltext>

				<button name="btnForget" rect="387,4,79,56" text="" color="#ffffff"
					extendstyle="1111" OnSelect="submitOnSelect"
					normal="src:file://image/ic_title_upload.png;style:autosize;color:#ffffff"
					sel="src:file://image/ic_title_upload.png;style:autosize;color:#000000"
					font-size="24" />
			</node>
			<node rect="0,66,480,730" extendstyle="1111">
				<listview name="sampleList" rect="0,10,480,710" col="1"
					extendstyle="1111">
					<list-item rect="0,0,480,170" extendstyle="1111">
						<node name="baseSprite" rect="10,0,230,50" extendstyle="1111">
							<label name="label1" rect="0,0,80,50" border="false" text="标  题："
								h-align="left" v-align="center" color="#000000" font-size="22"
								extendstyle="1111"></label>
							<scrolltext name="location" rect="80,0,140,50"
								extendstyle="1010" font-size="22" h-align="left" v-align="center"
								color="#0" scroll="true" step="2"></scrolltext>
						</node>
						<node name="baseSprite" rect="240,0,230,50" extendstyle="1111">
							<label name="label1" rect="0,0,80,50" border="false" text="类  别："
								h-align="left" v-align="center" color="#000000" font-size="22"
								extendstyle="1111"></label>
							<scrolltext name="type" rect="80,0,140,50"
								extendstyle="1010" font-size="22" h-align="left" v-align="center"
								color="#0" scroll="true" step="2"></scrolltext>
						</node>
						<node name="baseSprite" rect="10,60,230,50" extendstyle="1111">
							<label name="label1" rect="0,0,80,50" border="false" text="巡检组："
								h-align="left" v-align="center" color="#000000" font-size="22"
								extendstyle="1111"></label>
							<scrolltext name="group" rect="80,0,140,50"
								extendstyle="1010" font-size="22" h-align="left" v-align="center"
								color="#0" scroll="true" step="2"></scrolltext>
						</node>
						<node name="baseSprite" rect="240,60,230,50" extendstyle="1111">
							<label name="label1" rect="0,0,80,50" border="false" text="时  间："
								h-align="lefts" v-align="center" color="#000000" font-size="22"
								extendstyle="1111"></label>
							<scrolltext name="time" rect="80,0,140,50"
								extendstyle="1010" font-size="22" h-align="left" v-align="center"
								color="#0" scroll="true" step="2"></scrolltext>
						</node>
						<node name="baseSprite" rect="0,120,480,50" extendstyle="1111"
							border="false">
							<image rect="0,0,480,50" src="file://image/title_bar.png"
								style="autosize" extendstyle="1111" />
							<label name="label1" rect="10,0,460,50" border="false"
								text="巡检任务明细:" h-align="left" v-align="center" color="#ffffff"
								font-size="22" extendstyle="1111"></label>
						</node>
					</list-item>
					<list-item rect="0,0,480,140" extendstyle="1111" border="false">
						<listview name="editList" rect="5,0,460,140" col="1"
							extendstyle="1111" limit="true">
						</listview>
					</list-item>
				</listview>
			</node>
			<node name="itemNode" rect="0,0,460,60" enable="false" active="false"
				visible="false">
				<node name="errorTitleNode" rect="0,5,460,50" extendstyle="1111">
					<scrolltext name="errorTitle" rect="0,0,460,50"
						extendstyle="1010" font-size="20" h-align="left" v-align="center"
						color="#0" scroll="true" step="2"></scrolltext>
					<button name="errorBtn" rect="300,0,160,50" border="false"
						text="button1" color="#ffffff" OnSelect="errorOnSelect"
						extendstyle="1111" data="01">
						<image rect="0,0,160,50" src="file://image/input.png" style="autosize"
							extendstyle="1111">
							<image rect="117,0,43,50" src="file://image/dropdown_arrow.png"
								style="autosize" extendstyle="1111" />
						</image>
						<label name="errorTypeName" rect="7,0,112,50" text="正常"
							color="#0" extendstyle="1111" style="autosize" h-align="center"
							v-align="center" font-size="24"></label>
					</button>
				</node>
				<node name="errorNode" rect="0,60,460,0" extendstyle="1111"
					enable="false" active="false" visible="false" data="230">
					<label name="label1" rect="0,0,150,50" border="false" text="异常描述："
						h-align="right" v-align="center" color="#000000" font-size="22"
						extendstyle="1111"></label>
					<image rect="150,0,310,50" src="file://image/input.png"
						style="autosize" extendstyle="1111">
					</image>
					<edit name="exEdit" rect="155,0,300,50" border="false"
						v-center="true" extendstyle="1111"></edit>
					<label name="label1" rect="0,60,150,50" border="false" text="处理描述："
						h-align="right" v-align="center" color="#000000" font-size="22"
						extendstyle="1111"></label>
					<image rect="150,60,310,50" src="file://image/input.png"
						style="autosize" extendstyle="1111">
					</image>
					<edit name="doEdit" rect="155,60,300,50" border="false"
						v-center="true" extendstyle="1111"></edit>

					<button name="takePicBtn" rect="10,120,130,50" border="false"
						text="button1" color="#ffffff" OnSelect="takePicOnSelect"
						extendstyle="1111">
						<image rect="0,0,130,50" src="file://image/take_pic.png"
							style="autosize" extendstyle="1111">
						</image>
					</button>

					<panorama name="picPanorama" rect="150,120,310,100"
						extendstyle="0010" foreground="panoramaItem"></panorama>
				</node>
			</node>
			<node name="errorTypeSelectNode" rect="0,0,480,800" visible="false"
				enable="false">
				<button name="button" rect="0,0,480,800" border="false" text=""
					color="#ffffff" OnSelect="hideErrorSelected"></button>
				<image rect="70,170,340,180" src="file://image/input.png"
					style="sudoku-auto" extendstyle="1111" sudoku="15,15,15,15">
				</image>
				<button name="" rect="100,200,280,56" text="正常" color="#ffffff"
					extendstyle="1111" OnSelect="errorTypeOnSelect"
					normal="src:file://image/btn_bg_n.png;style:sudoku-auto;sudoku:15,15,15,15;color:#ffffff"
					sel="src:file://image/btn_bg_s.png;style:sudoku-auto;sudoku:15,15,15,15;color:#000000"
					font-size="24" data="01" />
				<button name="" rect="100,270,280,56" text="异常" color="#ffffff"
					extendstyle="1111" OnSelect="errorTypeOnSelect"
					normal="src:file://image/btn_bg_n.png;style:sudoku-auto;sudoku:15,15,15,15;color:#ffffff"
					sel="src:file://image/btn_bg_s.png;style:sudoku-auto;sudoku:15,15,15,15;color:#000000"
					font-size="24" data="02" />
			</node>

			<node name="panoramaItem" extendstyle="0010" visible="false"
				enable="false" active="false">
				<button name="picBtn1" rect="0,0,60,60" border="false" text=""
					color="#ffffff" OnSelect="picBtnOnSelect" extendstyle="1111">
					<image name="bg1" rect="0,0,60,60" src="" style="autosize"
						extendstyle="1111">
					</image>
				</button>
				<button name="picBtn2" rect="62,0,60,60" border="false" text=""
					color="#ffffff" OnSelect="picBtnOnSelect" extendstyle="1111">
					<image name="bg2" rect="0,0,60,60" src="" style="autosize"
						extendstyle="1111">
					</image>
				</button>
				<button name="picBtn3" rect="124,0,60,60" border="false"
					text="" color="#ffffff" OnSelect="picBtnOnSelect" extendstyle="1111">
					<image name="bg3" rect="0,0,60,60" src="" style="autosize"
						extendstyle="1111">
					</image>
				</button>
				<button name="picBtn4" rect="186,0,60,60" border="false"
					text="" color="#ffffff" OnSelect="picBtnOnSelect" extendstyle="1111">
					<image name="bg4" rect="0,0,60,60" src="" style="autosize"
						extendstyle="1111">
					</image>
				</button>
				<button name="picBtn5" rect="248,0,60,60" border="false"
					text="" color="#ffffff" OnSelect="picBtnOnSelect" extendstyle="1111">
					<image name="bg5" rect="0,0,60,60" src="" style="autosize"
						extendstyle="1111">
					</image>
				</button>
			</node>

		</node>
	</body>
    <![CDATA[

    require 'com_wondertek_dw.common.framework'
    local rootSprite
    local sampleList
    local editList
    local errorListTotalHeight = 0
    local curErrorBtn
    local id = ''
    local taskid = ''
    local data = {}
    local stations = {}
    --拍照显示图片
    local picPathAry1 = {}
    local picPathAry2 = {}
    local errorCount
    local selectIndex = 1
    local selectAry = {}
    local picPathList1 = {}
    --local picPathList2 = {}
    --local picPathAry2 = {{"file://image//label_blue_new.png","file://image//label_blue_new.png","file://image//label_blue_new.png"},{"file://image//label_blue_new.png","",""}}
    local bufferList = {}
    --提交时用字段
    local orderId
    ---------------------------------------callbacks--------------------------------
    -- @brief root子节点创建完事件
    function bodyBuildChildrenFinished(sprite)
        rootSprite = sprite
        sampleList = Sprite:findChild(rootSprite, "sampleList")
        editList = Sprite:findChild(sampleList, "editList")
    end
    -- @brief root节点消息方法
    function bodyOnSpriteEvent(msg, param)
        if msg == MSG_ACTIVATE then -- 页面激活
            local regHandle = Reg:create('xunjian')
            id = Reg:getString(regHandle, 'id')
            taskid = Reg:getString(regHandle, 'taskid')
            flag = Reg:getString(regHandle,'flag')
            local tijiaonode = Sprite:findChild(rootSprite,'NodeTitle')
            if flag=='3' then
                setAllShoworHide(Sprite:findChild(tijiaonode, 'btnForget'),0)
                else
                setAllShoworHide(Sprite:findChild(tijiaonode, 'btnForget'),1)
            end
            loadRequest()
            elseif msg == MSG_DEACTIVATE then
            --Scene:freeByHandle(rootSprite)
        end
    end
    -- @brief 插件消息方法
    function bodyOnPluginEvent(msg)
        if Loading:isShow() then Loading:close() end
        responseWarn(msg)
        if msg == 101 then
            data = Http:jsonDecode('pay_data')
            Log:write("data101 = ", data)
            if not data or type(data) ~= 'table' then
                Dialog:show(rootSprite, '返回数据格式错误', 'ok')
                return
            end
            if data ~= nil then
                if data.code == '0' then
                    setTopSpriteValue()
                    stations = data.stations
                    if #stations > 0 then
                        errorCount = #stations + 1
                        initPicPathList(#stations + 1)
                        fillContent(#stations + 1)
                        elseif stations[0] then
                        errorCount = 1
                        initPicPathList(1)
                        fillContent(1)
                        else
                        Dialog:show(rootSprite, '巡检任务明细暂无数据！', 'ok')
                    end
                    else
                    Dialog:show(rootSprite, getErrorCode(data.code), 'ok')
                end
                else
                Dialog:show(rootSprite, '未知错误！', 'ok')
            end
            elseif msg == 102 then -- 不提交图片时提交相应
            data = Http:jsonDecode('handled_data')
            Log:write("data102 = ", data)
            if not data or type(data) ~= 'table' then
                Dialog:show(rootSprite, '返回数据格式错误', 'ok')
                return
            end
            if data ~= nil then
                if data.code == '0' then
                    clearFromConfig()
                    Scene:setReturn(Alias.home, Alias.xunjianrenwu)
                    Scene:go(Alias.xunjianrenwu)
                    else
                    Dialog:show(rootSprite, getErrorCode(data.code), 'ok')
                end
                else
                Dialog:show(rootSprite, '未知错误！', 'ok')
            end
            elseif msg == 103 then
            local updateData = Http:jsonDecode('upload_data')
            Log:write("updateData103:", updateData)
            if updateData.code ~= '0' then
                Dialog:show('提示',getErrorCode(updateData.code) .. ' ，是否暂存？','ok_cancel','saveToConfig','doBack')
                else
                orderId = updateData.data
                getUploadUrl()
            end
            elseif msg == 104 then
            local uploadData = Http:xmlDecode('upload_url', 'RESULT')
            Log:write("upload url:", updateData)
            local url = uploadData.URL
            Log:write('url', url)
            local param = uploadData.PARAM
            if param then
                param = param .. '&'
                else
                param = ''
            end
            doRealUpload(url, param)
            elseif msg == 101 + MSG_CACHEDATA_RELOAD then -- 101请求的数据有更新
            elseif msg == MSG_NETWORK_ERROR then -- 拨号失败
            Log:write('拨号失败')
            elseif msg > MSG_NETWORK_ERROR then -- 请求超时
            Log:write('请求超时')
        end
    end
    -- @brief 按键响应处理
    function mainNodeOnKeyUp(sprite, kc)
        if kc == Key.F2 then -- 按下返回键
            Dialog:show('提示','是否保存该页面内容？','ok_cancel','saveToConfig','doBack')
            return 1
        end
    end
    ---------------------------------------util functions---------------------------
    function loadRequest()
        --local url = 'http://61.191.25.238:7011/nbspweb/webservice/wplan!doWebservice.action'
        local wholeUrl = getWholeUrl('nbspweb/webservice/wplan!doWebservice.action', "")
        Log:write("wholeUrl = ", wholeUrl)
        local param = '&code='..id..'&taskid='..taskid
        Log:write("param = ", param)
        Http:request('pay_data', wholeUrl, 101, {useCache = false, method = 'post', postData='&cmd=wlbxunjianDetail'..param})
        Loading:show(rootSprite)
    end
    function setTopSpriteValue()
        Sprite:setProperty(Sprite:findChild(rootSprite, "location"), 'text', data.planName)
        Sprite:setProperty(Sprite:findChild(rootSprite, 'group'), 'text', data.patrolgroupname)
        Sprite:setProperty(Sprite:findChild(rootSprite, 'type'), 'text', data.businessTypename)
        Sprite:setProperty(Sprite:findChild(rootSprite, 'time'), 'text', data.startTime)
    end
    function fillContent(count)
        --local regHandle = Reg:create('xunjian')
        local sampleList = Sprite:findChild(rootSprite, "sampleList")
        local editList = Sprite:findChild(sampleList, "editList")
        ListView:removeAllItems(editList, 1, 1)
        ListView:loadItem(editList, Sprite:findChild(rootSprite, 'itemNode'), count, 'loadListItem')
        local x,y,w,h = Sprite:getRect(editList)
        Sprite:setRect(editList, x,y,w, errorListTotalHeight)
        Sprite:setRect(Sprite:getParent(editList), x,y,w, errorListTotalHeight)
        ListView:adjust(editList)
        ListView:adjust(sampleList)
        Log:write('11111', Sprite:getRect(sampleList))
    end
    function loadListItem(list, item, index)
        Sprite:setRect(item, 0,0,460,60)
        Sprite:setProperty(item, 'extendstyle', '1111')
        local errorTitle = Sprite:findChild(item, 'errorTitle')
        local errorBtn = Sprite:findChild(item, 'errorBtn')
        local takePicBtn = Sprite:findChild(item, 'takePicBtn')
        Sprite:setProperty(takePicBtn, 'data', index + 1)
        local errorNode = Sprite:findChild(item, 'errorNode')
        local exEdit = Sprite:findChild(item, 'exEdit')
        local doEdit = Sprite:findChild(item, 'doEdit')
        Sprite:setProperty(errorTitle, 'text', (index + 1)..'、'..stations[index].resourceTypename  .. '-' .. stations[index].name)
        --带入上次缓存起来的数据
        local bufferStr = Config:get(stations[index].resourceId)
        Log:write("bufferStr = ", bufferStr)
        Log:write("stations[index].resourceId = ", stations[index].resourceId)
        --bufferStr = "123;456;file://image//label_blue_new.png|file://image//label_blue_new.png"
        if bufferStr ~= nil and bufferStr ~= "" then
            local bufferStrAry = Util:split(bufferStr, ";")
            if bufferStrAry[1] ~= nil and bufferStrAry[1] ~= "" then
                Sprite:setProperty(exEdit, "text", bufferStrAry[1])
            end
            if bufferStrAry[2] ~= nil and bufferStrAry[2] ~= "" then
                Sprite:setProperty(doEdit, "text", bufferStrAry[2])
            end
            --如果缓存的图片不为空
            if bufferStrAry[3] ~= nil and bufferStrAry[3] ~= "" then
                local pathBufferAry = stringToTable(bufferStrAry[3])
                picPathList1[index + 1] = pathBufferAry
                Log:write("==picPathList1==", picPathList1)
                -----------加载Panorama控件-----------
                picPathAry2 = pathAry2Ary(pathBufferAry)
                --获取对应下标的控件刷新
                local ePanorama = Sprite:findChild(item, 'picPanorama')
                local eItem = Sprite:findChild(rootSprite, 'panoramaItem')
                Panorama:removeAllItems(ePanorama, 1, 1)
                Panorama:loadItem(ePanorama, eItem, #picPathAry2, 'panoramaLoadItem')
                Panorama:adjust(ePanorama)
            end
        end
        --动态设置高度
        if Sprite:getData(errorBtn) == '01' then
            Log:write(12)
            setAllShoworHide(errorNode, 0)
            else
            Log:write(13)
            setAllShoworHide(errorNode, 1)
            Sprite:setRect(item, 0,0,460,60 + 200)
        end
        Log:write(14)
        local x,y,w,h = Sprite:getRect(item)
        Log:write(15, h)
        Sprite:setProperty(item, 'data', h)
        errorListTotalHeight = errorListTotalHeight + h
        Log:write(16, errorListTotalHeight)
    end
    function errorOnSelect(sprite)
        local btnData = Sprite:getData(sprite)
        curErrorBtn = sprite
        setAllShoworHide(Sprite:findChild(rootSprite, 'errorTypeSelectNode'), 1)
    end
    function errorTypeOnSelect(sprite)
        local btnData = Sprite:getData(sprite)
        local errorText = Sprite:findChild(curErrorBtn, 'errorTypeName')
        Sprite:setProperty(curErrorBtn, 'data', btnData)
        if btnData == '01' then
            --正常
            Sprite:setProperty(errorText, 'text', '正常')
            elseif btnData == '02' then
            --异常
            Sprite:setProperty(errorText, 'text', '异常')
        end
        doChangeListHeight(curErrorBtn)
        setAllShoworHide(Sprite:findChild(rootSprite, 'errorTypeSelectNode'), 0)
    end
    function hideErrorSelected(sprite)
        setAllShoworHide(Sprite:findChild(rootSprite, 'errorTypeSelectNode'), 0)
    end
    function doChangeListHeight(sprite)
        local sampleList = Sprite:findChild(rootSprite, 'sampleList')
        local errorList = Sprite:findChild(sampleList, 'editList')
        local item = Sprite:getParent(Sprite:getParent(sprite))
        local btnData = Sprite:getData(sprite)
        local x,y,w,h = Sprite:getRect(item)
        local errorNode = Sprite:findChild(item, 'errorNode')
        Log:write(1, h)
        if btnData == '01' then
            Log:write(2)
            --收缩
            if h > 100 then
                errorListTotalHeight = errorListTotalHeight - tonumber(Sprite:getData(errorNode))
                setAllShoworHide(errorNode, 0)
                Sprite:setRect(item, x, y, w, h-tonumber(Sprite:getData(errorNode)))
            end
            elseif btnData == '02' then
            Log:write(3)
            --扩展
            if h < 100 then
                Log:write(4)
                errorListTotalHeight = errorListTotalHeight + tonumber(Sprite:getData(errorNode))
                setAllShoworHide(errorNode, 1)
                Sprite:setRect(item, x, y, w, h+tonumber(Sprite:getData(errorNode)))
            end
        end
        Log:write(5)
        ListView:adjust(errorList)
        local x,y,w,h = Sprite:getRect(errorList)
        Log:write(6, x, y, w, h, errorListTotalHeight)
        Sprite:setRect(errorList, x, y, w, errorListTotalHeight)
        Sprite:setRect(Sprite:getParent(errorList), x, y, w, errorListTotalHeight)
        ListView:adjust(Sprite:getParent(Sprite:getParent(errorList)))
        Log:write(7, Sprite:getRect(errorList))
        Log:write('2222', Sprite:getRect(Sprite:getParent(Sprite:getParent(errorList))))
    end
    function isSave(sprite)
        Dialog:show('提示','是否保存该页面内容？','ok_cancel','saveToConfig','doBack')
    end
    function doSave(sprite)
        --local url = 'http://61.191.25.238:7011/nbspweb/webservice/wplan!doWebservice.action'
        local wholeUrl = getWholeUrl('nbspweb/webservice/wplan!doWebservice.action', "")
        Log:write("wholeUrl = ", wholeUrl)
        local param = '&code='..id..'&taskid='..taskid..'&dealflag='..'pass'..'&content='..'同意'
        Log:write("param = ", param)
        Http:request('handled_data', wholeUrl, 102, {useCache = false, method = 'post', postData='&cmd=wlbxunjianAudit'..param})
        Loading:show(rootSprite)
    end
    function doBack(sprite)
        Scene:freeByHandle(rootSprite)
        Scene:back()
    end
    function submitOnSelect(sprites)
        Dialog:show('提示','是否确定提交此隐患？','ok_cancel','doUpload','doBack')
    end
    function doUpload()
        doSave()
    end
    --缓存填写数据到本地
    function saveToConfig()
        for i = 0, #stations do
            local item = ListView:getItem(editList, i)
            local exEdit = Sprite:findChild(item, "exEdit")
            local doEdit = Sprite:findChild(item, "doEdit")
            Config:set(stations[i].resourceId, Sprite:getText(exEdit)..";"..Sprite:getText(doEdit)..";"..tableToString(picPathList1[i + 1]))
            Config:set(taskid, "1234") -- 为了记忆巡检任务是否缓存
        end
        doBack()
    end
    --提交时清除本地缓存数据
    function clearFromConfig()
        for i = 0, #stations do
            Config:delete(stations[i].resourceId)
            Config:delete(taskid)
        end
    end
    function tableToString(tempTable)
        local result = ""
        for i = 1, #tempTable do
            result = result .. tempTable[i]
            if i < #tempTable then
                result = result .. "|"
            end
        end
        return result
    end
    function stringToTable(tempString)
        local resultTable = Util:split(tempString, "|")
        return resultTable
    end
    -----------------------------------拍照图片显示-----------------------------------
    function takePicOnSelect(sprite)
        selectIndex = tonumber(Sprite:getData(sprite))
        Log:write("selectIndex = ", selectIndex)
        local fileName = 'ict' .. getCurDateAndTime()
        local result = System:openCamera('onCameraDialog', 'file://image/' .. fileName .. '.jpg', 'jpg')
        if result == 0 then
            Dialog:show('提示', '相机打开失败!', 'ok')
            return 1
        end
    end
    function onCameraDialog(photoPath, photoType)
        picPathAry1 = picPathList1[selectIndex]
        local aryTemp = copyBufferAry(picPathAry1)
        table.insert(aryTemp, photoPath)
        picPathList1[selectIndex] = aryTemp
        Log:write("picPathList1 = ", picPathList1)
        Log:write("picPathAry1 count = ", #picPathAry1)
        picPathAry2 = pathAry2Ary(aryTemp)
        --picPathList2[selectIndex] = picPathAry2
        --获取对应下标的控件刷新
        local eNode = ListView:getItem(editList, selectIndex - 1)
        local ePanorama = Sprite:findChild(eNode, 'picPanorama')
        local eItem = Sprite:findChild(rootSprite, 'panoramaItem')
        Panorama:removeAllItems(ePanorama, 1, 1)
        Panorama:loadItem(ePanorama, eItem, #picPathAry2, 'panoramaLoadItem')
        Panorama:adjust(ePanorama)
    end
    --本地测试方法
    function addNewPic()
        Log:write("selectIndex = ", selectIndex)
        photoPath = "file://image//label_blue_new.png"
        Log:write("picPathList1 =0 ", picPathList1)
        picPathAry1 = picPathList1[selectIndex]
        local aryTemp = copyBufferAry(picPathAry1)
        table.insert(aryTemp, photoPath)
        picPathList1[selectIndex] = aryTemp
        Log:write("picPathList1 =1 ", picPathList1)
        Log:write("picPathAry1 = ", picPathAry1)
        Log:write("picPathAry1 count = ", #picPathAry1)
        picPathAry2 = pathAry2Ary(aryTemp)
        --picPathList2[selectIndex] = picPathAry2
        --获取对应下标的控件刷新
        local eNode = ListView:getItem(editList, selectIndex - 1)
        local ePanorama = Sprite:findChild(eNode, 'picPanorama')
        local eItem = Sprite:findChild(rootSprite, 'panoramaItem')
        Panorama:removeAllItems(ePanorama, 1, 1)
        Panorama:loadItem(ePanorama, eItem, #picPathAry2, 'panoramaLoadItem')
        Panorama:adjust(ePanorama)
        Log:write("resultStr = ", tableToString(picPathList1[selectIndex]))
        Log:write("resultTab = ", stringToTable(photoPath))
    end
    ------------------------------------List方式显示图片-----------------------------------------
    function loadPicList()
        Log:write("==loadPicList==")
        local picList = Sprite:findChild(rootSprite, 'picList')
        local picItem = Sprite:findChild(rootSprite, 'picItem')
        List:removeAllItems(picList, 1, 1)
        List:loadItem(picList, picItem, #picPathAry, 'loadPicListItem')
        List:adjust(picList)
    end
    function loadPicListItem(list, item, index)
        index = index + 1
        Sprite:setRect(item, 0, 0, 60, 60)
        Sprite:setProperty(item, 'extendstyle', '1010')
        local bg = Sprite:findChild(item, 'bg')
        local button = Sprite:findChildByClass(item, 'button')
        Sprite:setProperty(bg, 'src', picPathAry[index])
        Sprite:setProperty(button, 'data', picPathAry[index])
        Sprite:setProperty(item, 'data', index)
    end
    function listBuildChildrenFinished(sprite)
        local count = List:getItemCount(sprite)
        Sprite:setProperty(sprite, 'line', tostring(count))
        local x,y = Sprite:getRect(sprite)
        local height = 60 * count
        Sprite:setRect(sprite, x, y, 300, height)
        List:adjust(sprite)
    end
    function picBtnOnSelect(sprite)
        local path = Sprite:getData(sprite)
        local index = Sprite:getData(Sprite:getParent(sprite))
        local reg = Reg:create("imageDetail")
        Reg:setString(reg, "imageSrc", path)
        Scene:setReturn(Alias.xunjianEdit, Alias.imageDetail)
        Scene:go(Alias.imageDetail)
    end
    ------------------------------------Panorama方式显示图片-----------------------------------------
    function loadPicPanorama(count)
        local picPanorama = Sprite:findChild(rootSprite, 'picPanorama')
        local panoramaItem = Sprite:findChild(rootSprite, 'panoramaItem')
        Panorama:removeAllItems(picPanorama, 1, 1)
        Panorama:loadItem(picPanorama, panoramaItem, count, 'panoramaLoadItem')
        Panorama:adjust(picPanorama)
    end
    function panoramaLoadItem(panorama, item, index)
        index = index + 1
        Sprite:setRect(item, 0, 0, 310, 60)
        Sprite:setProperty(item, 'extendstyle', '1010')
        local picBtn1 = Sprite:findChild(item, 'picBtn1')
        local picBtn2 = Sprite:findChild(item, 'picBtn2')
        local picBtn3 = Sprite:findChild(item, 'picBtn3')
        local picBtn4 = Sprite:findChild(item, 'picBtn4')
        local picBtn5 = Sprite:findChild(item, 'picBtn5')
        local bg1 = Sprite:findChild(picBtn1, 'bg1')
        local bg2 = Sprite:findChild(picBtn2, 'bg2')
        local bg3 = Sprite:findChild(picBtn3, 'bg3')
        local bg4 = Sprite:findChild(picBtn4, 'bg4')
        local bg5 = Sprite:findChild(picBtn5, 'bg5')
        Sprite:setProperty(bg1, 'src', picPathAry2[index][1])
        Sprite:setProperty(bg2, 'src', picPathAry2[index][2])
        Sprite:setProperty(bg3, 'src', picPathAry2[index][3])
        Sprite:setProperty(bg4, 'src', picPathAry2[index][4])
        Sprite:setProperty(bg5, 'src', picPathAry2[index][5])
        Sprite:setProperty(picBtn1, 'data', picPathAry2[index][1])
        Sprite:setProperty(picBtn2, 'data', picPathAry2[index][2])
        Sprite:setProperty(picBtn3, 'data', picPathAry2[index][3])
        Sprite:setProperty(picBtn4, 'data', picPathAry2[index][4])
        Sprite:setProperty(picBtn5, 'data', picPathAry2[index][5])
        Sprite:setProperty(item, 'data', index)
    end
    function pathAry2Ary(pathAry)
        local num = 0
        local objectAry = {}
        local line = math.ceil(#pathAry/5)
        Log:write("line = ", line)
        for i = 1, line do
            objectAry[i] = {}
            for j = 1, 5 do
                num = num + 1
                if pathAry[num] == nil or pathAry[num] == "" then
                    objectAry[i][j] = ""
                    else
                    objectAry[i][j] = pathAry[num]
                end
            end
        end
        Log:write("objectAry = ", objectAry)
        return objectAry
    end
    function initPicPathList(count)
        local tempAry = {}
        for i = 1, count do
            picPathList1[i] = tempAry
        end
    end
    function copyBufferAry(ary)
        local tempAry = {}
        for i = 1, #ary do
            tempAry[i] = ary[i]
        end
        return tempAry
    end
    --------------------------------------------------------------------------------------------------
    function doUploadRequest()
        --local url = 'http://61.191.25.238:7011/nbspweb/webservice/wplan!doWebservice.action'
        local wholeUrl = getWholeUrl('nbspweb/webservice/wplan!doWebservice.action', "")
        Log:write("wholeUrl = ", wholeUrl)
        local param = '&code='..id..'&taskid='..taskid..'&dealflag='..'pass'..'&content='..'同意'
        Log:write("param = ", param)
        Http:request('upload_data', wholeUrl, 103, {useCache = false, method = 'post', postData='&cmd=wlbxunjianAudit'..param})
        Loading:show(rootSprite)
    end
    function getUploadUrl()
        for i = 1, #picPathList1 do
            if picPathList1[i] ~= nil and #picPathList1[i] > 0 then
                for j = 1, #picPathList1[i] do
                    Log:write("picPathList1[i][j] = ", picPathList1[i][j])
                    local _,_,fileName = string.find(picPathList1[i][j], '([^/\\%.]+)%.?[^/\\]*$')
                    Log:write("fileName = ", fileName)
                    local url = 'http://61.191.25.238:7011/nbspweb/upload/UGC_GetUploadUrl.html'
                    local param = 'FILE_NAME=' .. fileName ..
                    '&C_TYPE=' .. 'jpg' .. '&C_LEN=' .. "4"--IO:fileSize(picPathList1[i][j])
                    Log:write("-------------url upload------------", url .. param)
                    Http:request('upload_url' .. 1000 * i + j, url, 1000 * i + j, {useCache = false, method = 'post', postData= param})
                end
                else
                if Loading:isShow() then Loading:close() end
            end
        end
    end
    function responseWarn(msg)
        Log:write("msg = ", msg)
        for i = 1, #picPathList1 do
            if picPathList1[i] ~= nil and #picPathList1[i] > 0 then
                for j = 1, #picPathList1[i] do
                    if msg == 1000 * i + j then
                        local uploadData = Http:xmlDecode('upload_url'.. 1000 * i + j, 'RESULT')
                        Log:write("upload url:", updateData)
                        local url = uploadData.URL
                        Log:write('url', url)
                        local param = uploadData.PARAM
                        if param then
                            param = param .. '&'
                            else
                            param = ''
                        end
                        doRealUpload(url, param, i, j)
                    end
                end
            end
        end
    end
    function doRealUpload(url, param, i, j)
        Log:write("i = ", i)
        Log:write("j = ", j)
        orderId = "123"
        local _,_,fileName = string.find(picPathList1[i][j], '([^/\\%.]+)%.?[^/\\]*$')
        local poststr = 'id=' .. orderId .. '&markid='..stations[i - 1].resourceId..'&interfaceMainType=2&usercode=' .. Config:get('username') .. '&uploadFileName=' .. fileName .. '.jpg'
        deleleUploadItems()
        Upload:append(url, param .. poststr, picPathList1[i][j], fileName .. '.jpg', 'test', 'jpg')
        Timer:set(1, 500, 'onGetUploadStatus')
    end
    function onGetUploadStatus()
        Log:write('onGetUploadStatus=========================')
        local status = Upload:getStatus()
        Log:write('status', status)
        if status[1].status == 5 then
            deleleUploadItems()
            if Loading:isShow() then Loading:close() end
            Dialog:show('', '信息发布成功！', 'ok', 'doBack')
            elseif status[1].status == 6 or status[1].status == 1 or status[1].status == 4 then
            deleleUploadItems()
            if Loading:isShow() then Loading:close() end
            Dialog:show('', '信息发布失败，请稍后再试！', 'ok')
            else
            Timer:set(1, 500, 'onGetUploadStatus')
        end
    end
    function deleleUploadItems()
        local count = Upload:getCount()
        for i=1,count do
            Upload:delete(i)
        end
    end
]]>
</root>
