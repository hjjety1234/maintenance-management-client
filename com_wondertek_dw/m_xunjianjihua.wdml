<?xml version="1.0" encoding="utf-8"?>
<!--
==
============================================================================
== | WonderTek [ 网络无处不在，沟通及时到达 ] ==
============================================================================
== | Copyright (c) 2012, WonderTek, Inc. All Rights Reserved. ==
============================================================================
== | Author: hewu2008 <hewu2008@gmail.com> ==
============================================================================
== | Desc: 页面描述 ==
============================================================================
-->
<root>
    <header />
    <body resolution="480,800" BuildChildrenFinished="bodyBuildChildrenFinished"
        OnSpriteEvent="bodyOnSpriteEvent" OnPluginEvent="bodyOnPluginEvent">
        
        <!-- 页面背景  -->
        <node rect="0,0,480,800" extendstyle="1111">
			<image name="background" rect="0,0,480,800" border="false"
			    src="file://image/background.png" style="autosize" extendstyle="1111">
			</image>
        </node>
                
        <!-- 页面头部  -->
        <node name="baseSprite" rect="0,0,480,66" extendstyle="1111">
            <image name="title" rect="0,0,480,66" border="false"
                src="file://image/nav_bar.png" style="autosize" extendstyle="1111">
                <label rect="0,0,480,66" text="巡检计划" color="#ffffff" v-align="center"
                    h-align="center" font-size="28" font-family="黑体"  extendstyle="1111" />
            </image>
            <!-- 返回首页按钮  -->
            <button name="backBtn" rect="20,13,60,40" normal="normal" sel="sel"
                OnSelect="doBack" extendstyle="1111">
                <image name="normal" rect="0,0,40,40" src="file://image/ico_home.png"
                    extendstyle="1111" />
                <image name="sel" rect="0,0,40,40" src="file://image/ico_home.png"
                    extendstyle="1111" />
            </button>
        </node>
        
        <!-- 页面主体  -->
        <node name="mainNode" rect="0,0,480,800" enable="true" active="true"
            OnKeyUp="mainNodeOnKeyUp" layouttype="1" extendstyle="1111">
            <node name="listNode" rect="0,60,480,740" extendstyle="1111">
                <listview name="sampleList" rect="0,10,480,730" extendstyle="1111">
                </listview>
            </node>
            <!-- 列表项模板  -->
            <node name="listitem" visible="false" enable="false" active="false"
                extendstyle="1011" rect="0,0,480,140">
                <button name="btnname" rect="5,5,470,130" OnSelect="itemOnSelect"
                    extendstyle="1111">
                    <image rect="0,0,470,130" border="false" src="file://image/tongxunlu_bg.png" 
                         style="autosize" sudoku="15,15,15,15" extendstyle="1111" />
                    <!-- 计划标题 -->
                    <image rect="10,15,30,30" border="false" src="file://image/ico_tieta.png" 
                          extendstyle="1111" />
                    <scrolltext name="texttitle" rect="50,10,370,30" text="萧县代维组2012年第四季度巡检" color="#303030" font-family="微软雅黑"
                        font-size="24" h-align="left" v-align="center" extendstyle="1111"
                        border="false" scroll="true" step="2" />
                    <label name="textTitle" rect="50,40,270,25" text="巡检完成数/总数 :" color="#5a5a5a" font-family="微软雅黑"
                        font-size="20" h-align="left" v-align="center" extendstyle="1111"
                        border="false" />
                    <label name="finished" rect="186,40,20,25" text="40" color="#0062ab" v-align="center"
                        h-align="center" font-size="20" font-family="微软雅黑" extendstyle="1111" />
                    <label rect="206,40,10,25" text="/" color="#303030" v-align="center"
                        h-align="left" font-size="20" font-family="微软雅黑" extendstyle="1111" />
                    <label name="total" rect="216,40,40,25" text="100" color="#dd512e" v-align="center"
                        h-align="left" font-size="20" font-family="微软雅黑" extendstyle="1111" />
                    
                    <label name="pollingRate" rect="283,40,100,25" text="巡检率 :" color="#5a5a5a" font-family="微软雅黑"
                    font-size="20" h-align="left" v-align="center" extendstyle="1111"
                    border="false" />
                    
                    <label name="textNum" rect="336,40,50,25" text="" color="#5a5a5a"  font-family="微软雅黑"
                    font-size="20" h-align="left" v-align="center" extendstyle="1111"
                    border="false" />
                    
                    <label name="planDate" rect="50,65,130,25" text="巡检计划日期 :" 
                    color="#5a5a5a" v-align="center" font-family="微软雅黑" 
                    h-align="left" font-size="20" extendstyle="1111" />
                    
                     <label name="publishDate" rect="155,65,130,25" text="" 
                    color="#5a5a5a" v-align="center" font-family="微软雅黑" 
                    h-align="left" font-size="20" extendstyle="1111" />
                    
                    <label name="endDateTitle" rect="50,90,130,25" text="巡检截止日期 :" 
                    color="#5a5a5a" v-align="center" font-family="微软雅黑" 
                    h-align="left" font-size="20" extendstyle="1111" />
                    
                    <label name="endDate" rect="155,90,130,25" text="" 
                    color="#5a5a5a" v-align="center" font-family="微软雅黑" 
                    h-align="left" font-size="20" extendstyle="1111" />
                    
                </button>
               
            </node>
            <!-- 无巡检任务时的提示信息  -->
            <node name="nullNode" rect="0,220,480,220" extendstyle="1010"
                visible="false" enable="false" active="false">
                <label rect="0,25,480,35" extendstyle="1010" text="暂无巡检任务"
                    h-align="center" v-align="center" color="#686868" font-size="24" />
            </node>
        </node>
    </body>
    <![CDATA[

require 'com_wondertek_dw.common.framework'
require 'framework.barcode'
local rootSprite
local data = {}
local flag
local list
local nullNode

-- 优化GPS用户体验，在巡检计划中提前开启gps
-- 如果获得经纬度，则直接传给下一个页面
-- local longitude = 1172513390
-- local latitude = 318494380
local longitude = 0
local latitude = 0

---------------------------------------callbacks--------------------------------
-- @brief root子节点创建完事件
function bodyBuildChildrenFinished(sprite)
    rootSprite = sprite
    nullNode = Sprite:findChild(rootSprite, 'nullNode')
    list = Sprite:findChild(rootSprite, 'sampleList')
    getCurrentLoc()
end

-- @brief root节点消息方法
function bodyOnSpriteEvent(msg, param)
    if msg == MSG_ACTIVATE then -- 页面激活
        loadRequest()
    elseif msg == MSG_DEACTIVATE then
    end
end

-- @brief 插件消息方法
function bodyOnPluginEvent(msg)
    showOrHideNullNode(0)
    if Loading:isShow() then Loading:close() end
    if msg == 101 then
        data = Http:jsonDecode('pay_data')
        Log:write("data101 = ", data)
        if not data or type(data) ~= 'table' then
            Dialog:show(rootSprite, '返回数据格式错误', 'ok')
            return
        end
        if data ~= nil then
            if data.code == '0' then
                -- 对巡检计划按发布时间进行排序
                sortFunc = function(a, b) return a.startTime > b.startTime end
                table.insert(data.value, data.value[0])
                table.sort(data.value, sortFunc)
                Log:write('sorted datavalue:', data.value)
                loadList(#data.value)
            elseif data.code == '50' then 
                    showOrHideNullNode(1)
                    Dialog:show(rootSprite, '暂无待巡检任务！', 'ok')
            else
                showOrHideNullNode(1)
                Dialog:show(rootSprite, getErrorCode(data.code), 'ok')
            end
        else
            Dialog:show(rootSprite, '未知错误！', 'ok')
        end
    elseif msg ==102 then
        data = Http:jsonDecode('handled_data')
        Log:write("data102 = ", data)
        if not data or type(data) ~= 'table' then
            Dialog:show(rootSprite, '返回数据格式错误', 'ok')
            return
        end
        if data ~= nil then
            if data.code == '0' then
                if #data.value > 0 then
                    loadList(#data.value + 1)
                elseif data.value[0] then
                    loadList(1)
                else
                    showOrHideNullNode(1)
                    Dialog:show(rootSprite, '暂无已巡检任务！', 'ok')
                end
            else
                showOrHideNullNode(1)
                Dialog:show(rootSprite, getErrorCode(data.code), 'ok')
            end
        else
            Dialog:show(rootSprite, '未知错误！', 'ok')
        end
    elseif msg == 101 + MSG_CACHEDATA_RELOAD then -- 101请求的数据有更新
    elseif msg == MSG_NETWORK_ERROR then -- 拨号失败
        Log:write('拨号失败')
    elseif msg > MSG_NETWORK_ERROR then -- 请求超时
        Log:write('请求超时')
    end
end

-- @brief 按键响应处理
function mainNodeOnKeyUp(sprite, kc)
    if kc == Key.F2 then -- 按下返回键
        Scene:freeByHandle(rootSprite)
        Scene:back()
        return 1
    end
end

---------------------------------------util functions---------------------------
function loadRequest()
    local param = 'cmd=wlbxunjianPatrolList&page=1'
    local Url = getWholeUrl('nbspweb/webservice/wplan!doWebservice.action', param)
    Http:request('pay_data', Url, 101, {useCache = false})
    --Loading:show(rootSprite)
end

function loadDoneRequest()
    local param = 'cmd=wlbxunjianPatrolList&page=1'
    local Url = getWholeUrl('nbspweb/webservice/wplan!doWebservice.action', param)
    Http:request('handled_data', Url, 102, {useCache = false})
    Loading:show(rootSprite)
end

function loadList(count)
    ListView:removeAllItems(list,true)
    ListView:loadItem(list, Sprite:findChild(rootSprite, 'listitem'), count, 'loadListItem')
    ListView:adjust(list)
end

function loadListItem(list, item, index)
    Sprite:setRect(item, 0, 0, 480, 140)
    
    -- 获取服务端的返回的字段
    index = index + 1
    local strFinished = data.value[index].finished
    if strFinished == nil then strFinished = '' end
    local strTotal = data.value[index].total
    if strTotal == nil then strTotal = '' end
    local startDate = string.sub(data.value[index].startTime, 1, 11)
    Log:write('+++++++++startDate++++++', startDate)
    local endDate = string.sub(data.value[index].endTime, 1, 11)
     Log:write('+++++++++endDate++++++', endDate)
     local polling = math.floor(strFinished*100/strTotal)..'%'
    
    -- 获取列表项的Sprite
    Sprite:setProperty(item, 'extendstyle', '1111')
    local texttitle = Sprite:findChild(item, 'texttitle')
    local publishDate = Sprite:findChild(item, 'publishDate')
    local btnname = Sprite:findChild(item, 'btnname')
    local finished = Sprite:findChild(item, 'finished')
    local total = Sprite:findChild(item, 'total')
    local endDatenode=Sprite:findChild(item, 'endDate')
     local textNum =Sprite:findChild(item, 'textNum')
   
    -- 显示到界面
    Sprite:setProperty(texttitle, 'text', data.value[index].planName)   -- 计划名称
    Sprite:setProperty(publishDate, 'text', startDate)     -- 发布时间
    Sprite:setProperty(finished, 'text', strFinished)                   -- 完成站点数
    Sprite:setProperty(total, 'text', strTotal)         -- 总数
    Sprite:setProperty(endDatenode, 'text', endDate)                          
   Sprite:setProperty(textNum, "text", polling)
    Sprite:setProperty(btnname, "data", index)   
end

function itemOnSelect(sprite)
    Sprite:killFocus(sprite)
    Sprite:releaseCapture(sprite)
    local index = tonumber(Sprite:getData(sprite))
    -- 获取计划信息
    local planId = data.value[index].id
    local planName = data.value[index].planName
    local templateId = data.value[index].templateId
    local businessType = data.value[index].businessType
    Log:write(string.format('下标:%s 巡检计划Id=%s, 巡检模板Id=%s', index, planId, templateId))
    -- 页面传值，保证值都是新的
    local regHandle = Reg:create('xunjianrenwu')
    Reg:clear(regHandle)
    Reg:setString(regHandle, 'planId', planId)
    Reg:setString(regHandle, 'planName', planName)
    Reg:setString(regHandle, 'templateId', templateId)
    Reg:setString(regHandle, 'businessType', businessType)
    Reg:setString(regHandle, 'longitude', longitude)
    Reg:setString(regHandle, 'latitude', latitude)
    -- 页面跳转，跳转到站点列表
    Scene:setReturn(Alias.m_xunjianjihua, Alias.m_xunjianzhandian)
    Scene:go(Alias.m_xunjianzhandian, true)
end

function tabOnSelect(sprite)
    local tabNode = Sprite:getParent(sprite)
    local dataInfo = Sprite:getData(sprite)
    local tab1 = Sprite:findChild(tabNode, 'btnTab1')
    local tab2 = Sprite:findChild(tabNode, 'btnTab2')
    local tab3 = Sprite:findChild(tabNode, 'btnTab3')
    Sprite:setProperty(Sprite:findChild(tab1, 'tabBg'), 'src', 'file://image/tab_n.png')
    Sprite:setProperty(Sprite:findChild(tab2, 'tabBg'), 'src', 'file://image/tab_n.png')
    Sprite:setProperty(Sprite:findChild(tab3, 'tabBg'), 'src', 'file://image/tab_n.png')
    Sprite:setProperty(Sprite:findChild(sprite, 'tabBg'), 'src', 'file://image/tab_s.png')
    if dataInfo=='01' then
        flag='1'
        loadRequest()
    elseif dataInfo=='03' then
        flag='3'
        loadDoneRequest()
    end
end

function doBack(sprite)
    Scene:freeByHandle(rootSprite)
    Scene:back()
end

function showOrHideNullNode(showOrHide)
    if showOrHide == 0 then
        Sprite:setEnable(nullNode, 0)
        Sprite:setActive(nullNode, 0)
        Sprite:setVisible(nullNode, 0)
        Sprite:setEnable(list, 1)
        Sprite:setActive(list, 1)
        Sprite:setVisible(list, 1)
    else
        Sprite:setEnable(nullNode, 1)
        Sprite:setActive(nullNode, 1)
        Sprite:setVisible(nullNode, 1)
        Sprite:setEnable(list, 0)
        Sprite:setActive(list, 0)
        Sprite:setVisible(list, 0)
    end
end

function xianlu_onselected(sprite)
	Scene:go(Alias.m_xianluxunjian)
end
---------------------------------------GPS相关函数---------------------------
-- 取得当前的经纬度，设置全局变量
function getCurrentLoc()
    local result = System:getGPSStatus()
    if result == -1 then
       Log:write('gps不可用')
    elseif result == 0 then
        local gpsStatus = System:setGPSStatus(1)
        if gpsStatus then
            --Timer:set(111, 1000, '__getGpsData')
        else
           Log:write('gps开启失败')
        end
    elseif result == 1 then
        Log:write('gps已经开启')
        --Timer:set(111, 1000, '__getGpsData')
    end
end

-- gps已经打开的情况下，获取gps数据
function __getGpsData()
    longitude, latitude = System:getGPSData()
    -- 重设定时器
    Timer:set(111, 1000, '__getGpsData')
end

]]>
</root>
