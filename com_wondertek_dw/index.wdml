<?xml version="1.0" encoding="utf-8"?>
<!--
 == ============================================================================
 == | WonderTek [ 网络无处不在，沟通及时到达 ]
 == ============================================================================
 == | Copyright (c) 2012, WonderTek, Inc. All Rights Reserved.
 == ============================================================================
 == | Author: xxxx <xxxx@xxxx.com>
 == ============================================================================
 == | Desc: 登陆（入口）页
 == ============================================================================
-->
<root>
    <header/>
    <body resolution="640,960" BuildChildrenFinished="bodyBuildChildrenFinished" OnSpriteEvent="bodyOnSpriteEvent" OnPluginEvent="bodyOnPluginEvent">
        <node name="mainNode" rect="0,0,640,960" enable="true" active="true" OnKeyUp="mainNodeOnKeyUp" layouttype="1" extendstyle="1111">
            <image rect="0,0,0,0" extendstyle="0077" src="file://image/loading_bg.jpg" style="autosize"/>
            <image rect="0,0,0,0" extendstyle="0077" src="file://image/light.png" style="autosize"/>
            <button rect="300,300,42,43" extendstyle="1000" src="file://image/ball6.png" style="autosize"/>
            <button rect="200,420,123,240" extendstyle="1000" OnTick="icon6OnTick">
                <image rect="0,0,0,0" extendstyle="0077" src="file://image/icon6.png" style="autosize"/>
            </button>
            <button rect="230,480,157,149" extendstyle="1000" OnTick="icon7OnTick">
                <image rect="0,0,0,0" extendstyle="0077" src="file://image/icon7.png" style="autosize"/>
            </button>
            <button rect="300,550,131,125" extendstyle="1000" OnTick="icon1OnTick">
                <image rect="0,0,0,0" extendstyle="0077" src="file://image/icon1.png" style="autosize"/>
            </button>
            <button rect="400,240,61,60" extendstyle="1000" src="file://image/ball2.png" style="autosize"/>
            <button rect="310,570,132,128" extendstyle="1000" OnTick="icon2OnTick">
                <image rect="0,0,0,0" extendstyle="0077" src="file://image/icon2.png" style="autosize"/>
            </button>
            <button rect="280,500,130,221" extendstyle="1000" OnTick="icon3OnTick">
                <image rect="0,0,0,0" extendstyle="0077" src="file://image/icon3.png" style="autosize"/>
            </button>
            <button rect="220,600,95,107" extendstyle="1000" OnTick="icon4OnTick">
                <image rect="0,0,0,0" extendstyle="0077" src="file://image/icon4.png" style="autosize"/>
            </button>
            <button rect="150,420,56,50" extendstyle="1000" src="file://image/ball3.png" style="autosize"/>
            <button rect="260,580,110,124" extendstyle="1000" OnTick="icon5OnTick">
                <image rect="0,0,0,0" extendstyle="0077" src="file://image/icon5.png" style="autosize"/>
            </button>
            <button rect="280,555,113,109" extendstyle="1000" OnTick="icon8OnTick">
                <image rect="0,0,0,0" extendstyle="0077" src="file://image/icon8.png" style="autosize"/>
            </button>
            <button rect="520,370,49,49" extendstyle="1000" src="file://image/ball4.png" style="autosize"/>
            <button rect="280,540,63,61" extendstyle="1000" src="file://image/ball1.png" style="autosize"/>

            <label name="noticeLbl" rect="0,685,480,30" font-size="25" text="版本检测中..." v-align="center" h-align="center" color="#000000" extendstyle="1171" />
            <node name="downloadingNode" rect="0,660,0,30" visible="false" enable="false" extendstyle="1171">
                <image name="progressBg" rect="163,8,154,10" src="file://image/login_progress_bg.png" style="autosize" extendstyle="1111" />
                <image name="progressImg" rect="163,8,0,10" src="file://image/login_progress.png" style="sudoku-auto" sudoku="2,2,2,0" extendstyle="1111" />
                <label name="proLab" rect="320,0,160,26" text="0KB/0KB" font-size="25" color="#000000" v-align="center" h-align="left" extendstyle="1111" />
                <label name="speedLab" rect="0,0,160,26" text="0KB/S" font-size="25" color="#000000" v-align="center" h-align="right" extendstyle="1111" />
            </node>
        </node>
    </body>
    <![CDATA[

require 'com_wondertek_dw.common.framework'
local rootSprite
local noticeLbl = nil -- 提示语Label句柄
local downloadTime = 0
local packageUrl
local progressWidth = 154 -- 进度条长度
local downloadingNode
local speedLab
local proLab
local progressImg

---------------------------------------callbacks--------------------------------
-- @brief root子节点创建完事件
function bodyBuildChildrenFinished(sprite)
    rootSprite = sprite
    System:setFontSize()
    noticeLbl = Sprite:findChild(sprite, 'noticeLbl')
    downloadingNode = Sprite:findChild(sprite, 'downloadingNode')
    speedLab = Sprite:findChild(downloadingNode, 'speedLab')
    proLab = Sprite:findChild(downloadingNode, 'proLab')
    progressImg = Sprite:findChild(downloadingNode, 'progressImg')
    connectToNetWork()
end

-- @brief 跳转
function goHome()
    Scene:go(Alias.login)
    --[[
    if Config:get('isJump') == nil or Config:get('isJump') ~= '1' then
        Scene:go(Alias.jump)
    else
        Scene:go(Alias.login)
    end
    --]]
end

-- @brief root节点消息方法
function bodyOnSpriteEvent(msg, param)
    if msg == MSG_ACTIVATE then
        --checkClientVersion()
    elseif msg == MSG_DEACTIVATE then
        Scene:freeByHandle(rootSprite)
    elseif msg == MSG_NETWORK then
        Log:write('param', param)
        local paramFlag = param.flag
        local paramStatus = param.networkstatus
        if paramStatus == NETWORK_CONNECTED then
            checkClientVersion()
        elseif paramStatus == NETWORK_ERROR then
            if paramFlag == 5 then
                 Dialog:show('提示', 'APN设置失败，要打开系统设置界面进行设置吗？', 'ok_cancel', 'showSysSetting', 'exitApp')
            end
        end
    end
end

function showSysSetting()
    ShowNetSetting()
end

function exitApp()
    Scene:exit()
end

-- @brief 插件消息方法
function bodyOnPluginEvent(msg)
    if msg == 101 then
        local checkversionData = Http:jsonDecode('index_checkversion')
        if checkversionData then
            local versionTable = checkversionData.version
            if versionTable and versionTable.isNeedUpdate and versionTable.isNeedUpdate ~= '0' then
                packageUrl = versionTable.url
                if versionTable.isNeedUpdate == '1' then -- 提示升级
                    Dialog:show('', '检测到新的客户端版本，是否升级？', 'ok_cancel', 'downloadPackage', 'goHome')
                elseif versionTable.isNeedUpdate == '2' then -- 强制升级
                    Dialog:show('', '检测到新的客户端版本，是否升级？', 'ok_cancel', 'downloadPackage', 'doExit')
                end
            else
                Timer:set(1, 3000, 'goHome')
            end
        else
            Timer:set(1, 3000, 'goHome')
        end
    elseif msg == 101 + MSG_CACHEDATA_RELOAD then -- 101请求的数据有更新
    elseif msg == 101 + MSG_NETWORK_ERROR then -- 101请求的数据超时
    elseif msg == MSG_NETWORK_ERROR then -- 拨号失败
        Log:write('拨号失败')
    elseif msg > MSG_NETWORK_ERROR then -- 请求超时
        Log:write('请求超时')
    end
end

-- @brief 按键响应处理
function mainNodeOnKeyUp(sprite, kc)
    if kc == Key.F2 then -- 按下返回键
        Scene:exit()
        return 1
    end
end

function doExit()
    Scene:exit()
end

function fun(t, b, c, d)
    t = t / d
    return c * t * t * t + b
end

local t1 = 0
function icon1OnTick(sprite)
    local c = 550
    local d = 60
    local start = 550
    if t1 < d then
        t1 = t1 + 1
        if t1 > 75 then
            Sprite:setProperty(sprite, 'alpha', 255 - (t1 - 75) * 10)
        elseif t1 < 10 then
            Sprite:setProperty(sprite, 'alpha', t1 * 25)
        elseif t == 10 then
            Sprite:setProperty(sprite, 'alpha', 255)
        end
        Sprite:setRect(sprite, 300 + math.ceil(fun(t1, 0, 200, d)) / 3, start - math.ceil(fun(t1, 0, c, d)), 131, 125)
    else
        t1 = 0
        Sprite:setProperty(sprite, 'alpha', 0)
        Sprite:setRect(sprite, 300, start - math.ceil(fun(t1, 0, c, d)), 131, 125)
    end
end

local t2 = 0
function icon2OnTick(sprite)
    local c = 600
    local d = 100
    local start = 570
    if t2 < d then
        t2 = t2 + 1
        if t2 > 95 then
            Sprite:setProperty(sprite, 'alpha', 255 - (t2 - 95) * 10)
        elseif t2 < 10 then
            Sprite:setProperty(sprite, 'alpha', t2 * 25)
        elseif t2 == 10 then
            Sprite:setProperty(sprite, 'alpha', 255)
        end
        Sprite:setRect(sprite, 310 + math.ceil(fun(t2, 0, 200, d)) / 2, start - math.ceil(fun(t2, 0, c, d)), 132, 128)
    else
        t2 = 0
        Sprite:setProperty(sprite, 'alpha', 0)
        Sprite:setRect(sprite, 310, start - math.ceil(fun(t2, 0, c, d)), 132, 128)
    end
end

local t3 = 0
function icon3OnTick(sprite)
    local c = 400
    local d = 110
    local start = 500
    if t3 < d then
        t3 = t3 + 1
        if t3 > d - 25 then
            Sprite:setProperty(sprite, 'alpha', 255 - (t3 - (d - 25)) * 10)
        elseif t3 < 10 then
            Sprite:setProperty(sprite, 'alpha', t3 * 25)
        elseif t3 == 10 then
            Sprite:setProperty(sprite, 'alpha', 255)
        end
        Sprite:setRect(sprite, 280, start - math.ceil(fun(t3, 0, c, d)), 130, 221)
    else
        t3 = 0
        Sprite:setRect(sprite, 280, start - math.ceil(fun(t3, 0, c, d)), 130, 221)
    end
end

local t4 = 0
function icon4OnTick(sprite)
    local c = 600
    local d = 70
    local start = 600
    if t4 < d then
        t4 = t4 + 1
        if t4 > d - 25 then
            Sprite:setProperty(sprite, 'alpha', 255 - (t4 - (d - 25)) * 10)
        elseif t4 < 10 then
            Sprite:setProperty(sprite, 'alpha', t4 * 25)
        elseif t4 == 10 then
            Sprite:setProperty(sprite, 'alpha', 255)
        end
        Sprite:setRect(sprite, 220 - math.ceil(fun(t4, 0, 200, d)) / 2, start - math.ceil(fun(t4, 0, c, d)), 95, 107)
    else
        t4 = 0
        Sprite:setRect(sprite, 220, start - math.ceil(fun(t4, 0, c, d)), 95, 107)
    end
end

local t5 = 0
function icon5OnTick(sprite)
    local c = 580
    local d = 50
    local start = 580
    if t5 < d then
        t5 = t5 + 1
        if t5 > d - 25 then
            Sprite:setProperty(sprite, 'alpha', 255 - (t5 - (d - 25)) * 10)
        elseif t5 < 10 then
            Sprite:setProperty(sprite, 'alpha', t5 * 25)
        elseif t5 == 10 then
            Sprite:setProperty(sprite, 'alpha', 255)
        end
        Sprite:setRect(sprite, 260 - math.ceil(fun(t5, 0, 200, d)), start - math.ceil(fun(t5, 0, c, d)), 110, 124)
    else
        t5 = 0
        Sprite:setRect(sprite, 260, start - math.ceil(fun(t5, 0, c, d)), 110, 124)
    end
end

local t6 = 0
function icon6OnTick(sprite)
    local c = 380
    local d = 65
    local start = 420
    if t6 < d then
        t6 = t6 + 1
        if t6 > d - 25 then
            Sprite:setProperty(sprite, 'alpha', 255 - (t6 - (d - 25)) * 10)
        elseif t6 < 10 then
            Sprite:setProperty(sprite, 'alpha', t6 * 25)
        elseif t6 == 10 then
            Sprite:setProperty(sprite, 'alpha', 255)
        end
        Sprite:setRect(sprite, 200 - math.ceil(fun(t6, 0, 200, d)) / 2.5, start - math.ceil(fun(t6, 0, c, d)), 123, 240)
    else
        t6 = 0
        Sprite:setRect(sprite, 200, start - math.ceil(fun(t6, 0, c, d)), 123, 240)
    end
end

local t7 = 0
function icon7OnTick(sprite)
    local c = 450
    local d = 75
    local start = 480
    if t7 < d then
        t7 = t7 + 1
        if t7 > d - 25 then
            Sprite:setProperty(sprite, 'alpha', 255 - (t7 - (d - 25)) * 10)
        elseif t7 < 10 then
            Sprite:setProperty(sprite, 'alpha', t7 * 25)
        elseif t7 == 10 then
            Sprite:setProperty(sprite, 'alpha', 255)
        end
        Sprite:setRect(sprite, 230 - math.ceil(fun(t7, 0, 200, d)) / 2, start - math.ceil(fun(t7, 0, c, d)), 157, 149)
    else
        t7 = 0
        Sprite:setRect(sprite, 230, start - math.ceil(fun(t7, 0, c, d)), 157, 149)
    end
end

local t8 = 0
function icon8OnTick(sprite)
    local c = 505
    local d = 55
    local start = 555
    if t8 < d then
        t8 = t8 + 1
        if t8 > d - 25 then
            Sprite:setProperty(sprite, 'alpha', 255 - (t8 - (d - 25)) * 10)
        elseif t8 < 10 then
            Sprite:setProperty(sprite, 'alpha', t8 * 25)
        elseif t8 == 10 then
            Sprite:setProperty(sprite, 'alpha', 255)
        end
        Sprite:setRect(sprite, 280 + math.ceil(fun(t8, 0, 200, d)) / 2, start - math.ceil(fun(t8, 0, c, d)), 113, 109)
    else
        t8 = 0
        Sprite:setRect(sprite, 280, start - math.ceil(fun(t8, 0, c, d)), 113, 109)
    end
end

function connectToNetWork()
    local APNtype = Http:getCurrentAPNType()
    Log:write('APN类型为:'..APNtype)
    if APNtype == 1 then                     -- Net网
        Http:setProxy('')
    elseif APNtype == 2 then                 --移动wap
        Http:setProxy('http://10.0.0.172:80/')
    elseif APNtype == 3 then                 --电信wap
        Http:setProxy('http://10.0.0.200:80/')
    elseif APNtype == 4 then                 --联通wap
        Http:setProxy('http://10.0.0.172:80/')
    else
        Http:setProxy('')
    end
    Http:startNetwork()
end

---------------------------------------util functions---------------------------

function checkClientVersion()
    local updateUrl = 'http://192.168.1.88:8080/webcloud/sso/sso_auth.html?appkey=1111&version=' .. Config:get('app_version')
    Http:request('index_checkversion', updateUrl, 101, {useCache=false})
end

-- @brief 下载大升级安装包
function downloadPackage()
    if not packageUrl or '' == packageUrl then
        Dialog:show('', '返回下载地址为空，版本升级失败！【确定】继续进入，【取消】退出客户端！', 'ok_cancel', 'goHome', 'doExit')
        return
    end
    Sprite:setProperty(noticeLbl, 'text', '升级中')
    -- 删除缓存
    IO:dirRemove('CACHE:\\com_wondertek_dw', 1)
    -- 显示下载进度
    Sprite:setVisible(downloadingNode, 1)
    Sprite:setEnable(downloadingNode, 1)
    -- 开始下载
    require('framework.download')
    Log:write('xxxxxxx')
    Download:append('WONDER:\\temp\\' .. 'intallPackageName' .. '.apk', 'intallPackageName', packageUrl, true)
    Log:write('yyyyyyyyy')
    onGetDownloadStatus()
end

-- @brief 设置进度条及进度百分比
function setDownloadingProgress(percent)
    local x, y, _, h = Sprite:getRect(progressImg)
    Sprite:setRect(progressImg, x, y, progressWidth * percent / 100, h)
end

-- @brief 获取下载状态
function onGetDownloadStatus()
    local count = Download:getCount(true)
    Log:write('onGetDownloadStatus count===', count)
    downloadTime = downloadTime + 0.5
    for i = 1, count do
        local task = Download:getStatus(i, true)
        Log:write('task', task)
        if task.title == 'intallPackageName' then
            local percent = 0
            if task.size and task.maxsize and task.maxsize ~= 0 then
                percent = math.floor(task.size / task.maxsize * 100)
            end
            if task.status == Download.status.Downloading then -- 下载中
                setDownloadingProgress(percent)
                Sprite:setProperty(speedLab, 'text', math.floor(task.size / 1024 / downloadTime) .. 'KB/S')
                Sprite:setProperty(proLab, 'text', math.floor(task.size/1024) .. 'KB/' .. math.floor(task.maxsize/1024) .. 'KB')
            elseif task.status == Download.status.Finished then -- 下载完毕
                downloadTime = 0
                Sprite:setProperty(noticeLbl, 'text', '完成')
                Download:delete(i, false, true)
                Sprite:setProperty(speedLab,'text', '0KB/S')
                Sprite:setProperty(proLab, 'text', math.floor(task.maxsize/1024) .. 'KB/' .. math.floor(task.maxsize/1024) .. 'KB')
                setDownloadingProgress(100)
                Http:stopNetwork()
                -- 安装退出
                Util:installApp('WONDER:\\temp\\' .. 'intallPackageName' .. '.apk')
                -- 安装成功，重启时引擎将干掉module
                -- 清除cache
                IO:dirRemove('CACHE:\\com_wondertek_dw', 1)
                IO:dirCreate('CACHE:\\com_wondertek_dw')
                IO:dirCreate('CACHE:\\com_wondertek_dw\\image')
            end
            break
        end
    end
    Timer:set(111, 500, 'onGetDownloadStatus')
end

    ]]>
</root>
