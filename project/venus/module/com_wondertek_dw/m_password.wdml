<?xml version="1.0" encoding="utf-8"?>
<!--
 == ============================================================================
 == | WonderTek [ 网络无处不在，沟通及时到达 ]
 == ============================================================================
 == | Copyright (c) 2012, WonderTek, Inc. All Rights Reserved.
 == ============================================================================
 == | Author: jiangfeng 
 == ============================================================================
 == | Desc: 2013/1/22 修改密码
 == ============================================================================
-->
<root>
    <header/>
    <body resolution="480,800" BuildChildrenFinished="bodyBuildChildrenFinished"
        OnSpriteEvent="bodyOnSpriteEvent" OnPluginEvent="bodyOnPluginEvent">
        <!-- 主节点  -->
        <node name="mainNode" rect="0,0,480,800" enable="true" 
            active="true" OnKeyUp="mainNodeOnKeyUp" layouttype="1" extendstyle="1111">
	        <!-- 设置背景 -->
            <node name="baseSprite" rect="0,0,480,160" extendstyle="1111">
        	        <image rect="0,0,480,800" src="file://image/backgroundImg.png" style="autosize"
        	           extendstyle="1111" />
                <node rect="0,0,480,66" name="NodeTitle" extendstyle="1111">
                    <image name="titleBg" rect="0,0,480,66" src="file://image/title_bg_new.png"
                        extendstyle="1111" style="autosize" />

                    <button name="backBtn" rect="0,0,66,66" normal="normal" sel="sel"
                        OnSelect="doBack" extendstyle="1111">
                        <image name="normal" rect="15,8,75,75" src="file://image/skin/ico_back.png"
                             extendstyle="1111" />
                        <image name="sel" rect="15,8,75,75" src="file://image/skin/ico_back.png"
                             extendstyle="1111" />
                    </button>  
                    <scrolltext name="title" rect="105,5,280,40" text="修改密码" font-family='微软雅黑'
                        extendstyle="1111" font-size="36" h-align="center" v-align="center"
                        color="#ffffff" scroll="true"  step="2" />
                </node>
            </node>
             <!-- 密码提示问题提示内容 -->
            <node name="baseSprite" rect="0,67,415,60" extendstyle="1111">
              <image name="pswMark" rect="0,0,480,54" src="file://image/search_bg_n.png" style="autosize" extendstyle="1111" />
              <label name="answerLabel" rect="15,0,465,50" text="" color="#dd512e"
                        extendstyle="1111" style="autosize" h-align="left" v-align="center" font-family='微软雅黑'
                          font-size="24" />
            </node>
            <node name="baseSprite" rect="0,110,415,311" extendstyle="1111">
                <!-- 输入旧密码 -->
                <node name="baseSprite" rect="0,23,480,160" extendstyle="1111">
                    <image rect="24,0,432,64" src="file://image/password_bg.png" style="autosize"
                   extendstyle="1111" />
                    <image rect="42,17,28,28" src="file://image/system_password.png" style="autosize"
                   extendstyle="1111" />
                    <edit name="oldpassword" rect="95,0,300,66" extendstyle='1111' OnTextChanged="editOnTextChanged"
                        v-align="center" text="" color="#303030"   option="english,numeric" OnLostFocus="editOnLost" >
                        <label name="hideLabel" rect="0,10,278,42" text="请输入旧密码" color="#9e9d9d"
                            extendstyle="1111" style="autosize" h-align="left" v-align="center" font-family='微软雅黑'
                            font-size="24" />
                    </edit>
                    <image name="pswMark1" rect="420,17,26,25" src="file://image/ico_d.png" style="autosize" extendstyle="1111" visible="false"/>
                    <label name="oldpswLabel" rect="30,65,400,42" text="" color="#9e9d9d"
                            extendstyle="1111" style="autosize" h-align="left" v-align="center" font-family='微软雅黑'
                            font-size="24" />
                </node>
                <!-- 输入新密码 -->
                <node name="baseSprite" rect="0,130,480,160" extendstyle="1111">
                    <image rect="24,0,432,64" src="file://image/password_bg.png" style="autosize"
                   extendstyle="1111" />
                    <image rect="42,17,34,36" src="file://image/password_new.png" style="autosize"
                   extendstyle="1111" />
                    <edit name="newpassword" rect="95,0,300,66" extendstyle='1111' OnTextChanged="editOnTextChanged"
                        v-align="center" text=""  color="#303030"  option="english,numeric" OnLostFocus="newpswOnLost">
                        <label name="hideLabel" rect="0,10,278,42" text="请输入新密码" color="#9e9d9d"
                            extendstyle="1111" style="autosize" h-align="left" v-align="center" font-family='微软雅黑'
                            font-size="24" />
                    </edit>
                    <image name="newpswMark1" rect="420,17,26,25" src="file://image/ico_d.png" style="autosize" extendstyle="1111" visible="false"/>
                    <label name="newpswLabel" rect="30,65,400,42" text="" color="#9e9d9d"
                            extendstyle="1111" style="autosize" h-align="left" v-align="center" font-family='微软雅黑'
                            font-size="24" />
                </node>
                <!-- 再次输入新密码 -->
                <node name="baseSprite" rect="0,240,480,160" extendstyle="1111">
                    <image rect="24,0,432,64" src="file://image/password_bg.png" style="autosize" extendstyle="1111" />
                    <image rect="42,17,34,36" src="file://image/password_again.png" style="autosize" extendstyle="1111" />
                    <edit name="againpassword" rect="95,0,300,66" extendstyle='1111' OnTextChanged="editOnTextChanged"
                        v-align="center" color="#303030" text="" OnLostFocus="editnewpswOnLost">
                        <label name="hideLabel" rect="0,10,278,42" text="请再次输入新密码" color="#9e9d9d"
                            extendstyle="1111" style="autosize" h-align="left" v-align="center" font-family='微软雅黑'
                            font-size="24" />
                    </edit>
                    <image name="newpswMark" rect="420,17,26,25" src="file://image/ico_d.png" style="autosize" extendstyle="1111" visible="false"/>
                    <label name="againpswLabel" rect="30,65,400,42" text="" color="#9e9d9d"
                            extendstyle="1111" style="autosize" h-align="left" v-align="center" font-family='微软雅黑'
                            font-size="24" />
               </node>
               
               <node name="baseSprite" rect="0,440,480,80" extendstyle="1111">
                 <image rect="20,0,432,64" src="file://image/xialabg.png" style="autosize" extendstyle="1111"/>
                 <edit name="answer" rect="20,0,434,66" extendstyle='1111' OnTextChanged="editOnTextChanged"
                        v-align="center" color="#303030" text="" OnLostFocus="editnewpswOnLost">
                    <label name="hideLabel" rect="20,10,278,42" text="请输入你的问题答案" color="#9e9d9d"
                            extendstyle="1111" style="autosize" h-align="left" v-align="center" font-family='微软雅黑'
                            font-size="24" />
                </edit>
               </node>
            </node>
            <!-- 确定或取消或重置 -->
            <node name="baseSprite" rect="20,640,434,66" extendstyle="1111">
                <button name="defineBtn" rect="0,0,434,66"  style="autosize"  normal="normal" sel='sel' 
                    OnSelect="yesOn" extendstyle="1111">
                    <image name="normal" rect="0,0,434,66" src="file://image/pass_ok.png"  h-align="center"
                       extendstyle="1111"  style="autosize">
                    </image>
                    <image name="sel" rect="0,0,434,66" src="file://image/pass_ok_on.png" h-align="center"
                       extendstyle="1111" style="autosize">
                    </image>
                    <label name="hideLabel" rect="0,10,434,34" text="保存" color="#ffffff"
                            extendstyle="1111" style="autosize" h-align="center" v-align="center" font-family='微软雅黑'
                            font-size="32" />
                </button>
                <button name="cancelBtn" rect="0,90,434,66"  normal="normal" sel='sel'
                    OnSelect="noOn" extendstyle="1111"> 
                    <image name="normal" rect="0,0,434,66" src="file://image/pass_no.png"  h-align="center"
                       extendstyle="1111" style="autosize">
                    </image>
                    <image name="sel" rect="0,0,434,66" src="file://image/pass_no_on.png" h-align="center" extendstyle="1111" style="autosize"></image>
                    <label name="hideLabel" rect="0,10,434,34" text="取消" color="#ffffff"
                            extendstyle="1111" style="autosize" h-align="center" v-align="center" font-family='微软雅黑'
                            font-size="32" />
                </button>
              
            </node>

            <!-- 下拉框  -->
            <node name="pswSelectNode" rect="0,0,480,800" mushroom="false" visible="false" enable="false">
                <shadow rect="0,0,480,800" color="#333333" extendstyle="1111" alpha="125"/>
                <button name="button" rect="0,0,480,800" OnSelect="hidepswSelected"></button>
                <image rect="20,515,432,164" src="file://image/xialabg.png" style="autosize" extendstyle="1111" />
                <listview name="listSelect" rect="0,515,480,170" auto-scroll="true" style="autosize"
                    auto-adjust="true" extendstyle="1111"/>
              
            </node>
            <node name="selectItem" rect="0,500,480,50" visible="false" enable="false" active="false">                   
              <button name="pswGroupBtn" rect="30,5,342,50" text="" color="#303030" h-align="left" v-align="center" font-family="微软雅黑" font-size="24" style="autosize" 
                    extendstyle="0010" OnSelect="pswGroupOnSelect"  normal="" sel="" data="0">
              </button>
              <image rect="20,10,432,1" src="file://image/mimaline.png"  style="autosize" extendstyle="1114" border="1"/>
            </node>
            <!-- 密码提示问题 -->
               <node name="baseSprite" rect="0,460,480,80" extendstyle="1111">
                  <button name="pswBtn" rect="20,0,432,64"  src=""
                    OnSelect="pswOnselect" extendstyle="1111" > 
                    <image rect="0,0,432,64" src="file://image/xialabg.png" style="autosize" extendstyle="1111"/>
                    <scrolltext name="name" rect="20,10,300,35" text="请选择您的密码提示问题" color="#9e9d9d" extendstyle="1111"
                                style="autosize" scroll="true" h-align="left" v-align="center" font-size="24" >
                    </scrolltext>
                    <image  rect="400,25,16,14" src="file://image/mimajt.png" style="autosize" extendstyle="1111"/>
                  </button>
               </node>
        </node>
    </body>
    <![CDATA[

require 'com_wondertek_dw.common.framework'
local rootSprite
local oldpassword = ''
local newpassword = ''
local againpassword = ''
local pswSelectNode
local curpswBtn
local pswData
---------------------------------------callbacks--------------------------------
-- @brief root子节点创建完事件
function bodyBuildChildrenFinished(sprite)
    rootSprite = sprite
    pswSelectNode = Sprite:findChild(rootSprite,"pswSelectNode")
    local param = 'cmd=wlbtakesecurityauth&usercode=' .. Config:get('username')
    local url = getWholeUrl('nbspweb/webservice/common!doWebservice.action', param)
    Http:request('pswselect', url, 102, {useCache = true})
end

-- @brief root节点消息方法
function bodyOnSpriteEvent(msg, param)
    if msg == MSG_ACTIVATE then -- 页面激活
    elseif msg == MSG_DEACTIVATE then
    end
end

-- @brief 插件消息方法
function bodyOnPluginEvent(msg, param)
    if msg == 101 then  -- 判断修改结果是否正确
        local data = Http:jsonDecode('data')
       
        if data.result=='0' then 
            Dialog:show('', '修改密码成功', 'ok', 'okOn') 
        elseif data.result=='1' then
            Dialog:show('','服务器不稳定，请稍后再试','ok')
        elseif data.result=='-1' then
            Dialog:show('', '密码输入错误','ok')
        elseif data.result=='-2' then
            Dialog:show('', '验证问题回答不正确 ','ok')
        end   
    elseif msg==102 then
        pswData=Http:jsonDecode('pswselect')
        Log:write("为保证用户信息安全",pswData["result"])
        local answerLabel=Sprite:findChild(rootSprite,"answerLabel")
        if pswData["result"] == "0" then
          Sprite:setProperty(answerLabel,'text',"为保证用户信息安全，请设置密码提示问题")
        elseif pswData["result"] == "1" then
         Sprite:setProperty(answerLabel,'text',"为了保证用户信息安全，请验证密码提示问题")
        end
    elseif msg == 101 + MSG_CACHEDATA_RELOAD then -- 101请求的数据有更新
    elseif msg == 101 + MSG_NETWORK_ERROR then -- 101请求的数据超时
    elseif msg == MSG_NETWORK_ERROR then -- 拨号失败
        Log:write('拨号失败')
    elseif msg > MSG_NETWORK_ERROR then -- 请求超时
        Log:write('请求超时')
    end
end

-- @brief 按键响应处理
function mainNodeOnKeyUp(sprite, kc)
    if kc == Key.F2 then -- 按下返回键
        doBack()
        return 1
    end
end

-- 返回上一个页面
function doBack()
    Scene:back()
end
--点击确定
function yesOn()
    local oldpassword = Sprite:getText(Sprite:findChild(rootSprite,'oldpassword'))
    local newpassword = Sprite:getText(Sprite:findChild(rootSprite,'newpassword'))
    local againpassword = Sprite:getText(Sprite:findChild(rootSprite,'againpassword'))
    local pswBtn = Sprite:findChild(rootSprite,'pswBtn')
    local question = Sprite:getText(Sprite:findChild(pswBtn,'name'))
    local answerLab= Sprite:findChild(rootSprite,'answer')
    local hideLabel =Sprite:findChild(answerLab,'hideLabel')
    Log:write("请输入你的问题答案=====",Sprite:getText(hideLabel))
    --判断是否输入数据
    if  oldpassword==nil or  oldpassword=='' then 
        Dialog:show('', '请输入旧密码','ok')
        return
    elseif newpassword==nil or  newpassword==''  or againpassword==nil or  againpassword=='' then 
        Dialog:show('', '请输入新密码','ok')
        return
    elseif newpassword~=againpassword then 
        Dialog:show('', '两次新密码应保持一致','ok')
        return
    elseif question=='请选择您的密码提示问题' then
        Dialog:show('', '请选择您的密码提示问题','ok')
        return
    elseif Sprite:getText(answerLab)=='' then
        Dialog:show('', '请输入你的问题答案','ok')
        return
    end
    request()
end
--点击取消
function noOn()
    Scene:go(Alias.m_system)
end
--上传修改数据
function request()
    local old = Sprite:findChild(rootSprite,'oldpassword')
    local again = Sprite:findChild(rootSprite,'againpassword')
    local pswGroupBtn = Sprite:findChild(rootSprite,'pswGroupBtn')
    local answer=Sprite:findChild(rootSprite,'answer')
    local oldpassword = Sprite:getText(old)
    local againpassword = Sprite:getText(again)
    local username = Config:get('username')
    local param = 'nbspweb/webservice/common!doWebservice.action?usercode='..username..'&oldpassword='..oldpassword..'&password='..againpassword..'&question='..Sprite:getData(pswGroupBtn)..'&answer='..Sprite:getText(answer)..'&cmd=wlbpassword'
    local url = getUrl()..param
    Log:write('修改密码保存url',url)
    Http:request('data', url, 101, {useCache = false})
    end 

function okOn()
    Scene:go(Alias.home_new)
end
--旧密码输入错误时显示错误标志
function editOnLost(sprite)
    local old = Sprite:findChild(rootSprite,'oldpassword')
    local pswMark=Sprite:findChild(rootSprite,'pswMark1')
    local oldpswLabel =  Sprite:findChild(rootSprite,'oldpswLabel')
    if Config:get("password") ~= Sprite:getText(old) then
         Sprite:setVisible(pswMark, 1)
         Sprite:setProperty(pswMark,'src','file://image/ico_d.png')
         Sprite:setProperty(oldpswLabel,'text','旧密码输入有误')
    else   
         Sprite:setVisible(pswMark, 1)  
         Sprite:setProperty(pswMark,'src','file://image/ico_y.png')
         Sprite:setProperty(oldpswLabel,'text','')
    end
end
--输入新密码不小于6位
function newpswOnLost()
   local newpassword = Sprite:getText(Sprite:findChild(rootSprite,'newpassword'))
   local newpswMark1 = Sprite:findChild(rootSprite,'newpswMark1')
   local newpswLabel =  Sprite:findChild(rootSprite,'newpswLabel')
    if string.len(newpassword)<6 then
       Sprite:setVisible(newpswMark1, 1)
       Sprite:setProperty(newpswMark1,'src','file://image/ico_d.png')
       Sprite:setProperty(newpswLabel,'text','输入密码不能小于6位')
    else
       Sprite:setVisible(newpswMark1, 1)  
       Sprite:setProperty(newpswMark1,'src','file://image/ico_y.png')
       Sprite:setProperty(newpswLabel,'text','')
    end
end
--两次输入密码判断标志
function editnewpswOnLost()
    local newpassword = Sprite:getText(Sprite:findChild(rootSprite,'newpassword'))
    local againpassword = Sprite:getText(Sprite:findChild(rootSprite,'againpassword'))
    local newpswMark = Sprite:findChild(rootSprite,'newpswMark')
    local againpswLabel =Sprite:findChild(rootSprite,'againpswLabel')
    if newpassword ~= againpassword then
        Sprite:setVisible(newpswMark, 1)
        Sprite:setProperty(newpswMark,'src','file://image/ico_d.png')
        Sprite:setProperty(againpswLabel,'text','两次输入密码不一致')
    else
        Sprite:setVisible(newpswMark, 1)  
        Sprite:setProperty(newpswMark,'src','file://image/ico_y.png')
        Sprite:setProperty(againpswLabel,'text','')
    end
    if string.len(againpassword)<6 then
        Sprite:setVisible(newpswMark, 1)
        Sprite:setProperty(newpswMark,'src','file://image/ico_d.png')
        Sprite:setProperty(againpswLabel,'text','输入密码不能小于6位')
    else 
        Sprite:setVisible(newpswMark, 1)  
        Sprite:setProperty(newpswMark,'src','file://image/ico_y.png')
        Sprite:setProperty(againpswLabel,'text','')
    end
end
--密码提示问题
function pswOnselect(sprite)
    local pswData = Sprite:getData(sprite)
    curpswBtn = sprite
    setAllShoworHide(Sprite:findChild(rootSprite, 'pswSelectNode'), 1)
    local list = Sprite:findChild(rootSprite, 'listSelect')
    local item = Sprite:findChild(rootSprite, 'selectItem')
    ListView:removeAllItems(list, 1, 1)
    ListView:loadItem(list, item, 3, 'loadSelectItem')
    ListView:adjust(list)
end
function hidepswSelected()
    setAllShoworHide(Sprite:findChild(rootSprite, 'pswSelectNode'), 0)
end
function loadSelectItem(list, item, index)
    Sprite:setRect(item, 0, 0, 480, 50)
    local button = Sprite:findChildByClass(item, 'button')
    Sprite:setProperty(item, 'extendstyle', '0010')
    Sprite:setProperty(button, 'text', "   "..defaultLevelOnSelect[index+1].name)
    Sprite:setProperty(button, 'data', defaultLevelOnSelect[index+1].id)
 end
defaultLevelOnSelect = {
    {name='您的故乡是？', id='0'},
    {name='您父亲的姓名？', id='1'},
    {name='您初中班主任的姓名？', id='2'},
}
function pswGroupOnSelect(sprite)
    local pswGroupData = Sprite:getData(sprite)
    local pswGroupText = Sprite:findChild(curpswBtn, 'name')
    local index = ListView:getItemIndex(Sprite:getParent(sprite))
    Sprite:setProperty(curpswBtn, 'data', Sprite:getProperty(sprite, 'data'))
    Sprite:setProperty(pswGroupText, 'text', defaultLevelOnSelect[index+1].name)
    setAllShoworHide(Sprite:findChild(rootSprite, 'pswSelectNode'), 0)
end
]]>
</root>
