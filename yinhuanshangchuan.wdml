<?xml version="1.0" encoding="utf-8"?>
	<!--
		==
		============================================================================
		== | WonderTek [ 网络无处不在，沟通及时到达 ] ==
		============================================================================
		== | Copyright (c) 2012, WonderTek, Inc. All Rights Reserved. ==
		============================================================================
		== | Author: xxxx <xxxx@xxxx.com> ==
		============================================================================
		== | Desc: 页面描述 ==
		============================================================================
	-->
<root>
	<header />
	<body resolution="480,800" BuildChildrenFinished="bodyBuildChildrenFinished"
		OnSpriteEvent="bodyOnSpriteEvent" OnPluginEvent="bodyOnPluginEvent">
		<shadow rect="0,0,480,800" color="#e8e8e8" alpha="255"
			extendstyle="1111" />
		<node name="mainNode" rect="0,0,480,800" enable="true" active="true"
			OnKeyUp="mainNodeOnKeyUp" layouttype="1" extendstyle="1111">
			<node name="baseSprite" rect="0,0,480,66" extendstyle="1111">
				<image name="title" rect="0,0,480,66" border="false"
					src="file://image/title_bg.png" style="autosize" extendstyle="1111">

					<label rect="0,0,480,66" text="隐患上传" color="#ffffff" v-align="center"
						h-align="center" font-size="28" extendstyle="1111" />
				</image>

				<button name="backBtn" rect="0,10,75,45" normal="normal" sel="sel"
					OnSelect="doBack" extendstyle="1111">
					<image name="normal" rect="0,0,75,45" src="file://image/title_back_n.png"
						style="autosize" extendstyle="1111">
					</image>
					<image name="sel" rect="0,0,75,45" src="file://image/title_back_s.png"
						style="autosize" extendstyle="1111">
					</image>
					<label rect="15,0,60,45" text="返回" color="#ffffff"
						extendstyle="1111" style="autosize" h-align="center" v-align="center"
						font-size="24"></label>
				</button>
				<button name="btnForget" rect="387,4,79,56" text="提交" color="#ffffff"
					extendstyle="1111" OnSelect="submitOnSelect"
					normal="src:file://image/btn_bg_n.png;style:sudoku-auto;sudoku:15,15,15,15;color:#ffffff"
					sel="src:file://image/btn_bg_s.png;style:sudoku-auto;sudoku:15,15,15,15;color:#000000"
					font-size="24" />
			</node>
			<node name="baseSprite" rect="0,70,480,60" extendstyle="1111">
				<label name="label1" rect="0,0,150,60" border="false" text="所属专业："
					h-align="right" v-align="center" color="#000000" font-size="24"
					extendstyle="1111"></label>
				<button name="button1" rect="150,0,292,60" border="false"
					text="" color="#ffffff" OnSelect="" extendstyle="1111">
					<image rect="0,0,292,60" src="file://image/input.png" style="autosize"
						extendstyle="1111">
						<image rect="245,5,43,51" src="file://image/dropdown_arrow.png"
							style="autosize" extendstyle="1111" />
					</image>
					<label rect="0,0,252,60" text="无线专业" color="#0" extendstyle="1111"
						style="autosize" h-align="center" v-align="center" font-size="24"></label>
				</button>
			</node>

			<node name="baseSprite" rect="0,140,480,60" extendstyle="1111">
				<label name="label1" rect="0,0,150,60" border="false" text="隐患类别："
					h-align="right" v-align="center" color="#000000" font-size="24"
					extendstyle="1111"></label>
				<button name="button1" rect="150,0,292,60" border="false"
					text="" color="#ffffff" OnSelect="" extendstyle="1111">
					<image rect="0,0,292,60" src="file://image/input.png" style="autosize"
						extendstyle="1111">
						<image rect="245,5,43,51" src="file://image/dropdown_arrow.png"
							style="autosize" extendstyle="1111" />
					</image>
					<label rect="0,0,252,60" text="火患" color="#0" extendstyle="1111"
						style="autosize" h-align="center" v-align="center" font-size="24"></label>
				</button>
			</node>
			<node name="baseSprite" rect="0,210,480,60" extendstyle="1111">
				<label name="label1" rect="0,0,150,60" border="false" text="隐患级别："
					h-align="right" v-align="center" color="#000000" font-size="24"
					extendstyle="1111"></label>
				<button name="button1" rect="150,0,292,60" border="false"
					text="" color="#ffffff" OnSelect="" extendstyle="1111">
					<image rect="0,0,292,60" src="file://image/input.png" style="autosize"
						extendstyle="1111">
						<image rect="245,5,43,51" src="file://image/dropdown_arrow.png"
							style="autosize" extendstyle="1111" />
					</image>
					<label rect="0,0,252,60" text="一级" color="#0" extendstyle="1111"
						style="autosize" h-align="center" v-align="center" font-size="24"></label>
				</button>
			</node>
			<node name="baseSprite" rect="10,280,460,270" extendstyle="1111">
				<image rect="0,0,460,270" src="file://image/title_edit_bg.png"
					style="sudoku-auto" extendstyle="1111" sudoku="20,20,20,20">
				</image>
				<edit name="edit" rect="10,10,440,250" border="false"
					extendstyle="1111" multiline="true" font-size="25" max-size="140"
					OnTextChanged="editOnTextChanged">
					<label name="hideLabel" rect="0,0,440,250" text="隐患详述" color="#c0c0c0"
						extendstyle="1111" style="autosize" h-align="left" v-align="top"
						font-size="24"></label>
				</edit>
			</node>
			<node name="baseSprite" rect="10,560,460,120" extendstyle="1111">

				<button name="pic1" rect="0,0,110,120" border="false" text=""
					color="#ffffff" OnSelect="picOnSelect" extendstyle="1111">
					<image name="bg" rect="0,0,110,120" src="" style="autosize"
						extendstyle="1111">
					</image>
				</button>
				<button name="pic2" rect="116,0,110,120" border="false" text=""
					color="#ffffff" OnSelect="picOnSelect" extendstyle="1111">
					<image name="bg" rect="0,0,110,120" src="" style="autosize"
						extendstyle="1111">
					</image>
				</button>
				<button name="pic3" rect="232,0,110,120" border="false" text=""
					color="#ffffff" OnSelect="picOnSelect" extendstyle="1111">
					<image name="bg" rect="0,0,110,120" src="" style="autosize"
						extendstyle="1111">
					</image>
				</button>
				<button name="pic4" rect="348,0,110,120" border="false" text=""
					color="#ffffff" OnSelect="picOnSelect" extendstyle="1111">
					<image name="bg" rect="0,0,110,120" src="" style="autosize"
						extendstyle="1111">
					</image>
				</button>
			</node>
			<node name="baseSprite" rect="0,723,480,80" extendstyle="1111">
				<image rect="0,0,480,80" src="file://image/bottom_bg.png"
					style="autosize" extendstyle="1111">
				</image>
				<button name="button1" rect="20,1,96,75" border="false" text=""
					color="#ffffff" OnSelect="bottomMenuSelect" extendstyle="1111"
					data="1">
					<image rect="0,0,96,75" src="file://image/ic_back_home.png"
						style="autosize" extendstyle="1111">
					</image>
				</button>
				<button name="button1" rect="136,1,96,75" border="false"
					text="" color="#ffffff" OnSelect="bottomMenuSelect" extendstyle="1111"
					data="2">
					<image rect="0,0,96,75" src="file://image/ic_location.png"
						style="autosize" extendstyle="1111">
					</image>
				</button>
				<button name="button1" rect="252,1,96,75" border="false"
					text="" color="#ffffff" OnSelect="bottomMenuSelect" extendstyle="1111"
					data="3">
					<image rect="0,0,96,75" src="file://image/ic_take_pic.png"
						style="autosize" extendstyle="1111">
					</image>
				</button>
				<button name="button1" rect="368,1,96,75" border="false"
					text="" color="#ffffff" OnSelect="bottomMenuSelect" extendstyle="1111"
					data="4">
					<image rect="0,0,96,75" src="file://image/ic_record.png"
						style="autosize" extendstyle="1111">
					</image>
				</button>
			</node>
			<label name="locInfo" rect="20,691,444,30" border="false" text=""
				h-align="left" v-align="center" color="#000000" font-size="18"
				extendstyle="1111"></label>
		</node>
	</body>
    <![CDATA[

    require 'com_wondertek_dw.common.framework'
    local rootSprite
    local observer
    local mapViewPlugin
    local picArray = {}
    ---------------------------------------callbacks--------------------------------
    -- @brief root子节点创建完事件
    function bodyBuildChildrenFinished(sprite)
        rootSprite = sprite
        observer = Plugin:getObserver()
        observer = Plugin:getObserver()
        local regHandle = Reg:create(Regs.regName)
        mapViewPlugin = Reg:getInteger(regHandle, "map_handle")
        if mapViewPlugin == 0 then
            mapViewPlugin = pluginCreate("MapView", "MapView")
            Reg:setInteger(regHandle, "map_handle", mapViewPlugin)
        end
        pluginInvoke(mapViewPlugin, "getCurrentPosition", observer, 1000)
        --Map:getCurPosition(observer, 1000)
        picArray = { Sprite:findChild(rootSprite, 'pic1'),
        Sprite:findChild(rootSprite, 'pic2'),
        Sprite:findChild(rootSprite, 'pic3'),
        Sprite:findChild(rootSprite, 'pic4')
        }
    end
    -- @brief root节点消息方法
    function bodyOnSpriteEvent(msg, param)
        if msg == MSG_ACTIVATE then -- 页面激活
            elseif msg == MSG_DEACTIVATE then
        end
    end
    -- @brief 插件消息方法
    function bodyOnPluginEvent(msg, param)
        if msg == 101 then
            elseif msg == 1000 then
            local postData = Param:getString(param, 0)
            if postData.latitude ~= nil then
                Config:set("latitude", postData.latitude)
            end
            if postData.longitude ~= nil then
                Config:set("longitude", postData.longitude)
            end
            if postData.longitude ~= nil and postData.latitude ~= nil then
                pluginInvoke(mapViewPlugin, "reverse", observer, 1001, tonumber(postData.latitude), tonumber(postData.longitude))
            end
            -- postData为Json数据({"latitude":"31250614","longitude":"121600975"})
            elseif msg == 1001 then
            local postData = Param:getString(param, 0)
            local locInfo = Sprite:findChild(rootSprite, 'locInfo')
            if postData.address ~= nil then
                Sprite:setProperty(locInfo, 'text', postData.address)
            end
            -- postData为Json数据({"address":"北京市西城区后红井胡同2号","city":"北京"})
            elseif msg == 101 + MSG_CACHEDATA_RELOAD then -- 101请求的数据有更新
            elseif msg == MSG_NETWORK_ERROR then -- 拨号失败
            Log:write('拨号失败')
            elseif msg > MSG_NETWORK_ERROR then -- 请求超时
            Log:write('请求超时')
        end
    end
    -- @brief 按键响应处理
    function mainNodeOnKeyUp(sprite, kc)
        if kc == Key.F2 then -- 按下返回键
            Scene:back()
            return 1
        end
    end
    ---------------------------------------util functions---------------------------
    function doBack()
        Scene:back()
    end
    function editOnTextChanged(sprite,ncount)
        local hideLabel = Sprite:findChild(sprite, 'hideLabel')
        if ncount > 0 then
            setAllShoworHide(hideLabel, 0)
            else
            setAllShoworHide(hideLabel, 1)
        end
    end
    function bottomMenuSelect(sprite)
        local dataInfo = Sprite:getData(sprite)
        if dataInfo == '1' then
            doBack()
            elseif dataInfo == '2' then
            doLocation()
            elseif dataInfo == '3' then
            doTakePic()
            elseif dataInfo == '4' then
            doRecord()
        end
    end
    function doLocation()
        local locInfo = Sprite:findChild(rootSprite, 'locInfo')
        Sprite:setProperty(locInfo, 'text', '正在定位......')
        pluginInvoke(mapViewPlugin, "getCurrentPosition", observer, 1000)
        --Map:getCurPosition(observer, 1000)
        if Config:get("latitude") ~= nil and Config:get("latitude") ~= '' and Config:get("longitude") ~= nil and Config:get("longitude") ~= '' then
            pluginInvoke(mapViewPlugin, "reverse", observer, 1001, tonumber(Config:get("latitude")), tonumber(Config:get("longitude")))
            --Map:getCurPosition(observer, 1001, tonumber(Config:get("latitude")), tonumber(Config:get("longitude")))
        end
    end
    function isSave(sprites)
        Dialog:show('提示','是否保存该内容？','ok_cancel','doSave','doBack')
    end
    function submitOnSelect(sprites)
        Dialog:show('提示','是否确定提交此隐患？','ok_cancel','doUpload','doBack')
    end
    function doUpload()
        doSave()
    end
    function doSave()
        doBack()
    end
    function doTakePic()
        local fileName = 'ict' .. getCurDateAndTime()
        local result = System:openCamera('onCameraDialog', 'file://image/' .. fileName .. '.jpg', 'jpg')
        if result == 0 then
            Dialog:show('提示', '相机打开失败!', 'ok')
            return 1
        end
    end
    function onCameraDialog(photoPath, photoType)
        for i=1, #picArray do
            local bg = Sprite:findChild(picArray[i], 'bg')
            if Sprite:getProperty(bg, 'src') == nil or Sprite:getProperty(bg, 'src') == '' then
                Sprite:setProperty(bg, 'src', photoPath)
                return
            end
        end
    end
    function doRecord()
        
    end
]]>
</root>
