<?xml version="1.0" encoding="utf-8"?>
<!--
 == ============================================================================
 == | WonderTek [ 网络无处不在，沟通及时到达 ]
 == ============================================================================
 == | Copyright (c) 2012, WonderTek, Inc. All Rights Reserved.
 == ============================================================================
 == | Author: xxxx <xxxx@xxxx.com>
 == ============================================================================
 == | Desc: 页面描述
 == ============================================================================
-->
<root>
    <header/>
    <body resolution="480,800" BuildChildrenFinished="bodyBuildChildrenFinished" OnSpriteEvent="bodyOnSpriteEvent" OnPluginEvent="bodyOnPluginEvent">
        <node name="mainNode" rect="0,0,480,800" enable="true" active="true" OnKeyUp="mainNodeOnKeyUp" layouttype="1" extendstyle="1111">
            <image name='citybgImg' rect="0,80,480,720" src="file://image/jttxl/bj.png" style="autosize" extendstyle="1111" />
            <node name="baseSprite" rect="0,0,480,80" extendstyle="1111" >
                <image name="title" rect="0,0,480,80" border="false" src="file://image/jttxl/top.png" style="autosize" extendstyle="1111" />
                <button name="fenleibtnName" rect="0,0,480,80" text="本机通讯录▼" color="#ffffff" v-align="center" h-align="center" OnSelect="fenleiBtnOnselect" font-family="微软雅黑" font-size="32" extendstyle="1111"  style='autosize' />
            </node>
            <node rect="0,85,480,62" extendstyle="1111" >
                <button rect="27,0,213,62"  extendstyle="1111"  style='autosize' src='file://image/jttxl/local_top_b1.png' OnSelect="jituanOnselect">
                    <label rect="0,0,213,50" text="安徽公司" font-family="微软雅黑" font-size="24" color="#ffffff" v-align="center" h-align="center" extendstyle="1111" />
                </button>
                <button rect="240,0,214,61"  extendstyle="1111"  style='autosize' src='file://image/jttxl/local_top_b2.png' >
                    <label rect="0,0,213,50" text="本机通讯录" font-family="微软雅黑" font-size="24" color="#ffffff" v-align="center" h-align="center" extendstyle="1111" />
                </button>
            </node>
            <!-- 设置搜索框 -->
            <node rect="28,138,406,90" extendstyle="1111">   
                <image name="searchInput" rect="0,10,406,67" src="file://image/jttxl/search_bj.png"
                    style='autosize' extendstyle="1111" />
                <image rect="15,24,40,39" src="file://image/jttxl/search.png"
                    style="autosize" extendstyle="1111"/>
                
                <!-- 编辑文本框 -->
                <edit name="keywordEdit" rect="60,10,290,70" h-align="left" v-align="center" 
                    font-family="微软雅黑" color="#605e5e" font-size="24" text="搜索姓名、号码" 
                    OnSetFocus="editOnSetFocus" OnLostFocus="editOnLostFocus" OnTextChanged="editOnTextChanged" extendstyle='1111'>
                </edit>
                <!-- 搜索输入框置空按钮 -->  
                <button name="resetBtn" rect="360,30,32,31" OnSelect="doCancel" visible="false" enable="false"
                    normal="src:file://image/jttxl/close_d.png;"
                    sel="src:file://image/jttxl/close_s.png;" style="autosize" extendstyle="1111">
                </button>             
            </node>
            <node rect="0,220,430,495" extendstyle="1111">
                <listview name="sampleList" rect="0,0,430,495" extendstyle="1111" />
            </node>
            <!-- 底部菜单  -->
            <node name="listNode" rect="0,720,480,80" extendstyle="1111">
                <image  rect="0,0,480,80" border="false" extendstyle="1111" 
                src="file://image/book/list_bg.png"  style="autosize"/>
                <!-- 搜索  -->
                <button name='searchBtn' rect="15,0,110,80"  extendstyle="1111"  style='autosize'
                src='file://image/book/lianxiren_d.png' OnSelect="doSearch"></button>
                <!-- 联系人  -->
                <button name='contactBtn' rect="125,0,110,80"  extendstyle="1111"  style='autosize'
                src='file://image/book/zuijinglianxiren_s.png' OnSelect="doContact"></button>
                <!-- 个人中心  -->
                <button name='personBtn' rect="250,0,82,80"  extendstyle="1111"  style='autosize'
                src='file://image/book/person_d.png' OnSelect="doPersonalCenter"></button>
                <!-- 设置  -->
                <button name='siteBtn' rect="385,0,48,80"  extendstyle="1111"  style='autosize'
                src='file://image/book/site_d.png' OnSelect="doSetting"></button>
                <!-- New -->
                <node name="newNode" rect="410,0,48,80" extendstyle="1111">
                    <image  rect="10,5,24,24" border="false" src="file://image/jttxl/new.png" 
                        style="autosize" extendstyle="1111" />
                </node>
            </node> 
            <node name="indexListNode" rect="430,140,50,570" extendstyle="1111">
                <list name="indexList" rect="0,8,50,562" extendstyle="1111" line="26" col="1" auto-adjust="true" offset="0,0">
                    <list-item rect="0,0,50,21" >
                        <button name="indexBtn" rect="0,0,50,21" font-family="微软雅黑" h-align="center" v-align="center" extendstyle="1111" OnSelect="indexitemOnSelect" text="$(text)" font-size="20" color='#7a7a7d'></button>
                    </list-item>
                    <dataset>
                        <set text="A" />
                        <set text="B" />
                        <set text="C" />
                        <set text="D" />
                        <set text="E" />
                        <set text="F" />
                        <set text="G" />
                        <set text="H" />
                        <set text="I" />
                        <set text="J" />
                        <set text="K" />
                        <set text="L" />
                        <set text="M" />
                        <set text="N" />
                        <set text="O" />
                        <set text="P" />
                        <set text="Q" />
                        <set text="R" />
                        <set text="S" />
                        <set text="T" />
                        <set text="U" />
                        <set text="V" />
                        <set text="W" />
                        <set text="X" />
                        <set text="Y" />
                        <set text="Z" />                        
                    </dataset>
                </list>
            </node>
            
            <node name="fenleiListNode" rect="136,60,230,85" extendstyle="1111" visible="false" enable="false" active="false">
               <image rect="44,0,143,63" src="file://image/jttxl/local_fenleitop.png" style='autosize' extendstyle="1111"/>  
               <image name="fenleiImg" rect="0,12,230,70" src="file://image/jttxl/local_fenlei_d.png" style='autosize' extendstyle="1111"/>  
               <listview name="fenleiList" limit="true" rect="0,22,230,60" extendstyle="1111" />
            </node>
            
            <node name="phoneListNode" rect="0,0,480,800" extendstyle="1111" visible="false" enable="false" active="false">
               <button name="button" rect="0,0,480,800" border="false" text="" color="#ffffff" ></button>
               <shadow rect="0,0,480,800" color="#000000" extendstyle="1111" alpha="192"/>
               <image rect="55,160,370,65" src="file://image/jttxl/local_phone_top.png" style='autosize' extendstyle="1111"/> 
               <label rect="55,160,370,46" text="选择号码" font-family="微软雅黑" font-size="26" color="#e0e0e0" v-align="center" h-align="center" extendstyle="1111" />
               <image name="phonelistImg" rect="55,212,365,116" src="file://image/jttxl/local_phone_basic2.png" style='autosize' extendstyle="1111"/>  
               <listview name="phoneList" limit="true" rect="55,212,365,58" extendstyle="1111" />
               <button name="phonecancelbtn" rect="55,270,365,58" normal="normal" sel="sel" extendstyle="1111" OnSelect="phonecancelOnSelect">
                    <node name="normal" rect="0,0,0,0" extendstyle="1177">
                        <image name="norimg" rect="0,0,365,58" src="file://image/jttxl/local_phone_basic.png" border="false" extendstyle="1111" style="autosize" />
                        <label rect="0,0,365,50" text="取消" font-family="微软雅黑" h-align="center" v-align="center" color="#ffffff" font-size="26" extendstyle="1111" />
                    </node>
                    <node name="sel" rect="0,0,0,0" extendstyle="1177"> 
                        <image name="selimg" rect="0,0,365,58" src="file://image/jttxl/local_phones_s.png" border="false" extendstyle="1111" style="autosize" />
                        <label rect="0,0,365,50" text="取消" font-family="微软雅黑" h-align="center" v-align="center" color="b5b0b0" font-size="26" extendstyle="1111" />
                    </node>
                </button> 
            </node>
        </node>
        <node name="listItem" rect="0,200,430,85"  visible="false" enable="false">
            <image name="jiange_line" rect="50,73,10,12" src="file://image/jttxl/jiange_line.png" style='autosize' extendstyle="1111"/> 
            <button name="lianxirenbtn" rect="0,0,430,85" extendstyle="1111" OnSelect="listitemOnSelect">
                <!--<node name="normal" rect="0,0,0,0" extendstyle="1177">
                    <image name="norimg" rect="397,25,33,34" src="file://image/jttxl/more_d.png" border="false" extendstyle="1111" style="autosize" />
                </node>
                <node name="sel" rect="0,0,0,0" extendstyle="1177"> 
                    <image name="selimg" rect="397,25,33,34" src="file://image/jttxl/more_s.png" border="false" extendstyle="1111" style="autosize" />
                </node>-->
                <button name="phonebtn" data="1" rect="18,0,74,73" OnSelect="telOnSelect" normal="src:file://image/jttxl/tel_d.png" sel="src:file://image/jttxl/tel_s.png" style="autosize" extendstyle="1111" />
                <scrolltext name="name" rect="112,0,260,35" text="" v-align="center" font-family="微软雅黑" color="#ffffff" font-size="28" extendstyle="0010" step="2" scroll="true"/>
                <label name="phone" rect="112,41,170,30" text="" font-family="微软雅黑" v-align="top" color="#aeb1b1" font-size="22" extendstyle="0010" />
                <label name="manyphone" visible="false" rect="320,41,100,30" text="多号码»" font-family="微软雅黑" h-align="left" v-align="top" font-size="22" color="#aeb1b1" extendstyle="0010" />
                <label name="phoneindex" visible="false" rect="288,43,100,30" text="" font-family="微软雅黑" h-align="left" v-align="top" font-size="22" color="#aeb1b1" extendstyle="0010" />
                <button name="smsbtn" rect="380,5,43,36" data="1" OnSelect="smsOnSelect" normal="src:file://image/jttxl/sms_d.png" sel="src:file://image/jttxl/sms_s.png" style="autosize" extendstyle="1111" />
            </button>
        </node>
        <node name="fenleiItem" rect="0,400,230,60"  visible="false" enable="false">
            <button rect="0,0,230,60" normal="normal" sel="sel" extendstyle="1111" OnSelect="fenleiitemOnSelect">
                <node name="normal" rect="0,0,0,0" extendstyle="1177">
                    <image name="norimg" rect="0,0,0,0" src="file://image/jttxl/local_fenlei_d.png" border="false" extendstyle="1177" style="autosize" />
                </node>
                <node name="sel" rect="0,0,0,0" extendstyle="1177"> 
                    <image name="selimg" rect="0,0,0,0" src="file://image/jttxl/local_fenlei_s.png" border="false" extendstyle="1177" style="autosize" />
                </node>
                <label name="name" rect="0,0,0,0" text="" h-align="center" v-align="center" color="#ffffff" font-size="26" extendstyle="1177" />
            </button>
        </node>
        <node name="phoneItem" rect="0,300,365,58"  visible="false" enable="false">
            <button rect="0,0,365,58" normal="normal" sel="sel" extendstyle="1111" OnSelect="phoneitemOnSelect">
                <node name="normal" rect="0,0,0,0" extendstyle="1177">
                    <image name="norimg" rect="0,0,0,0" src="file://image/jttxl/local_phone_basic.png" border="false" extendstyle="1177" style="autosize" />
                </node>
                <node name="sel" rect="0,0,0,0" extendstyle="1177"> 
                    <image name="selimg" rect="0,0,0,0" src="file://image/jttxl/local_phones_s.png" border="false" extendstyle="1177" style="autosize" />
                </node>
                <label name="phonetype" visible="false" rect="24,9,115,38" text="手机号码" font-family="微软雅黑" h-align="left" v-align="center" color="#aeb1b1" font-size="22" extendstyle="1111" />
                <label name="phonenumber" rect="25,9,340,38" text="" font-family="微软雅黑" h-align="left" v-align="center" color="#ffffff" font-size="26" extendstyle="1111" />
            </button>
        </node>
    </body>
    <![CDATA[

require('com_wondertek_tx.common.framework')
require('framework.sqlite')
require 'framework.umsagent'
local rootSprite
local list
local fenleiList
local phoneList
local callorsms
local curphones
local contactsTable = {}   
local displayTable = {}
local groupTable = {}
local phoneItemH = 58
local lastsprite = nil
local resetBtn
---------------------------------------callbacks--------------------------------
-- @brief root子节点创建完事件
function bodyBuildChildrenFinished(sprite)
    rootSprite = sprite    
    list = Sprite:findChild(rootSprite, 'sampleList')
    fenleiList = Sprite:findChild(rootSprite, 'fenleiList')
    phoneList = Sprite:findChild(rootSprite, 'phoneList')
    resetBtn = Sprite:findChild(rootSprite, 'resetBtn')
end

-- @brief root节点消息方法
function bodyOnSpriteEvent(msg, param)
    if msg == MSG_ACTIVATE then -- 页面激活
        local newNode = Sprite:findChild(rootSprite, 'newNode')
        if (Config:get("isNeedUpdate") == "true") then 
            setAllShoworHide(newNode, 1)
        else 
            setAllShoworHide(newNode, 0)
        end 
        if IO:fileExist('WONDER:\\contacts.txt') then
            Timer:set(1000, 200, 'showContactList')
        else
            Loading:show()
            -- System:getContacts()
        end
    elseif msg == MSG_DEACTIVATE then
    
    elseif msg == MSG_CONTACTS then
        showContactList()
        Loading:close()
    end
end

-- @brief 插件消息方法
function bodyOnPluginEvent(msg)
    if msg == 101 then

    elseif msg == 101 + MSG_CACHEDATA_RELOAD then -- 101请求的数据有更新
    elseif msg == MSG_NETWORK_ERROR then -- 拨号失败
        Log:write('拨号失败')
    elseif msg > MSG_NETWORK_ERROR then -- 请求超时
        Log:write('请求超时')
    end
end

-- @brief 按键响应处理
function mainNodeOnKeyUp(sprite, kc)
    if kc == Key.F2 then -- 按下返回键
        Scene:back()
        return 1
    end
end

---------------------------------------util functions---------------------------
function loadItemData(list, item, index)
    Sprite:setProperty(item, 'extendstyle', '1111')
    Sprite:setRect(item, 0,0,430,85) 
    local name = Sprite:findChild(item, 'name')
    Sprite:setProperty(name, 'text', displayTable[index+1].name)
    local phone = Sprite:findChild(item, 'phone')
    Sprite:setProperty(phone, 'text', displayTable[index+1].phone[1])
    local phoneindex = Sprite:findChild(item, 'phoneindex')
    Sprite:setProperty(phoneindex, 'text', index+1)
    local phoneall = displayTable[index+1].phone
    if #phoneall > 1 then
        local manyphone = Sprite:findChild(item, 'manyphone')
        Sprite:setVisible(manyphone, 1)
    end
end

function loadfenleiData(list, item, index)
    Sprite:setProperty(item, 'extendstyle', '1111')
    Sprite:setRect(item, 0,0,230,60)   
    local name = Sprite:findChild(item, 'name')
    Sprite:setProperty(name, 'text', groupTable[index+1].name)
end

function loadphoneData(list, item, index)
    Sprite:setProperty(item, 'extendstyle', '1111')
    Sprite:setRect(item, 0,0,365,58) 
    local phonenumber = Sprite:findChild(item, 'phonenumber')
    Sprite:setProperty(phonenumber, 'text', curphones[index+1])
end

function listitemOnSelect(sprite)
end

-- 搜索函数
function doSearch(sprite)
    Sprite:setProperty(sprite,'src','file://image/book/lianxiren_s.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'contactBtn'),'src','file://image/book/zuijinglianxiren_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'personBtn'),'src','file://image/book/person_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'siteBtn'),'src','file://image/book/site_d.png')
    Scene:setReturn(Alias.m_local, Alias.m_recentContacter)
    Scene:go(Alias.m_recentContacter, true)
end

-- 联系人列表
function doContact(sprite)
    Sprite:setProperty(sprite,'src','file://image/book/zuijinglianxiren_s.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'searchBtn'),'src','file://image/book/lianxiren_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'personBtn'),'src','file://image/book/person_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'siteBtn'),'src','file://image/book/site_d.png')
    Scene:setReturn(Alias.m_local, Alias.m_renyuantongji)
    Scene:go(Alias.m_renyuantongji, true)
    --Log:write("已在联系人列表界面，点击不做任何操作！")
end

-- 个人信息详情
function doPersonalCenter(sprite)
    Sprite:setProperty(sprite,'src','file://image/book/person_s.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'searchBtn'),'src','file://image/book/zuijinglianxiren_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'contactBtn'),'src','file://image/book/contact_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'siteBtn'),'src','file://image/book/site_d.png')   
    Scene:setReturn(Alias.m_local, Alias.m_myInfo .. '?employeeId=' .. Config:get("employeeId"))
    Scene:go(Alias.m_myInfo .. '?employeeId=' .. Config:get("employeeId"), true)
end

-- 设置
function doSetting(sprite)
    Sprite:setProperty(sprite,'src','file://image/book/site_s.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'searchBtn'),'src','file://image/book/zuijinglianxiren_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'contactBtn'),'src','file://image/book/contact_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'personBtn'),'src','file://image/book/person_d.png') 
    Scene:setReturn(Alias.m_local, Alias.m_system)
    Scene:go(Alias.m_system, true)
end

--点击拨号按钮
function telOnSelect(sprite)
   local cursprite = Sprite:getParent(sprite)
   local phoneindex = Sprite:getText(Sprite:findChild(cursprite, "phoneindex"))
   curphones = displayTable[tonumber(phoneindex)].phone
   Log:write('phonenum22222222222',curphones)
   local phonenum = #curphones
   Log:write('phonenum111111111',phonenum)
   
   if phonenum > 1 then
      ListView:removeAllItems(phoneList, true) 
      ListView:loadItem(phoneList, Sprite:findChild(rootSprite, 'phoneItem'), tonumber(phonenum), 'loadphoneData')
      if phonenum < 6 then
        Sprite:setRect(phoneList, 55,212,365,phoneItemH*phonenum)
        Sprite:setRect(Sprite:findChild(rootSprite, 'phonelistImg'),55,212,365,phoneItemH*(phonenum+1))
        Sprite:setRect(Sprite:findChild(rootSprite, 'phonecancelbtn'),55,212+phoneItemH*phonenum,365,phoneItemH)
      else
        Sprite:setRect(phoneList, 55,212,365,53*6)
        Sprite:setRect(Sprite:findChild(rootSprite, 'phonelistImg'),55,212,365,phoneItemH*7)
        Sprite:setRect(Sprite:findChild(rootSprite, 'phonecancelbtn'),55,210+phoneItemH*6,365,phoneItemH)
      end
      setAllShoworHide(Sprite:findChild(rootSprite, 'phoneListNode'), 1)
      callorsms = 1
   else
	   local cursprite = Sprite:getParent(sprite)
	   local phone = Sprite:getText(Sprite:findChild(cursprite, "phone"))
	   Log:write('phone number is:',phone)
	   if phone ~= nil and phone ~= '' then
	       if Util:openCallDialog('callFinished',formatPhoneNum(phone), 0) then
	           Log:write('telSuccess')
	           else
	           Dialog:show('提示', '调用接口失败，请检查手机设置！', 'ok')
	       end
	   else
	       Dialog:show('提示', '电话号码为空！', 'ok')
	   end
   end
end

function phoneitemOnSelect(sprite)
   setAllShoworHide(Sprite:findChild(rootSprite, 'phoneListNode'), 0)
   local phone = Sprite:getText(Sprite:findChild(sprite, "phonenumber"))
   Log:write('phone number is:',phone)
   if phone ~= nil and phone ~= '' then
       if callorsms == 1 then
	       if Util:openCallDialog('callFinished',formatPhoneNum(phone), 0) then
	           Log:write('telSuccess')
	           else
	           Dialog:show('提示', '调用接口失败，请检查手机设置！', 'ok')
	       end
	   else
	       if Util:sendSMS(formatPhoneNum(phone),'',false) then
               Log:write('smsSuccess')
               else
               Dialog:show('提示', '调用接口失败，请检查手机设置！', 'ok')
           end
       end
   else
       Dialog:show('提示', '电话号码为空！', 'ok')
   end
end

--点击发送短信
function smsOnSelect(sprite)
   local cursprite = Sprite:getParent(sprite)
   local phoneindex = Sprite:getText(Sprite:findChild(cursprite, "phoneindex"))
   curphones = displayTable[tonumber(phoneindex)].phone
   Log:write('phonenum22222222222',curphones)
   local phonenum = #curphones
   Log:write('phonenum111111111',phonenum)
   
   if phonenum > 1 then
      ListView:removeAllItems(phoneList, true) 
      ListView:loadItem(phoneList, Sprite:findChild(rootSprite, 'phoneItem'), tonumber(phonenum), 'loadphoneData')
      if phonenum < 6 then
        Sprite:setRect(phoneList, 55,212,365,phoneItemH*phonenum)
        Sprite:setRect(Sprite:findChild(rootSprite, 'phonelistImg'),55,212,365,phoneItemH*(phonenum+1))
        Sprite:setRect(Sprite:findChild(rootSprite, 'phonecancelbtn'),55,212+phoneItemH*phonenum,365,phoneItemH)
      else
        Sprite:setRect(phoneList, 55,212,365,53*6)
        Sprite:setRect(Sprite:findChild(rootSprite, 'phonelistImg'),55,212,365,phoneItemH*7)
        Sprite:setRect(Sprite:findChild(rootSprite, 'phonecancelbtn'),55,210+phoneItemH*6,365,phoneItemH)
      end
      setAllShoworHide(Sprite:findChild(rootSprite, 'phoneListNode'), 1)
      callorsms = 0
   else
	   local cursprite = Sprite:getParent(sprite)
	   local phone = Sprite:getText(Sprite:findChild(cursprite, "phone"))
	   if phone ~= nil and phone ~= '' then
	       if Util:sendSMS(formatPhoneNum(phone),'',false) then
	           Log:write('smsSuccess')
	           else
	           Dialog:show('提示', '调用接口失败，请检查手机设置！', 'ok')
	       end
	   else
	       Dialog:show('提示', '电话号码为空！', 'ok')
	   end
   end
end

function indexitemOnSelect(sprite)
    if lastsprite ~= nil then
        Sprite:setProperty(lastsprite, 'color', '#7a7a7d')
    end
    lastsprite = sprite
    Sprite:setProperty(sprite, 'color', '#1cf700')
    local indextxt = string.lower(Sprite:getText(sprite))
    local indexNum = 0
    for i=1,#displayTable do
        if string.sub(displayTable[i].fullSpel,1,1) < indextxt then
            indexNum = indexNum + 1
        end
    end
    ListView:setItemToTop(list, tonumber(indexNum), 0) 
end

function fenleiBtnOnselect(sprite)
    if Sprite:isVisible(Sprite:findChild(rootSprite, 'fenleiListNode'))== 1 then
        setAllShoworHide(Sprite:findChild(rootSprite, 'fenleiListNode'), 0)
    else
        local fenleiNum = #groupTable
        ListView:removeAllItems(fenleiList, true) 
        ListView:loadItem(fenleiList, Sprite:findChild(rootSprite, 'fenleiItem'), fenleiNum, 'loadfenleiData')        
        Sprite:setRect(Sprite:findChild(rootSprite, 'fenleiListNode'), 160,60,230,25+60*fenleiNum+25)
        Sprite:setRect(fenleiList, 0,22,230,60*fenleiNum) 
        Sprite:setRect(Sprite:findChild(rootSprite, 'fenleiImg'), 0,12,230,60*fenleiNum+25)
        ListView:adjust(fenleiList)
        setAllShoworHide(Sprite:findChild(rootSprite, 'fenleiListNode'), 1)
    end
end

function fenleiitemOnSelect(sprite)
    setAllShoworHide(Sprite:findChild(rootSprite, 'fenleiListNode'), 0)
    local groupName = Sprite:getText(Sprite:findChild(sprite, 'name'))
    Sprite:setProperty(Sprite:findChild(rootSprite, 'fenleibtnName'), 'text', groupName..'▼')
    ListView:removeAllItems(list, true) 
    local oneGroup = {}
    if groupName == '全部' then
        displayTable = contactsTable
    else
	    for i = 1, #contactsTable do
	        if contactsTable[i].group == groupName then
	            --插入value
	            table.insert(oneGroup,contactsTable[i])
	        end  
	    end 
	    displayTable = oneGroup
	end
    ListView:loadItem(list, Sprite:findChild(rootSprite, 'listItem'), #displayTable, 'loadItemData')
    ListView:adjust(list)
end

function jituanOnselect(sprite)
    Scene:setReturn(Alias.m_local, Alias.m_renyuantongji)
    Scene:go(Alias.m_renyuantongji, true)
end
  
function phonecancelOnSelect(sprite)
    setAllShoworHide(Sprite:findChild(rootSprite, 'phoneListNode'), 0)
end
 
function clearLastConstactStatus()
    contactsTable = {}
    groupTable = {}
    ListView:removeAllItems(list, 1, 1)
end

function getContactsData()
    Log:write('=========getContactsData=========')
    local beginTime = os.time()
    -- 全局变量初始化
    groupTable = {}
    contactsTable = {}
    -- 添加默认群组
    local group = {}
    groupTable["全部"] = 1     -- 用于快速查找
    group.name = '全部'
    group.total = 0
    table.insert(groupTable, group)
    if IO:fileExist('WONDER:\\contacts.txt') then
        local tempStr = IO:fileRead('WONDER:\\contacts.txt')
        local tempTable = Util:split(tempStr, '\n')
        for i = 1, #tempTable do
            if i % 2 == 0 then
                -- 获取姓名,所属群组, 拼音
                local allstr = SplitWithBlank(tempTable[i] , ';')
                local contact = {}
                contact.name = tempTable[i-1] 
                contact.phone = SplitWithBlank(allstr[1], ":")
                if allstr[2] == "" then 
                    contact.group = "未分组"
                else
                    contact.group = allstr[2]
                end 
                contact.fullSpel = allstr[3]
                contact.firstSpel = allstr[4]
                table.insert(contactsTable, contact)
                -- 添加群组到群组表中
                if groupTable[contact.group] == nil then
                    groupTable[contact.group] = 1 -- 标记该群组是否已经添加
                    group = {}
                    group.name = contact.group
                    group.total = 0
                    table.insert(groupTable, group)
                end
            end
        end
    end
    -- 打印加载的统计数据
    local endTime = os.time()
    Log:write("=====共加载本机联系人:"..#contactsTable.."个, 群组:"..#groupTable.."个!=====")
    Log:write("time elapse: "..(endTime-beginTime).."seconds")

    --[[
    local midTable = {} 
    if IO:fileExist('WONDER:\\contacts.txt') then
        local tempStr = IO:fileRead('WONDER:\\contacts.txt')
        local tempTable = Util:split(tempStr, '\n')
        for i = 1, #tempTable do
            if i % 2 == 0 then
                local contact = {}
                contact.name = tempTable[i-1] 
                contact.phone = tempTable[i] 
                table.insert(midTable, contact)
            end
        end
    end
    Log:write('qqqqqqqqqqqqqqqqqqqq',midTable)
    local samenum = 0
    local group = {}
    group.name = '全部'
    group.total = 0
    table.insert(groupTable,group)
    for i = 1, #midTable do
        samenum = 0
        for j = 1, #contactsTable do
            if contactsTable[j].name == midTable[i].name then
                --插入value
                local allstr = SplitWithBlank(midTable[i].phone, ';')
                table.insert(contactsTable[j].phone, allstr[1])
                samenum = samenum+1
            end  
        end
        if samenum < 1 then
            --插入该条记录
            local contact = {}
	        contact.name = midTable[i].name
	        local allstr = SplitWithBlank(midTable[i].phone, ';')
	        Log:write('11111111', allstr)
	        contact.phone = {allstr[1]}
	        if allstr[2]=='' then
	           allstr[2] = '未分组'
	        end
	        contact.group = allstr[2]
	        contact.fullSpel = allstr[3]
	        contact.firstSpel = allstr[4]
	        table.insert(contactsTable,contact)
	        local gsum = 0
	        for q = 1, #groupTable do
	           if groupTable[q].name == allstr[2] then
	               groupTable[q].total = groupTable[q].total + 1
	               gsum = gsum + 1
	           end
	        end
	        if gsum < 1 then
	            local group = {}
                group.name = allstr[2]
                group.total = 1 
                table.insert(groupTable,group)
            end
        end 
    end
    groupTable[1].total = #contactsTable
    Log:write('111111111111111111111',contactsTable)
    Log:write('111111111111111111111',groupTable)
    --]]
end

function buildContactList()
     Log:write("===buildContactList===")
    displayTable = contactsTable
    ListView:loadItem(list, Sprite:findChild(rootSprite, 'listItem'), #displayTable, 'loadItemData')
    ListView:adjust(list)
end

-- @brief 显示联系人列表
function showContactList()
    Log:write("===showContactList===")
    if #contactsTable == 0 or #groupTable == 0 then 
        clearLastConstactStatus()
        getContactsData()
        buildContactList()
    else
        Log:write("联系人表和群组信息已经存在，不做任何操作！")
    end
end

--当未有任何输入时，初始化为提示
function editOnTextChanged(sprite) 
    setAllShoworHide(resetBtn,1)
    Log:write("文本发生改变时触发") 
    local editeKeyword = string.lower(Sprite:getProperty(sprite, 'text'))
    Log:write("editeKeyword ====== ",editeKeyword)
    ListView:removeAllItems(list, true) 
    if editeKeyword ~= '' then    
        local tempTab = {}
        for i=1 , #contactsTable do
            if(string.find(contactsTable[i].name,editeKeyword)~=nil or string.find(contactsTable[i].fullSpel,editeKeyword)~=nil 
                or string.find(contactsTable[i].firstSpel,editeKeyword)~=nil or string.find(contactsTable[i].phone[1],editeKeyword)~=nil) then
                table.insert(tempTab,contactsTable[i])
            end
        end
        displayTable = tempTab 
    else
        displayTable = contactsTable
    end
    -- Log:write('displayTable==========',displayTable)
    if #displayTable > 0 then
        ListView:loadItem(list, Sprite:findChild(rootSprite, 'listItem'), #displayTable, 'loadItemData')
        ListView:adjust(list)
    end
end 

--获得焦点时
function editOnSetFocus(sprite)
    Log:write("获得焦点时触发")
    local txt= Sprite:getProperty(sprite, 'text')
    if txt=='搜索姓名、号码' then
        Sprite:setProperty(sprite, 'text', '')
        Sprite:setProperty(sprite, 'color', '#605e5e')
    end
end 

--释放焦点时
function editOnLostFocus(sprite)
    Log:write("释放焦点时触发") 
    local txt= Sprite:getProperty(sprite, 'text')
    if txt=='' then
        setAllShoworHide(resetBtn,0)
        Sprite:setProperty(sprite, 'text', '搜索姓名、号码')
        Sprite:setProperty(sprite, 'color', '#605e5e')
        --[[displayTable = contactsTable
        ListView:removeAllItems(list, true) 
        ListView:loadItem(list, Sprite:findChild(rootSprite, 'listItem'), #displayTable, 'loadItemData')
        ListView:adjust(list)--]]
    end
end

-- 搜索输入框置空
function doCancel()
    local keywordEditNode = Sprite:findChild(rootSprite,'keywordEdit')
    Sprite:setProperty(keywordEditNode, 'color', '#605e5e')
    Sprite:setProperty(keywordEditNode, 'text', '搜索姓名、号码')
    ListView:removeAllItems(list,true)
    displayTable = contactsTable
    ListView:loadItem(list, Sprite:findChild(rootSprite, 'listItem'), #displayTable, 'loadItemData')
    ListView:adjust(list)
end

    ]]>
</root>
