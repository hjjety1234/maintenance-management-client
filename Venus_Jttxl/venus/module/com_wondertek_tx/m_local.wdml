<?xml version="1.0" encoding="utf-8"?>
<!--
 == ============================================================================
 == | WonderTek [ 网络无处不在，沟通及时到达 ]
 == ============================================================================
 == | Copyright (c) 2012, WonderTek, Inc. All Rights Reserved.
 == ============================================================================
 == | Author: xxxx <xxxx@xxxx.com>
 == ============================================================================
 == | Desc: 页面描述
 == ============================================================================
-->
<root>
    <header/>
    <body resolution="480,800" BuildChildrenFinished="bodyBuildChildrenFinished" OnSpriteEvent="bodyOnSpriteEvent" OnPluginEvent="bodyOnPluginEvent">
        <node name="mainNode" rect="0,0,480,800" enable="true" active="true" OnKeyUp="mainNodeOnKeyUp" layouttype="1" extendstyle="1111">
            <image name='citybgImg' rect="0,80,480,720" src="file://image/jttxl/bj.png" style="autosize" extendstyle="1111" />
            <node name="baseSprite" rect="0,0,480,80" extendstyle="1111" >
                <image name="title" rect="0,0,480,80" border="false" src="file://image/jttxl/top.png" style="autosize" extendstyle="1111" />
                <button rect="0,0,480,80" text="本机通讯录" color="#ffffff" v-align="center" h-align="center" font-family="微软雅黑" font-size="32" extendstyle="1111"  style='autosize' />
            </node>
            <node rect="0,85,480,62" extendstyle="1111" >
                <button rect="27,0,213,62"  extendstyle="1111"  style='autosize' src='file://image/jttxl/local_top_d.png' OnSelect="jituanOnselect">
                    <label rect="0,0,213,50" text="安徽公司" font-family="微软雅黑" font-size="24" color="#ffffff" v-align="center" h-align="center" extendstyle="1111" />
                </button>
                <button rect="240,0,213,62"  extendstyle="1111"  style='autosize' src='file://image/jttxl/local_top_s.png' >
                    <label rect="0,0,213,50" text="本机通讯录" font-family="微软雅黑" font-size="24" color="#ffffff" v-align="center" h-align="center" extendstyle="1111" />
                </button>
            </node>
            <node rect="0,148,480,570" extendstyle="1111">
                <listview name="sampleList" rect="0,0,480,570" extendstyle="1111" />
            </node>
            <!-- 底部菜单  -->
            <node name="listNode" rect="0,720,480,80" extendstyle="1111">
                <image  rect="0,0,480,80" border="false" extendstyle="1111" 
                src="file://image/book/list_bg.png"  style="autosize"/>
                <!-- 搜索  -->
                <button name='searchBtn' rect="15,0,110,80"  extendstyle="1111"  style='autosize'
                src='file://image/book/lianxiren_d.png' OnSelect="doSearch"></button>
                <!-- 联系人  -->
                <button name='contactBtn' rect="125,0,110,80"  extendstyle="1111"  style='autosize'
                src='file://image/book/zuijinglianxiren_s.png' OnSelect="doContact"></button>
                <!-- 个人中心  -->
                <button name='personBtn' rect="250,0,82,80"  extendstyle="1111"  style='autosize'
                src='file://image/book/person_d.png' OnSelect="doPersonalCenter"></button>
                <!-- 设置  -->
                <button name='siteBtn' rect="385,0,48,80"  extendstyle="1111"  style='autosize'
                src='file://image/book/site_d.png' OnSelect="doSetting"></button>
                <!-- New -->
                <node name="newNode" rect="410,0,48,80" extendstyle="1111">
                    <image  rect="0,0,43,28" border="false" src="file://image/jttxl/new.png" 
                        style="autosize" extendstyle="1111" />
                </node>
            </node> 
            <!-- <node name="indexListNode" rect="430,148,50,570" extendstyle="1111">
                <list name="indexList" rect="0,8,50,562" extendstyle="1111" line="26" col="1" auto-adjust="true" offset="0,0">
                    <list-item rect="0,0,50,21" >
                        <button name="indexBtn" rect="0,0,50,21" font-family="微软雅黑" h-align="center" v-align="center" extendstyle="1111" OnSelect="indexitemOnSelect" text="$(text)" font-size="20" color='#7a7a7d'></button>
                    </list-item>
                    <dataset>
                        <set text="A" />
                        <set text="B" />
                        <set text="C" />
                        <set text="D" />
                        <set text="E" />
                        <set text="F" />
                        <set text="G" />
                        <set text="H" />
                        <set text="I" />
                        <set text="J" />
                        <set text="K" />
                        <set text="L" />
                        <set text="M" />
                        <set text="N" />
                        <set text="O" />
                        <set text="P" />
                        <set text="Q" />
                        <set text="R" />
                        <set text="S" />
                        <set text="T" />
                        <set text="U" />
                        <set text="V" />
                        <set text="W" />
                        <set text="X" />
                        <set text="Y" />
                        <set text="Z" />                        
                    </dataset>
                </list>
            </node>-->
            
            <node name="fenleiListNode" rect="180,60,143,63" extendstyle="1111" visible="false" enable="false" active="false">
               <image rect="0,0,143,63" src="file://image/jttxl/local_fenleitop.png" style='autosize' extendstyle="1111"/>  
               <image name="fenleiImg" rect="0,26,143,37" src="file://image/jttxl/local_fenlei_d.png" style='autosize' extendstyle="1111"/>  
               <listview name="fenleiList" limit="true" rect="0,26,143,37" extendstyle="1111" />
            </node>
            
            <node name="phoneListNode" rect="0,0,480,800" extendstyle="1111" visible="false" enable="false" active="false">
               <button name="button" rect="0,0,480,800" border="false" text="" color="#ffffff" ></button>
               <image rect="55,160,370,62" src="file://image/jttxl/local_phone_top.png" style='tile' extendstyle="1111"/> 
               <label rect="55,160,370,62" text="选择号码" font-family="微软雅黑" font-size="26" color="#e0e0e0" v-align="center" h-align="center" extendstyle="1111" />
               <image name="phonelistImg" rect="55,210,365,53" src="file://image/jttxl/local_phone_basic2.png" style='autosize' extendstyle="1111"/>  
               <listview name="phoneList" limit="true" rect="55,210,365,53" extendstyle="1111" />
               <button name="phonecancelbtn" rect="55,263,365,53" src="file://image/jttxl/local_phone_basic.png" normal="normal" sel="sel" extendstyle="1111" OnSelect="phonecancelOnSelect">
                    <node name="normal" rect="0,0,0,0" extendstyle="1177">
                        <label rect="0,0,365,40" text="取消" font-family="微软雅黑" h-align="center" v-align="center" color="#ffffff" font-size="26" extendstyle="1111" />
                    </node>
                    <node name="sel" rect="0,0,0,0" extendstyle="1177"> 
                        <label rect="0,0,365,40" text="取消" font-family="微软雅黑" h-align="center" v-align="center" color="b5b0b0" font-size="26" extendstyle="1111" />
                    </node>
                </button> 
            </node>
        </node>
        <node name="listItem" rect="0,200,480,85"  visible="false" enable="false">
            <image name="jiange_line" rect="50,73,10,12" src="file://image/jttxl/jiange_line.png" style='autosize' extendstyle="1111"/> 
            <button name="lianxirenbtn" rect="0,0,480,85" extendstyle="1111" OnSelect="listitemOnSelect">
                <!--<node name="normal" rect="0,0,0,0" extendstyle="1177">
                    <image name="norimg" rect="397,25,33,34" src="file://image/jttxl/more_d.png" border="false" extendstyle="1111" style="autosize" />
                </node>
                <node name="sel" rect="0,0,0,0" extendstyle="1177"> 
                    <image name="selimg" rect="397,25,33,34" src="file://image/jttxl/more_s.png" border="false" extendstyle="1111" style="autosize" />
                </node>-->
                <button name="phonebtn" data="1" rect="18,0,74,73" OnSelect="telOnSelect" normal="src:file://image/jttxl/tel_d.png" sel="src:file://image/jttxl/tel_s.png" style="autosize" extendstyle="1111" />
                <label name="name" rect="112,5,210,35" text="刘科长" v-align="center" font-family="微软雅黑" color="#ffffff" font-size="28" extendstyle="0010" />
                <label name="phone" rect="112,43,170,30" text="13111111111" font-family="微软雅黑" v-align="top" color="#aeb1b1" font-size="22" extendstyle="0010" />
                <label name="manyphone" visible="false" rect="320,43,100,30" text="多号码»" font-family="微软雅黑" h-align="left" v-align="top" font-size="22" color="#aeb1b1" extendstyle="0010" />
                <label name="phoneindex" visible="false" rect="288,43,100,30" text="" font-family="微软雅黑" h-align="left" v-align="top" font-size="22" color="#aeb1b1" extendstyle="0010" />
                <button name="smsbtn" rect="410,15,43,36" data="1" OnSelect="smsOnSelect" normal="src:file://image/jttxl/sms_d.png" sel="src:file://image/jttxl/sms_s.png" style="autosize" extendstyle="1111" />
            </button>
        </node>
        <node name="fenleiItem" rect="0,400,143,37"  visible="false" enable="false">
            <button rect="0,0,143,37" normal="normal" sel="sel" extendstyle="1111" OnSelect="fenleiitemOnSelect">
                <node name="normal" rect="0,0,0,0" extendstyle="1177">
                    <image name="norimg" rect="0,0,0,0" src="file://image/jttxl/local_fenlei_d.png" border="false" extendstyle="1177" style="autosize" />
                </node>
                <node name="sel" rect="-1,2,145,33" extendstyle="1111"> 
                    <image name="selimg" rect="0,0,145,33" src="file://image/jttxl/local_fenlei_s.png" border="false" extendstyle="1111" style="autosize" />
                </node>
                <label name="name" rect="0,0,0,0" text="同事" h-align="center" v-align="center" color="#ffffff" font-size="24" extendstyle="1177" />
            </button>
        </node>
        <node name="phoneItem" rect="0,300,365,53"  visible="false" enable="false">
            <button rect="0,0,365,53" src="file://image/jttxl/local_phone_basic.png" extendstyle="1111" OnSelect="phoneitemOnSelect">
                <label name="phonetype" visible="false" rect="24,9,115,30" text="手机号码" font-family="微软雅黑" h-align="left" v-align="center" color="#aeb1b1" font-size="22" extendstyle="1111" />
                <label name="phonenumber" rect="25,9,340,30" text="13711111111" font-family="微软雅黑" h-align="left" v-align="center" color="#0e0f0e" font-size="26" extendstyle="1111" />
            </button>
        </node>
    </body>
    <![CDATA[

require('com_wondertek_tx.common.framework')
require('framework.sqlite')
require 'framework.umsagent'
local rootSprite
local list
local fenleiList
local phoneList
local fenleiNum  
local callorsms
local curphones
local contactsTable = {}   
---------------------------------------callbacks--------------------------------
-- @brief root子节点创建完事件
function bodyBuildChildrenFinished(sprite)
    rootSprite = sprite    
    list = Sprite:findChild(rootSprite, 'sampleList')
    fenleiList = Sprite:findChild(rootSprite, 'fenleiList')
    phoneList = Sprite:findChild(rootSprite, 'phoneList')
    listlen = 9
    fenleiNum = 8
    --System:getContacts()
    --ListView:loadItem(list, Sprite:findChild(rootSprite, 'listItem'), listlen, 'loadItemData')
    --ListView:loadItem(fenleiList, Sprite:findChild(rootSprite, 'fenleiItem'), fenleiNum, 'loadfenleiData')
    --ListView:loadItem(phoneList, Sprite:findChild(rootSprite, 'phoneItem'), 8, 'loadphoneData')
    --Sprite:setRect(Sprite:findChild(rootSprite, 'fenleiListNode'), 180,60,143,26+37*fenleiNum)
    --Sprite:setRect(fenleiList, 0,26,143,37*fenleiNum)
    --Sprite:setRect(Sprite:findChild(rootSprite, 'fenleiImg'), 0,26,143,37*fenleiNum)
end

-- @brief root节点消息方法
function bodyOnSpriteEvent(msg, param)
    if msg == MSG_ACTIVATE then -- 页面激活
        System:getContacts()
    elseif msg == MSG_DEACTIVATE then
    
    elseif msg == MSG_CONTACTS then
        clearLastConstactStatus()
        getContactsData()
        buildContactList()
    end
end

-- @brief 插件消息方法
function bodyOnPluginEvent(msg)
    if msg == 101 then

    elseif msg == 101 + MSG_CACHEDATA_RELOAD then -- 101请求的数据有更新
    elseif msg == MSG_NETWORK_ERROR then -- 拨号失败
        Log:write('拨号失败')
    elseif msg > MSG_NETWORK_ERROR then -- 请求超时
        Log:write('请求超时')
    end
end

-- @brief 按键响应处理
function mainNodeOnKeyUp(sprite, kc)
    if kc == Key.F2 then -- 按下返回键
        Scene:back()
        return 1
    end
end

---------------------------------------util functions---------------------------
function loadItemData(list, item, index)
    Sprite:setProperty(item, 'extendstyle', '1111')
    Sprite:setRect(item, 0,0,480,85) 
    local name = Sprite:findChild(item, 'name')
    Sprite:setProperty(name, 'text', contactsTable[index+1].name)
    local phone = Sprite:findChild(item, 'phone')
    Sprite:setProperty(phone, 'text', contactsTable[index+1].phone[1])
    local phoneindex = Sprite:findChild(item, 'phoneindex')
    Sprite:setProperty(phoneindex, 'text', index+1)
    local phoneall = contactsTable[index+1].phone
    if #phoneall > 1 then
        local manyphone = Sprite:findChild(item, 'manyphone')
        Sprite:setVisible(manyphone, 1)
    end
end

function loadfenleiData(list, item, index)
    Sprite:setProperty(item, 'extendstyle', '1111')
    Sprite:setRect(item, 0,0,143,37)   
    
end

function loadphoneData(list, item, index)
    Sprite:setProperty(item, 'extendstyle', '1111')
    Sprite:setRect(item, 0,0,365,53) 
    local phonenumber = Sprite:findChild(item, 'phonenumber')
    Sprite:setProperty(phonenumber, 'text', curphones[index+1])
end

function listitemOnSelect(sprite)
end

-- 搜索函数
function doSearch(sprite)
    Sprite:setProperty(sprite,'src','file://image/book/lianxiren_s.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'contactBtn'),'src','file://image/book/zuijinglianxiren_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'personBtn'),'src','file://image/book/person_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'siteBtn'),'src','file://image/book/site_d.png')
    Scene:setReturn(Alias.m_local, Alias.m_recentContacter)
    Scene:go(Alias.m_recentContacter, true)
end

-- 联系人列表
function doContact(sprite)
    Sprite:setProperty(sprite,'src','file://image/book/zuijinglianxiren_s.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'searchBtn'),'src','file://image/book/lianxiren_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'personBtn'),'src','file://image/book/person_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'siteBtn'),'src','file://image/book/site_d.png')
    Scene:setReturn(Alias.m_local, Alias.m_renyuantongji)
    Scene:go(Alias.m_renyuantongji, true)
    --Log:write("已在联系人列表界面，点击不做任何操作！")
end

-- 个人信息详情
function doPersonalCenter(sprite)
    Sprite:setProperty(sprite,'src','file://image/book/person_s.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'searchBtn'),'src','file://image/book/zuijinglianxiren_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'contactBtn'),'src','file://image/book/contact_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'siteBtn'),'src','file://image/book/site_d.png')   
    Scene:setReturn(Alias.m_local, Alias.m_myInfo .. '?employeeId=' .. Config:get("employeeId"))
    Scene:go(Alias.m_myInfo .. '?employeeId=' .. Config:get("employeeId"), true)
end

-- 设置
function doSetting(sprite)
    Sprite:setProperty(sprite,'src','file://image/book/site_s.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'searchBtn'),'src','file://image/book/zuijinglianxiren_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'contactBtn'),'src','file://image/book/contact_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'personBtn'),'src','file://image/book/person_d.png') 
    Scene:setReturn(Alias.m_local, Alias.m_system)
    Scene:go(Alias.m_system, true)
end

--点击拨号按钮
function telOnSelect(sprite)
   local cursprite = Sprite:getParent(sprite)
   local phoneindex = Sprite:getText(Sprite:findChild(cursprite, "phoneindex"))
   curphones = contactsTable[tonumber(phoneindex)].phone
   Log:write('phonenum22222222222',curphones)
   local phonenum = #curphones
   Log:write('phonenum111111111',phonenum)
   
   if phonenum > 1 then
      ListView:removeAllItems(phoneList, true) 
      ListView:loadItem(phoneList, Sprite:findChild(rootSprite, 'phoneItem'), tonumber(phonenum), 'loadphoneData')
      if phonenum < 6 then
        --Sprite:setRect(Sprite:findChild(rootSprite, 'phoneListNode'),55,160,370,108+53*phonenum)
        Sprite:setRect(phoneList, 57,210,365,53*phonenum)
        Sprite:setRect(Sprite:findChild(rootSprite, 'phonelistImg'),57,210,365,53*phonenum)
        Sprite:setRect(Sprite:findChild(rootSprite, 'phonecancelbtn'),57,210+53*phonenum,365,53)
      else
        --Sprite:setRect(Sprite:findChild(rootSprite, 'phoneListNode'),55,160,370,108+53*6)
        Sprite:setRect(phoneList, 57,210,365,53*6)
        Sprite:setRect(Sprite:findChild(rootSprite, 'phonelistImg'),57,210,365,53*6)
        Sprite:setRect(Sprite:findChild(rootSprite, 'phonecancelbtn'),57,210+53*6,365,53)
      end
      setAllShoworHide(Sprite:findChild(rootSprite, 'phoneListNode'), 1)
      callorsms = 1
   else
	   local cursprite = Sprite:getParent(sprite)
	   local phone = Sprite:getText(Sprite:findChild(cursprite, "phone"))
	   Log:write('phone number is:',phone)
	   if phone ~= nil and phone ~= '' then
	       if Util:openCallDialog('callFinished',phone, 0) then
	           Log:write('telSuccess')
	           else
	           Dialog:show('提示', '调用接口失败，请检查手机设置！', 'ok')
	       end
	   else
	       Dialog:show('提示', '电话号码为空！', 'ok')
	   end
   end
end

function phoneitemOnSelect(sprite)
   local phone = Sprite:getText(Sprite:findChild(sprite, "phonenumber"))
   Log:write('phone number is:',phone)
   if phone ~= nil and phone ~= '' then
       if callorsms == 1 then
	       if Util:openCallDialog('callFinished',phone, 0) then
	           Log:write('telSuccess')
	           else
	           Dialog:show('提示', '调用接口失败，请检查手机设置！', 'ok')
	       end
	   else
	       if Util:sendSMS(phone,' ',false) then
               Log:write('smsSuccess')
               else
               Dialog:show('提示', '调用接口失败，请检查手机设置！', 'ok')
           end
       end
   else
       Dialog:show('提示', '电话号码为空！', 'ok')
   end
end

--点击发送短信
function smsOnSelect(sprite)
   local cursprite = Sprite:getParent(sprite)
   local phoneindex = Sprite:getText(Sprite:findChild(cursprite, "phoneindex"))
   curphones = contactsTable[tonumber(phoneindex)].phone
   Log:write('phonenum22222222222',curphones)
   local phonenum = #curphones
   Log:write('phonenum111111111',phonenum)
   
   if phonenum > 1 then
      ListView:removeAllItems(phoneList, true) 
      ListView:loadItem(phoneList, Sprite:findChild(rootSprite, 'phoneItem'), tonumber(phonenum), 'loadphoneData')
      if phonenum < 6 then
        --Sprite:setRect(Sprite:findChild(rootSprite, 'phoneListNode'),55,160,370,108+53*phonenum)
        Sprite:setRect(phoneList, 57,210,365,53*phonenum)
        Sprite:setRect(Sprite:findChild(rootSprite, 'phonelistImg'),57,210,365,53*phonenum)
        Sprite:setRect(Sprite:findChild(rootSprite, 'phonecancelbtn'),57,210+53*phonenum,365,53)
      else
        --Sprite:setRect(Sprite:findChild(rootSprite, 'phoneListNode'),55,160,370,108+53*6)
        Sprite:setRect(phoneList, 57,210,365,53*6)
        Sprite:setRect(Sprite:findChild(rootSprite, 'phonelistImg'),57,210,365,53*6)
        Sprite:setRect(Sprite:findChild(rootSprite, 'phonecancelbtn'),57,210+53*6,365,53)
      end
      setAllShoworHide(Sprite:findChild(rootSprite, 'phoneListNode'), 1)
      callorsms = 0
   else
	   local cursprite = Sprite:getParent(sprite)
	   local phone = Sprite:getText(Sprite:findChild(cursprite, "phone"))
	   if phone ~= nil and phone ~= '' then
	       if Util:sendSMS(phone,' ',false) then
	           Log:write('smsSuccess')
	           else
	           Dialog:show('提示', '调用接口失败，请检查手机设置！', 'ok')
	       end
	   else
	       Dialog:show('提示', '电话号码为空！', 'ok')
	   end
   end
end

function indexitemOnSelect(sprite)
    if lastsprite ~= nil then
        Sprite:setProperty(lastsprite, 'color', '#7a7a7d')
    end
    lastsprite = sprite
    Sprite:setProperty(sprite, 'color', '#1cf700')
    local txt = string.lower(Sprite:getText(sprite))
end

function fenleiBtnOnselect(sprite)
    if Sprite:isVisible(Sprite:findChild(rootSprite, 'fenleiListNode'))== 1 then
        setAllShoworHide(Sprite:findChild(rootSprite, 'fenleiListNode'), 0)
    else
        setAllShoworHide(Sprite:findChild(rootSprite, 'fenleiListNode'), 1)
    end
end

function jituanOnselect(sprite)
    Scene:setReturn(Alias.m_local, Alias.m_renyuantongji)
    Scene:go(Alias.m_renyuantongji, true)
end
  
function phonecancelOnSelect(sprite)
    setAllShoworHide(Sprite:findChild(rootSprite, 'phoneListNode'), 0)
end
 
function clearLastConstactStatus()
    contactsTable = {}
    ListView:removeAllItems(list, 1, 1)
end

function getContactsData()
    Log:write('=========getContactsData=========')
    local midTable = {} 
    if IO:fileExist('WONDER:\\contacts.txt') then
        local tempStr = IO:fileRead('WONDER:\\contacts.txt')
        local tempTable = Util:split(tempStr, '\n')
        for i = 1, #tempTable do
            if i % 2 == 0 then
                local contact = {}
                contact.name = tempTable[i-1] 
                contact.phone = tempTable[i] 
                table.insert(midTable, contact)
            end
        end
    end
    Log:write('qqqqqqqqqqqqqqqqqqqq',midTable)
    local samenum = 0
    for i = 1, #midTable do
        samenum = 0
        if #contactsTable > 0 then
            for j = 1, #contactsTable do
                if contactsTable[j].name == midTable[i].name then
                    --插入value
                    table.insert(contactsTable[j].phone, midTable[i].phone)
                    samenum = samenum+1
                end  
            end
            if samenum < 1 then
                --插入该条记录
                local contact = {}
                contact.name = midTable[i].name
                contact.phone = {midTable[i].phone}
                table.insert(contactsTable,contact)
            end
        else
            --插入第一条记录
            local contact = {}
            contact.name = midTable[i].name
            contact.phone = {midTable[i].phone}
            table.insert(contactsTable,contact)
        end
    end
    Log:write('111111111111111111111',contactsTable)
end

function buildContactList()
    ListView:loadItem(list, Sprite:findChild(rootSprite, 'listItem'), #contactsTable, 'loadItemData')
    ListView:adjust(list)
end
    ]]>
</root>
