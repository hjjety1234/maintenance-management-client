<?xml version="1.0" encoding="utf-8"?>
<!--
 == ============================================================================
 == | 
 == ============================================================================
 == | Copyright (c) 2012, WonderTek, Inc. All Rights Reserved.
 == ============================================================================
 == | Author: xxxx <xxxx@xxxx.com>
 == ============================================================================
 == | Desc: 页面描述
 == ============================================================================
-->
<root>
    <header/>
    <body resolution="480,800" BuildChildrenFinished="bodyBuildChildrenFinished" OnSpriteEvent="bodyOnSpriteEvent" OnPluginEvent="bodyOnPluginEvent">
        <node name="mainNode" rect="0,0,480,800" enable="true" active="true" OnKeyUp="mainNodeOnKeyUp" layouttype="1" extendstyle="1111">
            <image rect="0,0,480,800" src="file://image/jttxl/bj.png" style="autosize"
               extendstyle="1111" />
            <!-- 设置头部 -->
            <node name="baseSprite" rect="0,0,480,80" extendstyle="1111">
                <image name="title" rect="0,0,480,80" border="false" src="file://image/jttxl/top.png" 
                    style="autosize" extendstyle="1111">
                    <label name="titleLabel" rect="0,0,480,80" text="名片尺寸设置" color="#ffffff" v-align="center"  
                       h-align="center" font-family="微软雅黑" font-size="32px" extendstyle="1111" />
                </image>
                 <!-- 返回 -->
                <button rect="20,18,48,45" OnSelect="doBack" normal="src:file://image/jttxl/back_d.png;"
                    sel="src:file://image/jttxl/back_s.png;" style="autosize" extendstyle="1111">
                </button>
            </node>
            <!--中间名片预览区域-->
            <button name="cardNode" rect="72,218,349,235" layouttype="1" style="autosize" extendstyle="1111">
                <image name="cardImg" rect="0,0,349,235" extendstyle="1111" style="autosize" src="file://image/default_incoming_bg.png" />
                <!--名片中的内容-->
                <!--1.Logo-->
                <image name="imgLog" src="file://image/m_logo.png" rect="24,27,64,64" style="autosize" extendstyle="1111" />
                <!--2.姓名-->
                <label name="nameLabel" rect="100,15,200,50" font-size="30" font-family="微软雅黑" text="严翔" />
                <!--3.职位-->
                <label name="headshipLabel" rect="100,66,340,40" font-size="10" font-family="微软雅黑" text="省公司部门主要领导" />
                <!--4.部门信息-->
                <textarea name="txtDeptInfo" extendstyle="1111" line-height="25" style="autosize" 
                    rect="34,148,280,62" font-family="微软雅黑" font-size="10"
                    text="安庆分公司\怀宁县分公司\石牌乡中心营业部"></textarea>
            </button>
            <!--滑动条左侧减少键-->
            <button OnSelect="addorslowButton_selected" data="01" name="slowButton" rect="35,518,32,34" style="autosize" extendstyle="1111" 
                normal="src:file://image/jianhao.png;" sel="src:file://image/jianhao.png;">
            </button>
            <!--滑动条右侧按钮-->
            <button name="addButton" rect="415,518,32,34" data="02" OnSelect="addorslowButton_selected" style="autosize" extendstyle="1111" 
                normal="src:file://image/jiahao.png;" sel="src:file://image/jiahao.png;">
            </button>
            <!--下方的滑动条-->
            <node name="progressNode" rect="71,521,460,40" layouttype="2" extendstyle="1111">
                <button rect="0,0,338,40" layouttype="3" OnKeyDown="progressOnKeyDown" OnMouseDown="progressOnMouseDown" OnMouseMove="progressOnMouseMove" OnMouseUp="progressOnMouseUp" extendstyle="1111">
                    <image name="progressBgImg" rect="0,10,338,14" src="file://image/mingpian_shezhi_bj.png" style="autosize" extendstyle="1111"/>
                    <image name="progressBarImg" rect="3,13 ,14,24" src="file://image/mingpian_shezhi_dian.png"  style="autosize" extendstyle="1111"/>
                    <image name="progressPointImg" rect="324,0,23,40" src="file://image/mingpian_shezhi_dian.png" style="autosize" extendstyle="1111"/>
                </button>
                <label name="lblPercent" rect="0,35,338,25" text="100%" h-align="center" color="#aaaaaa" font-size="16px" />
            </node>
            <!--tips-->
            <node name="nodeSuccess" rect="131,630,250,48" enable="false" visible="false" active="false" layouttype="1" extendstyle="1111">
                <image rect="0,0,218,48" border="false" src="file://image/jttxl/gengxin_bj.png" style="autosize"></image>
                <label name="content" rect="0,0,218,48" border="false" text="设置成功" h-align="center" 
                    v-align="center" font-family="微软雅黑" font-size="24" color="#FFFFFF" style="autosize" extendstyle="1111"></label>
            </node>
            <!--下方保存和复位按钮-->
            <button name="btnreset" OnSelect="btnreset_onselected" rect="29,690,216,73" style="autosize" extendstyle="1111" 
                normal="node:normalNode" sel="node:selNode">
                <node name="normalNode" rect="0,0,216,73" extendstyle="1111">
                    <image rect="0,0,216,73" style="autosize" src="file://image/fuwei_s.png" extendstyle="1111" />
                </node>
                <node name="selNode" rect="0,0,216,73" extendstyle="1111">
                    <image rect="0,0,216,73" style="autosize" src="file://image/fuwei_d.png" extendstyle="1111" />
                </node>
            </button>
            <button OnSelect="savebtn_onselected" name="btnsave" rect="247,690,215,73" style="autosize" extendstyle="1111" 
               normal="node:normalNode" sel="node:selNode">
               <node name="normalNode" rect="0,0,216,73" extendstyle="1111">
                    <image rect="0,0,216,73" style="autosize" src="file://image/baocun_s.png" extendstyle="1111" />
                </node>
                <node name="selNode" rect="0,0,216,73" extendstyle="1111">
                    <image rect="0,0,216,73" style="autosize" src="file://image/baocun_d.png" extendstyle="1111" />
                </node>
             </button>
        </node>
    </body>
    <![CDATA[

require 'com_wondertek_tx.common.framework'
require 'framework.sqlite'
local rootSprite
local department_name

---------------------------------------callbacks--------------------------------
-- @brief root子节点创建完事件
function bodyBuildChildrenFinished(sprite)
    rootSprite = sprite
    progressBgImg = Sprite:findChild(sprite, 'progressBgImg')
    progressBarImg = Sprite:findChild(sprite, 'progressBarImg')
    progressPointImg = Sprite:findChild(sprite, 'progressPointImg')
    local imageCard = Sprite:findChild(Sprite:findChild(rootSprite,'cardNode'),'cardImg')
    imageCard_x,imageCard_y,imageCard_w,imageCard_h = Sprite:getRect(imageCard)
    readUserInfo() --读取用户信息，显示在名片上
    --读取配置文件，显示默认的比例
    readDefaultConfig()
end

--@zhouyusgs#ahmobile.com
function readDefaultConfig()
    local path = getLocalDiskPath() .. '/config.json'
    if IO:fileExist(path) then
        local configTable = IO:fileReadToTable(path)
        local percent = configTable[1]
        --设置默认的百分比
        setProgressBarPos(324*tonumber(percent)/100*(tonumber(percent)-90)/10)
    else
        setProgressBarPos(324)
    end
end

--@zhouyu 读取用户个人信息
function readUserInfo()
    databaseName = getLocalDiskPath()..'/jttxlDatabase'
    bRet, errMsg = Sqlite:open(databaseName)
    Log:write('open database status ',bRet)
    Log:write('opendatabase error message',errMsg)
    local sql = "SELECT employee_name,department_id,headship_name,department_name FROM tb_c_employee WHERE employee_id=(SELECT employee_id FROM tb_c_system)"
    local bRet,retTable,errMsg = Sqlite:query(databaseName,sql)
    Log:write('用户信息',retTable)
    local nameLabel = Sprite:findChild(rootSprite,'nameLabel')
    local headshipLabel = Sprite:findChild(rootSprite,'headshipLabel')
    local txtDeptInfo = Sprite:findChild(rootSprite,'txtDeptInfo')
    Sprite:setProperty(nameLabel,'text',retTable[1][1])
    Sprite:setProperty(headshipLabel,'text',retTable[1][3])
    department_name = retTable[1][4]
    --getUserDeptPath(retTable[1][2])
    Sprite:setProperty(txtDeptInfo,'text',department_name)
end
--获取用户的部门路径
function getUserDeptPath(department_id)
    local sql = "SELECT department_name,department_id,parent_department_id FROM tb_c_department WHERE department_id=(SELECT parent_department_id from tb_c_department WHERE department_id='"..department_id.."')"
    local bRet,retTable,errMsg = Sqlite:query(databaseName, sql)
    Log:write('department table is ',retTable)
    if #retTable > 0 and retTable[1][3]~='0' then
        department_name = retTable[1][1].. '\\' .. department_name 
        getUserDeptPath(retTable[1][2])
    end
end

-- @brief root节点消息方法
function bodyOnSpriteEvent(msg, param)
    if msg == MSG_ACTIVATE then -- 页面激活

    elseif msg == MSG_DEACTIVATE then
    end
end

-- @brief 插件消息方法
function bodyOnPluginEvent(msg)
    if msg == 101 then

    elseif msg == 101 + MSG_CACHEDATA_RELOAD then -- 101请求的数据有更新
    elseif msg == MSG_NETWORK_ERROR then -- 拨号失败
        Log:write('拨号失败')
    elseif msg > MSG_NETWORK_ERROR then -- 请求超时
        Log:write('请求超时')
    end
end

-- @brief 按键响应处理
function mainNodeOnKeyUp(sprite, kc)
    if kc == Key.F2 then -- 按下返回键
        local bRet = Sqlite:close('jttxlDatabase')
        Scene:back()
        return 1
    end
end

---------------------------------------util functions---------------------------
--@zhouyu 返回按钮点击事件
function doBack()
    local bRet = Sqlite:close('jttxlDatabase')
    Scene:back()
end

-- @zhouyu 进度条OnMouseDown事件
function progressOnMouseDown(sprite, x, y)
    setProgressBarPos(x)
    progressBarFlag = 1
    return 0
end

-- @zhouyu 进度条OnMouseUp事件
function progressOnMouseUp(sprite, x, y)
    progressBarFlag = 0
    return 0
end

-- @zhouyu 进度条OnMouseMove事件
function progressOnMouseMove(sprite, x, y)
    if progressBarFlag == 1 then -- 在OnMouseDown时设置此标识量，表明需要响应OnMouseMove事件，否则不响应
        setProgressBarPos(x)
    else
        return 0
    end
end

function progressOnKeyDown(sprite, kc)
    if kc == Key.Right then
        local progressPointImg = Sprite:findChild(sprite, 'progressPointImg')
        local x, y, w, h = Sprite:getRect(progressPointImg)
        setProgressBarPos(x + 10)
    elseif kc == Key.Left then
        local progressPointImg = Sprite:findChild(sprite, 'progressPointImg')
        local x, y, w, h = Sprite:getRect(progressPointImg)
        setProgressBarPos(x - 10)
    end
end

-- @zhouyu 设置进度条
function setProgressBarPos(x)
    local imageCard = Sprite:findChild(Sprite:findChild(rootSprite,'cardNode'),'cardImg') --名片背景
    local imageLog = Sprite:findChild(rootSprite,'imgLog')  --名片内部的Logo
    local nameLabel = Sprite:findChild(rootSprite,'nameLabel')  --名片内部的姓名
    local headshipLabel = Sprite:findChild(rootSprite,'headshipLabel') --名片内部的职位
    local txtDeptInfo = Sprite:findChild(rootSprite,'txtDeptInfo')  --名片内部的部门信息

    local _, _, bg_w = Sprite:getRect(progressBgImg)
    local _, point_y, point_w, point_h = Sprite:getRect(progressPointImg)
    if x > bg_w - point_w then
        x = bg_w - point_w
    elseif x < 0 then
        x = 0
    end
    local bar_x, bar_y, _, bar_h = Sprite:getRect(progressBarImg)
    Sprite:setRect(progressPointImg, x, point_y, point_w, point_h)
    local iPercent = (90+(x/324*10))/100
    local percent = string.format('%.0f',90+(x/324)*10)
    Sprite:setProperty(Sprite:findChild(rootSprite,'lblPercent'),'text',percent..'%')
    local img_x,img_y,img_w,img_h = Sprite:getRect(imageCard)
    local log_x,log_y,log_w,log_h = Sprite:getRect(imageLog)
    --为了使图片大小看起来像是缩放，重新计算图片的大小和位置
    --重新计算名片内部的文字大小、Log的大小
    local changeWidth = img_w - imageCard_w*iPercent
    local changeHeight = img_h - imageCard_h*iPercent
    if changeWidth < 0 then
        --刻度增加，图片的x和y减
        img_x = img_x - math.abs(changeWidth) / 2
        img_y = img_y - math.abs(changeHeight) / 2
    else
        --刻度减少，图片的x和y加
        img_x = img_x + math.abs(changeWidth) / 2
        img_y = img_y + math.abs(changeHeight) / 2
    end
    --Logo的位置和大小调整
    Sprite:setRect(imageLog,log_x,log_y,log_w,log_h)
    --设置名片字体大小
    setTextSize(iPercent)
    --名片的位置和大小调整
    Sprite:setRect(imageCard,img_x,img_y,imageCard_w*iPercent,imageCard_h*iPercent)
end

--@zhouyusgs#ahmobile.com设置名片字体大小
--设置按三档展示90%,95%,100%
function setTextSize(scale)
    scale = tonumber(scale)
    local nameLabel = Sprite:findChild(rootSprite,'nameLabel')  --名片内部的姓名
    local headshipLabel = Sprite:findChild(rootSprite,'headshipLabel') --名片内部的职位
    local txtDeptInfo = Sprite:findChild(rootSprite,'txtDeptInfo')  --名片内部的部门信息
    if scale < 0.93 and scale >= 0.9 then
        Log:write('the scale is '..scale..',the scale is lowest')
        Sprite:setProperty(nameLabel,'font-size','30')
        Sprite:setProperty(headshipLabel,'font-size','20')
        Sprite:setProperty(txtDeptInfo,'font-size','18')
    elseif scale >= 0.93 and scale < 0.96 then
        Sprite:setProperty(nameLabel,'font-size','30')
        Sprite:setProperty(headshipLabel,'font-size','20')
        Sprite:setProperty(txtDeptInfo,'font-size','20')
    else
        Sprite:setProperty(nameLabel,'font-size','35')
        Sprite:setProperty(headshipLabel,'font-size','23')
        Sprite:setProperty(txtDeptInfo,'font-size','23')
    end
end

--复位
function btnreset_onselected(sprite)
    setProgressBarPos(324)
end
--保存
function savebtn_onselected(sprite)
    --获取比例值
    local lblPercent = Sprite:findChild(rootSprite,'lblPercent')
    local percent = Sprite:getText(lblPercent)
    --保存至xml中
    local configString = string.gsub(percent,'[%%]','')
    local path = getLocalDiskPath() .. '/config.json'
    if IO:fileExist(path) == false then
        IO:fileCreate(path)
    end
    IO:fileWrite(path,configString)
    --Dialog:show('提示','保存成功','ok')
    failInvisible()
end


--显示设置更改时的提示信息
function failInvisible()
    Log:write('set visible')
    local nodeSuccess = Sprite:findChild(rootSprite,'nodeSuccess')
    Sprite:setVisible(nodeSuccess,1)
    Timer:set(158,3000,'failOutvisible')
end
--隐藏提示设置更改时的提示信息
function failOutvisible()
    Log:write('set unvisible')
    local nodeSuccess = Sprite:findChild(rootSprite,'nodeSuccess')
    Sprite:setVisible(nodeSuccess,0)
end

--增加或减少按钮单击事件
function addorslowButton_selected(sprite)
    local data = Sprite:getData(sprite)
    --获取当前滑块的刻度
    local point_x, point_y, point_w, point_h = Sprite:getRect(progressPointImg)
    if data == '01' then --减少
        if point_x>32 then
            point_x = point_x - 32
        else
            point_x = 0
        end
    else --增加
        if point_x<292 then
            point_x = point_x + 32
        else
            point_x = 324
        end
    end
    Sprite:setRect(progressPointImg,point_x,point_y,point_w,point_h)
    setProgressBarPos(point_x)
end

--多点触控，控制图片的缩放
function buttonOnTouchEvent(sprite,touch)
    Log:write('touch event ',touch.count)
    if touch.count>1 then
        local index = 0
        local txtDeptInfo = Sprite:findChild(rootSprite,'txtDeptInfo')
        while index < touch.count do
            Sprite:setProperty(txtDeptInfo,'text',Sprite:getText(txtDeptInfo)..'\r\n'..touch.pt[index].x..','..touch.pt[index].y)
            index = index + 1 
        end
    end
end


    ]]>
</root>
