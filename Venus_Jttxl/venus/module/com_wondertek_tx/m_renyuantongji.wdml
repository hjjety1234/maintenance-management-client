<?xml version="1.0" encoding="utf-8"?>
<!--
 == ============================================================================
 == | WonderTek [ 网络无处不在，沟通及时到达 ]
 == ============================================================================
 == | Copyright (c) 2012, WonderTek, Inc. All Rights Reserved.
 == ============================================================================
 == | Author: hewu <hewu2008@gmail.com>
 == ============================================================================
 == | Desc: 页面描述
 == ============================================================================
-->
<root>
    <header/>
    <body resolution="480,800" BuildChildrenFinished="bodyBuildChildrenFinished"
        OnSpriteEvent="bodyOnSpriteEvent" OnPluginEvent="bodyOnPluginEvent">
        <!-- 主节点  -->
        <node name="mainNode" rect="0,0,480,800" enable="true" 
            active="true" OnKeyUp="mainNodeOnKeyUp" layouttype="1" extendstyle="1111">
	        <!-- 设置背景 -->
	        <image name="image_bj" rect="0,80,480,720" src="file://image/jttxl/bj.png" style="autosize"
	           extendstyle="1111" />
	           
	        <!-- 设置头部 -->
            <node name="baseSprite" rect="0,0,480,80" extendstyle="1111">
                 <image rect="0,0,480,80" border="false" src="file://image/jttxl/top.png" 
                    style="autosize" extendstyle="1111">
                    <label name="title" rect="0,0,480,80" text="" color="#ffffff" v-align="center"  
                       h-align="center" font-family="微软雅黑" font-size="32" extendstyle="1111" />
                 </image>
            </node>
           <node rect="0,85,480,62" name="menuNode" extendstyle="1111">
                <button rect="30,10,130,62" name="left"  extendstyle="1111"  style='autosize' src='file://image/jttxl/local_menu_a2.png' OnSelect="groupOnSelect">
                    <label rect="0,0,130,50" name="leftLabel" font-family="微软雅黑" font-size="20" color="#ffffff" v-align="center" h-align="center" extendstyle="1111" />
                </button>
                <button rect="160,10,130,62" name="center"  extendstyle="1111"  style='autosize' src='file://image/jttxl/local_menu_b2.png' OnSelect="groupOnSelect">
                    <label rect="0,0,130,50" name="centerLabel" font-family="微软雅黑" font-size="20" color="#ffffff" v-align="center" h-align="center" extendstyle="1111" />
                </button>
                 <button rect="291,10,130,62" name="right"  extendstyle="1111"  style='autosize' src='file://image/jttxl/local_menu_c2.png' OnSelect="groupOnSelect">
                    <label rect="0,0,130,50" name="rightLabel" font-family="微软雅黑" font-size="20" color="#ffffff" v-align="center" h-align="center" extendstyle="1111" />
                </button>
                <button rect="425,12,50,50" name="showMoreBtn" extendstyle="1111" style='autosize' src="file://image/jttxl/local_top_more.png" OnSelect="showMoreGroup" visible="false" enable="false"/>
            </node>
             <!-- 下拉框节点 -->
            <node name="comboboxItem" rect="0,0,135,50" visible="false" enable="false" active="false"  extendstyle="1111">
                <button name="selectItemBtn" rect="0,0,135,50" normal="normal" sel="focus" OnSelect="comboboxItemOnSelect">
                    <node name="normal">
                        <label name="selectItemNormalLabel"  postfix="..." color="#ffffff" v-align="center" rect="10,0,135,50" extendstyle="1111"  font-size="21" />
                    </node>
                    <node name="focus">
                        <image rect="0,0,135,50" style="autosize" src="file://image/jttxl/local_fenlei_s.png"  extendstyle="1111"/>
                        <label name="selectItemFocusLabel"  postfix="..." color="#ffffff" v-align="center" rect="10,0,135,50" extendstyle="1111"  font-size="21" />
                    </node>
                </button>
            </node>
            
            <node name="cityListNode" rect="0,155,480,564" extendstyle="1111">
                <listview name="cityList" rect="0,0,480,564" extendstyle="1111" line="17" >
                </listview>    
            </node>
            <!--部门列表的item-->
            <node name="cityListItems" extendstyle="1111" visible="false" enable="false" active="false">
                 <!-- 图片连接线 -->
                <image name="jiange_line" rect="53,74,10,16" src="file://image/jttxl/jiange_line.png"
                    style='autosize' extendstyle="1111"/>
                <button name="zuzhiBtn" rect="0,0,480,92" data="" font-size="28" font-family='微软雅黑' color="#ffffff" OnSelect="doRegionClick" visiable="false" normal="normal" sel="sel" 
                    style="autosize" extendstyle="1111" text="">
                    <label name="lblid" visible="false" />
                    <!-- 组织机构名 -->
                    <scrolltext name="listButtonLabel" rect="150,12,240,45" text="" font-family='微软雅黑' color="#ffffff" font-size="28"
                        h-align="left" v-align="center" extendstyle="1111" border="false" scroll="true" />
                    <!--  正常时组织结构图片 -->
                    <node name="normal" extendstyle="1111">
                        <image name="cityImage_d" rect="21,0,75,74" src="file://image/jttxl/department_d.png"
                            style='autosize' extendstyle="1111"/> 
                        <image name="listButtonImage_d" rect="380,21,33,34" src="file://image/jttxl/more_d.png"
                            style='autosize' extendstyle="1111"/>                        
                    </node>
                    <!-- 点击时组织机构图片 -->
                    <node name="sel" extendstyle="1111">
                        <image name="cityImage_s" rect="21,0,75,74" src="file://image/jttxl/department_s.png"
                            style='autosize' extendstyle="1111"/>
                        <image name="listButtonImage_s" rect="380,21,33,34" src="file://image/jttxl/more_s.png"
                            style='autosize' extendstyle="1111"/>                    
                    </node> 
                </button>
            </node>
            <!--部门列表的item End-->
            <!-- 可以让select弹出框消失 -->
            <button name="blank" rect="0,0,480,800" OnSelect="blankOnSelect" extendstyle="1111" visible="false" enable="false" active="false"/>
            <!-- select 弹出框 -->
            <node name="comboboxsNode" rect="339,145,135,150" extendstyle="1111" visible="false" enable="false"  active="false">
               <image name="categoryImg" rect="0,0,135,150" src="file://image/jttxl/local_fenlei_d.png" style='autosize' extendstyle="1111"/>  
               <listview name="comboboxListview"  rect="0,0,135,150"  extendstyle="1111" auto-scroll="true" limit="true"/>
            </node>
            <!-- 底部菜单  -->
            <node name="listNode" rect="0,720,480,80" extendstyle="1111">
                <image  rect="0,0,480,80" border="false" extendstyle="1111" 
                src="file://image/book/list_bg.png"  style="autosize"/>
                <!-- 搜索  -->
                <button name='searchBtn' rect="15,0,110,80"  extendstyle="1111"  style='autosize'
                src='file://image/book/lianxiren_d.png' OnSelect="doSearch"></button>
                <!-- 联系人  -->
                <button name='contactBtn' rect="125,0,110,80"  extendstyle="1111"  style='autosize'
                src='file://image/book/zuijinglianxiren_s.png' OnSelect="doContact"></button>
                <!-- 个人中心  -->
                <button name='personBtn' rect="250,0,82,80"  extendstyle="1111"  style='autosize'
                src='file://image/book/person_d.png' OnSelect="doPersonalCenter"></button>
                <!-- 设置  -->
                <button name='siteBtn' rect="385,0,48,80"  extendstyle="1111"  style='autosize'
                src='file://image/book/site_d.png' OnSelect="doSetting"></button>
                <!-- New -->
                <node name="newNode" rect="410,0,48,80" extendstyle="1111">
                    <image  rect="10,5,43,28" border="false" src="file://image/jttxl/new1.png" 
                        style="autosize" extendstyle="1111" />
                </node>
            </node> 
        </node>
    </body>
    <![CDATA[

require 'com_wondertek_tx.common.framework'
require 'framework.webbrowser'
require 'framework.umsagent'
require('framework.sqlite')

local url_downdeptlist = Alias.url_server..'mobile/orger/downall?cmd=downall'
local url_userversion = Alias.url_server..'mobile/UserInfo/getUserInfoByCompany?'

local userversiondata
local databaseName
local rootSprite
local textcontent = {}
local currentCity 
local newNode

--群组代码
local groupDatas
local showData = {}
local moreGroup
local reg
--特殊群组
local companyGroup
local localGroup
--下拉框
local comboboxListview
local comboboxsNode
local comboboxItem
local blank

--保存从数据库取出来的城市列表
local retDeptTable2

local bRet2,companyTable,errMsg2

local currentCompanyId --保存当前选中的公司ID
local skinFalg='' --皮肤更新的标志
local skinPath='' --皮肤更新的路径
local skinData
local g_skinType

---------------------------------------回调函数--------------------------------
-- root子节点创建完事件
function bodyBuildChildrenFinished(sprite)
    rootSprite = sprite
    newNode = Sprite:findChild(rootSprite, 'newNode')
    reg = Reg:create('group_data')
    
    checkSkinPath()
	--更多下拉框
    comboboxListview = Sprite:findChild(rootSprite, 'comboboxListview')
    comboboxItem = Sprite:findChild(rootSprite, 'comboboxItem')
    blank = Sprite:findChild(rootSprite, 'blank')
    comboboxsNode = Sprite:findChild(rootSprite, 'comboboxsNode')
end

-- root节点消息方法
function bodyOnSpriteEvent(msg, param)
    if msg == MSG_ACTIVATE then -- 页面激活
        UmsAgent:OnActivate(string.match(Alias.m_renyuantongji, 'MODULE:\\(.*)'), 
            "组织机构首页")
        Timer:set(333, 100, "bodyOnSpriteFinish") 
    elseif msg == MSG_DEACTIVATE then
		UmsAgent:OnDeactivate()
    elseif msg == MSG_TAB_CLICKED then 
        local _, tab = getSelectedPage()
        if tab == 0 then 
            local left = Sprite:findChild(rootSprite, "left")
            groupOnSelect(left)
        elseif tab == 1 then 
            local center = Sprite:findChild(rootSprite, "center")
            groupOnSelect(center)
        end
    end
end

-- @brief 异步加载页面
function bodyOnSpriteFinish()
    if (Config:get("isNeedUpdate") == "true") then 
        setAllShoworHide(newNode, 1)
    else 
        setAllShoworHide(newNode, 0)
    end 
    Sprite:setProperty(Sprite:findChild(rootSprite,'personBtn'), 
        'src', 'file://image/book/person_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'searchBtn'),
        'src', 'file://image/book/lianxiren_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'contactBtn'),
        'src', 'file://image/book/zuijinglianxiren_s.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'siteBtn'),
        'src', 'file://image/book/site_d.png')
    Timer:set(222, 100, "checkDeviceInfo") 
    -- 初始化数据
    initCityData()
    queryGroupData()
    if tonumber(judgeFlag) == 2 then
        showTitleData(compName)
    else
        local showGroup
        for i=1,#showData do
            showGroup=showData[i]
            --更改标题
            if showGroup[4] == '1' then
                showTitleData()
                loadDeptData(showGroup[1])
                break
            elseif showGroup[4] == '-1' then
                Reg:setString(reg, 'company_name', showGroup[2])
                Scene:go(Alias.m_local,true)
                Log:write('m_local')
                break
            else
                Reg:setString(reg, 'company_id', (showGroup[1] == nil and "") or showGroup[1])
                Reg:setString(reg, 'company_name', showGroup[2])
                Log:write('m_group')
                Scene:go(Alias.m_group, true)
                break
            end
        end
    end 
end

-- 插件消息方法
function bodyOnPluginEvent(msg, param)
    if msg == 101 then
    elseif msg == 102 then
        --if Loading:isShow() then Loading:close() end
        local departmentdata1 = Http:jsonDecode('departmentdata0')
        local total = departmentdata1.total   
        Log:write('===total====='..total)  
        if total > 0 then
            bRet, errMsg = Sqlite:update(databaseName, "BEGIN;")
            Log:write("部门1添加事务开始:bRet = "..bRet.." errMsg ="..errMsg)
            for i=0,total-1 do
                local Valuedata = departmentdata1["value"][i]
                local department_id = Valuedata.department_id
                local department_name = Valuedata.department_name
                local parent_department_id = Valuedata.parent_department_id
                local department_level = Valuedata.department_level
                local department_firstword = Valuedata.department_firstword
                local company_id = Valuedata.company_id
                local display_order = Valuedata.display_order              
                local sql = "insert into tb_c_department(department_id,department_name,parent_department_id,department_level,department_firstword,mark1,mark2,mark3,mark4,company_id) values ('"..
                    department_id.."','"..department_name.."','"..parent_department_id.."','"..department_level.."','"..department_firstword.."' ,'"..display_order.."' ,'' ,'' ,'','"..company_id.."' );"
              --  Log:write('下载部门信息插入语句==第i=='..i..'次==sql=='..sql)
                bRet, errMsg = Sqlite:update(databaseName, sql)
            end
            bRet, errMsg = Sqlite:update(databaseName, "COMMIT;") 
            Log:write("部门1添加事务结束:bRet = "..bRet.." errMsg ="..errMsg)
        end

        Log:write('===departmentdata1.deptversion====='..departmentdata1.deptversion)
        department_version = departmentdata1.deptversion
        Config:set('deptversion', departmentdata1.deptversion)
        Log:write('deptversion====='..Config:get('deptversion'))
        --set dept version to db
        local v 
        local sql = "select department_version from tb_c_system;"
        bRet,v, errMsg = Sqlite:query(databaseName, sql)

        if(tonumber(v[1][1]) < departmentdata1.deptversion) then
            local sql = "update tb_c_system set department_version = '"..departmentdata1.deptversion.."';"
            bRet, errMsg = Sqlite:update(databaseName, sql)
        end
        -- 下载联系人接口地址
        firstUpdateUserData()

    elseif msg == 103 then 
        userversiondata = Http:jsonDecode('userversiondata0')
        InsertEmployeeData()

        if Loading:isShow() then Loading:close() end

        loadDeptData(currentCompanyId)

    elseif msg == 101 + MSG_CACHEDATA_RELOAD then -- 101请求的数据有更新
    elseif msg == 101 + MSG_NETWORK_ERROR then -- 101请求的数据超时
    elseif msg == 1000 then 
       checkDeviceRespProc()
    elseif msg == MSG_NETWORK_ERROR then -- 拨号失败
        Log:write('拨号失败')
    elseif msg > MSG_NETWORK_ERROR then -- 请求超时
        Log:write('请求超时')
    end
end

-- 按键响应处理
function mainNodeOnKeyUp(sprite, kc)
    if kc == Key.F2 then -- 按下返回键
        -- Dialog:show('提示', '是否确定退出？', 'ok_cancel', 'doExit') 
        --Scene:go(Alias.m_recentContacter, true)
        --return 1
        if Loading:isShow() then
            Loading:close()
        else
            Util:backgroundApp()
        end
    end
end

---------------------------------检查皮肤是否更新了-------------

function checkSkinPath()
    local imagebj=Sprite:findChild(rootSprite, 'image_bj')  
    Log:write("开始鉴权皮肤是否更新renyuantongji...")

    g_skinType = "0";
    --从数据库获取皮肤路径，判断是否为空
    local sql =" SELECT * FROM tb_c_skin where skin_type = '"..g_skinType.."' ;"
    local bRet,skinData,errMsg = Sqlite:query(Config:get('databaseName'), sql)
    Log:write("搜索皮肤更新分组SQL: ",errMsg)
    Log:write("搜索皮肤更新分组结果: ",skinData)

    len = tonumber(getJsonArrayCount(skinData))-1
    Log:write("皮肤更新列表记录数目：",len)
    Log:write("皮肤更新数据库：",skinData)

    if len == 0 then
        skinPath = ""
        skinFalg = ""
    else
        skinPath = skinData[1][1]
        skinFalg = skinData[1][10]
    end 

    -- skinFalg = Config:get('skinFlag')
    -- skinPath = Config:get('skinPath')
    Log:write("开始鉴权皮肤是否更新skinFalg...", skinFalg)
    Log:write("开始鉴权皮肤是否更新skinPath...", skinPath)
    
    if (skinFalg~='' and skinFalg=='1' and skinPath~='' and skinPath~=nil) then --如果皮肤已经更新
         Log:write("皮肤更新了"..skinPath..'/bg.png')
         Sprite:setProperty(imagebj,'src',skinPath..'/bg.png')
    else
         Log:write("皮肤没有更新")
         Sprite:setProperty(imagebj,'src','file://image/jttxl/bj.png')
    end
end


----------------------------------服务端交互函数列表---------------------------------

function doRegionClick(sprite)
    UmsAgent:onLoadStart()
    -- 获取当前被选地市的数据
    local current_dept_id = Sprite:getProperty(Sprite:findChild(sprite,'lblid'),'text')
    local listButtonLabel = Sprite:findChild(sprite,'listButtonLabel')
    local current_dept_name = Sprite:getProperty(listButtonLabel,'text')
    Log:write('the current_dept_id  is ',current_dept_id)
    UmsAgent:onLoadFinish()

    --如果没有二级组织，则直接跳转至人员列表
    local strSQL = "SELECT count(*) FROM tb_c_department WHERE parent_department_id='"..current_dept_id.."'"
    local  bRet1, retDeptTable1, errMsg1 = Sqlite:query(Config:get('databaseName'), strSQL)
    if(tonumber(retDeptTable1[1][1])>0) then
        Scene:go(Alias.m_zuzhijiegou.."?departmentid="..current_dept_id.."&departmentname="..current_dept_name..'&currentCompanyId='..currentCompanyId, true)
    else
        Scene:setReturn(Alias.m_renyuantongji, Alias.m_lianxirenlist)
        Scene:go(Alias.m_lianxirenlist.."?department_id="..current_dept_id.."&parent_departmentname="..current_dept_name..'&currentCompanyId='..currentCompanyId, true)
    end
    --Timer:set(3, 50, 'jumpToDeptPage')
end

function jumpToDeptPage()
    local mapdataHandler = Reg:create("mapdataRoom")
    Log:write('===='.."departmentid="..currentCity.deptid.."&departmentname="..currentCity.name)
    local anhuiBgImg = Sprite:findChild(rootSprite, 'anhuiBgImg')
    Sprite:setProperty(anhuiBgImg, 'visible', 'false')
    if currentCity.key == 'anhui' then
        Reg:setString(mapdataHandler, 'cityname', currentCity.key)
        Reg:setString(mapdataHandler, 'cityid', currentCity.deptid)
        Scene:setReturn(Alias.m_renyuantongji, Alias.m_zuzhijiegou)
        Scene:go(Alias.m_zuzhijiegou.."?departmentid="..currentCity.deptid.."&departmentname="..currentCity.name, true)       
        else
        Reg:setString(mapdataHandler, 'cityname', currentCity.key)
        Reg:setString(mapdataHandler, 'cityid', currentCity.deptid)
        Scene:setReturn(Alias.m_renyuantongji, Alias.m_zuzhijiegou)
        Scene:go(Alias.m_zuzhijiegou.."?departmentid="..currentCity.deptid.."&departmentname="..currentCity.name.."分公司", true)
    end
end

-- 隐藏地市
function hideCityNode(sprite)
    local cityNode = Sprite:findChild(rootSprite, 'cityNode')
    Sprite:setProperty(cityNode, 'visible', 'false')
    Sprite:setProperty(cityNode, 'enable', 'false')
end

function OnSelectShowMap(sprite)
    local cityNode = Sprite:findChild(rootSprite, 'cityNode')
    Sprite:setProperty(cityNode, 'visible', 'false') 
end

function OnstaffRatioBtn(sprite)
    local BtnData = Sprite:getData(sprite)
    local RatioCont = Sprite:findChild(rootSprite,'RatioCont')
    local solve= Sprite:findChild(rootSprite,'solve')
    setAllShoworHide(RatioCont, 1)
    local textcont = Sprite:findChild(rootSprite,'textcont')
    Sprite:setProperty(textcont,'text',textcontent[tonumber(BtnData)])
    if BtnData=='2' then 
        Sprite:setProperty(solve,'src','file://image/base_dialog1.png')
        Sprite:setRect(solve,70,37,316,54)  
        Sprite:setRect(textcont,75,15,300,80) 
    elseif  BtnData=='1' then 
        Sprite:setProperty(solve,'src','file://image/base_dialog.png')
        Sprite:setRect(solve,30,37,316,54)  
        Sprite:setRect(textcont,35,15,300,80) 
    end
end

function hiveRatioCont()
    local RatioCont = Sprite:findChild(rootSprite,'RatioCont')
    setAllShoworHide(RatioCont, 0)
end

-- 搜索函数
function doSearch(sprite)
    Sprite:setProperty(sprite,'src','file://image/book/lianxiren_s.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'contactBtn'),'src','file://image/book/zuijinglianxiren_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'personBtn'),'src','file://image/book/person_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'siteBtn'),'src','file://image/book/site_d.png')
    Scene:go(Alias.m_recentContacter, true)
end

-- 联系人列表
function doContact(sprite)
    Sprite:setProperty(sprite,'src','file://image/book/zuijinglianxiren_s.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'searchBtn'),'src','file://image/book/lianxiren_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'personBtn'),'src','file://image/book/person_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'siteBtn'),'src','file://image/book/site_d.png')
    Scene:go(Alias.m_renyuantongji, true)
    --Log:write("已在联系人列表界面，点击不做任何操作！")
end

-- 个人信息详情
function doPersonalCenter(sprite)
    Sprite:setProperty(sprite,'src','file://image/book/person_s.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'searchBtn'),'src','file://image/book/zuijinglianxiren_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'contactBtn'),'src','file://image/book/contact_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'siteBtn'),'src','file://image/book/site_d.png')   
    Scene:go(Alias.m_stdMyInfo, true)
end

-- 设置
function doSetting(sprite)
    Sprite:setProperty(sprite,'src','file://image/book/site_s.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'searchBtn'),'src','file://image/book/zuijinglianxiren_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'contactBtn'),'src','file://image/book/contact_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'personBtn'),'src','file://image/book/person_d.png') 
    Scene:go(Alias.m_system, true)
end

function goSearchPage()
    Log:write("进入搜索 = ") 
    Scene:setReturn(Alias.m_renyuantongji, Alias.m_searchContacter)
    Scene:go(Alias.m_searchContacter, true)
end

function initCityData()
    Log:write("@jldu 初始化数据：")
    databaseName = Config:get('databaseName')
    local bRet, errMsg = Sqlite:open(databaseName)
    --如果非企业用户不执行下面的
    local queryGroup = "select company_id,company_name,status,org_flag from tb_c_company where org_flag='1' order by org_flag desc,company_name desc;"
    bRet2, companyTable, errMsg2 = Sqlite:query(databaseName, queryGroup)
    if companyTable == nil or #companyTable ==0 then
        return
    end
    currentCompanyId = companyTable[1][1]
    local company_id = companyTable[1][1]
    if tonumber(judgeFlag) == 2 then
        Log:write("@jldu 从本机通讯录跳转过来")
        currentCompanyId = compId
        loadDeptData(compId)
        Reg:setString(reg, 'compId', compId)
    else
        Log:write("@jldu 从底部菜单点击")
        loadDeptData(company_id) 
        Reg:setString(reg, 'compId', company_id)
    end       
end

-- 加载部门数据
function loadDeptData(company_id)

    --@guokai,判断当前企业用户数据是否已经下载：若未下载，启动下载流程
    local count_sql = "select count(department_id) from tb_c_department where company_id='"..company_id.."';"
    local count;
    bRet2, count, errMsg2 = Sqlite:query(Config:get('databaseName'), count_sql)
    Log:write('@guokai,当前企业部门数 ',count)

    local count_emp_sql = "select count(employee_id) from tb_c_employee where company_id='"..company_id.."';"
    local count_emp;
    bRet2, count_emp, errMsg2 = Sqlite:query(Config:get('databaseName'), count_emp_sql)
    Log:write('@guokai,当前企业用户数据 ',count_emp)

    if tonumber(count[1][1]) == 0 then

        Loading:show(rootSprite)   --启动更新部门的loading
        local v
        local sql = "SELECT user_id FROM tb_c_system"
        bRet2,v, errMsg2 = Sqlite:query(databaseName, sql) 
        Log:write("系统表userId:bRet = "..bRet2.." errMsg ="..errMsg2.."userId is ",v[1][1]) 
        local paras = '&userCode='..Config:get('userId')..'&deptCode=0'..'&deptList='..'&token='..'&company_id='..company_id
        Http:request('departmentdata0', url_downdeptlist..paras, 102, {useCache = false})
        Log:write('首次登录时组织结构URL = '..url_downdeptlist..paras)

    elseif tonumber(count_emp[1][1])<=1  then
        Loading:show(rootSprite)   --启动更新用户的loading
        firstUpdateUserData()
    else 
        Log:write("@jldu 展示某个企业下的部门：",company_id)
        local sql2 = "select department_id, department_name,mark1 from tb_c_department where parent_department_id='0' and department_id!='001' and company_id='"..
            company_id.."' ORDER BY cast(mark1 as integer) ASC;"
        Log:write("==查询语句=="..sql2)
        bRet2, retDeptTable2, errMsg2 = Sqlite:query(Config:get('databaseName'), sql2)
        Log:write('@jldu 部门树数据： ',retDeptTable2)
        --开始绑定部门树
        local len = getJsonArrayCount(retDeptTable2)-1
        Log:write('the length is ',len)
        local list = Sprite:findChild(rootSprite,'cityList')
        ListView:removeAllItems(list,1)
        ListView:loadItem(list, Sprite:findChild(rootSprite, 'cityListItems'), len, 'LoadListItemCallback')
        ListView:adjust(list)
    end  
end

--加载部门列表
function LoadListItemCallback(list,item,index)
    Log:write('then company is ',retDeptTable2[index+1][2])
    Sprite:setRect(item,0,0,420,90) 
    Sprite:setProperty(item,'extendstyle','1111') 
    local zuzhiBtn = Sprite:findChild(item,'zuzhiBtn')  
    Sprite:setProperty(zuzhiBtn,'Data',retDeptTable2[index+1][1])
    --改用label绑定（data取不到，郁闷）
    local lblid = Sprite:findChild(item,'lblid')
    Sprite:setProperty(lblid,'text',retDeptTable2[index+1][1])
    local listButtonLabel = Sprite:findChild(item,'listButtonLabel') 
    Sprite:setProperty(listButtonLabel,'text',retDeptTable2[index+1][2])
end

function queryGroupData()
    if databaseName == nil then
        databaseName = Config:get('databaseName')
        local bRet, errMsg = Sqlite:open(databaseName)
    end
    
    local queryGroup = "select company_id,company_name,status,org_flag from tb_c_company order by org_flag desc,company_name desc;"
    bRet2, companyTable, errMsg2 = Sqlite:query(databaseName, queryGroup)
    groupDatas = companyTable
    showData = {}
    Log:write('@jldu 群组数据（企业与非企业）：', groupDatas)
    initTitleData()
end

function initTitleData()
    --字段顺序company_id,company_name,status,org_flag
    --本地通讯录
    local localContacts
    if Config:get('localContactStatus') == '1' then
        localContacts = {[2]="本机通讯录",[3]="1",[4]="-1"}
    end
    local num = 0     -- 企业用户个数
    local group
    local special = {}
    for i=1,#groupDatas do
        group = groupDatas[i]
        if group[3] == '1' then
            table.insert(showData,group)
            if group[4] == '1' then
                num = num + 1
                table.insert(special,group)
            end
        end
    end
    Log:write("@jldu 企业、非企业：",showData)
    Log:write("@jldu 企业用户个数：",num)
    Log:write("@jlud 企业用户：",special)
    local groupNum = #special + 1
    Log:write("@lnn #special = ",groupNum)
    if localContacts ~= nil then
        table.insert(showData,groupNum,localContacts)
        -- if special == nil then
        --     table.insert(showData,1,localContacts)
        -- elseif #special == 1 then
        --     table.insert(showData,2,localContacts)
        -- elseif #special == 2 then
        --     table.insert(showData,3,localContacts)
        -- end
    end
    Log:write("@jldu 企业、非企业、本地通讯录：",showData)
    -- 企业单位
    companyGroup = special
    -- 本机通讯录
    localGroup = localContacts
    
end
function showTitleData(company_name)
    if company_name == nil and companyGroup ~= nil then
        company_name = companyGroup[1][2]
        Reg:setString(reg, 'compName', company_name)
    end
    local title = Sprite:findChild(rootSprite, 'title')
    local leftBtn = Sprite:findChild(rootSprite, 'left')
    local centerBtn = Sprite:findChild(rootSprite, 'center')
    local rightBtn = Sprite:findChild(rootSprite, 'right')
    local leftLabel = Sprite:findChild(rootSprite, 'leftLabel')
    local centerLabel = Sprite:findChild(rootSprite, 'centerLabel')
    local rightLabel = Sprite:findChild(rootSprite, 'rightLabel')
    local showMore = Sprite:findChild(rootSprite, 'showMoreBtn')
    -- 初始化默认Tab 图片
    Sprite:setProperty(leftBtn, 'src', 'file://image/jttxl/local_menu_a2.png')
    Sprite:setProperty(centerBtn, 'src', 'file://image/jttxl/local_menu_b2.png')
    Sprite:setProperty(rightBtn, 'src', 'file://image/jttxl/local_menu_c2.png')

    Sprite:setVisible(showMore, 0)
    Sprite:setEnable(showMore, 0)
    Sprite:setProperty(title, 'text', company_name)
    local count = #showData
    Log:write('@jldu count：', count)
    if count == 1 then
        Sprite:setVisible(leftBtn, 0)
        Sprite:setEnable(leftBtn, 0)
        Sprite:setVisible(centerBtn, 0)
        Sprite:setEnable(centerBtn, 0)
        Sprite:setVisible(rightBtn, 0)
        Sprite:setEnable(rightBtn, 0)
        local cityListNode = Sprite:findChild(rootSprite, 'cityListNode')
        local cityList = Sprite:findChild(cityListNode, 'cityList')
        local x,y,w,h=Sprite:getRect(cityListNode)
        Sprite:setRect(cityListNode, x, y-62, w, h+62)
        Sprite:setRect(cityList, 0, 0, w, h+62)
    elseif count == 2 then
        Sprite:setVisible(centerBtn, 0)
        Sprite:setRect(centerBtn, 0, 0, 0, 0)
        Sprite:setRect(leftBtn, 27,0,213,62)
        Sprite:setRect(rightBtn, 239,0,213,62)
        Sprite:setProperty(leftLabel, 'text', showData[1][2])
        Sprite:setProperty(rightLabel, 'text', showData[2][2])

        Sprite:setRect(leftLabel, 0,0,213,50)
        Sprite:setRect(rightLabel, 0,0,213,50)
        Sprite:setProperty(leftBtn, 'src', 'file://image/jttxl/local_top_a2.png')
        Sprite:setProperty(rightBtn, 'src', 'file://image/jttxl/local_top_b1.png')
        if showData[1][2] == company_name then
            Sprite:setProperty(leftBtn, 'src', 'file://image/jttxl/local_top_a1.png')
        elseif showData[2][2] == company_name then
            Sprite:setProperty(rightBtn, 'src', 'file://image/jttxl/local_top_b2.png')
        end
        Sprite:setProperty(leftBtn, 'data', 1)
        Sprite:setProperty(rightBtn, 'data', 2)
    elseif count == 3 then
        Sprite:setProperty(leftLabel, 'text', showData[1][2])
        Sprite:setProperty(centerLabel, 'text', showData[2][2])
        Sprite:setProperty(rightLabel, 'text', showData[3][2])

        Sprite:setRect(leftBtn, 50,10,130,62)
        Sprite:setRect(centerBtn, 181,10,130,62)
        Sprite:setRect(rightBtn, 312,10,130,62)
        
        if showData[1][2] == company_name then
            Sprite:setProperty(leftBtn, 'src', 'file://image/jttxl/local_menu_a1.png')
        elseif showData[2][2] == company_name then
            Sprite:setProperty(centerBtn, 'src', 'file://image/jttxl/local_menu_b1.png')
        elseif showData[3][2] == company_name then
            Sprite:setProperty(rightBtn, 'src', 'file://image/jttxl/local_menu_c1.png')
        end
        Sprite:setProperty(leftBtn, 'data', 1)
        Sprite:setProperty(centerBtn, 'data', 2)
        Sprite:setProperty(rightBtn, 'data', 3)
    elseif count > 3 then
        Sprite:setProperty(leftLabel, 'text', showData[1][2])
        Sprite:setProperty(centerLabel, 'text', showData[2][2])
        Sprite:setProperty(rightLabel, 'text', showData[3][2])

        Sprite:setRect(leftBtn, 30,10,130,62)
        Sprite:setRect(centerBtn, 161,10,130,62)
        Sprite:setRect(rightBtn, 292,10,130,62)
        
        if showData[1][2] == company_name then
            Sprite:setProperty(leftBtn, 'src', 'file://image/jttxl/local_menu_a1.png')
        elseif showData[2][2] == company_name then
            Sprite:setProperty(centerBtn, 'src', 'file://image/jttxl/local_menu_b1.png')
        elseif showData[3][2] == company_name then
            Sprite:setProperty(rightBtn, 'src', 'file://image/jttxl/local_menu_c1.png')
        end
        Sprite:setProperty(leftBtn, 'data', 1)
        Sprite:setProperty(centerBtn, 'data', 2)
        Sprite:setProperty(rightBtn, 'data', 3)
        Sprite:setVisible(showMore, 1)
        Sprite:setEnable(showMore, 1)
    end
end
function groupOnSelect(sprite)
    local index = Sprite:getData(sprite)
    local data = showData[tonumber(index)]
    Log:write('@jldu 点击群组获得数据：', data)
    Log:write('@jldu 组织结构标题：'..Sprite:getText(Sprite:findChild(rootSprite, 'title')))
    Reg:setString(reg, 'company_id', (data[1] == nil and "") or data[1])
    Reg:setString(reg, 'company_name', data[2])
    Reg:setString(reg, 'org_flag', data[4])
    currentCompanyId = (data[1] == nil and "") or data[1]
    if data[2] ~= Sprite:getText(Sprite:findChild(rootSprite, 'title')) then
        if data[4] == '1' then
            loadDeptData(data[1])
            showTitleData(data[2])
            Reg:setString(reg, 'compId',data[1])
            Reg:setString(reg, 'compName',data[2])
            local compName = Reg:getString(reg, 'compName')
            local compId = Reg:getString(reg, 'compId')
            Log:write("@jldu renyuantongji compName="..compName.." compId="..compId)
        elseif data[4] == '-1' then
            setMainPage(1, 1)
            local root = Sprite:getRoot(sprite) 
            Sprite:sendEvent(root, MSG_ACTIVATE)
        elseif data[4] == '0' then
            Scene:go(Alias.m_group,true)
        end
    end
end
--更多
function showMoreGroup(sprite)
    moreGroup={}
    for i=4,#showData do
        table.insert(moreGroup,showData[i])
    end
    ListView:removeAllItems(comboboxListview, 1, 1)
    if Sprite:isVisible(comboboxsNode) == 1 then -- 如果显示则隐藏，如果隐藏则显示
        Sprite:setVisible(comboboxsNode, 0)
        Sprite:setEnable(comboboxsNode, 0)
        Sprite:setActive(comboboxsNode, 0)
        Sprite:setVisible(blank, 0)
        Sprite:setEnable(blank, 0)
        Sprite:setActive(blank, 0)
    else
        Sprite:setVisible(comboboxsNode, 1)
        Sprite:setEnable(comboboxsNode, 1)
        Sprite:setActive(comboboxsNode, 1)
        Sprite:setVisible(blank, 1)
        Sprite:setEnable(blank, 1)
        Sprite:setActive(blank, 1)
    end
    ListView:loadItem(comboboxListview, comboboxItem, #moreGroup, 'onLoadcomboboxList')
    --重设高度
    resetComboboxHeight()
    ListView:adjust(comboboxListview)
end
function resetComboboxHeight()
    local categoryImg = Sprite:findChild(comboboxsNode, 'categoryImg')
    local nx,ny,nw,nh = Sprite:getRect(comboboxsNode)
    local ix,iy,iw,ih = Sprite:getRect(categoryImg)
    local vx,vy,vw,vh = Sprite:getRect(comboboxListview)
    local height = 50*(#moreGroup)
    height = ((height>280 and 280) or height)
    Sprite:setRect(comboboxsNode, nx, ny, nw, height)
    Sprite:setRect(categoryImg, ix, iy, iw, height)
    Sprite:setRect(comboboxListview, vx, vy, vw, height)
end
-- @brief 加载comboboxItem的回调函数
function onLoadcomboboxList(list, item, index)
     Log:write('onLoadcomboboxList', index)
      Sprite:setRect(item, 0, 0, 135, 50)
      local selectItemNormalLabel = Sprite:findChild(item, 'selectItemNormalLabel')
      local selectItemFocusLabel = Sprite:findChild(item, 'selectItemFocusLabel')
      local selectItemBtn = Sprite:findChild(item, 'selectItemBtn')
      Sprite:setProperty(selectItemNormalLabel, 'text', moreGroup[index+1][2])
      Sprite:setProperty(selectItemFocusLabel, 'text', moreGroup[index+1][2])
      Sprite:setProperty(selectItemBtn, 'data', index+1)
end
function comboboxItemOnSelect(sprite)
    Sprite:setVisible(comboboxsNode, 0)
    Sprite:setEnable(comboboxsNode, 0)
    Sprite:setActive(comboboxsNode, 0)
    Sprite:setVisible(blank, 0)
    Sprite:setEnable(blank, 0)
    Sprite:setActive(blank, 0)
    
    local index = Sprite:getData(sprite)
    local data = moreGroup[tonumber(index)]
    Log:write('comboboxItemOnSelect', data)
    Reg:setString(reg, 'company_id', (data[1] == nil and "") or data[1])
    Reg:setString(reg, "company_name","")
    Reg:setString(reg, "more_name",data[2])
    Reg:setString(reg, 'org_flag', data[4])
    if data[2] ~= Sprite:getText(Sprite:findChild(rootSprite, 'title')) then
        if data[4] == '1' then
             --Scene:go(Alias.renyuantongji,true)
             currentCompanyId = data[1]
             loadDeptData(data[1])
             showTitleData(data[2])
             Reg:setString(reg, 'compId',data[1])
             Reg:setString(reg, 'compName',data[2])
             local compName = Reg:getString(reg, 'compName')
             local compId = Reg:getString(reg, 'compId')
             Log:write("@lnn renyuantongji compName="..compName.." compId="..compId)
        elseif data[4] == '-1' then
             Reg:setString(reg, "company_name",data[2])
             Scene:go(Alias.m_local,true)
        elseif data[4] == '0' then
             Scene:go(Alias.m_group,true)
        end
    end 
end
-- 点击其他区域让弹出框消失
function blankOnSelect()
    local comboboxsNode = Sprite:findChild(rootSprite, 'comboboxsNode')
    Sprite:setVisible(comboboxsNode, 0)
    Sprite:setEnable(comboboxsNode, 0)
    Sprite:setVisible(blank, 0)
    Sprite:setEnable(blank, 0)
    Sprite:setActive(blank, 0)
end
function localOnselect(sprite)
    Scene:setReturn(Alias.m_renyuantongji, Alias.m_local)
    -- Scene:go(Alias.m_local, true)
    -- 不释放页面，提高加载速度
    Scene:go(Alias.m_local)
end


-- 新加企业需要下载所有用户数据
function firstUpdateUserData()
        Log:write("新加企业，需要请求服务端接口！")
        local v
        local sql = "SELECT employee_version,user_id FROM tb_c_system"
        bRet,v, errMsg = Sqlite:query(databaseName, sql)  
        paras = 'departmentIdStr=0'..'&userId='..v[1][2]..'&companyId='..currentCompanyId..'&versionNum=0'
        Log:write('联系人URL = '..url_userversion..paras)
        Http:request('userversiondata0', url_userversion..paras, 103, {useCache = false})  
end

-- 初始化本地人员表
function InsertEmployeeData()
    local returnValue = userversiondata.value     
    local totalNum1 = tonumber(userversiondata.total)-1  
    Log:write("配置文件中存储的用户版本号：",Config:get('userVersion'))
    Log:write("配置文件中存储的用户权限：",Config:get('mobileRights'))
    Log:write("配置文件中存储的用户权限：",totalNum1)

    bRet, errMsg = Sqlite:update(databaseName, "BEGIN;")
    Log:write("新加企业--人员添加事务开始:bRet = "..bRet.." errMsg ="..errMsg)
    for i=0,totalNum1 do 
        -- 新增用户SQL
        local sqlInsert = "insert into tb_c_employee(employee_id ,company_id,employee_name,"..
            "department_id,department_name,headship_level,headship_name,mobile,mobile_short,"..
            "tel,tel_short,home_telephone,weibo,weixin,qq,school,user_major,user_grade,user_class,student_id,birthday,native_place,"..
            "address,home_address,remark,email,versionNum,picture,employee_firstword,employee_fullword,"..
            "parent_department_name,display_order, department_fax, manage_flag, mood , mark1, mark2, mark3, mark4,user_company_id,company_address,user_company)" ..
            " values('"..returnValue[i].employee_id.."','"..returnValue[i].company_id.."','"..
        returnValue[i].employee_name.."','"..returnValue[i].department_id.."','"..
        returnValue[i].department_name.."','','"..
        returnValue[i].headship_name.."','"..returnValue[i].mobile.."','"..
        returnValue[i].mobile_short.."','"..returnValue[i].tel.."','"..
        returnValue[i].tel_short.."','"..returnValue[i].home_telephone.."','"..
        returnValue[i].weibo.."','"..returnValue[i].weixin.."','"..
        returnValue[i].qq.."','"..returnValue[i].school.."','"..
        returnValue[i].user_major.."','"..returnValue[i].user_grade.."','"..
        returnValue[i].user_class.."','"..returnValue[i].student_id.."','"..
        returnValue[i].birthday .."','"..returnValue[i].native_place.."','"..
        returnValue[i].address.."','"..returnValue[i].home_address.."','"..
        returnValue[i].remark.."','"..returnValue[i].email.."','"..
        returnValue[i].group_version_num.."','"..returnValue[i].picture.."','"..
        returnValue[i].employee_firstword.."','"..returnValue[i].employee_fullword.."','"..returnValue[i].parent_department_name..
                "','"..returnValue[i].display_order.."','"..returnValue[i].department_fax.."','"..
        returnValue[i].manage_flag.."','"..returnValue[i].mood.."' ,'' ,'' ,'' ,'','"..returnValue[i].user_company_id.."','"..returnValue[i].company_address.."','"..returnValue[i].user_company.."');"                 
        Log:write("sqlInsert = ",sqlInsert)
        bRet, errMsg = Sqlite:update(databaseName, sqlInsert)
        Log:write("新增用户:bRet = "..bRet.." errMsg ="..errMsg)

                    --插入用户部门信息
        local deptList = returnValue[i].deptList
        --Log:write('deptlist size is ',#deptList)
        --Log:write("user_department_id is ",deptList[0].user_department_id)
        if deptList ~= nil then
            for i=0,#deptList do
                local dept_path = deptList[i].department_path
                if dept_path == nil then dept_path = '' end
                local gheadship_name = deptList[i].headship_name
                if gheadship_name == nil then gheadship_name = '' end

                -- local sqlDelete = "DELETE FROM tb_c_user_department WHERE user_company_id = '"..returnValue[i].user_company_id.."';"
                -- Log:write("sqlDelete = ",sqlDelete)
                -- bRet, errMsg = Sqlite:update(databaseName, sqlDelete)
                -- Log:write("删除用户:bRet = "..bRet.." errMsg ="..errMsg)

                local sqlInsert = "insert into tb_c_user_department (user_department_id,user_company_id,headship_id,headship_name,department_id,department_path,taxis,headship_name)"
                sqlInsert = sqlInsert .." values ('"..deptList[i].user_department_id.."','"..deptList[i].user_company_id.."','"..deptList[i].headship_id.."','"..gheadship_name.."','"..deptList[i].department_id.."','"..dept_path.."',"..deptList[i].taxis..",'"..deptList[i].headship_name.."');"
                --Log:write('department insert sql is ',sqlInsert)
                bRet,errMsg = Sqlite:update(databaseName,sqlInsert)
                Log:write("插入用户:bRet = "..bRet.." errMsg ="..errMsg)
            end
        end
    end
    bRet, errMsg = Sqlite:update(databaseName, "COMMIT;") 
    Log:write("新加企业--人员添加事务结束:bRet = "..bRet.." errMsg ="..errMsg) 
    local v
    local sql = "SELECT employee_version FROM tb_c_system"
    bRet,v, errMsg = Sqlite:query(databaseName, sql)    
    if tonumber(returnValue[0].group_version_num) > tonumber(v[1][1]) then
        maxUserVersion = returnValue[0].group_version_num
    else
        local v
        local sql = "SELECT employee_version FROM tb_c_system"
        bRet,v, errMsg = Sqlite:query(databaseName, sql)
        maxUserVersion = v[1][1]  
    end

    Log:write("maxUserVersion = ",maxUserVersion)
    employee_version = maxUserVersion
    Config:set('userVersion',employee_version)
    local sql = "update tb_c_system set employee_version = '"..employee_version.."';"
    bRet, errMsg = Sqlite:update(databaseName, sql)
end

    ]]>
</root>
