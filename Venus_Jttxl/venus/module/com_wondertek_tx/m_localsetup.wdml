<?xml version="1.0" encoding="utf-8"?>
<!--
 == ============================================================================
 == | WonderTek [ 网络无处不在，沟通及时到达 ]
 == ============================================================================
 == | Copyright (c) 2012, WonderTek, Inc. All Rights Reserved.
 == ============================================================================
 == | Author: xxxx <xxxx@xxxx.com>
 == ============================================================================
 == | Desc: 页面描述
 == ============================================================================
-->
<root>
    <header/>
    <body resolution="480,800" BuildChildrenFinished="bodyBuildChildrenFinished" OnSpriteEvent="bodyOnSpriteEvent" OnPluginEvent="bodyOnPluginEvent">
        <node name="mainNode" rect="0,0,480,800" enable="true" active="true" OnKeyUp="mainNodeOnKeyUp" layouttype="1" extendstyle="1111">
            <image name='citybgImg' rect="0,80,480,720" src="file://image/jttxl/bj.png" style="autosize" extendstyle="1111" />
            <node name="baseSprite" rect="0,0,480,80" extendstyle="1111" >
                <image name="title" rect="0,0,480,80" border="false" src="file://image/jttxl/top.png" style="autosize" extendstyle="1111" />
                <label rect="0,0,480,80" text="显示设置" color="#ffffff" v-align="center" h-align="center" font-family="微软雅黑" font-size="32" extendstyle="1111" />
                <button name="backBtn" rect="20,18,48,45" OnSelect="doBack" normal="src:file://image/jttxl/back_d.png" visible="true"
                    sel="src:file://image/jttxl/back_s.png" style="autosize" extendstyle="1111">
                </button>
            </node>
            <node rect="0,85,480,132" extendstyle="1111" >
                <label rect="17,0,213,40" text="名片尺寸设置" font-family="微软雅黑" font-size="26" color="#bababa" v-align="center" h-align="left" extendstyle="1111" />
                <button rect="0,48,480,71" normal="normal" sel="select" OnSelect="cardOnSelect" style="autosize" extendstyle="1110">
                    <node name="normal" extendstyle="1177" rect="0,0,0,0">
                        <image rect="12,0,455,71" border="false" src="file://image/jttxl/localsetup_list_d.png" style="autosize" extendstyle="1111" />
                        <image rect="25,16,45,42" border="false" src="file://image/jttxl/mingpian_d.png" style="autosize" extendstyle="1111" />
                        <label rect="75,6,213,55" text="名片尺寸设置" font-family="微软雅黑" font-size="26" color="#000000" v-align="center" h-align="left" extendstyle="1111" />
                        <image rect="428,26,12,19" border="false" src="file://image/jttxl/xianshishezhi_more_d.png" style="autosize" extendstyle="1111" />
                    </node>
                    <node name="select" extendstyle="1177" rect="0,0,0,0">
                        <image rect="12,0,455,71" border="false" src="file://image/jttxl/localsetup_list_s.png" style="autosize" extendstyle="1111" />
                        <image rect="25,16,45,42" border="false" src="file://image/jttxl/mingpian_s.png" style="autosize" extendstyle="1111" />
                        <label rect="75,6,213,55" text="名片尺寸设置" font-family="微软雅黑" font-size="26" color="#ffffff" v-align="center" h-align="left" extendstyle="1111" />
                        <image rect="428,26,12,19" border="false" src="file://image/jttxl/xianshishezhi_more_s.png" style="autosize" extendstyle="1111" />
                    </node>
                </button>               
            </node>
            <node name="fenzuList" rect="0,235,480,480" extendstyle="1111" >
                <label rect="17,0,213,40" text="通讯录设置" font-family="微软雅黑" font-size="26" color="#bababa" v-align="center" h-align="left" extendstyle="1111" />               
                <listview name="listNode" rect="0,48,480,420" extendstyle="1111"/>
            </node>
            
            <node name="groupListItemNode" visible="false" enable="false" active="false"
                extendstyle="1011" rect="0,0,480,71">
                <button name="button" rect="0,0,480,71" normal="normal" sel="select" OnSelect="groupSetOnSelect" style="autosize" extendstyle="1110">
                    <node name="normal" extendstyle="1111" rect="0,0,0,0">
                         <image name="groupNormal" rect="12,0,455,69" border="false" src="file://image/jttxl/quanzhi_d.png" style="autosize" extendstyle="1111"/>
                         <image name="imageNormal" rect="25,18,32,33" border="false" src="file://image/jttxl/xiaoren_d.png" style="autosize" extendstyle="1111" />
                         <label name="groupName1" rect="75,6,213,55" visible="true" text="" font-family="微软雅黑" font-size="26" color="#000000" v-align="center" h-align="left" extendstyle="1111" />  
                         <label name="localTextNormal" rect="75,6,213,30" visible="true" text="本机通讯录" font-family="微软雅黑" font-size="26" color="#000000" v-align="center" h-align="left" extendstyle="1111" /> 
                         <label name="localText2Normal" rect="75,32,313,30" visible="true" text="展示您的本机联系人" font-family="微软雅黑" font-size="22" color="#363232" v-align="center" h-align="left" extendstyle="1111" />
                    </node>
                    <node name="select" extendstyle="1111" rect="0,0,0,0">
                         <image name="groupSelect" rect="12,0,455,69" border="false" src="file://image/jttxl/quanzhi_s.png" style="autosize" extendstyle="1111"/>
                         <image name="imageSelect" rect="25,18,32,33" border="false" src="file://image/jttxl/xiaoren_s.png" style="autosize" extendstyle="1111" />
                         <label name="groupName2" rect="75,6,213,55" text="" font-family="微软雅黑" font-size="26" color="#ffffff" v-align="center" h-align="left" extendstyle="1111" />
                         <label name="localTextSelect" rect="75,6,213,30" visible="true" text="本机通讯录" font-family="微软雅黑" font-size="26" color="#ffffff" v-align="center" h-align="left" extendstyle="1111" />  
                         <label name="localText2Select" rect="75,32,313,30" visible="true" text="展示您的本机联系人" font-family="微软雅黑" font-size="22" color="#ffffff" v-align="center" h-align="left" extendstyle="1111" />
                    </node>
                    <image rect="422,17,33,34" visible="true" border="false" src="file://image/jttxl/base.png" style="autosize" extendstyle="1111"/>
                    <image name='groupsetImg' rect="420,19,38,30" visible="true" border="false" src="file://image/jttxl/select_on.png" style="autosize" extendstyle="1111" />
                 </button>
            </node>
            <!--tips-->
            <node name="nodeSuccess" rect="131,650,250,48" enable="false" visible="false" active="false" layouttype="1" extendstyle="1111">
                <image name="backgroud" rect="0,0,218,48" border="false" src="file://image/jttxl/gengxin_bj.png" style="autosize"></image>
                <label name="content" rect="0,0,218,48" border="false" text="" h-align="center" 
                    v-align="center" font-family="微软雅黑" font-size="24" color="#FFFFFF" style="autosize" extendstyle="1111"></label>
            </node>
            <!-- 底部菜单  -->
            <node name="listNode" rect="0,720,480,80" extendstyle="1111">
                <image  rect="0,0,480,80" border="false" extendstyle="1111" 
                src="file://image/book/list_bg.png"  style="autosize"/>
                <!-- 搜索  -->
                <button name='searchBtn' rect="15,0,110,80"  extendstyle="1111"  style='autosize'
                src='file://image/book/lianxiren_d.png' OnSelect="doSearch"></button>
                <!-- 联系人  -->
                <button name='contactBtn' rect="125,0,110,80"  extendstyle="1111"  style='autosize'
                src='file://image/book/zuijinglianxiren_d.png' OnSelect="doContact"></button>
                <!-- 个人中心  -->
                <button name='personBtn' rect="250,0,82,80"  extendstyle="1111"  style='autosize'
                src='file://image/book/person_d.png' OnSelect="doPersonalCenter"></button>
                <!-- 设置  -->
                <button name='siteBtn' rect="385,0,48,80"  extendstyle="1111"  style='autosize'
                src='file://image/book/site_s.png' OnSelect="doSetting"></button>
                <!-- New -->
                <node name="newNode" rect="410,0,48,80" extendstyle="1111">
                    <image  rect="10,5,43,28" border="false" src="file://image/jttxl/new1.png" 
                        style="autosize" extendstyle="1111" />
                </node>
            </node> 
        </node>
    </body>
    <![CDATA[

require('com_wondertek_tx.common.framework')
require('framework.sqlite')
require 'framework.umsagent'
local rootSprite
local databaseName  --数据库名
local  bRet2, groupDatas, errMsg2 
local ListViewItemNum
local bRet, status, orgFlagDatas, errMsg
  
---------------------------------------callbacks--------------------------------
-- @brief root子节点创建完事件
function bodyBuildChildrenFinished(sprite)
    rootSprite = sprite    
    local localsetImg = Sprite:findChild(rootSprite,'localsetImg')
    local status = Config:get('localContactStatus')
    if status == '1' then
        setAllShoworHide(localsetImg,1)
    else
        setAllShoworHide(localsetImg,0)
    end  
    
    initGroup()  
end

-- @brief root节点消息方法
function bodyOnSpriteEvent(msg, param)
    if msg == MSG_ACTIVATE then -- 页面激活
        local newNode = Sprite:findChild(rootSprite, 'newNode')
        Log:write("====获取数据库======================================") 
        readGroupName()
        if (Config:get("isNeedUpdate") == "true") then 
            setAllShoworHide(newNode, 1)
        else 
            setAllShoworHide(newNode, 0)
        end 
    elseif msg == MSG_DEACTIVATE then
    
    end
end

-- @brief 插件消息方法
function bodyOnPluginEvent(msg)
    if msg == 101 then

    elseif msg == 101 + MSG_CACHEDATA_RELOAD then -- 101请求的数据有更新
    elseif msg == MSG_NETWORK_ERROR then -- 拨号失败
        Log:write('拨号失败')
    elseif msg > MSG_NETWORK_ERROR then -- 请求超时
        Log:write('请求超时')
    end
end

-- @brief 按键响应处理
function mainNodeOnKeyUp(sprite, kc)
    if kc == Key.F2 then -- 按下返回键
        doBack()
        return 1
    end
end

---------------------------------------util functions---------------------------

function groupSetOnSelect(sprite)
    local groupsetImg = Sprite:findChild(sprite, 'groupsetImg')
    local imageSrc = Sprite:getProperty(Sprite:findChild(sprite, 'imageNormal'), 'src') 
    local tips
    local status = Config:get('localContactStatus')
    
    
    
    if imageSrc == "file://image/jttxl/xiaoren_d.png" then 
	    local groupName = Sprite:getProperty(Sprite:findChild(sprite, 'groupName1'), 'text') 
	    Log:write("groupName：",groupName) 
	    local rootSprint = Sprite:findChild(rootSprite,'nodeSuccess')
	   	local content = Sprite:findChild(rootSprint,'content')
	   	local backgroud = Sprite:findChild(rootSprint,'backgroud')
	   	local len
	   	
	   	Sprite:setRect(rootSprint, 131, 650, 250, 48)
		Sprite:setRect(backgroud, 0, 0, 218, 48)
		Sprite:setRect(content, 0, 0, 218, 48)
		
		--从数据库中获取分组的visible属性
		local sueryStatus = "select status from tb_c_company where company_name = '"..groupName.."'"
		bRet, groupStatusDatas, errMsg = Sqlite:query(databaseName, sueryStatus)
		Log:write("分组的visible属性：",groupStatusDatas)
		local status = groupStatusDatas[1][1]
		
	    
	    --如果不属于企业用户，并且只有一个分组，则不允许设置关闭该分组
	    local queryStatus = "select count(*) from tb_c_company where org_flag = '1'"
	    bRet, statusDatas, errMsg = Sqlite:query(databaseName, queryStatus)
	    Log:write("==statusDatas==", statusDatas)
	    local num = statusDatas[1][1]
	    Log:write("企业用户数：",num)
	    
	    if num == '0' then
	        local queryOrgFlag = "select count(*)  from tb_c_company where status = '1'"
	        bRet, orgFlagDatas, errMsg = Sqlite:query(databaseName, queryOrgFlag)
	        Log:write("==orgFlagDatas==", orgFlagDatas)
	        len = orgFlagDatas[1][1]
	        Log:write("分组列表记录数目：",len)
	        if len == '1' and status == '1' then 	
	            tips = '您至少需要保留一个通讯录'
	            Sprite:setRect(rootSprint, 54, 650, 372, 48)
			   	Sprite:setRect(backgroud, 0, 0, 340, 48)
			   	Sprite:setRect(content, 0, 0, 340, 48)
	        elseif  status == '1' then
		        setAllShoworHide(groupsetImg, 0)    
		        --更改分组显示状态
		        local sql = "update tb_c_company set status = '0' where company_name = '"..groupName.."' "
		        Sqlite:update(databaseName, sql)
		        tips = '不再显示'..groupName
		    else
		        setAllShoworHide(groupsetImg, 1)   
		        --更改分组显示状态
		        local sql = "update tb_c_company set status = '1' where company_name = '"..groupName.."' "
		        Sqlite:update(databaseName, sql)
		        tips = '显示'..groupName
		    end
	     elseif status == '1' then   
	            setAllShoworHide(groupsetImg, 0)    
	            --更改分组显示状态
	            local sql = "update tb_c_company set status = '0' where company_name = '"..groupName.."' "
	            Sqlite:update(databaseName, sql)
	            tips = '不再显示'..groupName
	        else
	            setAllShoworHide(groupsetImg, 1)   
	            --更改分组显示状态
	            local sql = "update tb_c_company set status = '1' where company_name = '"..groupName.."' "
	            Sqlite:update(databaseName, sql)
	            tips = '显示'..groupName
	      end    
	elseif status == '0' then
	        setAllShoworHide(groupsetImg, 1)
	        Config:set('localContactStatus', 1)
	        tips = '显示本机通讯录'
    	elseif status == '1' then
	        setAllShoworHide(groupsetImg, 0)
	        Config:set('localContactStatus', 0)
	        tips = '不再显示本机通讯录'
      end
    local content = Sprite:findChild(Sprite:findChild(rootSprite,'nodeSuccess'),'content')
    Sprite:setProperty(content,'text',tips)
    failInvisible()
end

--显示设置更改时的提示信息
function failInvisible()
    Log:write('set visible')
    local nodeSuccess = Sprite:findChild(rootSprite,'nodeSuccess')
    Sprite:setVisible(nodeSuccess,1)
    Timer:set(158,3000,'failOutvisible')
end
--隐藏提示设置更改时的提示信息
function failOutvisible()
    Log:write('set unvisible')
    local nodeSuccess = Sprite:findChild(rootSprite,'nodeSuccess')
    Sprite:setVisible(nodeSuccess,0)
end

-- 搜索函数
function doSearch(sprite)
    Sprite:setProperty(sprite,'src','file://image/book/lianxiren_s.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'contactBtn'),'src','file://image/book/zuijinglianxiren_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'personBtn'),'src','file://image/book/person_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'siteBtn'),'src','file://image/book/site_d.png')
    setMainPage(0, 0)
	Scene:go(Alias.m_main)
end

-- 联系人列表
function doContact(sprite)
    Sprite:setProperty(sprite,'src','file://image/book/zuijinglianxiren_s.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'searchBtn'),'src','file://image/book/lianxiren_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'personBtn'),'src','file://image/book/person_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'siteBtn'),'src','file://image/book/site_d.png')
    setMainPage(1, 0)
    Scene:go(Alias.m_main)
    --Log:write("已在联系人列表界面，点击不做任何操作！")
end

-- 个人信息详情
function doPersonalCenter(sprite)
    Sprite:setProperty(sprite,'src','file://image/book/person_s.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'searchBtn'),'src','file://image/book/zuijinglianxiren_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'contactBtn'),'src','file://image/book/contact_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'siteBtn'),'src','file://image/book/site_d.png')   
    setMainPage(2, 0)
	Scene:go(Alias.m_main)
end

-- 设置
function doSetting(sprite)
    Sprite:setProperty(sprite,'src','file://image/book/site_s.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'searchBtn'),'src','file://image/book/zuijinglianxiren_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'contactBtn'),'src','file://image/book/contact_d.png')
    Sprite:setProperty(Sprite:findChild(rootSprite,'personBtn'),'src','file://image/book/person_d.png') 
    Scene:setReturn(Alias.m_localsetup, Alias.m_system)
    setMainPage(3, 0)
	Scene:go(Alias.m_main)
end

function doBack()
    setMainPage(3, 0)
	Scene:go(Alias.m_main)    
end

function cardOnSelect()
    Scene:setReturn(Alias.m_localsetup, Alias.cardDesign)
    Scene:go(Alias.cardDesign, true)
end

function initGroup()
    databaseName = Config:get('databaseName')
    local bRet, errMsg = Sqlite:open(databaseName)
    Log:write("创建数据库jttxlDatabase结果:bRet = "..bRet.." errMsg ="..errMsg)
    
end
function readGroupName()
    local queryGroup = "select company_id,company_name,status,org_flag from tb_c_company where org_flag = '0'"
    bRet2, groupDatas, errMsg2 = Sqlite:query(databaseName, queryGroup)
    Log:write('groupDatas', groupDatas)
    
    local fenzuList = Sprite:findChild(rootSprite, 'fenzuList')
    local list = Sprite:findChild(fenzuList, 'listNode')
    local groupListItemNode = Sprite:findChild(rootSprite, 'groupListItemNode')
     
    ListView:removeAllItems(list,1) 
    ListView:loadItem(list, groupListItemNode, getJsonArrayCount(groupDatas), 'loadListItem')
    Log:write('getJsonArrayCount(groupDatas)',getJsonArrayCount(groupDatas))
    ListView:adjust(list)  
    
    --获取分组个数
    ListViewItemNum = ListView:getItemCount(list)
    
    if ListViewItemNum == 1 then
        local item = ListView:getItem(list, 0)
        
    	Sprite:setProperty(Sprite:findChild(item,'groupNormal'), 'src', "file://image/jttxl/localsetup_list_d.png")
    	Sprite:setProperty(Sprite:findChild(item,'groupSelect'), 'src', "file://image/jttxl/localsetup_list_s.png")
    	Sprite:setProperty(Sprite:findChild(item,'imageNormal'), 'src', "file://image/jttxl/localsetup_phone_d.png")
    	Sprite:setProperty(Sprite:findChild(item,'imageSelect'), 'src', "file://image/jttxl/localsetup_phone_s.png")
    	Sprite:setProperty(Sprite:findChild(item,'imageNormal'), 'rect', "25,6,31,58")
    	Sprite:setProperty(Sprite:findChild(item,'imageSelect'), 'rect', "25,6,31,58")
    	
    else 
	    local item = ListView:getItem(list, ListViewItemNum-1)
	    
	    Sprite:setProperty(Sprite:findChild(item,'groupNormal'), 'src', "file://image/jttxl/xiayuan_d.png")
	    Sprite:setProperty(Sprite:findChild(item,'groupSelect'), 'src', "file://image/jttxl/xiayuan_s.png")
	    
	    local item = ListView:getItem(list, 0)
	    Sprite:setProperty(Sprite:findChild(item,'groupNormal'), 'src', "file://image/jttxl/shangyuan_d.png")
    	Sprite:setProperty(Sprite:findChild(item,'groupSelect'), 'src', "file://image/jttxl/shangyuan_s.png")
    	Sprite:setProperty(Sprite:findChild(item,'imageNormal'), 'src', "file://image/jttxl/localsetup_phone_d.png")
    	Sprite:setProperty(Sprite:findChild(item,'imageSelect'), 'src', "file://image/jttxl/localsetup_phone_s.png")
    	Sprite:setProperty(Sprite:findChild(item,'imageNormal'), 'rect', "25,6,31,58")
    	Sprite:setProperty(Sprite:findChild(item,'imageSelect'), 'rect', "25,6,31,58")
	end    
end

function loadListItem(list, item, index)
    local groupName1 = Sprite:findChild(item, 'groupName1')
    local groupName2 = Sprite:findChild(item, 'groupName2')
    local localTextNormal = Sprite:findChild(item, 'localTextNormal')
    local localText2Normal = Sprite:findChild(item, 'localText2Normal')
    local localTextSelect = Sprite:findChild(item, 'localTextSelect')
    local localText2Select = Sprite:findChild(item, 'localText2Select')
    local imageNormal = Sprite:findChild(item, 'imageNormal')
    local imageSelect = Sprite:findChild(item, 'imageSelect')
    local groupsetImg = Sprite:findChild(item, 'groupsetImg')
    
    Sprite:setRect(item, 0, 0, 480, 71)
	Sprite:setProperty(item, 'extendstyle', '1111')

    Log:write("==index=="..index) 
    
    if index == 0 then
        local status = Config:get('localContactStatus')
        Log:write("==status=="..status)
	    if status == '1' then
	        setAllShoworHide(groupsetImg,1)
	    else
	        setAllShoworHide(groupsetImg,0)
	    end
	    	    
	    setAllShoworHide(groupName1,0)
	    setAllShoworHide(groupName2,0)
	    setAllShoworHide(localTextNormal,1)
	    setAllShoworHide(localText2Normal,1)
	    setAllShoworHide(localTextSelect,1)
	    setAllShoworHide(localText2Select,1)
	    Sprite:setProperty(imageNormal, 'src', "file://image/jttxl/localsetup_phone_d.png")
	    Sprite:setProperty(imageSelect, 'src', "file://image/jttxl/localsetup_phone_s.png")    
	else
	    --setRect(item, 0, 0, 480, 71)
	    --Sprite:setProperty(item, 'extendstyle', '1111')
	    --local groupName_1 = Sprite:findChild(item, 'groupName1')
	    --local groupName_2 = Sprite:findChild(item, 'groupName2')
        
        setAllShoworHide(groupName1,1)
	    setAllShoworHide(groupName2,1)
	    setAllShoworHide(localTextNormal,0)
	    setAllShoworHide(localText2Normal,0)
	    setAllShoworHide(localTextSelect,0)
	    setAllShoworHide(localText2Select,0)
        
        Sprite:setProperty(imageNormal, 'src', "file://image/jttxl/xiaoren_d.png")
        Sprite:setProperty(imageSelect, 'src', "file://image/jttxl/xiaoren_s.png")
	    
	    Sprite:setProperty(groupName1, 'text', groupDatas[index][2])
	    Sprite:setProperty(groupName2, 'text', groupDatas[index][2])   
	    
	    if groupDatas[index][3] == '1' then
	        setAllShoworHide(groupsetImg,1)
	    elseif groupDatas[index][3] == '0' then
	        setAllShoworHide(groupsetImg,0)
	    end 
	    
	end
    
end
    ]]>
</root>
