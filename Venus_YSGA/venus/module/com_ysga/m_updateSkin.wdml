<?xml version="1.0" encoding="utf-8"?>
    <!--
        ==
        ============================================================================
        == | WonderTek [ 网络无处不在，沟通及时到达 ] ==
        ============================================================================
        == | Copyright (c) 2012, WonderTek, Inc. All Rights Reserved. ==
        ============================================================================
        == | Author: xxxx <xxxx@xxxx.com> ==
        ============================================================================
        == | Desc: 页面描述 ==
        == | Revised: 何武
        == | 2013/03/16 增加消息推送和增量升级功能
        ============================================================================
    -->
<root>
    <header />
    <body resolution="480,800" BuildChildrenFinished="bodyBuildChildrenFinished"
        OnSpriteEvent="bodyOnSpriteEvent" OnPluginEvent="bodyOnPluginEvent">
        <!-- 背景图片  -->
        <image name="image1" rect="0,0,480,800" border="false" 
            src="file://pics/index_bg.png" style="autosize" extendstyle="1111" />
        <!-- 主界面  -->
        <node name="mainNode" rect="0,0,480,800" enable="true" active="true" 
            OnKeyUp="mainNodeOnKeyUp" layouttype="1" extendstyle="1111">
            <!-- 进度条 -->
            <node name="scrollBarNode" rect="110,450,300,22"  OnTick="scrollOnTick" 
                frame="true" extendstyle="1111" h-align="center">
                <image name="scrollBgImg" rect="0,0,269,22"  
                    src="file://pics/index_line.png" extendstyle="1111"   />
                <image name="scrollImg" rect="0,0,34,22" 
                    src="file://pics/light.png" extendstyle="1111"  />
            </node>
            <!-- 下载进度指示 -->
            <node name="downloadingNode" rect="163,700,0,0" visible="false"
                enable="false" extendstyle="1111">
             <image name="progressBg" rect="0,0,154,10" style="autosize" 
                    src="file://pics/login_progress_bg.png" extendstyle="1111" />
                <image name="progressImg" rect="0,0,0,10" style="autosize"
                    src="file://pics/login_progress.png" extendstyle="1111" />
                <label name="proLab" rect="164,-8,160,26" text="0KB/0KB" 
                    font-size="16" color="#ffffff" v-align="center" h-align="left" 
                    extendstyle="1111" />
                <label name="speedLab" rect="-170,-8,160,26" text="0KB/S" 
                    font-size="16" color="#ffffff" v-align="center"
                    h-align="right" extendstyle="1111" />
            </node> 
            <!-- 文本通知信息  -->
            <label name="noticeLbl" rect="0,725,480,30" font-size="20" 
                text="" v-align="center" h-align="center" color="#ffffff" 
                extendstyle="1111" />
         
                <textarea name='releaseLog' rect="80,350,340,80" step="1" loop='true' border="false" 
                    color="#303030" style="autosize" text="" h-align="left" v-align="top" 
                    font-family="微软雅黑" font-size="22" extendstyle="1111"/>

       </node>
    </body>
    <![CDATA[

require 'com_ysga.common.framework'
require 'framework.umsagent'
require 'framework.msgpush'
require 'framework.appmanager'
require 'framework.download'

local rootSprite
local timeNum = 50 --获取验证码倒计时秒数
local g_downloadTime = 0    
local g_progressWidth = 154        -- 进度条长度
local g_localPatchPath=nil
local g_localpath = nil             -- 下载apk路径
local tempTel=''
local tempEccode="001"
local tempSkinFalg=''
---------------------------------------回调函数列表--------------------------------
-- root子节点创建完事件
function bodyBuildChildrenFinished(sprite)
    rootSprite = sprite
    connectNet()
    --收集用户ua信息 
    Log:write('用户ua信息:',System:getUserAgent())
end

-- root节点消息方法
function bodyOnSpriteEvent(msg, param)
    if msg == MSG_ACTIVATE then -- 页面激活
        checkEcSkinFlag()
        elseif msg == MSG_DEACTIVATE then
    end
end



-- 插件消息方法
function bodyOnPluginEvent(msg)
    Log:write('the msg is ',msg)
    --Loading:close()
    if msg == 101 then
        elseif msg == 101 + MSG_CACHEDATA_RELOAD then -- 101请求的数据有更新
        elseif msg == MSG_NETWORK_ERROR then -- 拨号失败
        Log:write('拨号失败')
         Dialog:show('提示', '网络超时，请检查网络!', 'ok_cancel', 'doExit')
        elseif msg > MSG_NETWORK_ERROR then -- 请求超时
        Log:write('请求超时')
        Dialog:show('提示','请求超时','ok_cancel')
    end
end


-- 按键响应处理
function mainNodeOnKeyUp(sprite, kc)
    if kc == Key.F2 then -- 按下返回键
        if Loading:isShow() then
            Loading:close()
        else
            Dialog:show('提示', '是否确定退出？', 'ok_cancel', 'doExit')
        end
        return 1
        elseif kc == Key.F1 then
        return 1
    end
end

-- 连接至网络
function connectNet()
    WLAN:setUrl('http://www.baidu.com/', '')
    if WLAN:isSwitchOn() then
        local attach = WLAN:isAttach()
        if attach then
            curSSID = attach.ssid
            Http:connectWLAN(attach.ssid)
            else
            connectToWAP()
        end
        else
        connectToWAP()
    end
end

-- 连接移动网络
function connectToWAP()
    local APNtype = Http:getCurrentAPNType()
    if APNtype == 1 then -- Net网
        Http:setProxy('')
        elseif APNtype == 2 then --移动wap
        Http:setProxy('http://10.0.0.172:80/')
        elseif APNtype == 3 then --电信wap
        Http:setProxy('http://10.0.0.200:80/')
        elseif APNtype == 4 then --联通wap
        Http:setProxy('http://10.0.0.172:80/')
        else
        Http:setProxy('')
    end
    Http:connectCMWAP()
end

-- 取消升级，系统跳转至主界面
function goHome()
    goLogin()
end
----------------------------检查是否有皮肤存在如果有则进行皮肤下载---------------------
function checkEcSkinFlag()
local tableValue=readDownloadTxtConfig()
    if tableValue~=nil or tableValue~='' then
      if tableValue[3]~=nil or tableValue[3]~=''then
       -- tempEccode="5515800611"
        tempEccode=tableValue[1]
       tempTel=tableValue[2]
       tempSkinFalg=tableValue[3]
        end
    end
    if skinFalg==nil then
       skinFalg='0'
    end
    if(skinFalg=='1') then
       Scene:go(Alias.login)
     else
    local noticeLblSprite = Sprite:findChild(rootSprite, "noticeLbl")
    Sprite:setProperty(noticeLblSprite, "text", "下载皮肤中...")
    checkEcSkin()
     end
end


function checkEcSkin()
            --保存企业编号和手机号
g_localpath=getDownloadPath()
 Log:write("企业编号是"..tempEccode)
 ---
 g_patchUrl="http://120.209.131.144:9092/resources/upload/"..tempEccode..".zip"--路径命名规则按照企业ECcode
 Log:write("g_patchUrl.."..g_patchUrl)
 local count = Download:getCount(true)
     for i = 1, count do
           Download:delete(i,false,true)
     end
    -- 显示下载进度
    local downloadingNode = Sprite:findChild(rootSprite, 'downloadingNode')
    Sprite:setVisible(downloadingNode, 1)
    Sprite:setEnable(downloadingNode, 1)
    local progress = Sprite:findChild(downloadingNode, 'progressImg')
    local startX,startY,_,startH = Sprite:getRect(progress)
    Download:append(g_localpath, tempEccode, g_patchUrl, false)
    Log:write("企业编号是2"..tempEccode)
    onGetDownloadStatus()
end
-- 显示下载状态
function onGetDownloadStatus()
    local count = Download:getCount(false)
    g_downloadTime = g_downloadTime + 0.5
    local progressImg = Sprite:findChild(rootSprite, 'progressImg') -- 下载进度
    local speedLab = Sprite:findChild(rootSprite, 'speedLab')       -- 下载速度
    local proLab = Sprite:findChild(rootSprite, 'proLab')           -- 总体下载进度
    local noticeLbl = Sprite:findChild(rootSprite, "noticeLbl")     -- 通知信息
    -- 迭代下载队列
   -- for i = 1, count do
        local task = Download:getStatus(count, false)
        Log:write("进行了下载task"..task.maxsize..task.title)
        if task.title ==tempEccode then   
            if task.status == 3 then Download:start(count, fasle) end
            -- 计算当前的下载百分比
            Log:write('the task size is ',task.size)
            local percent = 0
            if task.size and task.maxsize and task.maxsize ~= 0 then
                Log:write("download 3 "..task.size)
                percent = math.floor(task.size / task.maxsize * 100)
            end
              Log:write('the task status is ',Download.status.Downloading)
            if task.status == 2 then -- 下载中
                Log:write("download is download"..task.status)
                Log:write("download is task.size"..task.size)
                local x, y, _, h = Sprite:getRect(progressImg)
                Sprite:setRect(progressImg, x, y, g_progressWidth * percent / 100, h)
                Sprite:setProperty(speedLab, 'text', math.floor(task.size / 1024 / g_downloadTime) .. 'KB/S')
                Log:write("下载速度"..math.floor(task.size / 1024 / g_downloadTime) .. 'KB/S')
                Sprite:setProperty(proLab, 'text', math.floor(task.size/1024) .. 'KB/' .. math.floor(task.maxsize/1024) .. 'KB')
            elseif task.status == 4 then -- 下载完毕
                Log:write("download is over"..task.status)
                g_downloadTime = 0
                Sprite:setProperty(noticeLbl, 'text', '完成')
                Download:delete(count, false, false)
                Sprite:setProperty(speedLab,'text', '0KB/S')
                Sprite:setProperty(proLab, 'text', math.floor(task.maxsize/1024) .. 'KB/' .. math.floor(task.maxsize/1024) .. 'KB')
                local x, y, _, h = Sprite:getRect(progressImg)
                Sprite:setRect(progressImg, x, y, g_progressWidth * percent / 100, h)
                Http:stopNetwork()
                Timer:cancel(112)
                local downloadingNode = Sprite:findChild(rootSprite, 'downloadingNode')
                -- Sprite:setVisible(downloadingNode, 0)
                -- Sprite:setEnable(downloadingNode, 0)
                 -- 下载完成
                local unzipPath = g_localpath
                Log:write("正在换肤"..unzipPath)
                Log:write("g_localpath..."..g_localpath)
                Log:write("g_localPatchPath.."..g_localPatchPath)
                local rtn = Util:unzip(g_localpath,g_localPatchPath)--下载完成进行解压缩操作
                   if(rtn) then --表示解压成功
                     Log:write("表示解压成功.."..g_localPatchPath)
                        local sucess=Sprite:findChild(rootSprite,'sucess')
                        local fail=Sprite:findChild(rootSprite,'fail')
                        local dengluBtn=Sprite:findChild(rootSprite,'dengluBtn')
                        local registerBtn=Sprite:findChild(rootSprite,'registerBtn')
                        skinFalg='1'
                        g_localPatchPath=g_localPatchPath.."/"..tempEccode
                       configString=tempEccode..'\n'..tempTel..'\n'..skinFalg..'\n'..g_localPatchPath
                       Log:write("configString value is"..configString)
                       savebtn_onselected(configString)
                       Scene:go(Alias.login)
                    else
                       Dialog:show('抱歉', '解压失败', 'ok')
                end
            end
            Log:write("ec-----------1")
         --   break
       -- end
         end
    Timer:set(112, 500, 'onGetDownloadStatus')
end

function unzipSkin()
                -- 下载完成
                local unzipPath = g_localpath
                Log:write("正在换肤"..unzipPath)
                Log:write("g_localpath..."..g_localpath)
                Log:write("g_localPatchPath.."..g_localPatchPath)
                local rtn = Util:unzip(g_localpath,g_localPatchPath)--下载完成进行解压缩操作
                   if(rtn) then --表示解压成功
                     local sucess=Sprite:findChild(rootSprite,'sucess')
                        local fail=Sprite:findChild(rootSprite,'fail')
                        local dengluBtn=Sprite:findChild(rootSprite,'dengluBtn')
                        local registerBtn=Sprite:findChild(rootSprite,'registerBtn')
                       Sprite:setVisible(sucess,1)
                        Sprite:setVisible(fail,0)
                        setAllShoworHide(registerBtn,0)
                        setAllShoworHide(dengluBtn,1)
                        skinFalg='1'
                       -- configString=ECCode..'\n'..phoneEdit..'\n'..skinFalg..'\n'..g_localPatchPath
                       -- savebtn_onselected(configString)
                        else
                       Dialog:show('抱歉', '解压失败', 'ok')
                end
    end
-- 登录和版本检查进度条
function scrollOnTick(sprite)
    local scrollImg = Sprite:findChild(sprite, 'scrollImg')
    local x, y, w, h = Sprite:getRect(scrollImg)
    if x > 250  then
       x = 0
    end
    Sprite:setRect(scrollImg, x + 7, y, w, h)
end
function getDownloadPath()
    g_localpath = ""
    local downloadPath = System:getFlashCardName(1) 
    if downloadPath == nil or downloadPath == "" then 
        Log:write("SD卡不存在,使用内部存储！")
        downloadPath = System:getFlashCardName(0)
         --在SD卡不存在的话，如果是htc_t327t_android_A001，则使用缓存
            if(System:getUserAgent() == 'htc_t327t_android_A001') then
                downloadPath = "MODULE:\\com_ysga\\"
            end
    end
    g_localpath = downloadPath.."com_ysga"
    g_tempPath = downloadPath.."temp"
    Log:write("getDownloadPath: localDir="..g_localpath)
    -- 如果路径不存在，创建下载目录
    if IO:dirExist(g_localpath) == false then 
        IO:dirCreate(g_localpath)
    end
     if IO:dirExist(g_tempPath) == false then 
        IO:dirCreate(g_tempPath)
    end
    -- -- 如果皮肤已经存在，删除之
    g_localPatchPath = g_localpath
    -- g_localPatchResult = g_localpath.."/Venus_GJ_New.apk"
   g_localpath = g_localpath.."/"..tempEccode..".zip"
    -- Log:write("getDownloadPath: g_localPatchPath="..g_localPatchPath)
    Log:write("getDownloadPath: g_localpath="..g_localpath)
    -- 返回apk本地路径
    return g_localpath
end




----------------------------------------end-------------------------------------------

function goLogin()
    Scene:go(Alias.login)
end

]]>
</root>