<?xml version="1.0" encoding="utf-8"?>
<root>
    <header />
    <body resolution="480,800" BuildChildrenFinished="bodyBuildChildrenFinished"
        OnSpriteEvent="bodyOnSpriteEvent" OnPluginEvent="bodyOnPluginEvent">
        <node name="mainNode" rect="0,0,480,800" enable="true" active="true"
            OnKeyUp="mainNodeOnKeyUp" layouttype="1" extendstyle="1111">
            <!-- 设置背景 -->
            <shadow rect="0,0,480,800"  alpha="255" extendstyle="1111">
                <image name="titleBg" rect="0,0,480,800" src="file://pics/main_bg.png" extendstyle="1111" style="autosize"/>
             </shadow>
            <!-- 信息头部 -->
            <node rect="0,0,480,80" extendstyle="1111" border="0" >
                <image name="titleBg" rect="0,0,480,80" src="file://pics/sub_top_bg.png" extendstyle="1111" style="autosize"/>
                <!-- 返回按钮 -->
                <button name="backBtn" rect="9,14,52,52" OnSelect="doBack" border="false"
                    normal="src:file://pics/icon_back_d.png;"
                    sel="src:file://pics/icon_back_s.png;" style="autosize"
                    extendstyle="1111"/>
                <image name="normal" rect="70,0,2,80" src="file://pics/sub_top_line.png" style="autosize" extendstyle="1111"/>
                <!--提交按钮-->
                <image name="normal" rect="410,0,2,80" src="file://pics/sub_top_line.png" style="autosize" extendstyle="1111"/>
                <button name="addBtn" rect="419,14,52,52" OnSelect="submitOnSelect" border="false"
                    normal="src:file://pics/icon_submit_d.png;"
                    sel="src:file://pics/icon_submit_s.png;" style="autosize"
                    extendstyle="1111"/>
                 <!-- 信息标题 -->
                 <scrolltext name="title" rect="100,0,280,70" text="考勤打卡" font-family="微软雅黑" 
                    extendstyle="1111" font-size="30" h-align="center" v-align="center"
                    color="#ffffff" scroll="true" step="2"/>
            </node>
	        <node name="node2" rect="0,80,460,71" extendstyle="1111">
	            <label rect="0,30,130,41"  text="签到人"  extendstyle="1111" style="autosize" h-align="right" v-align="center" font-family="微软雅黑" font-size="24"/>
                <label name="kaoqinren" rect="150,30,200,41"   
                   extendstyle="1111" style="autosize" h-align="left" v-align="center"
                   font-family="微软雅黑" font-size="24"></label>
	        </node>
	        <node name="node3" rect="0,145,460,71" extendstyle="1111">
                <label rect="0,0,130,50"  text="员工位置" 
                extendstyle="1111" style="autosize" h-align="right" v-align="bottom"
                font-family="微软雅黑" font-size="24"></label>
                <scrolltext name="kaoqinlocation" rect="150,0,300,52"  
                   extendstyle="1111" style="autosize" h-align="left" v-align="bottom"
                   font-family="微软雅黑" font-size="24" scroll="true">
                </scrolltext>
	        </node>
	        <node name="node4" rect="0,215,470,71" extendstyle="1111">
	           <label  rect="0,0,130,71"  text="考勤打卡" 
                extendstyle="1111" style="autosize" h-align="right" v-align="center"
                font-family="微软雅黑" font-size="24"/>
                <button name="startTime" rect="150,0,290,71" border="false" OnSelect="kaoqinOnSelect"
                       normal="src:file://pics/input_select_btn_d.png;style:sudoku-auto;sudoku:15,15,80,15;color:#ffffff"
                       sel="src:file://pics/input_select_btn_s.png;style:sudoku-auto;sudoku:15,15,80,15;color:#000000">
                     <label name="kaoqinContent" rect="0,0,302,71" border="false" text="请选择"
                     h-align="center"  v-align="center" color="#8f8e8e" font-family="微软雅黑" font-size="24"></label>
                </button>
	        </node>
	        <node name="node4" rect="0,293,470,71" extendstyle="1111">
                <button rect="29,0,71,71" OnSelect="btnCamera_Click" border="false"
                    normal="src:file://pics/icon_camera_d.png;"
                    sel="src:file://pics/icon_camera_s.png;" style="autosize"
                    extendstyle="1111">
                </button>
                <image rect="100,0,360,71" src="file://pics/input_text_bg.png"
                sudoku="15,15,15,15" style="sudoku-auto" extendstyle="1111">
                </image>
                <edit name="edit" rect="120,0,360,71" border="false" text="图片说明" 
                   OnLostFocus="editOnTextChanged" OnSetFocus="initText"
                   extendstyle="1111" style="autosize" h-align="left" color="#8f8e8e" 
                   v-align="center" font-family="微软雅黑" font-size="24">
                  </edit>
            </node>
            <listview rect="0,364,480,560" extendstyle="1111">
               <list-item name="imageListNode" rect="0,0,480,120" extendstyle="1111">
                    <panorama name="imageList" rect="0,0,480,120" extendstyle="1111" style="circle" foreground="foreground" alpha="255"/>
                </list-item>
            </listview>
            <node name="imageListItem" rect="10,0,460,120" extendstyle="1111" visible="false" enable="false" active="false">
                <button name="pic1" rect="0,0,110,110" border="false" enable="false"
                    color="#ffffff" OnSelect="shownail" extendstyle="1111">
                    <image name="bg" rect="0,5,110,110" src="" style="autosize"
                        extendstyle="1111">
                    </image>
                </button>
                <button name="pic2" rect="116,0,110,120" border="false" enable="false"
                    color="#ffffff" OnSelect="shownail" extendstyle="1111">
                    <image name="bg" rect="0,5,110,110" src="" style="autosize"
                        extendstyle="1111">
                    </image>
                </button>
                <button name="pic3" rect="232,0,110,120" border="false" enable="false"
                    color="#ffffff" OnSelect="shownail" extendstyle="1111">
                    <image name="bg" rect="0,5,110,110" src="" style="autosize"
                        extendstyle="1111">
                    </image>
                </button>
                <button name="pic4" rect="348,0,110,120" border="false" enable="false"
                    color="#ffffff" OnSelect="shownail" extendstyle="1111">
                    <image name="bg" rect="0,5,110,110" src="" style="autosize"
                        extendstyle="1111">
                    </image>
                </button>
            </node>
            <node name="noteSelectNode" rect="0,0,480,800" visible="false"  mushroom="false" enable="false">
		      <button rect="0,0,480,800" OnSelect="hidekaoqinSelected">
                    <shadow rect="0,0,480,800"  alpha="150" color="#0"  extendstyle="1111"/>
              </button>
	          <node rect="86,200,368,68" extendstyle="1111"  border="false">
	              <image rect="0,0,368,68" src="file://pics/Dialogs/top.png"  style="autosize" extendstyle="1111" />
                     <image rect="20,30,31,32" src="file://pics/Dialogs/icon_arrow.png"  style="autosize" extendstyle="1111" />
                     <label rect="40,10,120,68" border="false" color="#FFFFFF"
                      text="打卡类别" h-align="center" v-align="center" font-family="微软雅黑" font-size="24"></label>
	          </node>
	          <node rect="86,268,368,143" extendstyle="1111" border="false">
                    <image rect="0,0,368,143" src="file://pics/Dialogs/center.png"  style="autosize" extendstyle="1111" />
				 <button rect="12,0,342,61" text="    上班" h-align="left" 
						color="#ffffff" extendstyle="1111" OnSelect="kaoqinGroupOnSelect" font-family="微软雅黑" 
						 normal="src:file://pics/icon_list_bg_d.png;style:sudoku-auto;sudoku:0,0,100,0;color:#000000"
                           sel="src:file://pics/icon_list_bg_s.png;style:sudoku-auto;sudoku:0,0,100,0;color:#ffffff"
						font-size="24" data="1" />
				 <image rect="0,71,368,2" src="file://pics/Dialogs/line.png"  style="autosize" extendstyle="1111" />
                     <button rect="12,73,342,61" text="    下班" h-align="left" 
						color="#ffffff" extendstyle="1111" OnSelect="kaoqinGroupOnSelect" font-family="微软雅黑" 
						 normal="src:file://pics/icon_list_bg_d.png;style:sudoku-auto;sudoku:0,0,100,0;color:#000000"
                           sel="src:file://pics/icon_list_bg_s.png;style:sudoku-auto;sudoku:0,0,100,0;color:#ffffff"
						font-size="24" data="2" />
	          </node>
              <image rect="86,410,368,21" src="file://pics/Dialogs/bottom.png"  style="autosize" extendstyle="1111"/>
            </node>
            <node name="picdialog" rect="0,0,480,800" visible="false"  mushroom="false" enable="false">
                <button rect="0,0,480,800" OnSelect="hidenail">
                    <shadow rect="0,0,480,800"  alpha="150" color="#0"  extendstyle="1111"/>
                </button>
                  <node rect="86,200,368,68" extendstyle="1111"  border="false">
                      <image rect="0,0,368,68" src="file://pics/Dialogs/top.png"  style="autosize" extendstyle="1111" />
                      <image rect="20,30,31,32" src="file://pics/Dialogs/icon_arrow.png"  style="autosize" extendstyle="1111" />
                      <label rect="40,10,120,68" border="false" color="#FFFFFF"
                       text="操作" h-align="center" v-align="center" font-family="微软雅黑" font-size="24"></label>
                  </node>
                  <node rect="86,268,368,143" extendstyle="1111" border="false">
                     <image rect="0,0,368,143" src="file://pics/Dialogs/center.png"  style="autosize" extendstyle="1111" />
                     <button rect="12,0,342,61" text="    删除" h-align="left" 
                            color="#ffffff" extendstyle="1111" OnSelect="rmpic" font-family="微软雅黑" 
                             normal="src:file://pics/icon_list_bg_d.png;style:sudoku-auto;sudoku:0,0,100,0;color:#000000"
                            sel="src:file://pics/icon_list_bg_s.png;style:sudoku-auto;sudoku:0,0,100,0;color:#ffffff"
                            font-size="24" data="1" />
                     <image rect="0,71,368,2" src="file://pics/Dialogs/line.png"  style="autosize" extendstyle="1111" />
                      <button rect="12,73,342,61" text="    查看原图" h-align="left" 
                            color="#ffffff" extendstyle="1111" OnSelect="topic" font-family="微软雅黑" 
                             normal="src:file://pics/icon_list_bg_d.png;style:sudoku-auto;sudoku:0,0,100,0;color:#000000"
                            sel="src:file://pics/icon_list_bg_s.png;style:sudoku-auto;sudoku:0,0,100,0;color:#ffffff"
                            font-size="24" data="2" />
                  </node>
                  <image rect="86,410,368,21" src="file://pics/Dialogs/bottom.png"  style="autosize" extendstyle="1111"/>
            </node>
	        <image name="success" border="false" visible="false" rect="37,700,398,58" src="file://image/kaoqin/tishichengong.png"
	         style="autosize" extendstyle="1111">
	         <label name="hideLabel" rect="0,0,398,58" text="信息提交成功"
                        color="#FFFFFF" extendstyle="1111" style="autosize" h-align="center"
                        v-align="center" font-family="微软雅黑" font-size="24"></label>
	         </image>
        </node>
    </body>
    <![CDATA[
     require 'com_xsgj.common.framework'
     require 'framework.map'
     require 'framework.upload'
    local rootSprite
    local jsonDecodedData = nil
    local kaoqinlabel = nil
    local observer
    local latitude
    local longitude
    local piclist
    local picitem
    local curpic
    local imgdata={}
    local allimg=''
    local server=Alias.urlServer..'attendence/add'
    local up_url =Alias.urlServer..'fileUpload/getUploadUrl'
    local curitm
    local imageListNode 
    local imageList 
    local nilNode
    -- 第一次创建页面事件
    function bodyBuildChildrenFinished(sprite)
        rootSprite = sprite
        nilNode= Sprite:findChild(rootSprite, 'picdialog')
        imageListNode = Sprite:findChild(rootSprite, 'imageListNode')
        imageList = Sprite:findChild(imageListNode, 'imageList')
        --1.加载定位
        observer = Plugin:getObserver()
        local lusr=Sprite:findChild(rootSprite, 'kaoqinren')
        Sprite:setProperty(lusr, 'text', Config:get('truename'))
        --4.读取控件
        kaoqinlabel=Sprite:findChild(rootSprite, 'edit')
        --5.开始定位
        doLocation()
    end
    -- 页面加载事件
    function bodyOnSpriteEvent(msg, param)
       if msg == MSG_ACTIVATE then -- 页面激活
       elseif msg == MSG_DEACTIVATE then
       end
    end
    -- 获取接口返回时的反馈处理
    function bodyOnPluginEvent(msg, param)
       if msg == 1000 then--用来显示经纬度
            local postDataString = Param:getString(param, 0)
            local postData = Json:loadString2Table(postDataString)
            if postData.latitude ~= nil then
                latitude=postData.latitude
            end
            if postData.longitude ~= nil then
                longitude=postData.longitude
            end
            if postData.longitude ~= nil and postData.latitude ~= nil then
                Map:getLocation(observer, 1001, tonumber(postData.latitude), tonumber(postData.longitude))  
            end
        elseif msg == 1001 then--用来显示定位的位置
            local postDataString = Param:getString(param, 0)
            local postData = Json:loadString2Table(postDataString)
            local locInfo = Sprite:findChild(rootSprite, 'kaoqinlocation')
            if postData.address ~= nil then
                Sprite:setProperty(locInfo, 'text', postData.address)
            end
        elseif msg>=504 and msg<=600 then--返回上传路径，并启动上传
            local ii=(msg-504);
            local uploadData = Http:xmlDecode('upload_url'..ii, 'RESULT')
            local url = uploadData.URL
            local param = uploadData.PARAM
            if param then
                param = param .. '&'
            else
                param = ''
            end
            if string.len(allimg)>0 then
                  allimg=allimg..','..uploadData.REMOTE_FILE_NAME
            else
                  allimg=uploadData.REMOTE_FILE_NAME
            end
            local fname=string.sub(imgdata[ii],lastIndexof( imgdata[ii],'/')+1,string.len(imgdata[ii])-4)
            Upload:append(url, param,imgdata[ii], fname,'', 'jpg')
	        --testUpload:append(url, param,'MODULE:\\com_xsgj\\image\\Img338655873.jpg','Img338655873.jpg', 'test', 'jpg')
            --所有结束则结束load，提示成功
            imgdata[ii]=nil
            isok()
	    elseif msg == 503 then--提交表单成功
            jsonDecodedData = Http:jsonDecode('kaoqin_data')
            Log:write('后台接口返回数据为',jsonDecodedData)
            if (jsonDecodedData == nil or jsonDecodedData["Total"] == '0') then
                Dialog:show("", jsonDecodedData["Rows"], "ok")
                return
           else--提交成功
               --所有结束则结束load，提示成功
		        setAllShoworHide(Sprite:findChild(rootSprite, 'success'), 1)
		        Timer:set(1,1000,'doBack')
           end
        elseif msg == 101 + MSG_CACHEDATA_RELOAD then -- 101请求的数据有更新
            elseif msg == MSG_NETWORK_ERROR then -- 拨号失败
            Log:write('拨号失败')
            elseif msg > MSG_NETWORK_ERROR then -- 请求超时
            Log:write('请求超时')
        end
    end
    -- 按键响应处理
    function mainNodeOnKeyUp(sprite, kc) 
        if kc == Key.F2 then -- 按下返回键
            Scene:back()
            return 1
        end
    end
    ---------------------------------------util functions---------------------------
    --下拉框显示
    function kaoqinOnSelect(sprite)
        local t=Sprite:findChild(rootSprite, 'noteSelectNode');
        Sprite:setVisible(t, 1);
        Sprite:setEnable(t, 1);
    end
    ---选中下拉框后
    function kaoqinGroupOnSelect(sprite)
       local kaoqinData = Sprite:getData(sprite)
       local kaoqinContent = Sprite:findChild(rootSprite, 'kaoqinContent')
       Sprite:setProperty(kaoqinContent, 'data', kaoqinData)
       if kaoqinData == '1' then    
         Sprite:setProperty(kaoqinContent, 'text', '上班')
       elseif kaoqinData == '2' then
	       Sprite:setProperty(kaoqinContent, 'text', '下班')
        end
        Sprite:setProperty(kaoqinContent, 'color', '#0')
        setAllShoworHide(Sprite:findChild(rootSprite, 'noteSelectNode'), 0)
    end
    ---开启拍照
    function btnCamera_Click(sprite)
        local fileName = os.time()
        --testonCameraDialog('Img338655873', 'jpg')
        local result = System:openCamera('onCameraDialog',  'file://image/' ..fileName.. '.jpg' , 'jpg')
        if result == 0 then
          Dialog:show('提示', '相机打开失败!', 'ok')
          return 1
        end
    end
    ---获取照片
    function onCameraDialog(photoPath, photoType)
	     -- 添加图片压缩支持
	    local tmpSplitArray = Split(photoPath,'%.')
	    local dest = tmpSplitArray[1] .. 'temp' .. System:getTickTime() .. '.jpg'
	    Log:write('目标文件路径为:'..dest)
	    local ret = ScaleImageAsJpg(photoPath, dest, 480, 800, 0)
	    if ret == 1 then
	        table.insert(imgdata, dest)
	        Log:write('图片压缩成功，压缩后的图片位置为:'..dest)
	    else
	        table.insert(imgdata, photoPath)
	        Log:write('警告：图片压缩失败，使用未压缩的图片:'..photoPath)
	    end
        --显示图片列表
       reloadImages();
    end
    --重新显示图片列表
    function reloadImages()
        count=getJsonArrayCount(imgdata)
        local realCount = 0
        if count > 0 then
            if count % 4 > 0 then
                realCount = (count - (count % 4)) / 4 + 1
            else
                realCount = count / 4
            end
        end
        Panorama:removeAllItems(imageList) 
        Panorama:loadItem(imageList, Sprite:findChild(rootSprite, 'imageListItem'),realCount,'loadListItem')
        local x,y,w,h = Sprite:getRect(imageList)
        x,y,w,h = Sprite:getRect(imageListNode)
        Panorama:adjust(imageList)
        ListView:adjust(Sprite:getParent(imageListNode))
    end
    ---开始定位
    function doLocation()
        local locInfo = Sprite:findChild(rootSprite, 'kaoqinlocation')
        Sprite:setProperty(locInfo, 'text', '正在定位......')
        Map:getCurPosition(observer,  1000)
   end
   ---当进入编辑框时，修改文字为输入
   function initText(sprite)
       local txt= Sprite:getProperty(kaoqinlabel, 'text')
       if txt=='图片说明' then
        Sprite:setProperty(kaoqinlabel, 'text', '')
        Sprite:setProperty(kaoqinlabel, 'color', '#0')
       end
   end
   ---隐藏下拉框
   function hidekaoqinSelected(sprite)
        local t=Sprite:findChild(rootSprite, 'noteSelectNode');
        Sprite:setVisible(t, 0);
        Sprite:setEnable(t, 0);
    end
    --上传数据
    function submitOnSelect(sprite)
        local data=Sprite:getData(Sprite:findChild(rootSprite, 'kaoqinContent'))
        if data==nil or data =='' then
           Dialog:show('提示', '请选择考勤打卡类型', 'ok')
           return
        end
        
       
	       latitude=1
	       longitude=1
       
        subform()
       
        Loading:show(rootSprite)
       
        
    end
    ---当未有任何输入时，初始化为提示
    function editOnTextChanged(sprite)
       local txt= Sprite:getProperty(kaoqinlabel, 'text')
       if txt=='' or txt ==nil then
        Sprite:setProperty(kaoqinlabel, 'color', '#8f8e8e')
        Sprite:setProperty(kaoqinlabel, 'text', '图片说明')
       end
    end
    -- 返回按钮处理
    function doBack()
        Scene:back(true)
    end
     -- 显示图片
   function loadListItem(list, item, index)
        local picArray = {
            Sprite:findChild(item, 'pic1'),
            Sprite:findChild(item, 'pic2'),
            Sprite:findChild(item, 'pic3'),
            Sprite:findChild(item, 'pic4'),
        }
        for i=1,#picArray do
        Log:write(imgdata[tonumber(index) * 4 + i])
            if imgdata[tonumber(index) * 4 + i] == nil then
                break
            end
            Sprite:setProperty(picArray[i], "enable", "true");
            local bg = Sprite:findChild(picArray[i], 'bg')
            if Sprite:getProperty(bg, 'src') ~= nil and Sprite:getProperty(bg, 'src') == '' then
                Sprite:setProperty(bg, 'data', imgdata[tonumber(index) * 4 + i])
                Sprite:setProperty(bg, 'src', imgdata[tonumber(index) * 4 + i])
                --testSprite:setProperty(bg, 'src', 'MODULE:\\com_xsgj\\image\\Img338655873.jpg')
            end
        end
    end
    --上传表单
    function subform()
        local locInfo = Sprite:findChild(rootSprite, 'kaoqinlocation')
        local loc=Sprite:getText(locInfo)
        local mk1=Sprite:getText(Sprite:findChild(rootSprite, 'edit'))
        if mk1 =='图片说明' then
           mk1=''
        end
         --上传结束就跳转
        local param = 'userCode='..Config:get('username')
        ..'&userName='..Config:get('truename')
        ..'&longitude='..latitude
        ..'&latitude='..longitude
        ..'&locatDetail='..loc
        ..'&mark1='..mk1
        ..'&attencdCarType='..Sprite:getData(Sprite:findChild(rootSprite, 'kaoqinContent'))
        ..'&imageAddr='..allimg
        ..'&imageName='..allimg
        Log:write('param =================',param)
        Http:request('kaoqin_data', server, 503, {useCache = false, method = 'post',postData=param})
    end
    --成功上传
    function isok()
        --图片都已添加到队列
        local count=getJsonArrayCount(imgdata)
        for i=1,count-1 do
            if imgdata[i]~=nil then
                return
            end
        end
        subform()
    end
    --查找最后一个字符串
    function lastIndexof(s,tag)
        local index=-1
        Log:write(tag)
	    while true do
	     local i = string.find(s,tag,index+1)
	     if i == nil then
	         return index
	     end
	     index = i
	    end
    end
     --显示缩略图
    function shownail(sprite)
        curitm=Sprite:findChild(sprite, "bg");
        Sprite:setEnable(nilNode, 1);
        Sprite:setVisible(nilNode, 1);
    end
    --隐藏缩略图
    function hidenail(sprite)
        Sprite:setEnable(nilNode, 0);
        Sprite:setVisible(nilNode, 0);
        curitm=nil;
    end
    --显示原图
    function topic(sprite)
        --创建数据仓库
        local igsrc=Sprite:getProperty(curitm, "src")
        local reg=Reg:create("PicReg")
        Reg:setString(reg, "pic", igsrc)
        --跳转
        Scene:setReturn(Alias.kaoqinaction, Alias.orignImg)
        Scene:go(Alias.orignImg,true)
    end
     --删除图片
    function rmpic(sprite)
        Sprite:setProperty(curitm, "enable", "false");
        Sprite:removeChild(Sprite:getParent(curitm), curitm)
        local dt=Sprite:getData(curitm)
        local count=getJsonArrayCount(imgdata)
        for i=1,count-1 do
            if imgdata[i]==dt then
                table.remove(imgdata,i)
            break
            end
        end
        reloadImages()
        hidenail(sprite)
    end
]]>
</root>
