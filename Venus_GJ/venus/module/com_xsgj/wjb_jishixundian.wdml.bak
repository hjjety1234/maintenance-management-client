<?xml version="1.0" encoding="utf-8"?>
<!--
 == ============================================================================
 == | WonderTek [ 网络无处不在，沟通及时到达 ]
 == ============================================================================
 == | Copyright (c) 2012, WonderTek, Inc. All Rights Reserved.
 == ============================================================================
 == | Author: xxxx <xxxx@xxxx.com>
 == ============================================================================
 == | Desc: 页面描述
 == ============================================================================
-->
<root>
    <header/>
    <body resolution="480,800" BuildChildrenFinished="bodyBuildChildrenFinished" OnSpriteEvent="bodyOnSpriteEvent" OnPluginEvent="bodyOnPluginEvent">
        <node name="mainNode" rect="0,0,480,800" enable="true" active="true" OnKeyUp="mainNodeOnKeyUp" layouttype="1" extendstyle="1111">
           <!-- 设置背景 -->
            <shadow rect="0,0,480,800"  alpha="255" extendstyle="1111">
                <image name="titleBg" rect="0,0,480,800" src="file://pics/main_bg.png"
                    extendstyle="1111" style="autosize">
                </image>
             </shadow>

            <!-- 信息头部 -->
            <node rect="0,0,480,80" extendstyle="0010">
                <image name="titleBg" rect="0,0,480,80" src="file://pics/sub_top_bg.png"
                    extendstyle="0010" style="autosize">
                </image>

                <!-- 返回按钮 -->
                <button name="backBtn" rect="9,14,52,52" OnSelect="doBack"
                    extendstyle="0010" normal="normal" sel="sel">
                    <image name="normal" rect="0,0,52,52"
                        src="file://pics/icon_back_d.png" style="autosize"
                        extendstyle="0010">
                    </image>
                     <image name="sel" rect="0,0,52,52"
                        src="file://pics/icon_back_s.png" style="autosize"
                        extendstyle="0010">
                    </image>
                </button>
                <image name="normal" rect="70,0,2,80" src="file://pics/sub_top_line.png"
                        extendstyle="0010"/>
                

              <!-- 二级菜单标题 -->
                <scrolltext name="title" rect="100,0,280,70" text="即时巡店" font-family="微软雅黑" 
                    extendstyle="0010" font-size="30" h-align="center" v-align="center"
                    color="#ffffff" scroll="true" step="2"></scrolltext>


                <!--新增 -->
                <button name="addBtn" rect="419,14,52,52" OnSelect="add"
                    extendstyle="0010" normal="normal" sel="sel">
                     <image name="normal" rect="0,0,52,52"
                        src="file://pics/icon_submit_d.png" style="autosize"
                        extendstyle="0010">
                    </image>
                     <image name="sel" rect="0,0,52,52"
                        src="file://pics/icon_submit_s.png" style="autosize"
                        extendstyle="0010">
                    </image>
                </button>
                 <image name="normal" rect="410,0,2,80" src="file://pics/sub_top_line.png"
                         extendstyle="0010"/>
            </node>
             
        <node  rect="0,80,480,71"  extendstyle="1111">
           <label name="label1" rect="35,0,100,71" style="autosize" text="巡店时间" color="#0"
                        extendstyle="0010" h-align="right" v-align="center" font-weight="bold" font-family="微软雅黑"
                        font-size="24"></label>       
            <button name="btnname4" rect="155,0,290,71" normal="normal" sel="sel" OnKeyUp="comboboxOnKeyup4" OnSelect="comboboxOnSelect4" data="" extendstyle="0010">
              <image normal="normal" rect="0,0,290,71" src="file://pics/input_select_btn_d.png" style="sudoku-auto" sudoku="15,15,100,15" extendstyle="0010"/>  
               <image normal="sel" rect="0,0,290,71" src="file://pics/input_select_btn_s.png" style="sudoku-auto" sudoku="15,15,100,15" extendstyle="0010"/>       
              <label name="comboboxlabel4" rect="10,0,260,71" text="请点击选择" font-family="微软雅黑" color="#0" extendstyle="0010" style="autosize" h-align="left"
                            v-align="center" font-size="24"></label>                                  
           </button>                    
        </node>
        <node  rect="0,151,480,71"  extendstyle="1111">
           <label name="mendianlabel" rect="35,0,100,71" style="autosize" text="巡店名称" color="#0"
                        extendstyle="0010" h-align="right" v-align="center" font-weight="bold" font-family="微软雅黑"
                        font-size="24"></label>     
           <button name="btnname2" rect="155,0,290,71" normal="normal" sel="sel" OnKeyUp="comboboxOnKeyup2" OnSelect="comboboxOnSelect2" data="" extendstyle="0010">
              <image normal="normal" rect="0,0,290,71" src="file://pics/input_select_btn_d.png" style="sudoku-auto" sudoku="15,15,100,15" extendstyle="0010"/>  
               <image normal="sel" rect="0,0,290,71" src="file://pics/input_select_btn_s.png" style="sudoku-auto" sudoku="15,15,100,15" extendstyle="0010"/>    
              <label name="comboboxlabel2" rect="10,0,260,71" text="请点击选择" font-family="微软雅黑" color="#0" extendstyle="0010" style="autosize" h-align="left"
                            v-align="center" font-size="24"/>              
           </button>         
        </node>
         <node  rect="0,222,480,71"  extendstyle="1111">
           <label name="label3" rect="35,0,100,71" style="autosize" text="巡店位置" color="#0"
                        extendstyle="0010" h-align="right" v-align="center" font-weight="bold" font-family="微软雅黑"
                        font-size="24"></label>                                                         
           <label name="xundianlabel" rect="165,0,270,71" style="autosize" color="#0" font-family="微软雅黑" extendstyle="0010" h-align="left"
                            v-align="center" font-size="24"/>  
        </node>
        <node  rect="0,293,480,228"  extendstyle="1111">
           <label name="label5" rect="35,10,100,218" style="autosize" text="巡店内容" color="#0"
                        extendstyle="0010" h-align="right" v-align="top" font-weight="bold" font-family="微软雅黑"
                        font-size="24"></label>
          <image rect="155,0,290,228" src="file://pics/input_text_bg.png" style="sudoku-auto" sudoku="35,35,35,35"
                            extendstyle="0010"/>
           <edit name="xundianneirong"  rect="165,10,270,208"  text="请输入巡店内容" font-family="微软雅黑" font-size="24" style="autosize" max-size="50" color="#0" v-center="top" multiline="true" OnLostFocus="editOnTextChanged2" OnSetFocus="initText" extendstyle="0010"/>          
        </node>
        <node rect="0,521,480,71"  extendstyle="1111">
        <button name="button1" rect="35,0,100,71" border="false"
                    OnSelect="btnCamera_Click" extendstyle="0010" normal="normal" sel="sel">
                 <image name="normal" rect="29,0,71,71" src="file://pics/icon_camera_d.png" 
                    extendstyle="0010" style="autosize"/>
                 <image name="sel" rect="29,0,71,71" src="file://pics/icon_camera_s.png" 
                    extendstyle="0010" style="autosize"/>       
        </button>
         <image rect="155,0,290,71" src="file://pics/input_text_bg.png" style="sudoku-auto" sudoku="35,35,35,35"
                            extendstyle="0010"/>    
          <edit name="edit1" rect="165,10,270,71" text="拍照后输入说明"  font-size="24" font-family="微软雅黑" style="autosize" max-size="50" color="#0" multiline="true"  h-align="left" 
                   v-align="center" OnLostFocus="edit1OnTextChanged" OnSetFocus="initText1"
                   extendstyle="0010">
                  </edit>
         </node>  
            <listview rect="0,592,480,120" extendstyle="1111">
               <list-item name="imageListNode" rect="0,0,480,120" extendstyle="0010">
                    <panorama name="imageList" rect="0,0,480,120" extendstyle="0010" style="circle" foreground="foreground" alpha="255"/>
                </list-item>
            </listview>
            <node name="imageListItem" rect="10,0,460,120" extendstyle="0010" visible="false" enable="false" active="false">
                <button name="pic1" rect="0,0,110,110" border="false"
                    color="#ffffff" OnSelect="shownail" extendstyle="0010">
                    <image name="bg" rect="0,5,110,110" src="" style="autosize"
                        extendstyle="0010">
                    </image>
                </button>
                <button name="pic2" rect="116,0,110,120" border="false"
                    color="#ffffff" OnSelect="shownail" extendstyle="0010">
                    <image name="bg" rect="0,5,110,110" src="" style="autosize"
                        extendstyle="0010">
                    </image>
                </button>
                <button name="pic3" rect="232,0,110,120" border="false"
                    color="#ffffff" OnSelect="shownail" extendstyle="0010">
                    <image name="bg" rect="0,5,110,110" src="" style="autosize"
                        extendstyle="0010">
                    </image>
                </button>
                <button name="pic4" rect="348,0,110,120" border="false"
                    color="#ffffff" OnSelect="shownail" extendstyle="0010">
                    <image name="bg" rect="0,5,110,110" src="" style="autosize"
                        extendstyle="0010">
                    </image>
                </button>
            </node>  
            
            <node name="mendianlistShowNode" rect="0,0,480,800" visible="false" enable="false">
                <button name="bthide" rect="0,0,480,800" OnSelect="hidemendianSelected">
                     <shadow rect="0,0,480,800"  alpha="150" color="#0"  extendstyle="1111">
                  </shadow>
                </button>
                <node rect="66,200,368,68" extendstyle="1111"  border="false">
                      <image rect="0,0,368,68" src="file://pics/Dialogs/top.png"  style="autosize" extendstyle="1111" />
                      <image rect="20,30,31,32" src="file://pics/Dialogs/icon_arrow.png"  style="autosize" extendstyle="1111" />
                      <label rect="40,10,120,68" border="false" color="#FFFFFF" style="autosize"
                       text="选择门店" h-align="center" v-align="center" font-family="微软雅黑" font-size="24"></label>
                </node>
                <image rect="66,268,368,216" src="file://pics/Dialogs/center.png"  style="autosize" extendstyle="1111" />
                <listview name="listView1" rect="66,268,368,216" auto-scroll="true" style="autosize"
                    auto-adjust="true" extendstyle="1111" />
                <image rect="66,483,368,21" src="file://pics/Dialogs/bottom.png"  style="autosize" extendstyle="1111"/>
            </node>
             <node name="listitem1" rect="0,0,368,72" visible="false" enable="false" active="false">                   
            <button name="itemBtn" rect="12,0,342,61" text="" h-align="left" v-align="center" font-family="微软雅黑" font-size="24" 
                 extendstyle="1111" OnSelect="itemBtnOnSelect" style="autosize"
                 normal="src:file://pics/icon_list_bg_d.png;style:sudoku-auto;sudoku:0,0,100,0;color:#000000"
                sel="src:file://pics/icon_list_bg_s.png;style:sudoku-auto;sudoku:0,0,100,0;color:#ffffff"
                 data="0"  >
             <label name="mystoreCode"  type="hidden"/>             
            <image rect="12,70,342,2" src="file://pics/Dialogs/line.png"  style="autosize" extendstyle="1111" />
            </button>
            </node>
            
            <!-- 弹出框 -->
            <node name="selectNode2" rect="0,0,480,800"  visible="false" mushroom="false"  enable="false">
                <button rect="0,0,480,800" name="button" OnSelect="hidenail">
                <shadow rect="0,0,480,800"  alpha="150" color="#0"  extendstyle="1111">
                  </shadow>
                </button>            
                  <node rect="66,200,368,68" extendstyle="1111"  border="false">
                      <image rect="0,0,368,68" src="file://pics/Dialogs/top.png"  style="autosize" extendstyle="1111" />
                      <image rect="20,30,31,32" src="file://pics/Dialogs/icon_arrow.png"  style="autosize" extendstyle="1111" />
                      <label rect="40,10,120,68" border="false" color="#FFFFFF"
                       text="操作类型" h-align="center" v-align="center" font-family="微软雅黑" font-size="24"></label>
                  </node>
                  <node rect="66,268,368,143" extendstyle="1111" border="false">
                     <image rect="0,0,368,143" src="file://pics/Dialogs/center.png"  style="autosize" extendstyle="1111" />
                        <button rect="12,0,342,61"  OnSelect="rmpic"  text="        删除"  color="#FFFFFF" h-align="left" v-align="center" font-family="微软雅黑" font-size="24"
                            border="false" data="01"
                            normal="src:file://pics/icon_list_bg_d.png;style:sudoku-auto;sudoku:0,0,100,0;color:#000000"
                            sel="src:file://pics/icon_list_bg_s.png;style:sudoku-auto;sudoku:0,0,100,0;color:#ffffff" style="autosize"
                            extendstyle="1111">
                        </button>
                        <image rect="12,70,342,2" src="file://pics/Dialogs/line.png"  style="autosize" extendstyle="1111" />
                        <button rect="12,73,342,61"  OnSelect="topic"  text="        查看原图" color="#FFFFFF" h-align="left" v-align="center" font-family="微软雅黑" font-size="24"
                            border="false" data="02"
                            normal="src:file://pics/icon_list_bg_d.png;style:sudoku-auto;sudoku:0,0,100,0;color:#000000"
                            sel="src:file://pics/icon_list_bg_s.png;style:sudoku-auto;sudoku:0,0,100,0;color:#ffffff" style="autosize"
                            extendstyle="1111">
                        </button>
                  </node>
                  <image rect="66,410,368,21" src="file://pics/Dialogs/bottom.png"  style="autosize" extendstyle="1111"/>
            </node>
            
        <image name="success" border="false" visible="false" rect="68,730,344,58" src="file://pics/sucess.png"
                        style="autosize" extendstyle="1111">
                <label name="successxinxi" rect="112,5,120,48" text="信息提交成功"
                        h-align="center" v-align="center" color="#ffffff" font-size="18"
                        extendstyle="0010"/>     
        </image>
     </node>
    </body>
    <![CDATA[

require 'com_xsgj.common.framework'
require 'com_xsgj.common.map'
require 'com_xsgj.common.upload'
local rootSprite
local user_name = Config:get('truename')
local user_code = Config:get('username')
local jsonDecodedData = nil
local fanhui2 = ""
local changdu2 = 0
local observer
local address_port = Alias.urlServer  
local url
local param2
local longitude=""
local latitude=""
local dingwei_address=""
local imgdata={}
local imageListNode
local imageList
local curitm
local submitItem
local curxundianBtn
local curidx=0
local up_url =Alias.urlServer..'fileUpload/getUploadUrl'
local allimg=''
local allimg2
local image
local mystoreCode=' '
local count
local ndnode=nil

---------------------------------------callbacks--------------------------------
-- @brief root子节点创建完事件
function bodyBuildChildrenFinished(sprite)
    rootSprite = sprite
    imageListNode = Sprite:findChild(rootSprite, 'imageListNode')
    imageList = Sprite:findChild(imageListNode, 'imageList')
    ndnode = Sprite:findChild(rootSprite, 'selectNode2')
    local chuangjianlabel = Sprite:findChild(rootSprite, 'chuangjianlabel')
    Sprite:setProperty(chuangjianlabel, 'text', user_name) 
    local xuandianlabel = Sprite:findChild(rootSprite, 'xuandianlabel')
    Sprite:setProperty(xuandianlabel, 'text', user_name) 
    setAllShoworHide(Sprite:findChild(rootSprite, 'mendianlistShowNode'), 0)   
end

-- @brief root节点消息方法
function bodyOnSpriteEvent(msg, param)
    if msg == MSG_ACTIVATE then -- 页面激活            
             retuenTime = ''
             retuenType = ''          
             local regHandle = Reg:create("dateTime")
             retuenTime = Reg:getString(regHandle, "time")
             retuenType = Reg:getString(regHandle, "type")   
             Log:write('retuenType', retuenType)       
             Reg:clear(Reg:create("dateTime")) 
             if retuenType=='jishixundian' then 
                 local startTime = Sprite:findChild(rootSprite, 'btnname4')          
                 local startContent = Sprite:findChild(startTime, 'comboboxlabel4')                              
                 if retuenTime ~= '' and retuenTime ~= nil then
                      if retuenType == 'jishixundian' then
                         Sprite:setProperty(startContent, 'text', retuenTime)              
                      end
                 else
                      if retuenType == 'jishixundian' then                          
                          Sprite:setProperty(startContent, 'text', "请点击选择")                     
                      end
                 end               
             else 
--                 setAllShoworHide(Sprite:findChild(rootSprite, 'success'), 0)                      
--                 local mendian = Sprite:findChild(rootSprite, 'btnname2')          
--                 local mendianContent = Sprite:findChild(mendian, 'comboboxlabel2') 
--                 Sprite:setProperty(mendianContent, 'text', "请点击选择")                      
--                 local startTime = Sprite:findChild(rootSprite, 'btnname4')          
--                 local startContent = Sprite:findChild(startTime, 'comboboxlabel4') 
--                 Sprite:setProperty(startContent, 'text', "请点击选择")                 
--                 local xundianneirong = Sprite:findChild(rootSprite, 'xundianneirong')   
--                 Sprite:setProperty(xundianneirong, 'text', "请输入巡店内容")                   
--                 local edit1 = Sprite:findChild(rootSprite, 'edit1')   
--                 Sprite:setProperty(edit1, 'text', "拍照后输入说明") 
--                 --进入即时巡店页面,清除拍照图片列表
--                 Panorama:removeAllItems(imageList)
--                 setAllShoworHide(Sprite:findChild(rootSprite, 'mendianlistShowNode'), 0)                   
                 url = "mystore/getlist"
                 param2 = "page=1&pagesize=100&usercode="..user_code
                 -- Http:request("duru", address_port..url..param2, 105)
                 Http:request("duru", address_port..url, 105,{useCache = false, method = 'post', postData=param2})
                 longitude = '0'
                 latitude = '0'
                 dingwei_address=' '
                 observer = Plugin:getObserver()
                 doLocation()
             end          
    end
end

-- @brief 插件消息方法
function bodyOnPluginEvent(msg, param)
       if msg == 1000 then--用来显示经纬度
            local postDataString = Param:getString(param, 0)
            local postData = Json:loadString2Table(postDataString)
            if postData.latitude ~= nil then
                latitude=postData.latitude
            end
            if postData.longitude ~= nil then
                longitude=postData.longitude
            end
            if postData.longitude ~= nil and postData.latitude ~= nil then
                Map:getLocation(observer, 1001, tonumber(postData.latitude), tonumber(postData.longitude))  
            end
        end
        if msg == 1001 then--用来显示定位的位置
            local postDataString = Param:getString(param, 0)
            local postData = Json:loadString2Table(postDataString)
            local locInfo = Sprite:findChild(rootSprite, 'xundianlabel')
            if postData.address ~= nil then
                Sprite:setProperty(locInfo, 'text', postData.address)
                dingwei_address = postData.address
            end
        end        
        if msg == 105 then 
            jsonDecodedData = Http:jsonDecode('duru')         
            if (jsonDecodedData == nil ) then
                Dialog:show("", "无我的门店", "ok")
                return
            end
            --local len = jsonDecodedData["Total"]  
            local len = getJsonArrayCount(jsonDecodedData["Rows"])  
            local list = Sprite:findChild(rootSprite, 'listView1')
            ListView:removeAllItems(list)
            ListView:loadItem(list, Sprite:findChild(rootSprite, 'listitem1'), len, 'loadListItem1')
            ListView:adjust(list)                            
        end  
         if msg>=504 and msg<=600 then--返回上传路径，并启动上传
            local ii=(msg-504);
            local uploadData = Http:xmlDecode('upload_url'..ii, 'RESULT')
            local url = uploadData.URL
            local param = uploadData.PARAM
            if param then
                param = param .. '&'
            else
                param = ''
            end
            if string.len(allimg)>0 then
                  allimg=allimg..','..uploadData.REMOTE_FILE_NAME
            else
                  allimg=uploadData.REMOTE_FILE_NAME
            end
            local fname=string.sub(imgdata[ii],lastIndexof( imgdata[ii],'/')+1,string.len(imgdata[ii])-4)
            Upload:append(url, param,imgdata[ii], fname,'', 'jpg')
            --testUpload:append(url, param,'MODULE:\\com_xsgj\\image\\Img338655873.jpg','Img338655873.jpg', 'test', 'jpg')
            --所有结束则结束load，提示成功
            imgdata[ii]=nil
            isok()
        elseif msg == 503 then--提交表单成功
            jsonDecodedData = Http:jsonDecode('kaoqin_data')
            if (jsonDecodedData == nil or jsonDecodedData["total"] == nil or
                jsonDecodedData["total"] == '') then
                Dialog:show("", jsonDecodedData["rows"], "ok")
                return
           else--提交成功
               --所有结束则结束load，提示成功
                setAllShoworHide(Sprite:findChild(rootSprite, 'success'), 1)
                Timer:set(1,1000,'doBack')
           end
         end        
end

-- @brief 按键响应处理
function mainNodeOnKeyUp(sprite, kc)
    if kc == Key.F2 then -- 按下返回键
        Scene:back()
        return 1
    end
end

---------------------------------------util functions---------------------------
function myfunc()
end

function hidemendianSelected()
     setAllShoworHide(Sprite:findChild(rootSprite, 'mendianlistShowNode'), 0)
end

function hidenail()
    Sprite:setEnable(ndnode, 0);
    Sprite:setVisible(ndnode, 0);
end

function shownail(sprite)
    curitm=Sprite:findChild(sprite, "bg")
    Sprite:setEnable(ndnode, 1);
    Sprite:setVisible(ndnode, 1);
end
function doBack()
        Scene:back(true)
end
 
function comboboxOnSelect2(sprite)
        setAllShoworHide(Sprite:findChild(rootSprite, 'mendianlistShowNode'), 1)
end

function itemBtnOnSelect(sprite) 
   local MystoreCode = Sprite:findChild(sprite, 'mystoreCode') 
   local comboboxLbl = Sprite:findChild(rootSprite, 'comboboxlabel2')
   local text = string.sub(Sprite:getText(sprite),9,-1)  
   local curitem=Sprite:getData(sprite)--取出itemBtn值
   Log:write('curitem'..curitem)
   submitItem=curitem --设置提交序号
   mystoreCode = Sprite:getText(MystoreCode)
   Sprite:setProperty(comboboxLbl, 'text', text)
   setAllShoworHide(Sprite:findChild(rootSprite, 'mendianlistShowNode'), 0)
end

function loadListItem1(list, item, index)
        Sprite:setRect(item, 0,0,368,72)
        Sprite:setProperty(item, 'extendstyle', '0010')
        local btn = Sprite:findChild(item, 'itemBtn')
        local mystoreCode = Sprite:findChild(item, 'mystoreCode')
        if (jsonDecodedData ~= nil) then
           local value = jsonDecodedData['Rows'][index]
            if value.mystoreName~=nil then
            Sprite:setProperty(btn, 'text', "        "..value.mystoreName)
            Sprite:setProperty(mystoreCode, 'text', value.mystoreCode)
            Log:write("mystoreName="..value.mystoreName.."mystoreCode="..value.mystoreCode)
            end 
            Sprite:setProperty(btn, 'data', index)   
        end        
    end

function comboboxOnSelect4(sprite)
       local startTime = Sprite:findChild(rootSprite, 'btnname4')
       local content = Sprite:findChild(Sprite:getParent(sprite), 'label1')
      
        --local date = Sprite:getText(content)
        --构造请求地址
        --local stringDate = Split(date, '-')
        local regHandle = Reg:create('dateDialog')
        if tonumber(startTime) == tonumber(sprite) then
            Reg:setString(regHandle, 'type', 'jishixundian')
        else
            return
        end
        Reg:setString(regHandle, 'year', "")
        Reg:setString(regHandle, 'month', "")
        Reg:setString(regHandle, 'day', "")
        Scene:setReturn(Alias.wjb_jishixundian, Alias.dateDialog)
        Scene:go(Alias.dateDialog)
end

function add()  
      local xundian =  Sprite:findChild(rootSprite, 'btnname4') 
      local xundianTime = Sprite:findChild(xundian, 'comboboxlabel4')
      local xundianTimeText =  Sprite:getText(xundianTime)
      local mendian = Sprite:findChild(rootSprite, 'btnname2')
      local mendianmingcheng = Sprite:findChild(mendian, 'comboboxlabel2')
      local mendianText = Sprite:getText(mendianmingcheng)        
      local xundianneirong = Sprite:findChild(rootSprite, 'xundianneirong')
      local xundianneirongText = Sprite:getText(xundianneirong)
      local tupianshuoming = Sprite:findChild(rootSprite,"edit1")
      local tupianshuomingText = Sprite:getText(tupianshuoming)
      Log:write('巡店内容为',xundianneirongText)
      if xundianTimeText=="" or xundianTimeText=="请点击选择" then 
           Dialog:show("", "无巡店时间", "ok")  
           return 
      end
      if mendianText=="" or mendianText=="请点击选择" then 
           Dialog:show("", "无巡店门店", "ok") 
           return 
      end 
      if xundianneirongText=="" or xundianneirongText=="请输入巡店内容" then
          Dialog:show("", "无巡店内容", "ok") 
          return 
      end 
      if longitude=="" or latitude =="" then 
          Dialog:show("", "无定位坐标,定位失败,请重试", "ok") 
          return 
      end
      if dingwei_address=="" then 
          Dialog:show("", "无定位地址", "ok") 
            return 
      end    
        --1.首先上传
        count=getJsonArrayCount(imgdata)-1
        if count <= 1 then
           Log:write("COUNT="..count)
           subform()
           return
        end
        Loading:show(rootSprite)
        for i=1,count-1 do
       local fname=string.sub(imgdata[i],lastIndexof( imgdata[i],'/')+1,string.len(imgdata[i])-4)
        param2 = 'FILE_NAME='..fname..'&C_TYPE=jpg&C_LEN=' .. IO:fileSize(imgdata[i])
        --param2 = 'FILE_NAME='..string.sub(fname,1,string.len(fname)-4)..'&C_TYPE=jpg&C_LEN=' .. IO:fileSize('MODULE:\\com_xsgj\\image\\login_window_bg.png')
        Http:request('upload_url'..i, up_url, 504+i, {useCache = false, method = 'post', postData= param2})      
        end  
end
    
    function subform()
         local xundian =  Sprite:findChild(rootSprite, 'btnname4') 
      local xundianTime = Sprite:findChild(xundian, 'comboboxlabel4')
      local xundianTimeText =  Sprite:getText(xundianTime)
       local xundianneirong = Sprite:findChild(rootSprite, 'xundianneirong')
      local xundianneirongText = Sprite:getText(xundianneirong)
        url="mtour/submitTourim"
        image=""   
        if count<=1 then    
           image="&imageName="
        else
           image="&imageName="..allimg
        end       
        param2 ='mystoreCode='..mystoreCode
        ..'&addMan='..user_code
        ..'&tourDate='..xundianTimeText
        ..'&tourNote='..xundianneirongText
        ..'&longitude='..longitude
        ..'&latitude='..latitude
        ..'&tourLocation='..dingwei_address
        ..image
        Log:write("param2="..param2)
        --Http:request('kaoqin_data',address_port..url..param2, 103)
        Http:request('kaoqin_data',address_port..url, 503, {useCache = false, method = 'post',postData=param2})       
    end

function initText(sprite)
    local txt= Sprite:getProperty(sprite, 'text')
    if txt=="请输入巡店内容" then
    Sprite:setProperty(sprite, 'text', '')
    Sprite:setProperty(sprite, 'color', '#0')
    end
end 
   
function initText1(sprite)
    local txt= Sprite:getProperty(sprite, 'text')
    if txt=="拍照后输入说明" then
        Sprite:setProperty(sprite, 'text', '')
        Sprite:setProperty(sprite, 'color', '#0')
    end
end
    
function editOnTextChanged2(sprite)
       local txt= Sprite:getProperty(sprite, 'text')
       if txt=='' or txt ==nil then
          Sprite:setProperty(sprite, 'text',"请输入巡店内容")
       end
end
    
function edit1OnTextChanged(sprite)
       local txt= Sprite:getProperty(sprite, 'text')
       if txt=='' or txt ==nil then
         Sprite:setProperty(sprite, 'text', "拍照后输入说明")
       end
end
       
    ---开始定位
function doLocation()
        local locInfo = Sprite:findChild(rootSprite, 'xundianlabel')
        Sprite:setProperty(locInfo, 'text', '正在定位......')
        Map:getCurPosition(observer,  1000)
end
 
 ---开启拍照   
function btnCamera_Click(sprite)
        local fileName = os.time()        
        --onCameraDialog('file://image/login_window_bg.png', 'jpg')
        local result = System:openCamera('onCameraDialog', 'file://image/' .. fileName .. '.jpg', 'jpg')
        if result == 0 then
          Dialog:show('提示', '相机打开失败!', 'ok')
          return 1
       end
end

---获取照片
    function onCameraDialog(photoPath, photoType)
        local tmpSplitArray = Split(photoPath,'%.')
        local dest = tmpSplitArray[1] .. 'temp' .. System:getTickTime() .. '.jpg'
        Log:write('目标文件路径为:'..dest)
        local ret = ScaleImageAsJpg(photoPath, dest, 480, 800, 0)
        if ret == 1 then
            table.insert(imgdata, dest)
            Log:write('图片压缩成功，压缩后的图片位置为:'..dest)
        else
            table.insert(imgdata, photoPath)
            Log:write('警告：图片压缩失败，使用未压缩的图片:'..photoPath)
        end
        --显示图片列表
       reloadImages();
    end
    
--重新显示图片列表
    function reloadImages()
        count=getJsonArrayCount(imgdata)-1    
        local realCount = 0
        if count > 0 then
            if count % 4 > 0 then
                realCount = (count - (count % 4)) / 4 + 1
            else
                realCount = count / 4
            end
        end      
        Panorama:removeAllItems(imageList) 
        Panorama:loadItem(imageList, Sprite:findChild(rootSprite, 'imageListItem'),realCount,'loadListItem')
        local x,y,w,h = Sprite:getRect(imageList)
        x,y,w,h = Sprite:getRect(imageListNode)
        Panorama:adjust(imageList)
        ListView:adjust(Sprite:getParent(imageListNode))
    end
    
    -- 显示图片
   function loadListItem(list, item, index)
        local picArray = {
            Sprite:findChild(item, 'pic1'),
            Sprite:findChild(item, 'pic2'),
            Sprite:findChild(item, 'pic3'),
            Sprite:findChild(item, 'pic4'),
        }
        for i=1,#picArray do
        Log:write(imgdata[tonumber(index) * 4 + i])
            if imgdata[tonumber(index) * 4 + i] == nil then
                break
            end
            local bg = Sprite:findChild(picArray[i], 'bg')
            if Sprite:getProperty(bg, 'src') ~= nil and Sprite:getProperty(bg, 'src') == '' then            
                Sprite:setProperty(bg, 'data', imgdata[tonumber(index) * 4 + i])
                Sprite:setProperty(bg, 'src', imgdata[tonumber(index) * 4 + i])
                ----testSprite:setProperty(bg, 'src', 'http://120.209.131.143:9000/mobileSale/uploadfiles/1349534280708_camera.png')
            end
        end
    end
    
    --显示原图
    function topic(sprite)
        --创建数据仓库
        hidenail()
        local reg=Reg:create("PicReg")
        local igsrc=Sprite:getProperty(curitm, "src")
        local ogsrc=replaceStr(igsrc,'nail_','')
        Reg:setString(reg, "pic", ogsrc)
        --跳转
         Scene:setReturn('MODULE:\\com_xsgj\\wjb_jishixundian.wdml', 'MODULE:\\com_xsgj\\wjb_orignImg.wdml')
         Scene:go('MODULE:\\com_xsgj\\wjb_orignImg.wdml')  
    end
    --删除图片
    function rmpic(sprite)
         hidenail()
        Sprite:removeChild(Sprite:getParent(curitm), curitm)
        local dt=Sprite:getData(curitm)
        local count=getJsonArrayCount(imgdata)
        for i=1,count-1 do
            if imgdata[i]==dt then
            table.remove(imgdata,i)
            break
            end
        end
        reloadImages()       
    end
    
      --查找最后一个字符串
    function lastIndexof(s,tag)
        local index=-1
        Log:write(tag)
        while true do
         local i = string.find(s,tag,index+1)
         if i == nil then
             return index
         end
         index = i
        end
    end
    
    function isok()
        --图片都已添加到队列
        local count=getJsonArrayCount(imgdata)
        for i=1,count-1 do
            if imgdata[i]~=nil then
                return
            end
        end
        subform()
    end

    ]]>
</root>
                 